<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improved Barcode Scanner</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            background: #ffffff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 500px;
        }
        h1 {
            margin-top: 0;
            color: #1c1e21;
        }
        #controls {
            margin: 1.5rem 0;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        button, .file-upload-label {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        #startCameraBtn {
            background-color: #007bff;
            color: white;
        }
        #startCameraBtn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        .file-upload-label {
            background-color: #28a745;
            color: white;
        }
        .file-upload-label:hover {
            background-color: #1e7e34;
            transform: translateY(-2px);
        }
        #scanner-container {
            margin-top: 1rem;
            width: 100%;
            min-height: 250px;
            background: #e9ecef;
            border: 2px dashed #ced4da;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        video, img {
            max-width: 100%;
            max-height: 400px;
            display: none; /* Hide both initially */
        }
        #result {
            margin-top: 1.5rem;
            font-size: 1.1em;
            font-weight: bold;
            color: #dc3545;
            min-height: 24px;
            word-wrap: break-word;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Improved Barcode Scanner</h1>
        <p>Use your camera or upload an image to scan a barcode.</p>

        <!-- Controls for switching between modes -->
        <div id="controls">
            <button id="startCameraBtn">Scan with Camera</button>
            <label for="imageInput" class="file-upload-label">Upload Image</label>
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
        </div>

        <!-- This container will hold either the video stream or the uploaded image -->
        <div id="scanner-container">
            <video id="video" autoplay playsinline></video>
            <img id="uploadedImage" alt="Uploaded Barcode Image">
        </div>

        <!-- The result will be displayed here -->
        <p id="result">Select a scanning method to begin.</p>
    </div>

    <script>
        // DOM Element References
        const startCameraBtn = document.getElementById('startCameraBtn');
        const imageInput = document.getElementById('imageInput');
        const videoElem = document.getElementById('video');
        const uploadedImage = document.getElementById('uploadedImage');
        const resultElem = document.getElementById('result');

        let stream = null;
        let intervalId = null;
        let barcodeDetector;

        // Check for browser support and initialize the BarcodeDetector
        if (!('BarcodeDetector' in window)) {
            resultElem.textContent = 'Barcode Detector is not supported by this browser.';
            startCameraBtn.disabled = true;
            imageInput.disabled = true;
        } else {
            console.log('Barcode Detector supported!');
            barcodeDetector = new BarcodeDetector({
                formats: ['qr_code', 'ean_13', 'code_128', 'upc_a']
            });
        }

        /**
         * Stops the camera stream and scanning interval.
         */
        const stopScan = () => {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            videoElem.style.display = 'none';
            videoElem.srcObject = null;
        };

        /**
         * Starts the camera scan.
         */
        const startCameraScan = async () => {
            stopScan();
            uploadedImage.style.display = 'none';
            videoElem.style.display = 'block';
            resultElem.textContent = "Requesting camera access...";

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                videoElem.srcObject = stream;
                resultElem.textContent = "Scanning...";

                intervalId = setInterval(async () => {
                    try {
                        const barcodes = await barcodeDetector.detect(videoElem);
                        if (barcodes.length > 0) {
                            resultElem.textContent = `Found: ${barcodes[0].rawValue}`;
                            stopScan();
                        }
                    } catch (err) {
                        // This can happen if the video stream is closed, safe to ignore.
                    }
                }, 200);
            } catch (err) {
                resultElem.textContent = "Could not access the camera. Please grant permission.";
                console.error("Error accessing camera:", err);
            }
        };

        /**
         * Handles the file upload and scans the selected image after it loads.
         * This is the corrected function.
         */
        const handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // --- Step 1: Immediately reset the UI ---
            stopScan();
            videoElem.style.display = 'none';
            uploadedImage.style.display = 'block';
            resultElem.textContent = "Loading image..."; // Clear previous result

            // --- Step 2: Set up an onload event listener ---
            // This ensures we only scan after the image is fully loaded.
            uploadedImage.onload = async () => {
                resultElem.textContent = "Scanning image...";
                try {
                    const barcodes = await barcodeDetector.detect(uploadedImage);
                    if (barcodes.length > 0) {
                        resultElem.textContent = `Found: ${barcodes[0].rawValue}`;
                    } else {
                        resultElem.textContent = "No barcode found in the image.";
                    }
                } catch (err) {
                    resultElem.textContent = "Error scanning the image.";
                    console.error("Error during image detection:", err);
                }
            };

            // --- Step 3: Set the image source ---
            // This triggers the 'onload' event listener we just set up.
            uploadedImage.src = URL.createObjectURL(file);
        };

        // Attach event listeners to the controls
        startCameraBtn.addEventListener('click', startCameraScan);
        imageInput.addEventListener('change', handleImageUpload);

    </script>

</body>
</html>


