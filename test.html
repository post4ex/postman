<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assign Carrier - Postman</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icon Library (for refresh icon) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Ensure the main container fills the available space between header and footer */
        main {
            min-height: calc(100vh - 8rem); /* Adjust based on your header/footer height */
        }
        /* Simple animation for spinners */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        /* Custom scrollbar for scrollable areas */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <div id="header-placeholder"></div>

    <main class="flex-grow w-full flex flex-col p-4">
        <div id="mainContainer" class="flex flex-col md:flex-row w-full max-w-7xl mx-auto gap-8 flex-grow">

            <!-- Left Column: Shipments List -->
            <div class="w-full md:w-1/2 bg-white rounded-xl shadow-lg flex flex-col h-[60vh] md:h-full">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center flex-shrink-0">
                    <h2 class="text-xl font-bold text-gray-800">Recent Shipments</h2>
                </div>
                <div id="shipmentsListContainer" class="custom-scrollbar flex-grow p-4 space-y-3 overflow-y-auto">
                    <div id="shipmentsPlaceholder" class="text-center text-gray-500 pt-16">
                        <p>Waiting for application data...</p>
                    </div>
                     <div id="shipmentsSpinner" class="text-center text-gray-500 pt-16 hidden">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-2">Loading Shipments...</p>
                    </div>
                </div>
                <div id="loadMoreContainer" class="p-4 border-t border-gray-200 text-center hidden flex-shrink-0">
                    <button id="loadMoreButton" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                        Load More
                    </button>
                </div>
            </div>

            <!-- Right Column: Partial Order Update Form -->
            <div class="w-full md:w-1/2 md:h-full">
                <div class="p-4 sm:p-8 space-y-6 bg-white rounded-xl shadow-lg">
                    <div class="text-center">
                        <h1 class="text-3xl font-bold text-gray-800">Assign Carrier</h1>
                        <p class="mt-2 text-sm text-gray-600">Select a shipment from the left to update its details.</p>
                    </div>

                    <form id="partialUpdateForm" class="space-y-4">
                        <fieldset class="border-t border-gray-200 pt-4 hidden">
                            <legend class="text-lg font-semibold text-gray-700 mb-2">Authentication</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="code" class="text-sm font-medium text-gray-700">User Code</label>
                                    <input type="text" id="code" name="code" required class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" placeholder="Auto-filled" readonly>
                                </div>
                                <div>
                                    <label for="token" class="text-sm font-medium text-gray-700">Token</label>
                                    <input type="password" id="token" name="token" required class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" placeholder="Auto-filled" readonly>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset class="border-t border-gray-200 pt-4">
                            <legend class="text-lg font-semibold text-gray-700 mb-2">Identify Order</legend>
                            <div>
                                <label for="reference" class="text-sm font-medium text-gray-700">Reference ID</label>
                                <input type="number" id="reference" name="REFERANCE" required class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" placeholder="Select a shipment" readonly>
                            </div>
                        </fieldset>
                        <fieldset class="border-t border-gray-200 pt-4">
                            <legend class="text-lg font-semibold text-gray-700 mb-2">Fields to Update</legend>
                             <p class="text-xs text-gray-500 mb-4">Only fill in the fields you want to change.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <div>
                                    <label for="carrier" class="text-sm font-medium text-gray-700">Carrier</label>
                                    <select id="carrier" name="CARRIER" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="">Select a carrier</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="awb_number" class="text-sm font-medium text-gray-700">AWB Number</label>
                                    <input type="text" id="awb_number" name="AWB_NUMBER" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="New AWB number">
                                </div>
                                <div>
                                    <label for="order_date" class="text-sm font-medium text-gray-700">Order Date</label>
                                    <input type="date" id="order_date" name="ORDER_DATE" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="transit_date" class="text-sm font-medium text-gray-700">Transit Date</label>
                                    <input type="date" id="transit_date" name="TRANSIT_DATE" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="dyna_awb" class="text-sm font-medium text-gray-700">Dyna AWB</label>
                                    <input type="text" id="dyna_awb" name="DYNA_AWB" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="New Dyna AWB">
                                </div>
                            </div>
                        </fieldset>
                        <div>
                            <button type="submit" id="submitButton" class="w-full flex justify-center items-center py-2.5 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300">
                                <span id="buttonText">Update Order</span>
                                <svg id="spinner" class="spinner h-5 w-5 ml-3 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </button>
                        </div>
                    </form>
                    <div id="responseMessage" class="mt-4 p-4 text-sm rounded-md hidden"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="layout.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- PAGE PROTECTION ---
            // This is a protected page. Redirect to login if the user is not authenticated.
            const loginDataJSON = localStorage.getItem('loginData');
            let isLoggedIn = false;
            if (loginDataJSON) {
                try {
                    const loginData = JSON.parse(loginDataJSON);
                    if (loginData.expires && new Date().getTime() <= loginData.expires) {
                        isLoggedIn = true;
                    }
                } catch(e) { console.error("Error parsing login data", e); }
            }

            if (!isLoggedIn) {
                // Using replace to prevent user from coming back to this page via back button
                window.location.replace('https://post4ex.github.io/postman/login.html');
                return; // Stop script execution
            }

            // --- DOM ELEMENT CONSTANTS ---
            const form = document.getElementById('partialUpdateForm');
            const submitButton = document.getElementById('submitButton');
            const buttonText = document.getElementById('buttonText');
            const spinner = document.getElementById('spinner');
            const responseMessage = document.getElementById('responseMessage');
            const shipmentsListContainer = document.getElementById('shipmentsListContainer');
            const shipmentsPlaceholder = document.getElementById('shipmentsPlaceholder');
            const shipmentsSpinner = document.getElementById('shipmentsSpinner');
            const referenceInput = document.getElementById('reference');
            const carrierSelect = document.getElementById('carrier');
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            const loadMoreButton = document.getElementById('loadMoreButton');
            const codeInput = document.getElementById('code');
            const tokenInput = document.getElementById('token');

            // --- STATE & CONFIG ---
            let activeShipmentElement = null;
            let allShipments = [];
            let currentIndex = 0;
            const shipmentsPerLoad = 10; 
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx5PZJRnnDmyDtYbWctF6d0428h1haJnDfVA4HKQR4hcsdAolcmkhLG9MgntAhPSQyi/exec';

            // --- MAIN INITIALIZATION LOGIC ---
            function initializeAppLogic() {
                shipmentsPlaceholder.classList.add('hidden');
                shipmentsSpinner.classList.remove('hidden');
                
                const loginDataJSON = localStorage.getItem('loginData');
                const appDataJSON = localStorage.getItem('appData');

                if (!loginDataJSON || !appDataJSON) {
                    shipmentsSpinner.classList.add('hidden');
                    shipmentsListContainer.innerHTML = `<p class="text-center text-red-500 p-4">Could not find required login or application data. Please try refreshing.</p>`;
                    return;
                }

                try {
                    const loginData = JSON.parse(loginDataJSON);
                    const appData = JSON.parse(appDataJSON);
                    
                    codeInput.value = loginData.CODE || loginData.code;
                    tokenInput.value = loginData.TOKEN || loginData.token;

                    const b2b2cData = appData.data.B2B2C || [];
                    const ordersData = appData.data.ORDERS || [];
                    const carrierData = appData.data.CARRIER || [];

                    carrierSelect.innerHTML = '<option value="">Select a carrier</option>';
                    carrierData.forEach(carrier => {
                        const option = document.createElement('option');
                        option.value = carrier.COMPANY_CODE;
                        option.textContent = carrier.COMPANY_CODE;
                        carrierSelect.appendChild(option);
                    });
                    
                    const nameLookup = new Map(b2b2cData.map(client => [client.UID, client.NAME]));
                    const processedOrders = ordersData.map(shipment => ({
                        ...shipment,
                        CONSIGNOR: nameLookup.get(shipment.CONSIGNOR) || shipment.CONSIGNOR,
                        CONSIGNEE: nameLookup.get(shipment.CONSIGNEE) || shipment.CONSIGNEE
                    }));

                    const incompleteShipments = processedOrders.filter(s => !s.CARRIER || !s.AWB_NUMBER);
                    const completeShipments = processedOrders.filter(s => s.CARRIER && s.AWB_NUMBER);

                    incompleteShipments.sort((a, b) => new Date(b.ORDER_DATE) - new Date(a.ORDER_DATE));
                    completeShipments.sort((a, b) => new Date(b.ORDER_DATE) - new Date(a.ORDER_DATE));

                    allShipments = [...incompleteShipments, ...completeShipments];
                    currentIndex = 0;
                    
                    shipmentsSpinner.classList.add('hidden');
                    shipmentsListContainer.innerHTML = '';

                    if (allShipments.length === 0) {
                        shipmentsListContainer.innerHTML = '<p class="text-center text-gray-500">No shipments found.</p>';
                        loadMoreContainer.classList.add('hidden');
                        return;
                    }
                    
                    renderMoreShipments();

                } catch (error) {
                    shipmentsSpinner.classList.add('hidden');
                    shipmentsListContainer.innerHTML = `<p class="text-center text-red-500 p-4">Failed to process data: ${error.message}</p>`;
                }
            }

            // --- FORM SUBMISSION ---
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitButton.disabled = true;
                buttonText.textContent = 'Updating...';
                spinner.classList.remove('hidden');
                responseMessage.classList.add('hidden');
                
                const formData = new FormData(form);
                const payload = {
                    code: formData.get('code'),
                    token: formData.get('token'),
                    orderDetails: {
                        action: 'partial_update',
                        REFERANCE: formData.get('REFERANCE')
                    }
                };
                
                const updatableFields = ['ORDER_DATE', 'TRANSIT_DATE', 'CARRIER', 'AWB_NUMBER', 'DYNA_AWB'];
                updatableFields.forEach(field => {
                    const value = formData.get(field);
                    if (value) payload.orderDetails[field] = value;
                });
                
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST', mode: 'cors', body: JSON.stringify(payload)
                    });
                    const resultText = await response.text();
                    if (!resultText.trim().startsWith('{')) throw new Error(`Unexpected server response: ${resultText}`);
                    const result = JSON.parse(resultText);

                    if (result.success) {
                        responseMessage.textContent = result.message;
                        responseMessage.className = 'mt-4 p-4 text-sm rounded-md bg-green-100 text-green-800';
                        form.reset();
                        
                        const loginData = JSON.parse(localStorage.getItem('loginData'));
                        codeInput.value = loginData.CODE || loginData.code;
                        tokenInput.value = loginData.TOKEN || loginData.token;

                        if (activeShipmentElement) {
                             activeShipmentElement.classList.add('border-green-400', 'bg-green-50');
                             setTimeout(() => {
                                 activeShipmentElement.classList.remove('border-green-400', 'bg-green-50');
                             }, 2000);
                             activeShipmentElement = null;
                        }

                    } else {
                        throw new Error(result.message || 'An unknown error occurred.');
                    }
                } catch (error) {
                    responseMessage.textContent = `Error: ${error.message}`;
                    responseMessage.className = 'mt-4 p-4 text-sm rounded-md bg-red-100 text-red-800';
                } finally {
                    submitButton.disabled = false;
                    buttonText.textContent = 'Update Order';
                    spinner.classList.add('hidden');
                    responseMessage.classList.remove('hidden');
                }
            });

            // --- RENDER SHIPMENTS ---
            function renderMoreShipments() {
                const fragment = document.createDocumentFragment();
                const nextBatch = allShipments.slice(currentIndex, currentIndex + shipmentsPerLoad);

                if (currentIndex === 0) shipmentsListContainer.innerHTML = '';

                nextBatch.forEach(shipment => {
                    const div = document.createElement('div');
                    let classList = 'p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors';
                    if (!shipment.CARRIER || !shipment.AWB_NUMBER) {
                        classList = 'p-3 border border-amber-300 rounded-lg cursor-pointer bg-amber-50 hover:bg-amber-100 transition-colors';
                    }
                    div.className = classList;
                    div.dataset.referenceId = shipment.REFERANCE; 
                    const orderDate = shipment.ORDER_DATE ? new Date(shipment.ORDER_DATE).toISOString().split('T')[0] : 'No Date';

                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-gray-800">Ref: ${shipment.REFERANCE}</p>
                            <p class="text-xs text-gray-500">${orderDate}</p>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">From: ${shipment.CONSIGNOR || 'N/A'}</p>
                        <p class="text-sm text-gray-600 mt-1">To: ${shipment.CONSIGNEE || 'N/A'} - ${shipment.DEST_CITY || 'N/A'}</p>
                        <p class="text-sm text-gray-600 mt-1">Carrier: ${shipment.CARRIER || 'Not Assigned'}</p>
                        <p class="text-sm text-gray-600 mt-1">AWB: ${shipment.AWB_NUMBER || 'Not Assigned'}</p>
                    `;
                    fragment.appendChild(div);
                });

                shipmentsListContainer.appendChild(fragment);
                currentIndex += nextBatch.length;
                updateLoadMoreButton();
            }
            
            function updateLoadMoreButton() {
                if (currentIndex < allShipments.length) {
                    loadMoreContainer.classList.remove('hidden');
                } else {
                    loadMoreContainer.classList.add('hidden');
                    if (!shipmentsListContainer.querySelector('.end-of-list')) {
                        const endMessage = document.createElement('p');
                        endMessage.className = 'end-of-list text-center text-xs text-gray-400 py-2';
                        endMessage.textContent = 'End of list';
                        shipmentsListContainer.appendChild(endMessage);
                    }
                }
            }

            // --- UI EVENT LISTENERS ---
            loadMoreButton.addEventListener('click', renderMoreShipments);

            shipmentsListContainer.addEventListener('click', (e) => {
                const shipmentElement = e.target.closest('[data-reference-id]');
                if (shipmentElement) {
                    const refId = shipmentElement.dataset.referenceId;
                    const selectedShipment = allShipments.find(s => s.REFERANCE == refId);

                    if (selectedShipment) {
                        referenceInput.value = selectedShipment.REFERANCE || '';
                        document.getElementById('order_date').value = selectedShipment.ORDER_DATE ? new Date(selectedShipment.ORDER_DATE).toISOString().split('T')[0] : '';
                        document.getElementById('transit_date').value = selectedShipment.TRANSIT_DATE ? new Date(selectedShipment.TRANSIT_DATE).toISOString().split('T')[0] : '';
                        carrierSelect.value = selectedShipment.CARRIER || '';
                        document.getElementById('awb_number').value = selectedShipment.AWB_NUMBER || '';
                        document.getElementById('dyna_awb').value = selectedShipment.DYNA_AWB || '';
                    }

                    if (activeShipmentElement) {
                        activeShipmentElement.classList.remove('bg-indigo-50', 'border-indigo-300');
                    }
                    
                    shipmentElement.classList.add('bg-indigo-50', 'border-indigo-300');
                    activeShipmentElement = shipmentElement;
                    form.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });

            // --- INITIALIZATION ---
            window.addEventListener('appDataLoaded', initializeAppLogic);
            window.addEventListener('appDataRefreshed', initializeAppLogic);

            // Proactively check if data is already available in localStorage.
            const appDataJSON = localStorage.getItem('appData');
            if (appDataJSON) {
                try {
                    const appData = JSON.parse(appDataJSON);
                    if (appData && appData.data && new Date().getTime() < appData.expires) {
                        initializeAppLogic();
                    }
                } catch (e) {
                    console.error("AssignCarrier.html: Error parsing cached appData.", e);
                }
            }
        });
    </script>

</body>
</html>

