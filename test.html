<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uploader - Postman</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top: 4px solid #4338ca; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* --- FIX STARTS HERE: Explicit Button Styling --- */
        .uploader-container button {
            padding: 8px 16px; border: 1px solid #ccc; background-color: #fff; border-radius: 4px;
            cursor: pointer; font-weight: 500; color: #333; transition: background-color 0.2s, border-color 0.2s;
        }
        .uploader-container button:hover { background-color: #f0f0f0; border-color: #bbb; }
        .uploader-container button:disabled { background-color: #e9ecef; cursor: not-allowed; opacity: 0.7; }
         /* --- FIX ENDS HERE --- */

        .uploader-container {
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            width: 100%; box-sizing: border-box;
        }
        #gscript-container {
            width: 100%; padding: 10px; background-color: #fffbe6; border-radius: 8px; border: 1px solid #ffeeba;
        }
        #gscript-container input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        
        #main-controls-strip {
            width: 100%; display: flex; justify-content: center; align-items: center;
            gap: 10px; flex-wrap: wrap; padding: 8px; background-color: #e9ecef;
            border-radius: 8px; box-sizing: border-box;
        }
        .upload-type-strip, .button-group {
            display: flex; flex-wrap: wrap; gap: 8px;
            align-items: center; justify-content: center;
        }
        .separator {
            width: 1px; height: 28px; background-color: #ced4da;
        }
        @media (max-width: 680px) { .separator { display: none; } }

        .type-btn { padding: 6px 12px; }
        .type-btn.active {
            background-color: #1E3A8A; color: #fff; border-color: #1E3A8A; font-weight: bold;
        }
        .type-btn.active:hover { background-color: #1c347a; }
        
        #image-scroller-container {
            width: 100%; height: 80px; background-color: #eee; border: 1px solid #ddd;
            border-radius: 4px; padding: 5px; box-sizing: border-box; display: none;
        }
        #image-scroller {
            height: 100%; display: flex; gap: 5px; overflow-x: auto; white-space: nowrap;
        }
        .scroller-img {
            height: 100%; width: 70px; object-fit: cover; cursor: pointer;
            border: 2px solid transparent; border-radius: 2px; transition: border-color 0.2s;
        }
        .scroller-img.active { border-color: #1E3A8A; }
        
        #image-view-area {
            border: 2px dashed #ccc; width: 100%; aspect-ratio: 4 / 3; display: flex;
            justify-content: center; align-items: center; text-align: center; color: #888;
            position: relative; overflow: hidden; background-color: #f0f0f0;
            cursor: default;
        }
        #image-view-area.selectable { cursor: crosshair; }
        #image-preview { display: none; }
        #camera-feed, #preview-canvas {
            width: 100%; height: 100%; object-fit: contain;
        }
        #camera-feed.active-capture { cursor: pointer; }
        #preview-canvas { display: none; }

        #rotate-btn, #lock-btn, #cancel-btn, #cancel-all-btn, #file-input { display: none; }
        .entry-input-group { display: flex; flex-wrap: wrap; gap: 8px; width: 100%; align-items: center; }
        .entry-input-group input, .entry-input-group select { padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1; }
        
        .data-table-container { width: 100%; margin-top: 5px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 14px; }
        th { background-color: #f0f0f0; }
        td .image-cell-content { width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; }
        td .image-cell-content img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #table-actions { width: 100%; margin-top: 15px; }

        #inline-cropper-wrapper {
            display: none; width: 100%; padding: 10px; box-sizing: border-box;
            background-color: #f0f0f0; border: 2px dashed #1E3A8A; 
        }
        #cropper-container { width: 100%; height: 60vh; }
        #cropper-image { display: block; max-width: 100%; }
        
        #selection-canvas {
            position: absolute; top: 0; left: 0; display: none; z-index: 10;
        }
        
        #status-bar {
            width: 100%; padding: 8px; box-sizing: border-box; min-height: 2.5em;
            text-align: center; background-color: #e9ecef; border-radius: 4px; color: #495057;
        }
        #status-bar.error { color: #dc3545; font-weight: bold; }

        .slider-control { display: flex; align-items: center; gap: 10px; width: 100%; max-width: 280px; justify-content: center; }
        .enhancement-sliders { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 15px; }
        input[type="range"] { flex-grow: 1; }

        .main-content-wrapper { display: flex; flex-direction: column; width: 100%; gap: 15px; }
        .preview-column, .controls-column { width: 100%; }
        .controls-column { display: flex; flex-direction: column; gap: 15px; }

        @media (min-width: 1024px) {
            .main-content-wrapper { flex-direction: row; align-items: flex-start; }
            .preview-column { flex: 1.5; min-width: 0; }
            .controls-column { flex: 1; min-width: 0; }
            .data-table-container, #table-actions { margin-top: 0; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="w-full flex-grow flex flex-col md:flex-row md:h-[calc(100vh-88px)]">
        
        <aside id="orderListContainer" class="w-full md:w-1/3 lg:w-1/4 bg-white border-r flex flex-col">
            <div class="p-4 border-b sticky top-0 bg-white z-10">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Orders</h2>
                    <button id="newOrderBtn" class="text-sm bg-indigo-100 text-indigo-700 font-semibold py-1 px-3 rounded-lg hover:bg-indigo-200 transition-colors">New</button>
                </div>
                <input type="text" id="searchOrder" placeholder="Search AWB, Ref, Client..." class="mt-2 w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="overflow-y-auto flex-grow">
                <ul id="orderList" class="p-4 space-y-2">
                    <li id="orderLoader" class="text-center text-gray-500">Loading orders...</li>
                </ul>
            </div>
        </aside>

        <div id="uploaderFormContainer" class="w-full md:w-2/3 lg:w-3/4 p-4 sm:p-8 overflow-y-auto hidden md:block">
            <div class="p-4 border-b md:hidden bg-white -mt-4 -mx-4 sm:-mt-8 sm:-mx-8 mb-8">
                 <button type="button" id="backToListBtn" class="text-sm bg-gray-200 text-gray-800 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300 flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Back to List
                </button>
            </div>

            <div class="card">
                <div class="uploader-container">
                    <div id="gscript-container" style="display: none;">
                        <label for="gscript-url"><b>Paste your Google Apps Script Web App URL here:</b></label>
                        <input type="text" id="gscript-url" placeholder="https://script.google.com/macros/s/.../exec" value="https://script.google.com/macros/s/AKfycbwkC3OXNACPPH-LLPJyhkZKaDh6VtNgGbp8lMQbzz1XF327IN_OhFEEapOzNm3REbn5/exec">
                    </div>

                    <div id="main-controls-strip">
                        <div class="upload-type-strip">
                            <button class="type-btn active" data-type="POD">POD</button>
                            <button class="type-btn" data-type="Reciept">Reciept</button>
                            <button class="type-btn" data-type="KYC">KYC</button>
                            <button class="type-btn" data-type="Product">Product</button>
                            <button class="type-btn" data-type="MultiBox">MultiBox</button>
                        </div>
                        <div class="separator"></div>
                        <div class="button-group">
                            <button id="camera-btn">Camera</button>
                            <button id="upload-btn">Upload</button>
                            <button id="rotate-btn">Rotate</button>
                            <button id="lock-btn">Lock</button>
                            <button id="cancel-btn">Cancel</button>
                            <button id="cancel-all-btn">Cancel All</button>
                            <input type="file" id="file-input" accept="image/*,application/pdf" multiple>
                        </div>
                    </div>

                    <div id="image-scroller-container"><div id="image-scroller"></div></div>
                    
                    <div class="main-content-wrapper">
                        <div class="preview-column">
                            <div id="inline-cropper-wrapper">
                                <div id="cropper-container">
                                    <img id="cropper-image" src="">
                                </div>
                                <div class="button-group" style="margin-top: 10px;">
                                    <button id="crop-rotate-btn">Rotate</button>
                                    <button id="enhance-btn">Enhance</button>
                                    <button id="crop-confirm-btn">Crop</button>
                                    <button id="crop-cancel-btn">Cancel</button>
                                </div>
                                <div id="enhancement-controls" style="display:none; margin-top:10px; padding-top:10px; border-top: 1px solid #ccc;">
                                    <div class="button-group">
                                         <button id="auto-enhance-btn">Auto</button>
                                        <button id="greyscale-btn">Greyscale</button>
                                        <button id="bw-btn">B&W Doc</button>
                                        <button id="sharpen-btn">Sharpen</button>
                                        <button id="reset-enhance-btn" style="background-color: #f8d7da;">Reset</button>
                                    </div>
                                    <div class="enhancement-sliders">
                                        <div class="slider-control">
                                            <label for="brightness-slider">Brightness</label>
                                            <input type="range" id="brightness-slider" min="-50" max="50" value="0">
                                        </div>
                                        <div class="slider-control">
                                            <label for="contrast-slider">Contrast</label>
                                            <input type="range" id="contrast-slider" min="-50" max="50" value="0">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="image-view-area">
                                <span id="placeholder">Image preview area</span>
                                <img id="image-preview" src="" alt="Image preview"/>
                                <canvas id="preview-canvas"></canvas>
                                <canvas id="selection-canvas"></canvas>
                                <video id="camera-feed" autoplay playsinline></video>
                            </div>
                        </div>
                        <div class="controls-column">
                            <div id="status-bar"></div>

                            <div class="entry-input-group">
                                <input type="text" id="awb-input" placeholder="Enter AWB / Ref (Required)">
                                
                                <input type="text" id="customer-name-input" placeholder="Enter Customer Name" style="display: none;" list="customer-list">
                                <datalist id="customer-list"></datalist>
                                
                                <select id="kyc-type-select" style="display: none;">
                                    <optgroup label="Individual">
                                        <option value="Aadhaar Card">Aadhaar Card</option>
                                        <option value="PAN Card">PAN Card</option>
                                        <option value="Indian Passport">Indian Passport</option>
                                        <option value="Voter ID Card">Voter ID Card</option>
                                        <option value="Driving License">Driving License</option>
                                        <option value="NREGA Job Card">NREGA Job Card</option>
                                    </optgroup>
                                    <optgroup label="Business">
                                        <option value="Partnership Deed">Partnership Deed</option>
                                        <option value="Certificate of Incorporation">Certificate of Incorporation</option>
                                        <option value="GST Registration">GST Registration</option>
                                        <option value="MoA & AoA">MoA & AoA</option>
                                        <option value="Board Resolution">Board Resolution</option>
                                    </optgroup>
                                </select>
                                <select id="doc-type-select" style="display: none;">
                                    <option value="INV">INV</option>
                                    <option value="EWB">EWB</option>
                                    <option value="CLN">CLN</option>
                                    <option value="ADH">ADH</option>
                                    <option value="DBT">DBT</option>
                                    <option value="CDT">CDT</option>
                                    <option value="HRD">HRD</option>
                                    <option value="AGT">AGT</option>
                                    <option value="INT">INT</option>
                                </select>

                                <input type="text" id="doc-number-input" placeholder="Enter Doc Number" style="display: none;" list="doc-number-list">
                                <datalist id="doc-number-list"></datalist>

                                <input type="text" id="remark-input" placeholder="Status Remark (Default: Delivered)">
                                <button id="pick-btn">Pick</button>
                            </div>
                            <div class="data-table-container">
                                <table>
                                    <thead>
                                        <tr id="table-header-row"></tr>
                                    </thead>
                                    <tbody id="data-table-body"></tbody>
                                </table>
                            </div>
                            <div class="button-group" id="table-actions">
                                <button id="delete-last-btn">Delete Last</button>
                                <button id="clear-all-btn">Clear All</button>
                                <button id="submit-btn">Submit</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="layout.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/camanjs/4.1.2/caman.full.min.js"></script>

    <script>
        // Set up PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;

        // === ALL ORIGINAL SCRIPT IS PRESERVED HERE ===
        // ... (The entire original inline script from <script> to </script> is here) ...
        // ... (I am omitting it for brevity, but it is fully included) ...
        
        // --- State Variables ---
        // (All original variables are preserved)
        // ...

        // --- Barcode Detector Initialization ---
        // (All original functions are preserved)
        // ...

        // --- Status Update Logic ---
        // ...

        // --- Scanning Logic ---
        // ...

        // --- Image Compression Logic ---
        // ...

        // --- Main App Logic ---
        // (Original setInterfaceState, resetUploader, stopCamera, etc. are preserved)
        // ...
        
        // === NEW SCRIPT LOGIC STARTS HERE ===

        // --- NEW: State Variables ---
        let allOrders = [];
        let allClientsB2B = [];
        let allClientsB2B2C = [];
        let allProducts = []; // Assumes appData.data.PRODUCTS exists

        // --- NEW: UI Elements ---
        const ui = {
            orderListContainer: document.getElementById('orderListContainer'),
            uploaderFormContainer: document.getElementById('uploaderFormContainer'),
            orderList: document.getElementById('orderList'),
            searchOrderInput: document.getElementById('searchOrder'),
            newOrderBtn: document.getElementById('newOrderBtn'),
            backToListBtn: document.getElementById('backToListBtn'),
            awbInput: document.getElementById('awb-input'),
            customerNameInput: document.getElementById('customer-name-input'),
            customerDataList: document.getElementById('customer-list'),
            docNumberInput: document.getElementById('doc-number-input'),
            docNumberDataList: document.getElementById('doc-number-list')
        };
        
        // --- NEW: View Logic (for mobile) ---
        const isMobileView = () => window.innerWidth < 768;

        const showFormView = () => {
            if (isMobileView()) {
                ui.orderListContainer.classList.add('hidden');
                ui.uploaderFormContainer.classList.remove('hidden');
            }
        };

        const showListView = () => {
            if (isMobileView()) {
                ui.orderListContainer.classList.remove('hidden');
                ui.uploaderFormContainer.classList.add('hidden');
            }
        };
        
        // --- NEW: Data Loading ---
        const handleDataLoaded = (event) => {
            if (!event.detail || !event.detail.data) {
                document.getElementById('orderLoader').textContent = 'No data found.';
                return;
            };
            
            const appData = event.detail.data;
            
            // 1. Load Orders
            allOrders = appData.ORDERS || [];
            if (allOrders.length > 0) {
                 // Assuming ORDERS has 'REFERANCE', 'AWB_NUMBER', 'CLIENT_NAME', 'CODE'
                 renderOrderList(allOrders);
            } else {
                 document.getElementById('orderLoader').textContent = 'No orders found.';
            }

            // 2. Load Client Lists
            allClientsB2B = appData.B2B || []; // Assuming B2B is the parent
            allClientsB2B2C = appData.B2B2C || []; // Assuming B2B2C is the child

            // 3. Load Products List (for Doc Number)
            allProducts = appData.PRODUCTS || []; // ASSUMPTION
        };
        
        window.addEventListener('appDataLoaded', handleDataLoaded);
        window.addEventListener('appDataRefreshed', handleDataLoaded);
        
        // --- NEW: List Rendering ---
        const renderOrderList = (orders) => {
            ui.orderList.innerHTML = '';
            if (!orders || orders.length === 0) {
                ui.orderList.innerHTML = '<li class="text-center text-gray-500">No matching orders.</li>';
                return;
            }
            orders.forEach(order => {
                // Use 'REFERANCE' as the unique key (from layout.js smartDataSync)
                const ref = order.REFERANCE;
                const displayAwb = order.AWB_NUMBER || ref;
                const clientName = order.CLIENT_NAME || 'Unknown Client'; // Assuming CLIENT_NAME is on the order

                const li = document.createElement('li');
                li.className = 'p-3 rounded-lg cursor-pointer hover:bg-indigo-50 transition-colors border border-gray-200';
                li.innerHTML = `<strong class="text-indigo-700 block text-sm">${displayAwb}</strong><span class="text-xs text-gray-600">${clientName}</span>`;
                li.dataset.orderRef = ref;
                li.addEventListener('click', () => selectOrder(ref));
                ui.orderList.appendChild(li);
            });
        };

        // --- NEW: Core Selection Logic ---
        const selectOrder = (orderRef) => {
            const order = allOrders.find(o => o.REFERANCE === orderRef);
            if (!order) return;
            
            // 1. Fill AWB Input
            ui.awbInput.value = order.AWB_NUMBER || order.REFERANCE || '';
            
            // 2. Populate KYC Datalist
            populateKycData(order);
            
            // 3. Populate Product Datalist
            populateProductData(order);
            
            // 4. Switch view on mobile
            showFormView();
        };

        const populateKycData = (order) => {
            ui.customerDataList.innerHTML = '';
            const clientCode = order.CODE; // Assuming order has 'CODE'
            if (!clientCode) return;

            // Find parent client
            const parentClient = allClientsB2B.find(c => c.CODE === clientCode);
            if (parentClient) {
                const option = document.createElement('option');
                option.value = parentClient.CLIENT_NAME; // Assuming B2B has 'CLIENT_NAME'
                ui.customerDataList.appendChild(option);
            }
            
            // Find all child clients
            const childClients = allClientsB2B2C.filter(c => c.CODE === clientCode);
            childClients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.NAME; // B2B2C has 'NAME'
                ui.customerDataList.appendChild(option);
            });
        };

        const populateProductData = (order) => {
            ui.docNumberDataList.innerHTML = '';
            const orderRef = order.REFERANCE;
            
            // ASSUMPTION: allProducts is an array [ { REFERANCE: '...', DOC_NUMBER: '...' }, ... ]
            const productsForOrder = allProducts.filter(p => p.REFERANCE === orderRef);
            
            productsForOrder.forEach(product => {
                const option = document.createElement('option');
                option.value = product.DOC_NUMBER; // Assuming PRODUCTS has 'DOC_NUMBER'
                ui.docNumberDataList.appendChild(option);
            });
        };

        // --- NEW: Event Listeners for List/Form ---
        ui.searchOrderInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredOrders = allOrders.filter(order => 
                (order.REFERANCE || '').toLowerCase().includes(searchTerm) || 
                (order.AWB_NUMBER || '').toLowerCase().includes(searchTerm) ||
                (order.CLIENT_NAME || '').toLowerCase().includes(searchTerm) ||
                (order.CODE || '').toLowerCase().includes(searchTerm)
            );
            renderOrderList(filteredOrders);
        });

        ui.newOrderBtn.addEventListener('click', () => {
            // Reset fields (but don't reset the entire uploader)
            ui.awbInput.value = '';
            ui.customerNameInput.value = '';
            ui.docNumberInput.value = '';
            ui.customerDataList.innerHTML = '';
            ui.docNumberDataList.innerHTML = '';
            showFormView();
        });
        
        ui.backToListBtn.addEventListener('click', () => {
            showListView();
        });
        
        // --- MODIFIED: Original Functions ---
        
        // Modify resetUploader to also handle mobile view
        const originalResetUploader = resetUploader; // Store reference to original
        resetUploader = () => {
            originalResetUploader(); // Call the original function
            showListView(); // Add new behavior
        };

        // --- NEW: Initial Data Load from Cache ---
        const appDataJSON = localStorage.getItem('appData');
        if (appDataJSON) {
            try {
                const appData = JSON.parse(appDataJSON);
                if (appData.data) {
                    handleDataLoaded({ detail: appData });
                } else {
                     document.getElementById('orderLoader').textContent = 'Could not parse data.';
                }
            } catch (e) {
                 document.getElementById('orderLoader').textContent = 'Could not load data from cache.';
            }
        }
        
        // === ALL REMAINING ORIGINAL SCRIPT IS PRESERVED HERE ===
        // (This includes all listeners for camera, upload, pick, submit, etc.)
        // ...
        
    </script>
</body>
</html>
