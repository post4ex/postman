<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit/Delete Uploads - Postman</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Use existing style.css -->
    <link rel="stylesheet" href="style.css">
    <style>
        /* Reusing styles similar to Suppliers/Customer page */
        body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top: 4px solid #4338ca; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .readonly-input { background-color: #f3f4f6; cursor: not-allowed; opacity: 0.7; }
        .form-input {
            border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem;
            font-size: 0.875rem; width: 100%; transition: border-color 0.2s;
        }
        .form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 1px #4f46e5; }
        .form-label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: #374151; }
        .tab-button {
            padding: 0.5rem 1rem; border: none; background: none; cursor: pointer;
            font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-button.active { color: #4f46e5; border-bottom-color: #4f46e5; }

        /* Styles for the order list (similar to uploader) */
        #miniOrderListContainer {
            width: 100%; max-height: 300px; /* Increased height */
             overflow-y: auto; border: 1px solid #e5e7eb;
            border-radius: 0.375rem; background-color: #f9fafb; padding: 0.5rem; margin-bottom: 0.5rem;
        }
        #miniOrderList li {
            padding: 0.25rem 0.5rem; font-size: 0.875rem; cursor: pointer; border-radius: 0.25rem; margin-bottom: 0.25rem;
            white-space: normal; line-height: 1.4; border-bottom: 1px solid #eee;
        }
         #miniOrderList li:last-child { border-bottom: none; }
         #miniOrderList li.selected { background-color: #e0e7ff; font-weight: 500;}
        #miniOrderList li:hover { background-color: #eef2ff; }
        #miniOrderList li strong { color: #4338ca; display: block; margin-bottom: 2px; }
        #miniOrderList .client-info { font-size: 0.8rem; color: #6b7280; }
        #miniOrderList .details-info { font-size: 0.75rem; color: #4b5563; margin-top: 2px; }
        #miniOrderList .dest-info { font-size: 0.8rem; color: #374151; margin-top: 2px;}
        #loadMoreBtn {
            display: block; width: 100%; text-align: center; padding: 6px; font-size: 0.8rem;
            color: #4f46e5; background-color: #eef2ff; border: 1px solid #c7d2fe;
            border-radius: 0.375rem; margin-top: 0.5rem; margin-bottom: 1rem; cursor: pointer;
        }
         #loadMoreBtn:hover { background-color: #e0e7ff; }
         #loadMoreBtn:disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; }

        /* Styles for uploads table */
        #uploadsTableContainer { max-height: 300px; overflow-y: auto; }
        #uploadsTable th, #uploadsTable td { padding: 0.5rem; font-size: 0.8rem; }
        #uploadsTable tbody tr { cursor: pointer; transition: background-color 0.1s; }
        #uploadsTable tbody tr:hover { background-color: #f3f4f6; }
        #uploadsTable tbody tr.selected { background-color: #bfdbfe; font-weight: 500; }
        #uploadsTable img { max-height: 40px; max-width: 60px; object-fit: contain; }

         /* Make form grid responsive */
        #editForm { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1rem; }
        @media (min-width: 768px) {
            #editForm { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
         @media (min-width: 1024px) {
            #editForm { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="w-full flex-grow p-4 md:p-6 lg:p-8">
        <div class="container mx-auto">
            <h1 class="text-2xl font-semibold mb-4 text-gray-800">Edit/Delete Uploads</h1>

            <!-- Response Message Area -->
            <div id="response-message" class="hidden mb-4"></div>

            <!-- Two-column layout -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Left Column: Order List -->
                <div class="lg:col-span-1 bg-white p-4 rounded-lg shadow">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700">Select Order</h2>
                    <div id="miniOrderListContainer">
                        <input type="text" id="searchMiniOrder" placeholder="Filter orders by AWB, Ref, Client, Dest..." class="w-full p-2 mb-2 border border-gray-300 rounded-md text-sm form-input">
                        <ul id="miniOrderList">
                            <li class="text-center text-gray-500 text-sm">Loading orders...</li>
                        </ul>
                    </div>
                    <button id="loadMoreBtn" style="display: none;">Load More (Older)</button>
                </div>

                <!-- Right Column: Uploads Table & Edit Form -->
                <div class="lg:col-span-2 space-y-6">

                    <!-- Uploads Table -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h2 class="text-lg font-semibold mb-3 text-gray-700">Associated Uploads</h2>
                        <div id="uploadsTableContainer" class="border rounded-md overflow-hidden">
                            <table id="uploadsTable" class="w-full text-left">
                                <thead class="bg-gray-50 border-b">
                                    <tr>
                                        <!-- Headers will be dynamically set based on selected order/data -->
                                        <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">Identifier</th>
                                        <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                        <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                        <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">File</th>
                                    </tr>
                                </thead>
                                <tbody id="uploadsTableBody" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="6" class="text-center text-gray-500 p-4">Select an order to view uploads.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Edit Form -->
                    <div id="editFormContainer" class="bg-white p-4 rounded-lg shadow hidden">
                        <h2 class="text-lg font-semibold mb-3 text-gray-700">Edit Upload Details</h2>
                        <form id="editForm" class="space-y-4">
                            <!-- Hidden input to store the primary identifier for update/delete -->
                            <input type="hidden" id="edit-identifier">
                            <input type="hidden" id="edit-upload-type">
                             <input type="hidden" id="edit-file-url-hidden"> <!-- Store original URL -->

                            <!-- Read-only fields -->
                            <div>
                                <label for="edit-reference" class="form-label">Reference</label>
                                <input type="text" id="edit-reference" class="form-input readonly-input" readonly>
                            </div>
                            <div>
                                <label for="edit-file-url" class="form-label">File URL</label>
                                <input type="text" id="edit-file-url" class="form-input readonly-input" readonly>
                                <a id="view-file-link" href="#" target="_blank" class="text-sm text-blue-600 hover:underline mt-1 inline-block">View File</a>
                            </div>

                            <!-- Standard Fields (visibility controlled by JS) -->
                            <div id="field-awb-number">
                                <label for="edit-awb-number" class="form-label">AWB Number</label>
                                <input type="text" id="edit-awb-number" class="form-input">
                            </div>
                             <div id="field-child-awb">
                                <label for="edit-child-awb" class="form-label">Child AWB</label>
                                <input type="text" id="edit-child-awb" class="form-input">
                            </div>
                            <div id="field-customer-uid">
                                <label for="edit-customer-uid" class="form-label">Customer UID</label>
                                <input type="text" id="edit-customer-uid" class="form-input">
                            </div>
                            <div id="field-status-remark">
                                <label for="edit-status-remark" class="form-label">Status Remark</label>
                                <input type="text" id="edit-status-remark" class="form-input">
                            </div>

                            <!-- KYC Fields -->
                            <div id="field-kyc-number">
                                <label for="edit-kyc-number" class="form-label">KYC Number</label>
                                <input type="text" id="edit-kyc-number" class="form-input">
                            </div>
                            <div id="field-kyc-type">
                                <label for="edit-kyc-type" class="form-label">KYC Type</label>
                                <select id="edit-kyc-type" class="form-input">
                                    <optgroup label="Individual">
                                        <option value="Aadhaar Card">Aadhaar Card</option>
                                        <option value="PAN Card">PAN Card</option>
                                        <option value="Indian Passport">Indian Passport</option>
                                        <option value="Voter ID Card">Voter ID Card</option>
                                        <option value="Driving License">Driving License</option>
                                        <option value="NREGA Job Card">NREGA Job Card</option>
                                    </optgroup>
                                    <optgroup label="Business">
                                        <option value="Partnership Deed">Partnership Deed</option>
                                        <option value="Certificate of Incorporation">Certificate of Incorporation</option>
                                        <option value="GST Registration">GST Registration</option>
                                        <option value="MoA & AoA">MoA & AoA</option>
                                        <option value="Board Resolution">Board Resolution</option>
                                    </optgroup>
                                </select>
                            </div>

                            <!-- Product Fields -->
                             <div id="field-doc-number">
                                <label for="edit-doc-number" class="form-label">Doc Number</label>
                                <input type="text" id="edit-doc-number" class="form-input">
                            </div>
                            <div id="field-doc-type">
                                <label for="edit-doc-type" class="form-label">Doc Type</label>
                                <select id="edit-doc-type" class="form-input">
                                    <option value="INV">INV</option>
                                    <option value="EWB">EWB</option>
                                    <option value="CLN">CLN</option>
                                    <option value="ADH">ADH</option>
                                    <option value="DBT">DBT</option>
                                    <option value="CDT">CDT</option>
                                    <option value="HRD">HRD</option>
                                    <option value="AGT">AGT</option>
                                    <option value="INT">INT</option>
                                </select>
                            </div>
                        </form>
                        <!-- Action Buttons -->
                        <div class="mt-6 flex items-center justify-end gap-4">
                            <button id="delete-button" type="button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-150 ease-in-out text-sm font-medium flex items-center">
                                Delete
                                <span id="delete-spinner" class="spinner ml-2 hidden" style="width: 16px; height: 16px;"></span>
                            </button>
                            <button id="update-button" type="button" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-150 ease-in-out text-sm font-medium flex items-center">
                                Update
                                <span id="update-spinner" class="spinner ml-2 hidden" style="width: 16px; height: 16px;"></span>
                            </button>
                            <button id="cancel-edit-button" type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out text-sm font-medium">
                                Cancel
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="layout.js"></script>
    <script>
        // --- Global Variables & State ---
        let allOrders = [];
        let allUploads = [];
        let allClientsB2B = [];
        let allClientsB2B2C = [];
        let currentOrderRef = null;
        let selectedUploadData = null; // Holds data of the row selected in uploadsTable
        let displayDays = 90; // For order list filtering
        const GSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwkC3OXNACPPH-LLPJyhkZKaDh6VtNgGbp8lMQbzz1XF327IN_OhFEEapOzNm3REbn5/exec'; // Use the same URL as uploader

        // --- UI Elements ---
        let ui = {}; // Object to hold UI element references

        // --- Data Handling ---
        const initializeData = (event) => {
            if (!event || !event.detail || !event.detail.data) {
                showResponseMessage('Error: Could not load initial application data.', 'error');
                console.error("Invalid data event received:", event);
                return;
            };

            const data = event.detail.data;
            console.log("App data received:", data);

            // Store data globally
            allOrders = Array.isArray(data.ORDERS) ? data.ORDERS : [];
            allUploads = Array.isArray(data.UPLOADS) ? data.UPLOADS : [];
            allClientsB2B = Array.isArray(data.B2B) ? data.B2B : [];
            allClientsB2B2C = Array.isArray(data.B2B2C) ? data.B2B2C : [];

            // Sort orders
            allOrders = allOrders
                .filter(order => order && order.ORDER_DATE)
                .sort((a, b) => new Date(b.ORDER_DATE) - new Date(a.ORDER_DATE));

            // Initial render
            filterAndRenderOrders();
            resetEditForm(); // Ensure form is hidden initially
            showResponseMessage('Data loaded. Select an order from the list.', 'info');
        };

        // --- Order List Functions (Adapted from uploader.html) ---
        function formatDate(dateString) {
            // ... (keep the same formatDate function) ...
             if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) { return 'Invalid Date'; }
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) { return 'Invalid Date'; }
        }

        const renderMiniOrderList = (ordersToRender) => {
            ui.orderList.innerHTML = '';
            if (!ordersToRender || ordersToRender.length === 0) {
                ui.orderList.innerHTML = '<li class="text-center text-gray-500 text-sm">No matching orders found.</li>';
                ui.loadMoreBtn.style.display = 'none';
                return;
            }

            ordersToRender.forEach((order) => {
                const ref = order.REFERANCE; if (!ref) return;
                const displayAwb = order.AWB_NUMBER || ref;
                const consignor = allClientsB2B2C.find(c => c.UID === order.CONSIGNOR)?.NAME || 'Unknown';
                const consignee = allClientsB2B2C.find(c => c.UID === order.CONSIGNEE)?.NAME || 'Unknown';
                const dest = order.DEST_CITY || 'N/A';
                const date = formatDate(order.ORDER_DATE);
                const value = order.VALUE || 0;
                const pcs = order.PIECS || 0;

                const li = document.createElement('li');
                li.innerHTML = `<strong>${displayAwb}</strong>
                                <div class="client-info">${consignor} -> ${consignee}</div>
                                <div class="details-info">Date: ${date} | Val: ${value} | Pcs: ${pcs}</div>
                                <div class="dest-info">Dest: ${dest}</div>`;
                li.dataset.orderRef = ref;
                li.addEventListener('click', () => handleOrderSelection(ref, li));
                // Highlight if it's the currently selected order
                if(ref === currentOrderRef) {
                    li.classList.add('selected');
                }
                ui.orderList.appendChild(li);
            });

            // Load More button logic
            const searchTerm = ui.searchMiniOrderInput.value.toLowerCase();
            const totalFilteredCount = filterOrdersBySearchTerm(searchTerm).length;
            ui.loadMoreBtn.style.display = ordersToRender.length < totalFilteredCount ? 'block' : 'none';
            if(ui.loadMoreBtn.style.display === 'block'){
                ui.loadMoreBtn.disabled = false;
                ui.loadMoreBtn.textContent = `Load More (${ordersToRender.length}/${totalFilteredCount})`;
            }
        };

        function filterOrdersBySearchTerm(searchTerm) {
            // ... (keep the same filtering logic) ...
            if (!Array.isArray(allOrders)) return [];
             if (!searchTerm) return allOrders;
             return allOrders.filter(order => {
                const consignorName = allClientsB2B2C.find(c => c.UID === order.CONSIGNOR)?.NAME || '';
                const consigneeName = allClientsB2B2C.find(c => c.UID === order.CONSIGNEE)?.NAME || '';
                const dest = order.DEST_CITY || '';
                const date = formatDate(order.ORDER_DATE).toLowerCase();
                 return (order.REFERANCE ? String(order.REFERANCE).toLowerCase().includes(searchTerm) : false) ||
                        (order.AWB_NUMBER ? String(order.AWB_NUMBER).toLowerCase().includes(searchTerm) : false) ||
                        (consignorName ? consignorName.toLowerCase().includes(searchTerm) : false) ||
                        (consigneeName ? consigneeName.toLowerCase().includes(searchTerm) : false) ||
                        (dest ? dest.toLowerCase().includes(searchTerm) : false) ||
                        (date ? date.includes(searchTerm) : false);
             });
        }

        function filterOrdersByDate(orders) {
            // ... (keep the same date filtering logic) ...
            const cutoffDate = new Date();
             cutoffDate.setDate(cutoffDate.getDate() - displayDays);
             cutoffDate.setHours(0, 0, 0, 0);
             if (!Array.isArray(orders)) return [];
             return orders.filter(order => {
                 const orderDate = order.ORDER_DATE ? new Date(order.ORDER_DATE) : null;
                 return orderDate && orderDate >= cutoffDate;
             });
        }

        function filterAndRenderOrders() {
            // ... (keep the same combined filtering logic) ...
            const searchTerm = ui.searchMiniOrderInput.value.toLowerCase();
            let searchFiltered = filterOrdersBySearchTerm(searchTerm);
            let dateFiltered = filterOrdersByDate(searchFiltered);
            renderMiniOrderList(dateFiltered);
        }

        const handleOrderSelection = (orderRef, selectedLi) => {
            currentOrderRef = orderRef;
            selectedUploadData = null; // Clear selected upload when order changes

            // Update highlighting in order list
            ui.orderList.querySelectorAll('li.selected').forEach(li => li.classList.remove('selected'));
            if(selectedLi) selectedLi.classList.add('selected');

            // Filter and render uploads table
            const associatedUploads = allUploads.filter(upload => String(upload.REFERANCE) === String(orderRef));
            renderUploadsTable(associatedUploads);
            resetEditForm(); // Hide/clear the edit form
             showResponseMessage(`Showing ${associatedUploads.length} uploads for Order Ref: ${orderRef}. Select an upload to edit.`, 'info');
        };

        // --- Uploads Table Functions ---
        const renderUploadsTable = (uploads) => {
            ui.uploadsTableBody.innerHTML = ''; // Clear existing rows
            if (!uploads || uploads.length === 0) {
                ui.uploadsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">No uploads found for this order.</td></tr>';
                return;
            }

            uploads.forEach(upload => {
                const tr = document.createElement('tr');
                tr.dataset.uploadData = JSON.stringify(upload); // Store all data

                // Determine identifier and details based on type
                let identifier = upload.AWB_NUMBER || upload.KYC_NUMBER || upload.REFERANCE;
                let details = '';
                if(upload.UPLOAD_TYPE === 'MultiBox') details = `Child: ${upload.CHILD_AWB || 'N/A'}`;
                else if(upload.UPLOAD_TYPE === 'KYC') details = `${upload.CUSTOMER_UID || 'N/A'} (${upload.KYC_TYPE || 'N/A'})`;
                 else if(upload.UPLOAD_TYPE === 'Product') details = `${upload.DOC_NUMBER || 'N/A'} (${upload.DOC_TYPE || 'N/A'})`;
                else details = upload.STATUS_REMARK || 'N/A';

                tr.innerHTML = `
                    <td class="whitespace-nowrap">${upload.UPLOAD_TYPE || 'N/A'}</td>
                    <td class="whitespace-nowrap">${identifier || 'N/A'}</td>
                    <td>${details}</td>
                    <td class="whitespace-nowrap">${formatDate(upload.DATE_TIME)}</td>
                    <td class="whitespace-nowrap">${upload.USER_NAME || 'N/A'}</td>
                    <td><a href="${upload.FILE_URL}" target="_blank" class="text-blue-600 hover:underline text-xs">View File</a></td>
                `;

                tr.addEventListener('click', () => handleUploadSelection(upload, tr));
                ui.uploadsTableBody.appendChild(tr);
            });
        };

        const handleUploadSelection = (uploadData, selectedTr) => {
            selectedUploadData = uploadData; // Store the selected upload data

            // Update highlighting in uploads table
             ui.uploadsTableBody.querySelectorAll('tr.selected').forEach(row => row.classList.remove('selected'));
             if(selectedTr) selectedTr.classList.add('selected');

            populateEditForm(uploadData);
            ui.editFormContainer.classList.remove('hidden');
             showResponseMessage(`Editing upload for ${uploadData.REFERANCE || uploadData.CUSTOMER_UID}.`, 'info');
        };


        // --- Edit Form Functions ---
        const populateEditForm = (uploadData) => {
            resetEditForm(); // Clear and hide all fields first

            const type = uploadData.UPLOAD_TYPE;
            ui.editIdentifierInput.value = (type === 'KYC' ? uploadData.CUSTOMER_UID : uploadData.REFERANCE) || ''; // Store the key identifier
            ui.editUploadTypeInput.value = type || '';
             ui.editFileUrlHiddenInput.value = uploadData.FILE_URL || ''; // Store original URL


            // Set read-only fields
            ui.editReferenceInput.value = uploadData.REFERANCE || '';
            ui.editFileUrlInput.value = uploadData.FILE_URL || '';
            ui.viewFileLink.href = uploadData.FILE_URL || '#';

            // Show/Hide and populate fields based on type
            if (type === 'POD' || type === 'Reciept') {
                ui.fieldAwbNumber.style.display = 'block';
                ui.editAwbNumberInput.value = uploadData.AWB_NUMBER || '';
                ui.fieldStatusRemark.style.display = 'block';
                ui.editStatusRemarkInput.value = uploadData.STATUS_REMARK || '';
            } else if (type === 'MultiBox') {
                ui.fieldAwbNumber.style.display = 'block';
                ui.editAwbNumberInput.value = uploadData.AWB_NUMBER || '';
                ui.fieldChildAwb.style.display = 'block';
                ui.editChildAwbInput.value = uploadData.CHILD_AWB || '';
            } else if (type === 'KYC') {
                ui.fieldKycNumber.style.display = 'block';
                ui.editKycNumberInput.value = uploadData.KYC_NUMBER || '';
                 // NOTE: We don't populate Customer UID input as it's the identifier
                ui.fieldCustomerUid.style.display = 'block';
                 ui.editCustomerUidInput.value = uploadData.CUSTOMER_UID || '';
                 ui.editCustomerUidInput.classList.add('readonly-input'); // Make UID read-only for safety
                 ui.editCustomerUidInput.readOnly = true;

                ui.fieldKycType.style.display = 'block';
                ui.editKycTypeSelect.value = uploadData.KYC_TYPE || 'Aadhaar Card';
            } else if (type === 'Product') {
                ui.fieldAwbNumber.style.display = 'block';
                ui.editAwbNumberInput.value = uploadData.AWB_NUMBER || '';
                ui.fieldDocNumber.style.display = 'block';
                ui.editDocNumberInput.value = uploadData.DOC_NUMBER || '';
                ui.fieldDocType.style.display = 'block';
                ui.editDocTypeSelect.value = uploadData.DOC_TYPE || 'INV';
            }

            ui.editFormContainer.classList.remove('hidden');
            ui.updateButton.disabled = false;
            ui.deleteButton.disabled = false;
        };

        const resetEditForm = () => {
             ui.editForm.reset(); // Clear all form fields
             selectedUploadData = null; // Clear selection state
             // Hide all optional fields
            Object.keys(ui).forEach(key => {
                if (key.startsWith('field')) {
                    ui[key].style.display = 'none';
                }
            });
             // Ensure UID field is editable again if reset
             ui.editCustomerUidInput.classList.remove('readonly-input');
             ui.editCustomerUidInput.readOnly = false;
             // Hide the form container and disable buttons
            ui.editFormContainer.classList.add('hidden');
            ui.updateButton.disabled = true;
            ui.deleteButton.disabled = true;
             ui.uploadsTableBody.querySelectorAll('tr.selected').forEach(row => row.classList.remove('selected')); // Remove table highlight
        };

        // --- Action Handlers (Update/Delete) ---
        const handleUpdate = async () => {
             if (!selectedUploadData) {
                 showResponseMessage('No upload selected to update.', 'error');
                 return;
             }
            const identifier = ui.editIdentifierInput.value;
            const uploadType = ui.editUploadTypeInput.value;
            if(!identifier){
                 showResponseMessage('Error: Missing identifier for update.', 'error');
                 return;
            }

            // Collect updated data based on type
            const newData = {
                 // Include fields relevant to this upload type
                 UPLOAD_TYPE: uploadType, // Keep type consistent
                 REFERANCE: ui.editReferenceInput.value, // Keep original Reference
                 FILE_URL: ui.editFileUrlHiddenInput.value, // Keep original URL
                 // Add editable fields based on type:
                 ...( (uploadType === 'POD' || uploadType === 'Reciept') && {
                     AWB_NUMBER: ui.editAwbNumberInput.value.trim(),
                     STATUS_REMARK: ui.editStatusRemarkInput.value.trim()
                 }),
                 ...( uploadType === 'MultiBox' && {
                     AWB_NUMBER: ui.editAwbNumberInput.value.trim(),
                     CHILD_AWB: ui.editChildAwbInput.value.trim()
                 }),
                 ...( uploadType === 'KYC' && {
                     // CUSTOMER_UID: ui.editCustomerUidInput.value.trim(), // UID is the identifier, typically not edited here
                     KYC_NUMBER: ui.editKycNumberInput.value.trim(),
                     KYC_TYPE: ui.editKycTypeSelect.value
                 }),
                  ...( uploadType === 'Product' && {
                     AWB_NUMBER: ui.editAwbNumberInput.value.trim(),
                     DOC_NUMBER: ui.editDocNumberInput.value.trim(),
                     DOC_TYPE: ui.editDocTypeSelect.value
                 }),
            };

            const payload = {
                action: 'edit',
                identifier: identifier, // This is REFERANCE or CUSTOMER_UID
                newData: newData
            };

            await sendRequestToGAS(payload, ui.updateButton, ui.updateSpinner, 'Update');
        };

        const handleDelete = async () => {
             if (!selectedUploadData) {
                 showResponseMessage('No upload selected to delete.', 'error');
                 return;
             }
             const identifier = ui.editIdentifierInput.value;
             const uploadType = ui.editUploadTypeInput.value;
             if(!identifier){
                 showResponseMessage('Error: Missing identifier for delete.', 'error');
                 return;
             }

             // Confirmation dialog
             if (!confirm(`Are you sure you want to delete the upload associated with ${identifier}? This action cannot be undone.`)) {
                 return;
             }

            const payload = {
                action: 'delete',
                identifier: identifier,
                uploadType: uploadType // Send type to help GAS identify (esp. if using UID)
            };

             await sendRequestToGAS(payload, ui.deleteButton, ui.deleteSpinner, 'Delete');
        };

        // --- GAS Communication ---
        async function sendRequestToGAS(payload, button, spinner, buttonText) {
             const originalButtonText = button.textContent.trim();
             let authCode = '';
             let authToken = '';

             // Get Auth Credentials
             const loginDataJSON = localStorage.getItem('loginData');
             if (!loginDataJSON) {
                 showResponseMessage("Authentication error: loginData not found. Please re-login.", 'error');
                 return;
             }
             try {
                 const loginData = JSON.parse(loginDataJSON);
                 const codeKey = Object.keys(loginData).find(k => k.toLowerCase() === 'code');
                 const tokenKey = Object.keys(loginData).find(k => k.toLowerCase() === 'token');
                 if (!codeKey || !tokenKey) throw new Error("Code or Token missing.");
                 authCode = loginData[codeKey];
                 authToken = loginData[tokenKey];
             } catch (e) {
                 showResponseMessage(`Authentication error: ${e.message}. Please re-login.`, 'error');
                 return;
             }

             // Add auth to payload
             payload.code = authCode;
             payload.token = authToken;

             // UI updates for loading state
             if (button) button.disabled = true;
             if (spinner) spinner.classList.remove('hidden');
             if (button) button.childNodes[0].nodeValue = `${buttonText}ing... `; // Update button text


            showResponseMessage(`Sending ${payload.action} request...`, 'info');

            try {
                const response = await fetch(GSCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    mode: 'cors'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showResponseMessage(result.message || `${payload.action} successful! Refreshing data...`, 'success');
                    resetEditForm();
                    // Trigger layout.js to refresh all app data
                    showResponseMessage('Request successful! Refreshing data...', 'success');
                    // Give user time to see success message before refresh potentially hides it
                    setTimeout(() => {
                         window.dispatchEvent(new CustomEvent('forceAppDataRefresh'));
                    }, 1500);

                } else {
                    throw new Error(result.message || `Server returned status: ${result.status}`);
                }
            } catch (error) {
                 console.error(`Error during ${payload.action}:`, error);
                 showResponseMessage(`Error during ${payload.action}: ${error.message}`, 'error');
            } finally {
                // Restore button state
                 if (button) button.disabled = false;
                 if (spinner) spinner.classList.add('hidden');
                 if (button) button.childNodes[0].nodeValue = buttonText;
            }
        }


        // --- UI Helper ---
        function showResponseMessage(message, type) {
            ui.responseMessage.innerHTML = `<p>${message}</p>`;
            ui.responseMessage.className = `my-4 text-center p-3 rounded-lg text-sm ${
                type === 'success' ? 'bg-green-100 text-green-800' :
                type === 'error' ? 'bg-red-100 text-red-800' :
                'bg-blue-100 text-blue-800' // Default to info
            }`;
            ui.responseMessage.classList.remove('hidden');
        }

        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', () => {
            // Assign all UI elements
            ui = {
                responseMessage: document.getElementById('response-message'),
                searchMiniOrderInput: document.getElementById('searchMiniOrder'),
                orderList: document.getElementById('miniOrderList'),
                loadMoreBtn: document.getElementById('loadMoreBtn'),
                uploadsTableBody: document.getElementById('uploadsTableBody'),
                editFormContainer: document.getElementById('editFormContainer'),
                editForm: document.getElementById('editForm'),
                editIdentifierInput: document.getElementById('edit-identifier'),
                editUploadTypeInput: document.getElementById('edit-upload-type'),
                editFileUrlHiddenInput: document.getElementById('edit-file-url-hidden'),
                editReferenceInput: document.getElementById('edit-reference'),
                editFileUrlInput: document.getElementById('edit-file-url'),
                viewFileLink: document.getElementById('view-file-link'),
                // Form field containers (for show/hide)
                fieldAwbNumber: document.getElementById('field-awb-number'),
                fieldChildAwb: document.getElementById('field-child-awb'),
                fieldCustomerUid: document.getElementById('field-customer-uid'),
                fieldStatusRemark: document.getElementById('field-status-remark'),
                fieldKycNumber: document.getElementById('field-kyc-number'),
                fieldKycType: document.getElementById('field-kyc-type'),
                fieldDocNumber: document.getElementById('field-doc-number'),
                fieldDocType: document.getElementById('field-doc-type'),
                // Form input fields
                editAwbNumberInput: document.getElementById('edit-awb-number'),
                editChildAwbInput: document.getElementById('edit-child-awb'),
                editCustomerUidInput: document.getElementById('edit-customer-uid'),
                editStatusRemarkInput: document.getElementById('edit-status-remark'),
                editKycNumberInput: document.getElementById('edit-kyc-number'),
                editKycTypeSelect: document.getElementById('edit-kyc-type'),
                editDocNumberInput: document.getElementById('edit-doc-number'),
                editDocTypeSelect: document.getElementById('edit-doc-type'),
                // Buttons & Spinners
                updateButton: document.getElementById('update-button'),
                deleteButton: document.getElementById('delete-button'),
                cancelEditButton: document.getElementById('cancel-edit-button'),
                updateSpinner: document.getElementById('update-spinner'),
                deleteSpinner: document.getElementById('delete-spinner'),
            };

            // Add event listeners
            window.addEventListener('appDataLoaded', initializeData);
            window.addEventListener('appDataRefreshed', initializeData); // Re-render on refresh
             ui.searchMiniOrderInput.addEventListener('input', filterAndRenderOrders);
             ui.loadMoreBtn.addEventListener('click', () => { displayDays += 30; filterAndRenderOrders(); });
             ui.updateButton.addEventListener('click', handleUpdate);
             ui.deleteButton.addEventListener('click', handleDelete);
             ui.cancelEditButton.addEventListener('click', resetEditForm);

            // Initial setup
            resetEditForm();
            showResponseMessage('Loading data from cache...', 'info');

            // --- Load initial data from cache if available ---
            const appDataJSON = localStorage.getItem('appData');
             if (appDataJSON) {
                 try {
                     const cachedData = JSON.parse(appDataJSON);
                     // Check if data seems valid before initializing
                     if (cachedData && cachedData.data && Array.isArray(cachedData.data.ORDERS)) {
                         console.log('Initializing with cached data:', cachedData.data);
                         initializeData({ detail: { data: cachedData.data } });
                     } else {
                          console.warn("Cached data structure invalid.");
                          showResponseMessage('Cached data invalid. Waiting for network load...', 'error');
                     }
                 } catch (e) {
                      console.error("Error parsing cached appData", e);
                       showResponseMessage('Error reading cache. Waiting for network load...', 'error');
                 }
             } else {
                   console.log("No cached data found. Waiting for appDataLoaded event.");
                    showResponseMessage('No cached data. Waiting for network load...', 'info');
             }
        });
    </script>

</body>
</html>
