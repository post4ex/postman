<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Creation Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 20px;
        }
        .form-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .sub-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .three-column-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .three-one-grid {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }
        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 0; /* Ensure no rounded corners anywhere */
            -moz-appearance: textfield;
        }
        /* Hide number input spinners for Chrome, Safari, Edge, Opera */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        .submit-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 30px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .submit-btn:hover {
            background-color: #0056b3;
        }
        .status-message {
            margin-top: 10px;
            font-style: italic;
            color: #666;
            text-align: center;
        }
        .info-box {
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .info-box h4 {
            margin-top: 0;
            color: #0056b3;
        }
        .info-box ul {
            list-style-type: none;
            padding: 0;
            margin: 10px 0 0;
            font-family: monospace;
            font-size: 14px;
            color: #333;
        }
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px; /* Reduced width for a smaller modal */
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }
        .modal-close:hover {
            color: #555;
        }
        .modal-content h3 {
            margin-top: 0;
            text-align: center;
            color: #333;
        }
        .gstin-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            display: grid; /* Changed to grid */
            grid-template-columns: 1fr 1fr; /* Two columns */
            gap: 10px; /* Added gap between items */
        }
        .gstin-list li {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            text-align: center;
            font-weight: bold;
        }
        .gstin-list li:hover {
            background-color: #e2e2e2;
            transform: translateY(-2px);
        }
        .input-group-percent {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #formStatus {
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        /* Styles for the editable table */
        .editable-table-container {
            margin-top: 30px;
            border: 1px solid #ccc;
            border-radius: 0;
            overflow: auto;
        }
        .editable-table {
            width: 100%;
            border-collapse: collapse; /* Critical for a spreadsheet look */
        }
        .editable-table th,
        .editable-table td {
            padding: 0; /* Remove padding from cells */
            border: 1px solid #eee; /* Apply border to cells instead of inputs */
            text-align: left;
        }
        /* Allow text to wrap in header cells */
        .editable-table th {
            background-color: #f8f8f8;
            font-weight: bold;
            padding: 10px;
            vertical-align: top;
            white-space: normal;
            word-wrap: break-word;
            width: 70px; /* Ensure cells have enough space */
        }
        /* Prevent text wrapping in input fields */
        .editable-table input {
            width: 100%;
            padding: 10px; /* Padding for the input itself */
            box-sizing: border-box;
            border: none; /* Remove all borders from the input */
            background: transparent;
            font: inherit; /* Inherit font from parent */
            white-space: nowrap;
        }
        .editable-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .hidden-column {
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Customer Creation</h2>
    <form id="customerForm">
        <div class="form-grid">
            <!-- Left Section -->
            <div class="form-section">
                <div class="three-one-grid">
                    <div class="form-group">
                        <label for="billingID">Billing ID (GST, PAN, Aadhar)</label>
                        <input type="text" id="billingID" name="billingID">
                        <div id="gstStatus" class="status-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="gstInclusive">GST Inclusive</label>
                        <select id="gstInclusive" name="gstInclusive">
                            <option value="Y">Y</option>
                            <option value="N">N</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="customerName">Customer Name</label>
                    <input type="text" id="customerName" name="customerName" required>
                </div>
                <div class="sub-grid">
                    <div class="form-group">
                        <label for="customerCode">Customer Code</label>
                        <input type="text" id="customerCode" name="customerCode" required>
                    </div>
                    <div class="form-group">
                        <label for="mobileNumber">Mobile Number</label>
                        <input type="tel" id="mobileNumber" name="mobileNumber" pattern="[0-9]{10}" title="Ten digits number" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="billingAddress">Billing Address</label>
                    <textarea id="billingAddress" name="billingAddress" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label for="billingLandmark">Billing Landmark</label>
                    <input type="text" id="billingLandmark" name="billingLandmark">
                </div>
                <div class="three-column-grid">
                    <div class="form-group">
                        <label for="billingPincode">Billing Pincode</label>
                        <input type="number" id="billingPincode" name="billingPincode" required>
                        <div id="pincodeStatus" class="status-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="billingCity">Billing City</label>
                        <input type="text" id="billingCity" name="billingCity" required>
                    </div>
                    <div class="form-group">
                        <label for="billingState">Billing State</label>
                        <input type="text" id="billingState" name="billingState" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="billingEmail">Billing Email</label>
                    <input type="email" id="billingEmail" name="billingEmail" required>
                </div>
                <div class="three-column-grid">
                    <div class="form-group">
                        <label for="carrier">Carrier</label>
                        <select id="carrier" name="carrier">
                            <option value="GEN">GEN</option>
                            <option value="REV">REV</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="billerType">Biller Type</label>
                        <select id="billerType" name="billerType">
                            <option value="REG">REG</option>
                            <option value="URP">URP</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="billingCycle">Billing Cycle</label>
                        <select id="billingCycle" name="billingCycle">
                            <option value="E">E - Every Consignment</option>
                            <option value="D">D - Daily</option>
                            <option value="W">W - Weekly</option>
                            <option value="F">F - Fifteen Days</option>
                            <option value="M">M - Monthly</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Right Section -->
            <div class="form-section">
                <div class="form-group">
                    <label for="weightChange">Weight Change</label>
                    <input type="text" id="weightChange" name="weightChange" value="3">
                </div>
                <div class="form-group">
                    <label for="toPayIf">ToPay If</label>
                    <input type="number" id="toPayIf" name="toPayIf" value="150">
                </div>
                <div class="form-group">
                    <label for="codIf">COD If</label>
                    <div class="input-group-percent">
                        <input type="number" id="codIf" name="codIf" value="1.3">
                        <span>%</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="insuranceIf">Insurance If</label>
                    <div class="input-group-percent">
                        <input type="number" id="insuranceIf" name="insuranceIf" value="2">
                        <span>%</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="ewayIf">Eway If</label>
                    <div class="input-group-percent">
                        <input type="number" id="ewayIf" name="ewayIf" value="0.2">
                        <span>%</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="awbCharge">AWB Charge</label>
                    <input type="number" id="awbCharge" name="awbCharge" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <label for="packingCharges">Packing Charges</label>
                    <input type="number" id="packingCharges" name="packingCharges" step="0.01" value="10">
                </div>
                <div class="form-group">
                    <label for="fuelCharges">Fuel Charges</label>
                    <div class="input-group-percent">
                        <input type="number" id="fuelCharges" name="fuelCharges" step="0.01" value="15">
                        <span>%</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="devlpChg">Development Charges</label>
                    <div class="input-group-percent">
                        <input type="number" id="devlpChg" name="devlpChg" step="0.01" value="5">
                        <span>%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Editable Rate List Table -->
        <div class="editable-table-container">
            <h3>Rate List</h3>
            <table class="editable-table">
                <thead>
                    <!-- The new descriptive row is now first -->
                    <tr>
                        <th class="hidden-column"></th>
                        <th class="hidden-column"></th>
                        <th></th>
                        <th></th>
                        <th class="hidden-column"></th>
                        <th>UP UK WST</th>
                        <th>UP EST DIR</th>
                        <th>PB HR RAJ DIR</th>
                        <th>DEL NCR</th>
                        <th>RO UP UK</th>
                        <th>RO PB HR RAJ</th>
                        <th>BHR &RO IXJ HP</th>
                        <th>M E T R O</th>
                        <th>GJ MH</th>
                        <th>GWT SXR</th>
                        <th>WB OR ROI</th>
                        <th>DMN DUI</th>
                        <th>NOR EST</th>
                        <th>PBR AG IMP</th>
                    </tr>
                    <!-- The zone number row is now second -->
                    <tr>
                        <th class="hidden-column">Code</th>
                        <th class="hidden-column">Carrier</th>
                        <th>Service</th>
                        <th>Weight</th>
                        <th class="hidden-column">UID</th>
                        <th>Z1</th>
                        <th>Z2</th>
                        <th>Z3</th>
                        <th>Z4</th>
                        <th>Z5</th>
                        <th>Z6</th>
                        <th>Z7</th>
                        <th>Z8</th>
                        <th>Z9</th>
                        <th>Z10</th>
                        <th>Z11</th>
                        <th>Z12</th>
                        <th>Z13</th>
                        <th>Z14</th>
                    </tr>
                </thead>
                <tbody id="rateTableBody">
                    <!-- Table rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>

        <button type="submit" class="submit-btn">Create Customer</button>
    </form>
    <div id="formStatus"></div>
</div>

<!-- Modal for GSTIN Selection -->
<div id="gstinModal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" id="closeModal">&times;</span>
        <h3>Multiple GSTINs found. Please select one:</h3>
        <ul id="gstinList" class="gstin-list">
            <!-- GSTINs will be populated here by JavaScript -->
        </ul>
    </div>
</div>

<script>
    const pincodeInput = document.getElementById('billingPincode');
    const cityInput = document.getElementById('billingCity');
    const stateInput = document.getElementById('billingState');
    const pincodeStatusDiv = document.getElementById('pincodeStatus');
    const billingIdInput = document.getElementById('billingID');
    const customerNameInput = document.getElementById('customerName');
    const billingAddressInput = document.getElementById('billingAddress');
    const gstStatusDiv = document.getElementById('gstStatus');
    const customerForm = document.getElementById('customerForm');
    const formStatusDiv = document.getElementById('formStatus');
    const rateTableBody = document.getElementById('rateTableBody');
    const customerCodeInput = document.getElementById('customerCode');
    const billerTypeSelect = document.getElementById('billerType');

    const gstinModal = document.getElementById('gstinModal');
    const gstinListElement = document.getElementById('gstinList');
    const closeModalBtn = document.getElementById('closeModal');

    // Replace with your own API key to make the GSTIN lookup work
    const API_KEY = '22ac287aeba0d5281a0be722ac450f5b';

    // Debounce function to limit API calls
    const debounce = (func, delay) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), delay);
        };
    };

    // Function to fetch city/state from pincode
    const fetchPincodeDetails = () => {
        const pincode = pincodeInput.value;

        if (pincode.length !== 6 || isNaN(pincode)) {
            cityInput.value = '';
            stateInput.value = '';
            pincodeStatusDiv.textContent = '';
            return;
        }

        pincodeStatusDiv.textContent = 'Fetching location...';

        fetch(`https://api.postalpincode.in/pincode/${pincode}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0 && data[0].Status === 'Success') {
                    const postOffice = data[0].PostOffice[0];
                    cityInput.value = postOffice.District;
                    stateInput.value = postOffice.State;
                    pincodeStatusDiv.textContent = '';
                } else {
                    pincodeStatusDiv.textContent = 'Invalid Pincode.';
                    cityInput.value = '';
                    stateInput.value = '';
                }
            })
            .catch(error => {
                console.error('Error fetching pincode data:', error);
                pincodeStatusDiv.textContent = 'Error fetching location data.';
                cityInput.value = '';
                stateInput.value = '';
            });
    };
    
    // Function to fetch GSTIN details and populate form fields
    const fetchGstDetails = async (gstin) => {
        gstStatusDiv.textContent = 'Fetching GSTIN details...';
        
        // This is the added line to fix the issue
        billingIdInput.value = gstin;

        // Clear previous data
        customerNameInput.value = '';
        billingAddressInput.value = '';
        pincodeInput.value = '';
        cityInput.value = '';
        stateInput.value = '';
        billerTypeSelect.value = 'URP'; // Set to URP by default

        const apiUrl = `https://sheet.gstincheck.co.in/check/${API_KEY}/${gstin}`;

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `API response was not ok, status: ${response.status}`);
            }
            const data = await response.json();
            
            if (data.flag && data.data) {
                const gstDetails = data.data;

                // Populate form fields, prioritizing trade name over legal name
                customerNameInput.value = gstDetails.tradeNam || gstDetails.lgnm || '';
                
                // Use a more robust check for address and pincode
                if (gstDetails.pradr && gstDetails.pradr.addr) {
                    const addressParts = [
                        gstDetails.pradr.addr.flno,
                        gstDetails.pradr.addr.bno,
                        gstDetails.pradr.addr.bnm,
                        gstDetails.pradr.addr.st,
                        gstDetails.pradr.addr.loc
                    ].filter(part => part); // Filter out empty or null values
                    
                    billingAddressInput.value = addressParts.join(', ');
                    pincodeInput.value = gstDetails.pradr.addr.pncd || '';
                    cityInput.value = gstDetails.pradr.addr.dst || '';
                    stateInput.value = gstDetails.pradr.addr.stcd || '';

                } else {
                    // Fallback in case 'pradr' is not present or is empty
                    const addressPart1 = gstDetails.address1 || '';
                    const addressPart2 = gstDetails.address2 || '';
                    billingAddressInput.value = (addressPart1 + ' ' + addressPart2).trim();
                    pincodeInput.value = gstDetails.pinCode || '';
                }
                
                if (pincodeInput.value) {
                    pincodeInput.dispatchEvent(new Event('input')); 
                }
                
                gstStatusDiv.textContent = `GSTIN details found. Status: ${gstDetails.sts}`;

                // Set Biller Type to REG if GST is found
                billerTypeSelect.value = 'REG';

            } else {
                gstStatusDiv.textContent = `GSTIN not found: ${data.message}`;
            }
        } catch (error) {
            console.error('Error fetching GSTIN data:', error);
            gstStatusDiv.textContent = `Error: ${error.message}`;
        }
    };

    // Function to display the GSTIN selection modal
    const showGstinSelectionModal = (gstinData) => {
        gstinListElement.innerHTML = ''; // Clear previous list
        gstinData.forEach(gstin => {
            const li = document.createElement('li');
            li.textContent = gstin.gstin;
            li.onclick = () => {
                fetchGstDetails(gstin.gstin);
                hideGstinSelectionModal();
            };
            gstinListElement.appendChild(li);
        });
        gstinModal.style.display = 'flex';
    };

    // Function to hide the GSTIN selection modal
    const hideGstinSelectionModal = () => {
        gstinModal.style.display = 'none';
    };

    // Function to fetch GSTINs from a PAN number
    const fetchGstinsFromPan = async (pan) => {
        gstStatusDiv.textContent = 'Fetching associated GSTINs from PAN...';
        const panUrl = 'https://sheet.gstincheck.co.in/check/pan';
        const payload = {
            "api_key": API_KEY,
            "pan": pan
        };

        try {
            const response = await fetch(panUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            if (data.flag && data.data && data.data.gstinResList.length > 0) {
                if (data.data.gstinResList.length > 1) {
                    showGstinSelectionModal(data.data.gstinResList);
                    gstStatusDiv.textContent = `${data.data.gstinResList.length} GSTINs found. Please select one.`;
                } else {
                    const firstGstin = data.data.gstinResList[0].gstin;
                    gstStatusDiv.textContent = `Found GSTIN: ${firstGstin}. Fetching details...`;
                    fetchGstDetails(firstGstin);
                }
            } else {
                gstStatusDiv.textContent = 'No GSTINs found for this PAN.';
            }

        } catch (error) {
            console.error('Error fetching PAN data:', error);
            gstStatusDiv.textContent = `Error fetching PAN data: ${error.message}`;
        }
    };

    // Main function to handle input and determine type (GSTIN or PAN)
    const handleBillingIDInput = () => {
        const input = billingIdInput.value.trim().toUpperCase();
        
        // Clear previous data and status
        gstStatusDiv.textContent = '';
        customerNameInput.value = '';
        billingAddressInput.value = '';
        pincodeInput.value = '';
        cityInput.value = '';
        stateInput.value = '';
        billerTypeSelect.value = 'URP'; // Reset to default

        // Regex for GSTIN and PAN format validation
        const gstinRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
        const panRegex = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;

        if (gstinRegex.test(input)) {
            fetchGstDetails(input);
        } else if (panRegex.test(input)) {
            fetchGstinsFromPan(input);
        } else {
            gstStatusDiv.textContent = 'Enter a valid GSTIN or PAN.';
        }
    };

    // Function to generate UID based on service abbreviation
    const generateUid = (code, service, weight) => {
        let serviceAbbr = '';
        switch (service.toLowerCase()) {
            case 'premium':
                serviceAbbr = 'P';
                break;
            case 'express':
                serviceAbbr = 'E';
                break;
            case 'airline':
                serviceAbbr = 'A';
                break;
            case 'surface':
                serviceAbbr = 'S';
                break;
        }
        return `${code}${serviceAbbr}${weight}`.toUpperCase();
    };

    // Function to load the rate list data into the editable table
    const loadRateListTable = (customerCode = '') => {
        const rateListData = [
            { "Code": customerCode, "Carrier": "GEN", "Service": "Premium", "Weight": "0.5", "Zone 1": "50", "Zone 2": "60", "Zone 3": "65", "Zone 4": "50", "Zone 5": "85", "Zone 6": "85", "Zone 7": "95", "Zone 8": "95", "Zone 9": "120", "Zone 10": "120", "Zone 11": "120", "Zone 12": "120", "Zone 13": "170", "Zone 14": "190" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Premium", "Weight": "0.5A", "Zone 1": "45", "Zone 2": "50", "Zone 3": "55", "Zone 4": "45", "Zone 5": "70", "Zone 6": "70", "Zone 7": "80", "Zone 8": "80", "Zone 9": "100", "Zone 10": "100", "Zone 11": "100", "Zone 12": "100", "Zone 13": "140", "Zone 14": "160" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Express", "Weight": "0.5", "Zone 1": "45", "Zone 2": "55", "Zone 3": "60", "Zone 4": "45", "Zone 5": "75", "Zone 6": "75", "Zone 7": "85", "Zone 8": "85", "Zone 9": "110", "Zone 10": "110", "Zone 11": "110", "Zone 12": "110", "Zone 13": "160", "Zone 14": "180" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Express", "Weight": "0.5A", "Zone 1": "40", "Zone 2": "45", "Zone 3": "50", "Zone 4": "40", "Zone 5": "65", "Zone 6": "65", "Zone 7": "75", "Zone 8": "75", "Zone 9": "95", "Zone 10": "95", "Zone 11": "95", "Zone 12": "95", "Zone 13": "130", "Zone 14": "150" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Airline", "Weight": "3", "Zone 1": "25", "Zone 2": "30", "Zone 3": "35", "Zone 4": "25", "Zone 5": "45", "Zone 6": "45", "Zone 7": "50", "Zone 8": "50", "Zone 9": "60", "Zone 10": "60", "Zone 11": "60", "Zone 12": "60", "Zone 13": "90", "Zone 14": "110" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Airline", "Weight": "10", "Zone 1": "20", "Zone 2": "25", "Zone 3": "30", "Zone 4": "20", "Zone 5": "40", "Zone 6": "40", "Zone 7": "45", "Zone 8": "45", "Zone 9": "55", "Zone 10": "55", "Zone 11": "55", "Zone 12": "55", "Zone 13": "80", "Zone 14": "100" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Airline", "Weight": "25", "Zone 1": "18", "Zone 2": "23", "Zone 3": "28", "Zone 4": "18", "Zone 5": "38", "Zone 6": "38", "Zone 7": "43", "Zone 8": "43", "Zone 9": "53", "Zone 10": "53", "Zone 11": "53", "Zone 12": "53", "Zone 13": "78", "Zone 14": "98" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Airline", "Weight": "50", "Zone 1": "17", "Zone 2": "22", "Zone 3": "27", "Zone 4": "17", "Zone 5": "37", "Zone 6": "37", "Zone 7": "42", "Zone 8": "42", "Zone 9": "52", "Zone 10": "52", "Zone 11": "52", "Zone 12": "52", "Zone 13": "77", "Zone 14": "97" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Airline", "Weight": "100", "Zone 1": "16", "Zone 2": "21", "Zone 3": "26", "Zone 4": "16", "Zone 5": "36", "Zone 6": "36", "Zone 7": "41", "Zone 8": "41", "Zone 9": "51", "Zone 10": "51", "Zone 11": "51", "Zone 12": "51", "Zone 13": "76", "Zone 14": "96" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Airline", "Weight": "500", "Zone 1": "15", "Zone 2": "20", "Zone 3": "25", "Zone 4": "15", "Zone 5": "35", "Zone 6": "35", "Zone 7": "40", "Zone 8": "40", "Zone 9": "50", "Zone 10": "50", "Zone 11": "50", "Zone 12": "50", "Zone 13": "75", "Zone 14": "95" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Surface", "Weight": "3", "Zone 1": "30", "Zone 2": "40", "Zone 3": "45", "Zone 4": "40", "Zone 5": "50", "Zone 6": "50", "Zone 7": "55", "Zone 8": "55", "Zone 9": "65", "Zone 10": "65", "Zone 11": "65", "Zone 12": "65", "Zone 13": "100", "Zone 14": "110" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Surface", "Weight": "10", "Zone 1": "20", "Zone 2": "25", "Zone 3": "30", "Zone 4": "25", "Zone 5": "35", "Zone 6": "35", "Zone 7": "40", "Zone 8": "40", "Zone 9": "50", "Zone 10": "50", "Zone 11": "50", "Zone 12": "50", "Zone 13": "80", "Zone 14": "90" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Surface", "Weight": "25", "Zone 1": "18", "Zone 2": "23", "Zone 3": "28", "Zone 4": "23", "Zone 5": "33", "Zone 6": "33", "Zone 7": "38", "Zone 8": "38", "Zone 9": "48", "Zone 10": "48", "Zone 11": "48", "Zone 12": "48", "Zone 13": "78", "Zone 14": "88" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Surface", "Weight": "50", "Zone 1": "17", "Zone 2": "22", "Zone 3": "27", "Zone 4": "22", "Zone 5": "32", "Zone 6": "32", "Zone 7": "37", "Zone 8": "37", "Zone 9": "47", "Zone 10": "47", "Zone 11": "47", "Zone 12": "47", "Zone 13": "77", "Zone 14": "87" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Surface", "Weight": "100", "Zone 1": "16", "Zone 2": "21", "Zone 3": "26", "Zone 4": "21", "Zone 5": "31", "Zone 6": "31", "Zone 7": "36", "Zone 8": "36", "Zone 9": "46", "Zone 10": "46", "Zone 11": "46", "Zone 12": "46", "Zone 13": "76", "Zone 14": "86" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Surface", "Weight": "500", "Zone 1": "15", "Zone 2": "20", "Zone 3": "25", "Zone 4": "20", "Zone 5": "30", "Zone 6": "30", "Zone 7": "35", "Zone 8": "35", "Zone 9": "45", "Zone 10": "45", "Zone 11": "45", "Zone 12": "45", "Zone 13": "75", "Zone 14": "85" },
            { "Code": customerCode, "Carrier": "GEN", "Service": "Surface", "Weight": "1000", "Zone 1": "14", "Zone 2": "19", "Zone 3": "24", "Zone 4": "19", "Zone 5": "29", "Zone 6": "29", "Zone 7": "34", "Zone 8": "34", "Zone 9": "44", "Zone 10": "44", "Zone 11": "44", "Zone 12": "44", "Zone 13": "74", "Zone 14": "84" }
        ];

        rateTableBody.innerHTML = ''; // Clear existing rows

        rateListData.forEach(row => {
            const tr = document.createElement('tr');
            const uid = generateUid(customerCode, row.Service, row.Weight);
            tr.innerHTML = `
                <td class="hidden-column"><input type="text" value="${customerCode}" readonly></td>
                <td class="hidden-column"><input type="text" value="${row.Carrier}" readonly></td>
                <td><input type="text" value="${row.Service}" readonly></td>
                <td><input type="text" value="${row.Weight}" readonly></td>
                <td class="hidden-column"><input type="text" value="${uid}" readonly></td>
                <td><input type="number" value="${row['Zone 1']}"></td>
                <td><input type="number" value="${row['Zone 2']}"></td>
                <td><input type="number" value="${row['Zone 3']}"></td>
                <td><input type="number" value="${row['Zone 4']}"></td>
                <td><input type="number" value="${row['Zone 5']}"></td>
                <td><input type="number" value="${row['Zone 6']}"></td>
                <td><input type="number" value="${row['Zone 7']}"></td>
                <td><input type="number" value="${row['Zone 8']}"></td>
                <td><input type="number" value="${row['Zone 9']}"></td>
                <td><input type="number" value="${row['Zone 10']}"></td>
                <td><input type="number" value="${row['Zone 11']}"></td>
                <td><input type="number" value="${row['Zone 12']}"></td>
                <td><input type="number" value="${row['Zone 13']}"></td>
                <td><input type="number" value="${row['Zone 14']}"></td>
            `;
            rateTableBody.appendChild(tr);
        });
    };

    customerCodeInput.addEventListener('input', (e) => {
        loadRateListTable(e.target.value.trim());
    });

    // Function to handle form submission
    const handleFormSubmit = async (event) => {
        event.preventDefault(); // Prevent default form submission

        formStatusDiv.textContent = 'Submitting data...';
        formStatusDiv.className = 'status-message';

        const form = event.target;
        const formData = new FormData(form);

        // Convert form data to a JavaScript object
        const data = Object.fromEntries(formData.entries());

        // Gather data from the editable rate table
        const rateListRows = Array.from(rateTableBody.children);
        const rateListData = rateListRows.map(row => {
            const inputs = row.querySelectorAll('input');
            const rowData = {};
            rowData.Code = inputs[0].value;
            rowData.Carrier = inputs[1].value;
            rowData.Service = inputs[2].value;
            rowData.Weight = inputs[3].value;
            rowData.UID = inputs[4].value;
            rowData['Zone 1'] = inputs[5].value;
            rowData['Zone 2'] = inputs[6].value;
            rowData['Zone 3'] = inputs[7].value;
            rowData['Zone 4'] = inputs[8].value;
            rowData['Zone 5'] = inputs[9].value;
            rowData['Zone 6'] = inputs[10].value;
            rowData['Zone 7'] = inputs[11].value;
            rowData['Zone 8'] = inputs[12].value;
            rowData['Zone 9'] = inputs[13].value;
            rowData['Zone 10'] = inputs[14].value;
            rowData['Zone 11'] = inputs[15].value;
            rowData['Zone 12'] = inputs[16].value;
            rowData['Zone 13'] = inputs[17].value;
            rowData['Zone 14'] = inputs[18].value;
            return rowData;
        });

        // Add rate list data to the main data object
        data.rateList = rateListData;
        
        // This is the URL of your deployed Google Apps Script.
        // You MUST replace this with your actual URL after deploying the script provided below.
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbxC4C8q3Cy2RCw5ctLcb0U-gKQHz_uTaRCaYhCZfknmKn2G1n41Hd2aRiJQujBpImpqtA/exec'; 

        if (scriptUrl === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
            formStatusDiv.textContent = 'Please update the scriptUrl with your Google Apps Script URL.';
            formStatusDiv.className = 'status-message error';
            return;
        }

        try {
            const response = await fetch(scriptUrl, {
                method: 'POST',
                mode: 'no-cors', // Required for Google Apps Script to work with fetch
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            formStatusDiv.textContent = 'Customer data successfully submitted!';
            formStatusDiv.className = 'status-message success';
            form.reset(); // Reset the form after successful submission
            loadRateListTable(); // Reload the table with default values

        } catch (error) {
            console.error('Error submitting form:', error);
            formStatusDiv.textContent = `Error submitting data: ${error.message}`;
            formStatusDiv.className = 'status-message error';
        }
    };

    // Attach event listeners
    pincodeInput.addEventListener('input', debounce(fetchPincodeDetails, 500));
    billingIdInput.addEventListener('input', debounce(handleBillingIDInput, 500));
    closeModalBtn.addEventListener('click', hideGstinSelectionModal);
    customerForm.addEventListener('submit', handleFormSubmit);

    // Initial calls
    fetchPincodeDetails();
    loadRateListTable();
</script>

</body>
</html>
