<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Postman Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Site-wide styles -->
    <link rel="stylesheet" href="style.css">
    <style>
        /* Custom styles for the calculator */
        .calculate-btn {
            background-color: #2563eb;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .calculate-btn:hover {
            background-color: #1d4ed8;
        }
        .result-box {
            background-color: #eff6ff;
            border: 1px solid #dbeafe;
            padding: 1rem;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .result-box h4 {
            font-weight: 600;
            color: #1e40af;
        }
        
        .form-field-container {
            display: flex;
            flex-direction: column;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: white;
            transition: border-color 0.2s;
        }
        .form-field-container:focus-within {
            border-color: #2563eb;
        }
        .form-field-container label {
            font-weight: 500;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .form-field-container input, .form-field-container select {
            border: none;
            outline: none;
            padding: 0.25rem 0;
            margin-top: 0.25rem;
            background-color: transparent;
            width: 100%;
        }

        .segmented-control {
            display: flex;
            align-items: stretch;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: white;
        }
        .segmented-control button {
            flex-grow: 1;
            padding: 0.5rem 0.75rem;
            font-weight: 500;
            border-radius: 0;
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
            outline: none;
            border: none;
        }
        .segmented-control .active-btn {
            background-color: #2563eb;
            color: white;
        }
        .segmented-control .inactive-btn {
            background-color: white;
            color: #4b5563;
        }
        .segmented-control button:hover:not(.active-btn) {
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <main class="w-full flex-grow p-4 sm:p-8">
        <div class="container mx-auto">
             <!-- Calculator Section -->
            <section id="calculator-section" class="card space-y-8 py-8 px-6">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">The Postman Calculator</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 h-full">
                    <!-- Left side: Form for entries -->
                    <div class="space-y-6 flex flex-col justify-between">
                        <form id="calculator-form" class="space-y-6 flex-1 flex flex-col justify-between">
                            <!-- Booking Details -->
                             <div class="form-field-container">
                                <label for="booking-code-selector">Client Code</label>
                                <div id="booking-code-wrapper" class="mt-1">
                                    <input type="text" id="booking-input-locked" class="w-full bg-gray-100 cursor-not-allowed hidden" disabled>
                                    <select id="booking-code-dropdown" class="w-full hidden">
                                        <option value="">Loading clients...</option>
                                    </select>
                                    <input type="text" id="booking-input-manual" class="w-full hidden" placeholder="Enter 4-digit code" maxlength="4">
                                </div>
                            </div>

                            <!-- Payment Mode & Value -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-field-container">
                                    <label>Payment Mode</label>
                                    <div class="segmented-control mt-1">
                                        <button type="button" id="paid-btn" class="active-btn w-1/2">Paid</button>
                                        <button type="button" id="cod-btn" class="inactive-btn w-1/2">COD</button>
                                    </div>
                                </div>
                                <div class="form-field-container">
                                    <label for="declared-value" id="value-label">Declared Value</label>
                                    <input type="number" id="declared-value" name="declared-value" placeholder="Enter Amount" min="0" required>
                                </div>
                            </div>
                
                            <!-- Pickup and Delivery Pins -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-field-container">
                                    <label for="pickup-pin">Pickup Pin:</label>
                                    <input type="text" id="pickup-pin" name="pickup-pin" placeholder="e.g., 100001" maxlength="6" required oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,6)">
                                </div>
                                <div class="form-field-container">
                                    <label for="delivery-pin">Delivery Pin:</label>
                                    <input type="text" id="delivery-pin" name="delivery-pin" placeholder="e.g., 902100" maxlength="6" required oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,6)">
                                </div>
                            </div>
                
                            <!-- Shipment Details -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-field-container">
                                    <label for="weight">Weight (kg):</label>
                                    <input type="number" id="weight" name="weight" placeholder="Enter weight in kg" min="0" step="0.01" required>
                                    <div class="text-xs text-gray-500 mt-1">This will be used to calculate final cost.</div>
                                </div>
                                <div class="form-field-container">
                                    <label for="pieces">Pieces/Box:</label>
                                    <input type="number" id="pieces" name="pieces" placeholder="Number of items" min="0" step="1" required onkeydown="if(event.key==='.'){event.preventDefault();}">
                                    <div class="text-xs text-gray-500 mt-1">Number of individual boxes/pieces.</div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="form-field-container">
                                    <label for="length">Length (cm):</label>
                                    <input type="number" id="length" name="length" placeholder="Length" min="0" step="1" required onkeydown="if(event.key==='.'){event.preventDefault();}">
                                </div>
                                <div class="form-field-container">
                                    <label for="width">Width (cm):</label>
                                    <input type="number" id="width" name="width" placeholder="Width" min="0" step="1" required onkeydown="if(event.key==='.'){event.preventDefault();}">
                                </div>
                                <div class="form-field-container">
                                    <label for="height">Height (cm):</label>
                                    <input type="number" id="height" name="height" placeholder="Height" min="0" step="1" required onkeydown="if(event.key==='.'){event.preventDefault();}">
                                </div>
                            </div>
                
                            <!-- Service Type Buttons -->
                            <div class="input-group">
                                <div class="form-field-container">
                                    <label for="service-buttons">Service Type:</label>
                                    <div id="service-buttons" class="segmented-control mt-1">
                                        <button type="button" id="exp-btn" class="active-btn">EXP</button>
                                        <button type="button" id="air-btn" class="inactive-btn">AIR</button>
                                        <button type="button" id="sfc-btn" class="inactive-btn">SFC</button>
                                        <button type="button" id="pro-btn" class="inactive-btn">PRO</button>
                                    </div>
                                </div>
                            </div>
                
                            <div class="flex justify-center">
                                <button type="submit" class="calculate-btn">Calculate Cost</button>
                            </div>
                        </form>
                    </div>
                
                    <!-- Right side: Results display -->
                    <div class="flex items-center justify-center min-h-[300px]">
                        <div id="results-container" class="w-full h-full flex flex-col gap-4">
                            
                            <div id="pro-card" class="card p-4 flex-1 flex flex-col justify-center items-center text-center border-2 border-transparent transition-colors duration-200">
                                <h4 class="text-xl font-semibold mb-2 text-gray-800">Premium</h4>
                                <p id="pro-amount" class="text-3xl font-bold text-gray-800">₹--</p>
                            </div>
                            
                            <div id="exp-card" class="card p-4 flex-1 flex flex-col justify-center items-center text-center border-2 border-blue-500 transition-colors duration-200">
                                <h4 class="text-xl font-semibold mb-2 text-blue-500">Express</h4>
                                <p id="exp-amount" class="text-3xl font-bold text-blue-500">₹--</p>
                            </div>
                            
                            <div id="air-card" class="card p-4 flex-1 flex flex-col justify-center items-center text-center border-2 border-transparent transition-colors duration-200">
                                <h4 class="text-xl font-semibold mb-2 text-gray-800">Airline</h4>
                                <p id="air-amount" class="text-3xl font-bold text-gray-800">₹--</p>
                            </div>
                            
                            <div id="sfc-card" class="card p-4 flex-1 flex flex-col justify-center items-center text-center border-2 border-transparent transition-colors duration-200">
                                <h4 class="text-xl font-semibold mb-2 text-gray-800">Surface</h4>
                                <p id="sfc-amount" class="text-3xl font-bold text-gray-800">₹--</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
    
    <div id="footer-placeholder"></div>

    <script src="layout.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('calculator-form');
            const lockedInput = document.getElementById('booking-input-locked');
            const codeDropdown = document.getElementById('booking-code-dropdown');
            const manualInput = document.getElementById('booking-input-manual');
            const pickupPin = document.getElementById('pickup-pin');
            const deliveryPin = document.getElementById('delivery-pin');
            const paidBtn = document.getElementById('paid-btn');
            const codBtn = document.getElementById('cod-btn');
            const valueLabel = document.getElementById('value-label');
            const declaredValueInput = document.getElementById('declared-value');
            const expBtn = document.getElementById('exp-btn');
            const airBtn = document.getElementById('air-btn');
            const sfcBtn = document.getElementById('sfc-btn');
            const proBtn = document.getElementById('pro-btn');
            const proCard = document.getElementById('pro-card');
            const expCard = document.getElementById('exp-card');
            const airCard = document.getElementById('air-card');
            const sfcCard = document.getElementById('sfc-card');
            const proAmount = document.getElementById('pro-amount');
            const expAmount = document.getElementById('exp-amount');
            const airAmount = document.getElementById('air-amount');
            const sfcAmount = document.getElementById('sfc-amount');
            const weightInput = document.getElementById('weight');
            const piecesInput = document.getElementById('pieces');
            const lengthInput = document.getElementById('length');
            const widthInput = document.getElementById('width');
            const heightInput = document.getElementById('height');
            const proTitle = proCard.querySelector('h4');
            const expTitle = expCard.querySelector('h4');
            const airTitle = airCard.querySelector('h4');
            const sfcTitle = sfcCard.querySelector('h4');

            let paymentMode = 'paid';
            let serviceType = 'exp';
            let appData = null;

            function safeGet(obj, key, fallback = null) {
                if (!obj) return fallback;
                const lowerKey = key.toLowerCase();
                const actualKey = Object.keys(obj).find(k => k.toLowerCase() === lowerKey);
                return actualKey ? obj[actualKey] : fallback;
            }

            function setupPage() {
                const appDataJSON = localStorage.getItem('appData');
                if(appDataJSON) {
                    appData = JSON.parse(appDataJSON).data;
                }
                setupBookingInputByRole();
            }

            function setupBookingInputByRole() {
                lockedInput.style.display = 'none';
                codeDropdown.style.display = 'none';
                manualInput.style.display = 'none';

                const loginDataJSON = localStorage.getItem('loginData');
                if (!loginDataJSON) {
                    manualInput.style.display = 'block';
                    return;
                }

                try {
                    const loginData = JSON.parse(loginDataJSON);
                    const userRole = (loginData.ROLE || loginData.role || '').toUpperCase();
                    const userCode = loginData.CODE || loginData.code;

                    if (userRole === 'CLIENT') {
                        lockedInput.value = userCode;
                        lockedInput.style.display = 'block';
                        autoFillClientData(userCode);
                    } else if (['ADMIN', 'BRANCH', 'STAFF'].includes(userRole)) {
                        codeDropdown.style.display = 'block';
                        if (appData) {
                            const b2bData = safeGet(appData, 'b2b', []);
                            codeDropdown.innerHTML = '<option value="">-- Select a Client --</option>';
                            b2bData.forEach(client => {
                                const clientCode = safeGet(client, 'Code');
                                const clientName = safeGet(client, 'Name');
                                if (clientCode) {
                                    const option = document.createElement('option');
                                    option.value = clientCode;
                                    option.textContent = `${clientCode}${clientName ? ` - ${clientName}` : ''}`;
                                    codeDropdown.appendChild(option);
                                }
                            });
                        } else {
                            codeDropdown.innerHTML = '<option value="">App data not loaded</option>';
                        }
                    } else {
                        manualInput.style.display = 'block';
                    }
                } catch (e) {
                    console.error("Error setting up booking input:", e);
                    manualInput.style.display = 'block';
                }
            }
            
            function autoFillClientData(clientCode) {
                if (!appData || !clientCode) return;
                const b2bData = safeGet(appData, 'b2b', []);
                const client = b2bData.find(c => safeGet(c, 'Code') === clientCode);
                if (client) {
                    const billingPin = safeGet(client, 'Billing PinCode');
                    if (billingPin) {
                        pickupPin.value = billingPin;
                    }
                }
            }

            const updatePaymentMode = () => {
                paidBtn.classList.toggle('active-btn', paymentMode === 'paid');
                paidBtn.classList.toggle('inactive-btn', paymentMode !== 'paid');
                codBtn.classList.toggle('active-btn', paymentMode === 'cod');
                codBtn.classList.toggle('inactive-btn', paymentMode !== 'cod');
                valueLabel.textContent = paymentMode === 'cod' ? 'COD Amount' : 'Declared Value';
                declaredValueInput.placeholder = paymentMode === 'cod' ? 'Enter COD Amount' : 'Enter Declared Value';
            };

            const updateServiceType = (selectedType) => {
                serviceType = selectedType;
                // ... (UI update logic remains the same)
                 const buttons = [expBtn, airBtn, sfcBtn, proBtn];
                const cards = [expCard, airCard, sfcCard, proCard];
                const amounts = [expAmount, airAmount, sfcAmount, proAmount];
                const titles = [expTitle, airTitle, sfcTitle, proTitle];

                buttons.forEach(button => {
                    button.classList.toggle('active-btn', button.id.includes(selectedType));
                    button.classList.toggle('inactive-btn', !button.id.includes(selectedType));
                });

                cards.forEach((card, index) => {
                    const isActive = card.id.includes(selectedType);
                    card.classList.toggle('bg-blue-600', isActive);
                    card.classList.toggle('border-blue-600', isActive);
                    card.classList.toggle('bg-white', !isActive);
                    card.classList.toggle('border-transparent', !isActive);
                    amounts[index].classList.toggle('text-white', isActive);
                    amounts[index].classList.toggle('text-gray-800', !isActive);
                    titles[index].classList.toggle('text-white', isActive);
                    titles[index].classList.toggle('text-gray-800', !isActive);
                });
            };

            updatePaymentMode();
            updateServiceType(serviceType);

            paidBtn.addEventListener('click', () => { paymentMode = 'paid'; updatePaymentMode(); });
            codBtn.addEventListener('click', () => { paymentMode = 'cod'; updatePaymentMode(); });
            expBtn.addEventListener('click', () => updateServiceType('exp'));
            airBtn.addEventListener('click', () => updateServiceType('air'));
            sfcBtn.addEventListener('click', () => updateServiceType('sfc'));
            proBtn.addEventListener('click', () => updateServiceType('pro'));
            codeDropdown.addEventListener('change', () => autoFillClientData(codeDropdown.value));

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const errorMessage = document.getElementById('error-message');
                if (errorMessage) errorMessage.remove();
                
                if (!appData) {
                    showError("Application data is not loaded. Please refresh.");
                    return;
                }

                function getBookingCode() {
                    if (lockedInput.style.display === 'block') return lockedInput.value;
                    if (codeDropdown.style.display === 'block') return codeDropdown.value;
                    return manualInput.value;
                }

                const bookingCode = getBookingCode();
                const deliveryPinValue = deliveryPin.value;
                const weight = parseFloat(weightInput.value);
                const declaredValue = parseFloat(declaredValueInput.value) || 0;
                
                // --- Validation ---
                let errorMsg = '';
                if (!bookingCode || bookingCode.length !== 4) errorMsg = 'A valid 4-character client code is required.';
                // ... add other validations as before
                if (errorMsg) { showError(errorMsg); return; }

                // --- Start Complex Calculation ---
                const clientSettings = safeGet(appData, 'b2b', []).find(c => safeGet(c, 'Code') === bookingCode);
                if (!clientSettings) { showError(`Client settings not found for code: ${bookingCode}`); return; }

                const zoneData = safeGet(appData, 'b2b2c', []).find(z => safeGet(z, 'PIN') == deliveryPinValue);
                if (!zoneData) { showError(`Delivery zone not found for pincode: ${deliveryPinValue}`); return; }
                const zone = parseInt(String(safeGet(zoneData, 'Zone')).replace('Z', ''));

                const volumetricWeight = (parseFloat(lengthInput.value) * parseFloat(widthInput.value) * parseFloat(heightInput.value)) / 5000;
                const chargeableWeight = Math.max(weight, volumetricWeight);

                const serviceMap = { pro: 'P', exp: 'E', air: 'A', sfc: 'S' };
                const servicesToCalc = ['pro', 'exp', 'air', 'sfc'];
                const results = {};

                servicesToCalc.forEach(service => {
                    // 1. Find Weight Slab
                    const weightSlabs = [3, 10, 25, 50, 100, 500]; // as per your description
                    let applicableSlab = weightSlabs.find(slab => chargeableWeight <= slab);
                    if (!applicableSlab) applicableSlab = 500; // Fallback for very heavy items
                    
                    // 2. Find Rate
                    const ratesData = safeGet(appData, 'rates', []);
                    const serviceCode = serviceMap[service];
                    const uidToFind = `${bookingCode}${applicableSlab}${serviceCode}`;
                    
                    const rateRow = ratesData.find(r => safeGet(r, 'UID') === uidToFind);
                    if (!rateRow) {
                        results[service] = 'N/A';
                        return; // continue to next service
                    }

                    const ratePerKg = parseFloat(safeGet(rateRow, String(zone)));
                    if (isNaN(ratePerKg)) {
                         results[service] = 'N/A';
                        return;
                    }

                    // 3. Calculate Freight
                    const freight = ratePerKg * chargeableWeight;
                    
                    // 4. Calculate Other Charges
                    const codCharge = paymentMode === 'cod' ? (parseFloat(safeGet(clientSettings, 'COD If', 0)) * declaredValue) : 0;
                    const insuranceCharge = parseFloat(safeGet(clientSettings, 'Insuranse If', 0)) * declaredValue;
                    const ewayCharge = parseFloat(safeGet(clientSettings, 'Eway If', 0));
                    const awbCharge = parseFloat(safeGet(clientSettings, 'AWB Charge', 0));
                    const packingCharge = parseFloat(safeGet(clientSettings, 'Packing Charges', 0)) * chargeableWeight;
                    const fuelSurcharge = (parseFloat(safeGet(clientSettings, 'Fuel Charges', 0)) / 100) * freight;
                    const devSurcharge = (parseFloat(safeGet(clientSettings, 'Devlp Chg', 0)) / 100) * freight;
                    
                    // 5. Calculate Total
                    let total = freight + codCharge + insuranceCharge + ewayCharge + awbCharge + packingCharge + fuelSurcharge + devSurcharge;
                    
                    // 6. Apply GST
                    if (safeGet(clientSettings, 'GST Inclusive', 'N').toUpperCase() !== 'Y') {
                        total *= 1.18; // Add 18% GST
                    }
                    
                    results[service] = total.toFixed(2);
                });

                proAmount.textContent = results.pro !== 'N/A' ? `₹${results.pro}` : 'N/A';
                expAmount.textContent = results.exp !== 'N/A' ? `₹${results.exp}` : 'N/A';
                airAmount.textContent = results.air !== 'N/A' ? `₹${results.air}` : 'N/A';
                sfcAmount.textContent = results.sfc !== 'N/A' ? `₹${results.sfc}` : 'N/A';

                updateServiceType(serviceType);
            });

            function showError(message) {
                proAmount.textContent = expAmount.textContent = airAmount.textContent = sfcAmount.textContent = '₹--';
                const existingError = document.getElementById('error-message');
                if (existingError) existingError.remove();
                const errorDiv = document.createElement('div');
                errorDiv.id = 'error-message';
                errorDiv.className = 'col-span-2 text-center text-red-500 font-semibold mt-4';
                errorDiv.textContent = message;
                document.getElementById('results-container').appendChild(errorDiv);
            }

            window.addEventListener('appDataLoaded', setupPage);
            window.addEventListener('appDataRefreshed', setupPage);
            setupPage();
        });
    </script>

</body>
</html>

