<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Postman (V5.6)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* This CSS handles the floating label animation */
        .peer:not(:placeholder-shown) ~ label, .peer:focus ~ label {
            @apply text-sm -translate-y-4 text-blue-500;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- 
      NARRATION: This is the V5.6 login page.
      - It matches the V5.6 (Fully Narrated) API.
      - It sends `user` and `pass` (no `code`).
      - It expects `sessionId`, `name`, `code`, `token` back.
      - It saves all of them to `localStorage` to support
        both your new multi-tab system and your old system.
    -->

    <main class="flex-grow flex items-center justify-center p-4">
        <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden grid md:grid-cols-2 gap-0">
            <!-- Column 1: Login Form -->
            <div class="p-8 md:p-12">
                <div class="flex justify-center mb-8">
                    <img src="https://i.postimg.cc/wv02f1fb/postman-Logo-28.png" alt="Postman logo" class="h-20 w-auto"
                         onerror="this.onerror=null; this.src='https://placehold.co/150x80/022c5a/ffffff?text=Postman';">
                </div>
                <form id="login-form" class="space-y-6">
                    <!-- Username Input -->
                    <div class="relative">
                        <input type="text" id="username" autocomplete="username" required placeholder=" " class="w-full peer p-4 pt-6 font-semibold border-b-2 border-gray-300 focus:outline-none focus:border-blue-500 transition-colors">
                        <label for="username" class="absolute text-gray-500 transition-all left-4 top-5 pointer-events-none">
                            Username
                        </label>
                    </div>
                    <!-- Password Input -->
                    <div class="relative">
                        <input type="password" id="password" autocomplete="current-password" required placeholder=" " class="w-full peer p-4 pt-6 font-semibold border-b-2 border-gray-300 focus:outline-none focus:border-blue-500 transition-colors">
                        <label for="password" class="absolute text-gray-500 transition-all left-4 top-5 pointer-events-none">
                            Password
                        </label>
                    </div>
                    <!-- Submit Button -->
                    <button type="submit" class="w-full py-4 bg-blue-800 text-white font-semibold rounded-lg hover:bg-blue-900 transition-colors mt-6 flex items-center justify-center" disabled>
                        <span id="button-text">Log In</span>
                        <svg id="spinner" class="animate-spin h-5 w-5 text-white ml-3 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </form>
                <div id="message-area" class="text-center font-medium mt-4 text-sm"></div>
            </div>

            <!-- Column 2: Greeting and Image -->
            <div class="hidden md:block relative">
                <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1585713181935-d5f622cc261b?q=80&w=2070&auto=format&fit=crop');"></div>
                <div class="relative z-10 flex flex-col justify-center items-center h-full p-8 bg-blue-900 bg-opacity-75 text-white text-center">
                     <h2 class="text-4xl font-bold mb-4">Postman Welcomes You</h2>
                     <p class="text-lg">Manage shipments, track packages, and access all your services seamlessly in one place.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- The layout.js file is not used on the login page -->
    <!-- <script src="layout.js"></script> -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
             // --- DOM Elements ---
            const loginForm = document.getElementById('login-form');
            const messageArea = document.getElementById('message-area');
            const spinner = document.getElementById('spinner');
            const buttonText = document.getElementById('button-text');
            const submitButton = loginForm.querySelector('button[type="submit"]');

            // --- Configuration ---
            // NARRATION: Updated to the new V1 Deployment URL
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwEjKXvfpBJASCn5Bak19P7ehFIYAFAEjWm2PUaJgTuWkZnQqwekDiRzGbszQPI-hI55Q/exec';
            const SESSION_KEY = 'loginData'; 
            
            // --- NARRATION: This MUST match the 1-hour server timer ---
            const ABSOLUTE_SESSION_TIMEOUT_SECONDS = 3600; 

            // --- Initialization ---
            // Clear all storage on login page load to ensure a clean start.
            localStorage.clear();
            sessionStorage.clear();
            
            submitButton.disabled = false; // Enable button

            // --- Event Listener ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                setLoading(true);
                displayMessage('', 'info');

                const formData = {
                    username: document.getElementById('username').value.trim(),
                    password: document.getElementById('password').value.trim(),
                };

                // NARRATION: Create GET request parameters
                const params = new URLSearchParams({
                    action: 'login',
                    user: formData.username,
                    pass: formData.password
                });
                const URL = WEB_APP_URL + '?' + params.toString();

                try {
                    // NARRATION: Changed to GET, removed POST body/headers
                    const response = await fetch(URL, { method: 'GET', mode: 'cors' });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();

                    // NARRATION: Updated this check to look for all the new data
                    if (result.success && result.data.sessionId && result.data.code) {
                        displayMessage('Login successful! Redirecting...', 'success');
                        
                        // Pass the *entire* data object to be saved
                        saveUserSession(result.data);
                        
                        setTimeout(() => {
                            // NARRATION: Redirect to your dashboard page
                            window.location.href = 'https://post4ex.github.io/postman/dashboard.html';
                        }, 1000);

                    } else {
                        displayMessage(result.message || 'Login failed. Please check credentials.', 'error');
                        setLoading(false);
                    }
                } catch (error) {
                    console.error("Login Error:", error);
                    displayMessage('An unexpected error occurred. Please try again.', 'error');
                    setLoading(false);
                }
            });

            // --- NARRATION: This function is UPGRADED for transition ---
            function saveUserSession(data) {
                // 1. Create the 1-hour client-side expiry (matches server)
                const expiry = new Date().getTime() + (ABSOLUTE_SESSION_TIMEOUT_SECONDS * 1000); // 1 hour
                
                // 2. Save EVERYTHING to LOCAL STORAGE
                // This supports both the new `sessionId` and your
                // old system's `code` and `token`.
                localStorage.setItem(SESSION_KEY, JSON.stringify({
                    sessionId: data.sessionId,
                    expires: expiry,

                    // --- TRANSITION CODE (Remove Later) ---
                    // These are for your old system.
                    name: data.name,
                    code: data.code,
                    token: data.token
                    // --- END TRANSITION CODE ---
                }));
                
                // NARRATION: We do NOT save appData here.
                // Your `layout.js` will fetch that and save it
                // to `sessionStorage`.
            }

            // --- UI Functions ---
            function setLoading(isLoading) {
                spinner.classList.toggle('hidden', !isLoading);
                buttonText.textContent = isLoading ? 'Verifying...' : 'Log In';
                submitButton.disabled = isLoading;
                // NARRATION: Updated this to only disable the two existing fields
                document.getElementById('username').disabled = isLoading;
                document.getElementById('password').disabled = isLoading;
            }

            function displayMessage(message, type) {
                // Using .textContent is a critical XSS protection.
                messageArea.textContent = message;
                messageArea.className = 'text-center font-medium mt-4 text-sm';
                if (type === 'error') messageArea.classList.add('text-red-600');
                else if (type === 'success') messageArea.classList.add('text-green-600');
                else if (type === 'info') messageArea.classList.add('text-gray-600');
            }
        });
    </script>
</body>
</html>
