<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clients - Postman</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Additional style to ensure consistency */
        .form-input {
            border-radius: 0.375rem; /* default rounded-md */
            border: 1px solid #d1d5db; /* border-gray-300 */
            padding: 0.5rem 0.75rem;
            transition: border-color 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6; /* focus:border-blue-500 */
        }
        .readonly-input {
            background-color: #f3f4f6; /* bg-gray-100 */
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <div id="header-placeholder"></div>

    <main class="flex-grow container mx-auto p-4">
        <div class="card">
            <h2 class="text-2xl font-bold text-center text-gray-800 p-4 border-b mb-6">B2B2C Client Submission Form</h2>
            
            <form id="dataForm" class="space-y-4">
                <!-- Hidden Authorization Fields -->
                <input type="hidden" id="user" name="user">
                <input type="hidden" id="token" name="token">
                <input type="hidden" id="code" name="code">
                
                <!-- Data Fields Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <input type="tel" id="mobile" name="mobile" placeholder="MOBILE" required class="form-input w-full">
                    <input type="text" id="gst_id" name="gst_id" placeholder="GST/PAN/ADHAR" class="form-input w-full">
                    <input type="text" id="branch" name="branch" placeholder="BRANCH" class="form-input w-full">
                    
                    <div class="relative">
                        <input type="text" id="client-search" placeholder="Search Client (Name or Code)" class="form-input w-full" autocomplete="off">
                        <div id="client-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-60 overflow-y-auto hidden"></div>
                    </div>
                    <input type="text" id="name" name="name" placeholder="NAME" required class="form-input w-full md:col-span-2">

                    <input type="text" id="address" name="address" placeholder="ADDRESS" required class="form-input w-full md:col-span-2 lg:col-span-3">

                    <input type="email" id="email" name="email" placeholder="EMAIL" class="form-input w-full md:col-span-2">
                    <input type="text" id="pincode" name="pincode" placeholder="PINCODE" required class="form-input w-full">
                    
                    <input type="text" id="city" name="city" placeholder="CITY" class="form-input w-full readonly-input" readonly>
                    <input type="text" id="state" name="state" placeholder="STATE" class="form-input w-full readonly-input" readonly>
                    <input type="text" id="zone" name="zone" placeholder="ZONE" class="form-input w-full readonly-input" readonly>
                    
                    <input type="text" id="express_tat" name="express_tat" placeholder="EXPRESS TAT" class="form-input w-full readonly-input" readonly>
                    <input type="text" id="airline_tat" name="airline_tat" placeholder="AIRLINE TAT" class="form-input w-full readonly-input md:col-span-2" readonly>
                    
                    <input type="text" id="surface_tat" name="surface_tat" placeholder="SURFACE TAT" class="form-input w-full readonly-input" readonly>
                    <input type="text" id="premium_tat" name="premium_tat" placeholder="PREMIUM TAT" class="form-input w-full readonly-input" readonly>
                    <input type="text" id="oda" name="oda" placeholder="ODA" class="form-input w-full readonly-input" readonly>
                    <input type="text" id="carrier" name="carrier" placeholder="CARRIER" class="form-input w-full readonly-input" readonly>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-end space-x-4 pt-4 border-t mt-6">
                    <button type="button" id="cancelBtn" class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="submitBtn" class="px-6 py-2 bg-blue-800 text-white font-semibold rounded-lg hover:bg-blue-900 transition-colors disabled:bg-gray-400 flex items-center">
                        <span id="button-text">Submit</span>
                        <svg id="spinner" class="animate-spin h-5 w-5 text-white ml-3 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
            <!-- Status message area -->
            <div id="status" class="text-center font-medium mt-4 text-sm"></div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="layout.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- LOGIN CHECK ---
            const loginDataJSON = localStorage.getItem('loginData');
            let isLoggedIn = false;
            if (loginDataJSON) {
                try {
                    const loginData = JSON.parse(loginDataJSON);
                    const now = new Date().getTime();
                    if (loginData.expires && now <= loginData.expires) {
                        isLoggedIn = true;
                    }
                } catch (e) {
                    console.error("Login check failed:", e);
                }
            }

            if (!isLoggedIn) {
                window.location.href = 'https://post4ex.github.io/postman/login.html';
                return; // Stop executing script if not logged in
            }
            
            // --- DOM ELEMENT REFERENCES ---
            const form = document.getElementById('dataForm');
            const statusDiv = document.getElementById('status');
            const submitBtn = document.getElementById('submitBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');

            // Form Fields
            const userInput = document.getElementById('user');
            const tokenInput = document.getElementById('token');
            const codeInput = document.getElementById('code'); // Hidden input for selected client code
            const clientSearchInput = document.getElementById('client-search');
            const clientResultsContainer = document.getElementById('client-results');
            const branchInput = document.getElementById('branch');
            const nameInput = document.getElementById('name');

            const pincodeInput = document.getElementById('pincode');
            const cityInput = document.getElementById('city');
            const stateInput = document.getElementById('state');
            const carrierInput = document.getElementById('carrier');
            const expressTatInput = document.getElementById('express_tat');
            const airlineTatInput = document.getElementById('airline_tat');
            const surfaceTatInput = document.getElementById('surface_tat');
            const premiumTatInput = document.getElementById('premium_tat');
            const odaInput = document.getElementById('oda');
            const zoneInput = document.getElementById('zone');

            // --- CONFIGURATION ---
            const SUBMIT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwb5gqe6hep6orsrnviSzD-LDNt4axEnLKNPCfWJl8GINS55FzWEOKSMVVTy8M8KlO4w/exec';
            const PINCODE_API_URL = 'https://script.google.com/macros/s/AKfycbzZOoT6tp9XVgXiOdiiUL9wWchgGqdBPoTI9BiuT2HyKBIuFzPKPZI4z3kF1IAYBgpn/exec';

            let clientsData = [];

            // --- AUTO-FILL AUTHENTICATION ---
            function populateAuthFields() {
                const loginDataJSON = localStorage.getItem('loginData');
                if (loginDataJSON) {
                    try {
                        const loginData = JSON.parse(loginDataJSON);
                        const now = new Date().getTime();
                        if (loginData.expires && now <= loginData.expires) {
                            userInput.value = loginData.CODE || loginData.code || '';
                            tokenInput.value = loginData.TOKEN || loginData.token || '';
                        }
                    } catch (e) {
                        console.error("Failed to parse login data:", e);
                    }
                }
            }
            populateAuthFields();

             // --- CLIENT SEARCH & AUTOFILL ---
            function loadClientData(clients) {
                clientsData = clients.filter(client => client.CODE && client.CLIENT_NAME);
            }

            window.addEventListener('appDataLoaded', (event) => {
                const appData = event.detail;
                if (appData && appData.B2B && Array.isArray(appData.B2B)) {
                    loadClientData(appData.B2B);
                }
            });

            const storedAppDataJSON = localStorage.getItem('appData');
            if (storedAppDataJSON) {
                try {
                    const storedAppData = JSON.parse(storedAppDataJSON);
                    if (storedAppData.data && storedAppData.data.B2B) {
                        loadClientData(storedAppData.data.B2B);
                    }
                } catch(e) { console.error("Could not parse stored app data", e); }
            }

            clientSearchInput.addEventListener('input', () => {
                const searchTerm = clientSearchInput.value.trim();
                clientResultsContainer.innerHTML = '';
                clientResultsContainer.classList.add('hidden');

                if (!searchTerm) {
                    codeInput.value = ''; // Clear if search is cleared
                    return;
                }

                // Check for exact code match first
                const exactMatch = clientsData.find(c => c.CODE.toUpperCase() === searchTerm.toUpperCase());
                if (exactMatch) {
                    codeInput.value = exactMatch.CODE;
                    branchInput.value = exactMatch.BRANCH || '';
                    clientSearchInput.value = `${exactMatch.CLIENT_NAME} (${exactMatch.CODE})`;
                    return; // Found an exact match, stop here
                }

                const filteredClients = clientsData.filter(client =>
                    client.CLIENT_NAME.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    client.CODE.toLowerCase().includes(searchTerm.toLowerCase())
                );

                if (filteredClients.length > 0) {
                    filteredClients.forEach(client => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                        resultItem.textContent = `${client.CLIENT_NAME} (${client.CODE})`;
                        
                        resultItem.addEventListener('mousedown', () => {
                            clientSearchInput.value = `${client.CLIENT_NAME} (${client.CODE})`;
                            codeInput.value = client.CODE;
                            branchInput.value = client.BRANCH || '';
                            clientResultsContainer.classList.add('hidden');
                        });
                        clientResultsContainer.appendChild(resultItem);
                    });
                    clientResultsContainer.classList.remove('hidden');
                }
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', (e) => {
                if (!clientSearchInput.contains(e.target)) {
                    clientResultsContainer.classList.add('hidden');
                }
            });

            // --- UI FUNCTIONS ---
            function setLoading(isLoading) {
                submitBtn.disabled = isLoading;
                spinner.classList.toggle('hidden', !isLoading);
                buttonText.textContent = isLoading ? 'Submitting...' : 'Submit';
            }

            function displayMessage(message, type) {
                statusDiv.textContent = message;
                statusDiv.className = 'text-center font-medium mt-4 text-sm';
                if (type === 'error') {
                    statusDiv.classList.add('text-red-600');
                } else if (type === 'success') {
                    statusDiv.classList.add('text-green-600');
                }
                setTimeout(() => { statusDiv.textContent = ''; }, 5000);
            }

            // --- EVENT LISTENERS ---
            cancelBtn.addEventListener('click', () => {
                form.reset();
                clientSearchInput.value = '';
                clearPincodeDataFields();
                populateAuthFields();
            });

            let debounceTimer;
            pincodeInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const pincode = pincodeInput.value.trim();
                    if (pincode.length !== 6 || !/^\d{6}$/.test(pincode)) {
                        clearPincodeDataFields();
                        return;
                    }
                    fetchPincodeData(pincode);
                }, 500);
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                setLoading(true);

                try {
                    const response = await fetch(SUBMIT_SCRIPT_URL, {
                        method: 'POST',
                        body: new FormData(form)
                    });
                    const result = await response.json();

                    if (result.status === 'success') {
                        displayMessage(result.message, 'success');
                        form.reset();
                        clientSearchInput.value = '';
                        populateAuthFields();
                    } else {
                        displayMessage(result.message, 'error');
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                    displayMessage('An unexpected error occurred. Please check your connection.', 'error');
                } finally {
                    setLoading(false);
                }
            });

            // --- HELPER FUNCTIONS ---
            const clearPincodeDataFields = () => {
                const fields = [cityInput, stateInput, carrierInput, expressTatInput, airlineTatInput, surfaceTatInput, premiumTatInput, odaInput, zoneInput];
                fields.forEach(field => field.value = '');
            };

            async function fetchPincodeData(pincode) {
                pincodeInput.classList.add('opacity-50', 'cursor-wait');
                try {
                    const response = await fetch(`${PINCODE_API_URL}?pincode=${pincode}`);
                    if (!response.ok) throw new Error('Network response was not OK');
                    const result = await response.json();

                    if (result.found && result.data) {
                        const data = result.data;
                        stateInput.value = data.StateName || '';
                        cityInput.value = data.DestinationName || '';
                        carrierInput.value = data.Carrier || '';
                        expressTatInput.value = data['Dox (E)'] || '';
                        airlineTatInput.value = data['NonDox (A)'] || '';
                        surfaceTatInput.value = data['NonDox (S)'] || '';
                        odaInput.value = data.ODA || '';
                        premiumTatInput.value = data['PRO (P)'] || '';
                        zoneInput.value = data.ZONE || '';
                    } else {
                        clearPincodeDataFields();
                        console.warn(result.message || 'Pincode not found.');
                    }
                } catch (error) {
                    console.error('Error fetching pincode data:', error);
                    clearPincodeDataFields();
                } finally {
                    pincodeInput.classList.remove('opacity-50', 'cursor-wait');
                }
            }
        });
    </script>
</body>
</html>

