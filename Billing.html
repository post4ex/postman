<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoices - Postman</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Link to the main site stylesheet -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Page-specific styles (pruned to remove duplicates from style.css) -->
    <style>
        /* Shipment List (Left Pane) */
        #shipmentList li {
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid #e5e7eb;
            line-height: 1.4;
        }
        #shipmentList li.selected {
            background-color: #e0e7ff;
            font-weight: 500;
            border-color: #c7d2fe;
        }
        #shipmentList li:hover {
            background-color: #eef2ff;
        }
        #shipmentList li strong {
            /* Now used for Invoice Number/Group Header */
            color: #4338ca;
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
        }
        #shipmentList .client-info {
            /* Now used for Invoice ID and Code/Branch */
            font-size: 0.75rem;
            color: #6b7280;
        }
        #shipmentList .details-info {
            /* Now used for Invoice Date and Total */
            font-size: 0.75rem;
            color: #4b5563;
            margin-top: 4px;
            display: flex;
            justify-content: space-between;
        }
        #shipmentList .status-badge {
            /* Now used for Total amount */
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 0.25rem;
            text-transform: uppercase;
        }
        /* Style for the UnBilled button when active */
        .filter-active {
            background-color: #fca5a5 !important; /* bg-red-300 */
            color: #b91c1c !important; /* text-red-700 */
        }
        /* Right Pane Details */
        .detail-card {
            background-color: #ffffff;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .detail-card-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            background-color: #f9fafb;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .detail-card-body {
            padding: 1rem;
        }

        /* Form input style from style.css (needed for filter modal) */
        .form-input {
            border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem;
            font-size: 0.875rem; width: 100%; transition: border-color 0.2s;
        }
        .form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 1px #4f46e5; }

    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">
    <!-- Header placeholder -->
    <div id="header-placeholder"></div>

    <!-- Main content container -->
    <div class="flex flex-col md:flex-row flex-grow w-full min-h-0">

        <!-- Left Sidebar for Shipment List -->
        <aside id="shipmentListPane" class="w-full md:w-1/3 lg:w-1/4 bg-white border-r flex flex-col flex-grow md:flex-grow-0 min-h-0">
            <div class="p-4 border-b sticky top-0 bg-white z-10">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-bold text-gray-800">Invoices</h2>
                    <button id="unbilledToggleBtn" class="px-3 py-1 text-xs font-medium bg-gray-200 text-gray-700 rounded-md hover:bg-red-200 transition-colors">
                        UnBilled
                    </button>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="searchShipments" placeholder="Search INV#, ID, Code, Branch..." class="form-input w-full text-sm">
                    <button id="filterToggleBtn" class="p-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                    </button>
                </div>
            </div>
            <div id="shipmentListContainer" class="overflow-y-auto flex-grow min-h-0">
                <p id="status-message" class="text-gray-600 p-4 text-center">Loading invoice data...</p>
                <ul id="shipmentList" class="p-4 space-y-2">
                    <!-- Invoice list items will be rendered here -->
                </ul>
            </div>
        </aside>

        <!-- Main Content Area for Details -->
        <main id="shipmentDetailPane" class="w-full md:w-2/3 lg:w-3/4 p-6 md:p-8 overflow-y-auto bg-gray-50 hidden md:block min-h-0">
            
            <!-- Add Back Button for mobile -->
            <div class="p-4 border-b md:hidden bg-white -mt-6 -mx-6 mb-6 sm:-mt-8 sm:-mx-8 sm:mb-8 shadow-sm">
                 <button type="button" id="backToListBtn" class="text-sm bg-gray-200 text-gray-800 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300 flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Back to List
                </button>
            </div>

            <!-- Container for the actual detail content -->
            <div id="detailView" class="hidden space-y-6">
                <!-- 0. Invoice Details Card (NEW) -->
                <div id="invoiceDetailsCardContainer" class="detail-card">
                    <!-- Customer/Invoice dates will be rendered here -->
                </div>
                <!-- 1. Shipments Table -->
                <div id="shipmentDetailsTableContainer" class="detail-card">
                    <!-- Table/Cards will be rendered here -->
                </div>
                <!-- 2. Consolidated Charges Table (NEW) -->
                <div id="summaryTableContainer" class="detail-card">
                    <!-- Summary table/cards will be rendered here -->
                </div>
            </div>

            <!-- Retained: Empty view message -->
            <div id="emptyView" class="h-full flex items-center justify-center">
                <p class="text-gray-500 text-lg">Select an invoice from the list to view included shipments.</p>
            </div>
        </main>
    </div>

    <!-- Filter Modal (uses modal styles from style.css) -->
    <div id="filterModal" class="modal-overlay hidden">
        <div class="modal-content space-y-4">
            <h2 class="text-xl font-semibold text-gray-800">Filter Invoices</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="filter-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                    <input type="date" id="filter-start-date" class="form-input mt-1 block w-full text-sm">
                </div>
                <div>
                    <label for="filter-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                    <input type="date" id="filter-end-date" class="form-input mt-1 block w-full text-sm">
                </div>
                <div>
                    <label for="filter-branch" class="block text-sm font-medium text-gray-700">Branch</label>
                    <select id="filter-branch" class="form-input mt-1 block w-full text-sm">
                        <option value="">All</option>
                    </select>
                </div>
                <div>
                    <label for="filter-code" class="block text-sm font-medium text-gray-700">Code</label>
                    <select id="filter-code" class="form-input mt-1 block w-full text-sm">
                        <option value="">All</option>
                    </select>
                </div>
                <!-- Carrier filter is less relevant for Invoices but kept for filter structure -->
                <div class="sm:col-span-2">
                    <label for="filter-carrier" class="block text-sm font-medium text-gray-700">Carrier</label>
                    <select id="filter-carrier" class="form-input mt-1 block w-full text-sm">
                        <option value="">All</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end gap-4 pt-4 border-t">
                <button id="reset-filters" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm font-medium">Reset</button>
                <button id="apply-filters" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm font-medium">Apply Filters</button>
            </div>
        </div>
    </div>

    <!-- Footer placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Layout and docgen scripts (assuming layout.js handles headers/footers/auth setup) -->
    <script src="layout.js"></script>
    
    <script>
        // --- Document Generation Stub ---
        function generateDocument(docType, reference) {
            console.log(`Document generation for: ${docType} (Ref: ${reference}) is currently disabled.`);
            return false; 
        }
        // --- End Document Generation Stub ---

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const ui = {
                statusMessage: document.getElementById('status-message'),
                shipmentList: document.getElementById('shipmentList'),
                shipmentListPane: document.getElementById('shipmentListPane'), 
                shipmentDetailPane: document.getElementById('shipmentDetailPane'), 
                backToListBtn: document.getElementById('backToListBtn'), 
                detailView: document.getElementById('detailView'), 
                searchShipments: document.getElementById('searchShipments'),
                filterToggleBtn: document.getElementById('filterToggleBtn'),
                unbilledToggleBtn: document.getElementById('unbilledToggleBtn'), // NEW
                filterModal: document.getElementById('filterModal'),
                filterStartDate: document.getElementById('filter-start-date'),
                filterEndDate: document.getElementById('filter-end-date'),
                filterBranch: document.getElementById('filter-branch'),
                filterCode: document.getElementById('filter-code'),
                filterCarrier: document.getElementById('filter-carrier'),
                resetFiltersBtn: document.getElementById('reset-filters'),
                applyFiltersBtn: document.getElementById('apply-filters'),
                emptyView: document.getElementById('emptyView'),
                // NEW Detail Containers
                invoiceDetailsCardContainer: document.getElementById('invoiceDetailsCardContainer'),
                shipmentDetailsTableContainer: document.getElementById('shipmentDetailsTableContainer'),
                summaryTableContainer: document.getElementById('summaryTableContainer')
            };

            // --- Global State ---
            let allShipments = []; // Raw shipment data
            let b2bDataMap = new Map(); // NEW: Map for B2B customer data
            let consolidatedInvoices = []; // Consolidated list for display
            let currentSelectedRef = null;
            let isUnbilledMode = false; // NEW state for the toggle
            
            // --- Mobile View Functions ---
            const isMobileView = () => window.innerWidth < 768;

            const showDetailView = (showContent = false) => {
                if (isMobileView()) {
                    if (showContent) {
                        ui.shipmentListPane.classList.add('hidden');
                        ui.shipmentDetailPane.classList.remove('hidden');
                    } else {
                        // Returning to list
                        ui.shipmentListPane.classList.remove('hidden');
                        ui.shipmentDetailPane.classList.add('hidden');
                    }
                }
                
                if (showContent) {
                    ui.emptyView.classList.add('hidden');
                    ui.detailView.classList.remove('hidden');
                } else {
                    ui.emptyView.classList.remove('hidden'); 
                    ui.detailView.classList.add('hidden');
                }
            };
            
            // Add listener for back button
            ui.backToListBtn.addEventListener('click', () => {
                showDetailView(false);
            });
            
            // NEW: UnBilled Toggle Listener
            ui.unbilledToggleBtn.addEventListener('click', () => {
                isUnbilledMode = !isUnbilledMode;
                ui.unbilledToggleBtn.classList.toggle('filter-active', isUnbilledMode);
                // Clear search and filters when toggling the mode for a clean view
                ui.searchShipments.value = '';
                ui.filterStartDate.value = ''; ui.filterEndDate.value = ''; 
                ui.filterBranch.value = ''; ui.filterCode.value = ''; ui.filterCarrier.value = ''; 
                
                applyFilters(); 
            });
            // --- END Mobile View Functions ---

            // --- Data Consolidation Helpers ---
            // Function to determine the consolidation key for a single order (must match consolidateInvoiceData logic)
            function getConsolidationKey(order) {
                if (order.INV_NUMBER) {
                    return { key: 'INV-' + order.INV_NUMBER, type: 'INV' };
                } else if (order.INVOICE_ID) {
                    return { key: 'ID-' + order.INVOICE_ID, type: 'ID' };
                } else if (order.ORDER_DATE && order.CODE) {
                    const orderDate = new Date(order.ORDER_DATE);
                    if (isNaN(orderDate.getTime())) return null;
                    
                    const year = orderDate.getUTCFullYear();
                    const month = String(orderDate.getUTCMonth() + 1).padStart(2, '0');
                    
                    return { key: 'MONTH-' + order.CODE + '-' + year + month, type: 'MONTH' };
                }
                return null;
            }

            // Function to find all shipments for a selected invoice key
            function getShipmentsForInvoice(consolidationKey) {
                return allShipments.filter(shipment => {
                    const keyInfo = getConsolidationKey(shipment);
                    return keyInfo && keyInfo.key === consolidationKey;
                });
            }

            // --- Data Consolidation ---
            function consolidateInvoiceData(orders) {
                const invoiceMap = new Map();

                orders.forEach(order => {
                    const keyInfo = getConsolidationKey(order);
                    if (!keyInfo) return;

                    const { key: consolidationKey, type: displayKeyType } = keyInfo;
                    
                    // Use start and end dates from the first order found in the group for non-INV groups
                    const shipmentOrderDate = order.ORDER_DATE || null;
                    const invoiceDateForDisplay = order.INVOICE_DATE || null; 
                    let dateForSorting = invoiceDateForDisplay || shipmentOrderDate || null;
                    
                    if (!dateForSorting) return;

                    const orderTotal = parseFloat(order.TOTAL) || 0;
                    
                    // Console log for records where consolidation was not by INV_NUMBER
                    if (displayKeyType !== 'INV') {
                         console.warn(`Record [Ref: ${order.REFERANCE}] consolidated using ${displayKeyType}. Key: ${consolidationKey}`);
                    }
                    
                    const newSortingDate = new Date(dateForSorting);

                    if (invoiceMap.has(consolidationKey)) {
                        const invoice = invoiceMap.get(consolidationKey);
                        // Consolidate TOTAL
                        invoice.TOTAL += orderTotal;
                        
                        // Keep the earliest valid INVOICE_DATE for the consolidated group's display (if one exists)
                        if (invoiceDateForDisplay && (!invoice.INVOICE_DATE || new Date(invoiceDateForDisplay) < new Date(invoice.INVOICE_DATE))) {
                            invoice.INVOICE_DATE = invoiceDateForDisplay;
                        }
                        
                        // Track earliest and latest shipment dates for the group
                        if (shipmentOrderDate && (!invoice.START_DATE || new Date(shipmentOrderDate) < new Date(invoice.START_DATE))) {
                            invoice.START_DATE = shipmentOrderDate;
                        }
                        if (shipmentOrderDate && (!invoice.END_DATE || new Date(shipmentOrderDate) > new Date(invoice.END_DATE))) {
                            invoice.END_DATE = shipmentOrderDate;
                        }

                        // Keep the latest date for sorting (to ensure the group shows up high if it contains a recent order)
                         if (newSortingDate > new Date(invoice.DATE_FOR_SORTING)) {
                            invoice.DATE_FOR_SORTING = dateForSorting;
                        }

                    } else {
                        invoiceMap.set(consolidationKey, {
                            CONSOLIDATION_KEY: consolidationKey,
                            KEY_TYPE: displayKeyType,
                            INV_NUMBER: order.INV_NUMBER || null,
                            INVOICE_ID: order.INVOICE_ID || null,
                            CODE: order.CODE,
                            BRANCH: order.BRANCH,
                            INVOICE_DATE: invoiceDateForDisplay, // Only the actual Invoice Date (can be null)
                            DATE_FOR_SORTING: dateForSorting, // Best available date for sorting only
                            START_DATE: shipmentOrderDate, // For UnBilled groups: earliest shipment date
                            END_DATE: shipmentOrderDate,   // For UnBilled groups: latest shipment date
                            TOTAL: orderTotal,
                            CARRIER: order.CARRIER 
                        });
                    }
                });

                // Convert map to array and sort by DATE_FOR_SORTING descending (newer first)
                const invoices = Array.from(invoiceMap.values());
                
                invoices.sort((a, b) => {
                    const dateA = a.DATE_FOR_SORTING ? new Date(a.DATE_FOR_SORTING) : new Date(0);
                    const dateB = b.DATE_FOR_SORTING ? new Date(b.DATE_FOR_SORTING) : new Date(0);
                    return dateB - dateA;
                });
                
                return invoices;
            }


            // --- Data Initialization ---
            function initializePageWithData(eventOrData) {
                // Check if data is nested under event.detail.data or is the data itself (from cache)
                const appData = eventOrData.detail ? eventOrData.detail.data : eventOrData;
                
                if (!appData || !appData.ORDERS) {
                    ui.statusMessage.textContent = 'Could not find invoice data.';
                    console.error("Invalid data provided to initializePageWithData:", appData);
                    return;
                }
                try {
                    allShipments = appData.ORDERS;
                    
                    // NEW: Populate B2B Map
                    if (appData.B2B && Array.isArray(appData.B2B)) {
                        appData.B2B.forEach(client => {
                            if (client.CODE) {
                                b2bDataMap.set(client.CODE, client);
                            }
                        });
                    }
                    
                    // 1. Consolidate raw shipments into invoices
                    consolidatedInvoices = consolidateInvoiceData(allShipments);

                    populateFilters(consolidatedInvoices);
                    setupFilterListeners();
                    applyFilters(); // Initial render
                    ui.statusMessage.textContent = ''; // Clear loading message
                } catch (error) { ui.statusMessage.textContent = 'Failed to process data.'; console.error("Data processing error:", error); }
            }

            // --- RESTORED: Initial Data Load Logic ---
            // Listen for data loaded from layout.js
            window.addEventListener('appDataLoaded', initializePageWithData);
            window.addEventListener('appDataRefreshed', initializePageWithData);

            // Try to load data from cache immediately
            const appDataJSON = localStorage.getItem('appData');
            if (appDataJSON) {
                try {
                    const appData = JSON.parse(appDataJSON);
                    // Assuming appData structure contains a 'data' key with the raw payload
                    // If data exists, attempt to initialize immediately
                    if (appData.data) {
                        console.log('Invoices.html: Loading initial data from cache.');
                        // Pass the raw data object to initializePageWithData
                        initializePageWithData(appData.data); 
                    }
                } catch (e) {
                    console.error('Invoices.html: Could not parse cached app data.', e);
                    ui.statusMessage.textContent = 'Error loading cached data. Waiting for server data...';
                }
            } else {
                ui.statusMessage.textContent = 'Waiting for server data...';
            }
            // --- END RESTORED ---


            // --- Filter Modal & Search Logic ---
            function populateFilters(invoices) {
                // Clear existing options except the first "All" option
                ui.filterBranch.length = 1; ui.filterCode.length = 1; ui.filterCarrier.length = 1;
                
                // Use consolidated invoice data for filter options
                const branches = [...new Set(invoices.map(i => i.BRANCH).filter(Boolean))];
                const codes = [...new Set(invoices.map(i => i.CODE).filter(Boolean))];
                const carriers = [...new Set(invoices.map(i => i.CARRIER).filter(Boolean))];
                
                branches.sort().forEach(val => ui.filterBranch.add(new Option(val, val)));
                codes.sort().forEach(val => ui.filterCode.add(new Option(val, val)));
                carriers.sort().forEach(val => ui.filterCarrier.add(new Option(val, val)));
            }

            function setupFilterListeners() {
                ui.searchShipments.addEventListener('input', applyFilters);
                ui.filterToggleBtn.addEventListener('click', () => ui.filterModal.classList.remove('hidden'));
                ui.applyFiltersBtn.addEventListener('click', () => { 
                    isUnbilledMode = false; // Disable unbilled mode if manually applying filters
                    ui.unbilledToggleBtn.classList.remove('filter-active');
                    applyFilters(); 
                    ui.filterModal.classList.add('hidden'); 
                });
                ui.resetFiltersBtn.addEventListener('click', () => { 
                    ui.filterStartDate.value = ''; ui.filterEndDate.value = ''; 
                    ui.filterBranch.value = ''; ui.filterCode.value = ''; ui.filterCarrier.value = ''; 
                    // Do NOT reset isUnbilledMode here, let applyFilters handle the logic
                    applyFilters(); 
                });
                // Close modal on overlay click
                ui.filterModal.addEventListener('click', (e) => { if (e.target === ui.filterModal) ui.filterModal.classList.add('hidden'); });
            }

            function applyFilters() {
                let startDate = ui.filterStartDate.value; let endDate = ui.filterEndDate.value;
                const branch = ui.filterBranch.value; const code = ui.filterCode.value; const carrier = ui.filterCarrier.value;
                const searchTerm = ui.searchShipments.value.toLowerCase();

                const isAnyManualFilterApplied = startDate || endDate || branch || code || carrier || searchTerm;
                let statusText = `Displaying {count} of ${consolidatedInvoices.length} records.`;
                
                // --- Primary Filtering: Billed vs Unbilled ---
                const filteredInvoices = consolidatedInvoices.filter(invoice => {
                    let typeMatch;
                    if (isUnbilledMode) {
                        typeMatch = invoice.KEY_TYPE !== 'INV'; // Show only non-INV groups (UnBilled)
                        statusText = `Displaying UnBilled Invoices: {count} of ${consolidatedInvoices.length} records.`;
                    } else {
                        typeMatch = invoice.KEY_TYPE === 'INV'; // Show only INV groups (Billed)
                    }

                    if (!typeMatch) return false;
                    
                    // --- Secondary Filtering: Manual Filters/Search ---
                    
                    // Date filtering is only applied if start or end date is set by the user
                    const filterDate = invoice.DATE_FOR_SORTING ? new Date(invoice.DATE_FOR_SORTING) : null; 
                    
                    let sdMatch = true; 
                    if (startDate && filterDate) sdMatch = filterDate >= new Date(startDate + 'T00:00:00Z');
                    
                    let edMatch = true; 
                    if (endDate && filterDate) edMatch = filterDate <= new Date(endDate + 'T23:59:59Z');
                    
                    // Field filtering
                    const bMatch = !branch || invoice.BRANCH === branch; 
                    const cMatch = !code || invoice.CODE === code; 
                    const carMatch = !carrier || invoice.CARRIER === carrier;
                    
                    // Search term filtering
                    const sMatch = !searchTerm || 
                                   (invoice.INV_NUMBER ? String(invoice.INV_NUMBER).toLowerCase().includes(searchTerm) : false) || 
                                   (invoice.INVOICE_ID ? String(invoice.INVOICE_ID).toLowerCase().includes(searchTerm) : false) || 
                                   (invoice.CODE ? String(invoice.CODE).toLowerCase().includes(searchTerm) : false) || 
                                   (invoice.BRANCH ? String(invoice.BRANCH).toLowerCase().includes(searchTerm) : false);
                                   
                    return sdMatch && edMatch && bMatch && cMatch && carMatch && sMatch;
                });

                renderInvoiceList(filteredInvoices);
                
                // If any manual filter is applied, override the status message to show full count.
                if (isAnyManualFilterApplied && !isUnbilledMode) {
                     statusText = `Displaying Billed Invoices: {count} of ${consolidatedInvoices.length} records.`;
                }

                if(ui.statusMessage) ui.statusMessage.textContent = statusText.replace('{count}', filteredInvoices.length);
                else console.log(statusText.replace('{count}', filteredInvoices.length));
                
                // --- Mobile/Desktop View Logic ---
                if (isMobileView()) {
                    ui.shipmentListPane.classList.remove('hidden');
                    ui.shipmentDetailPane.classList.add('hidden');
                    
                    // If the selected item is no longer in view, clear the ref
                    if (currentSelectedRef && !filteredInvoices.find(i => i.CONSOLIDATION_KEY === currentSelectedRef)) {
                        currentSelectedRef = null;
                        showDetailView(false);
                    }
                    
                } else {
                    if (currentSelectedRef) {
                        const currentInvoice = filteredInvoices.find(i => i.CONSOLIDATION_KEY === currentSelectedRef);
                        if (currentInvoice) {
                            // Re-render the details for the current selection
                            handleInvoiceSelection(currentSelectedRef, ui.shipmentList.querySelector(`li[data-ref="${currentSelectedRef}"]`));
                        } else {
                            currentSelectedRef = null;
                            showDetailView(false);
                        }
                    } else {
                        showDetailView(false);
                    }
                }
            }

            // --- Render Invoice List (Left Pane) ---
            function renderInvoiceList(invoices) {
                ui.shipmentList.innerHTML = '';
                if (invoices.length === 0) { 
                    ui.shipmentList.innerHTML = `<li class="text-center text-gray-500 border-none hover:bg-transparent cursor-default">No invoices match filters.</li>`; 
                    return; 
                }
                
                invoices.forEach((invoice) => {
                    const consolidationKey = invoice.CONSOLIDATION_KEY; 
                    if (!consolidationKey) return;
                    
                    const invNum = invoice.INV_NUMBER; 
                    const invID = invoice.INVOICE_ID || 'N/A';
                    const code = invoice.CODE || 'N/A';
                    const branch = invoice.BRANCH || 'N/A';
                    const total = (invoice.TOTAL || 0).toFixed(2);
                    
                    // Display Logic: Use only INVOICE_DATE for display, and show N/A if null.
                    const dtObj = invoice.INVOICE_DATE ? new Date(invoice.INVOICE_DATE) : null;
                    const dt = dtObj ? dtObj.toLocaleDateString('en-IN', { timeZone: 'UTC', day: '2-digit', month: 'short', year: 'numeric'}) : 'N/A';
                    
                    // Use a constant color for the total badge
                    const scolor = 'bg-indigo-100 text-indigo-700'; 

                    let primaryDisplay;
                    let secondaryDisplay;

                    if (invoice.KEY_TYPE === 'INV') {
                        primaryDisplay = `INV#: ${invNum}`;
                        secondaryDisplay = `ID: ${invID} | ${code} - ${branch}`;
                    } else if (invoice.KEY_TYPE === 'ID') {
                        primaryDisplay = `[UnBilled ID] ID: ${invID}`;
                        secondaryDisplay = `${code} - ${branch}`;
                    } else { // MONTH
                        // Extract the generated month part from the key (e.g., 'MONTH-AGWL-202501' -> AGWL 2025/01)
                        const keyParts = consolidationKey.split('-');
                        const monthYear = keyParts.length > 2 ? keyParts[keyParts.length - 1] : 'N/A';
                        const year = monthYear.substring(0, 4);
                        const month = monthYear.substring(4, 6);
                        
                        primaryDisplay = `[UnBilled Month] ${code} (${month}/${year})`;
                        secondaryDisplay = `Branch: ${branch} | ID: ${invID}`;
                    }
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>${primaryDisplay}</strong>
                        <span class="client-info">${secondaryDisplay}</span>
                        <div class="details-info">
                            <span>Date: ${dt}</span>
                            <span class="status-badge ${scolor}">Total: ₹${total}</span>
                        </div>`;
                    li.dataset.ref = consolidationKey; // Use the new generated key
                    li.addEventListener('click', () => handleInvoiceSelection(consolidationKey, li));
                    
                    if(String(consolidationKey) === String(currentSelectedRef)) li.classList.add('selected'); 
                    ui.shipmentList.appendChild(li);
                });
            }

            // --- NEW: Render Invoice Details Card (Top Card) ---
            function renderInvoiceDetailsCard(invoice) {
                const b2b = b2bDataMap.get(invoice.CODE);
                
                // --- Left Side: Customer Details ---
                const clientName = b2b?.CLIENT_NAME || invoice.CODE;
                const mobile = b2b?.MOBILE_NUMBER || 'N/A';
                const address = b2b?.BILLING_ADDRESS || 'N/A';
                const landmark = b2b?.BILLING_LANDMARK || '';
                const pincode = b2b?.BILLING_PINCODE || 'N/A';
                const city = b2b?.BILLING_CITY || 'N/A';
                const state = b2b?.BILLING_STATE || 'N/A';
                const gst = b2b?.ID_GST_PAN_ADHAR || 'N/A';

                const leftContent = `
                    <div class="space-y-2 text-sm">
                        <div class="font-bold text-lg text-indigo-700">${clientName}</div>
                        <div class="text-gray-600">${mobile}</div>
                        <div class="text-gray-700">
                            ${address}${landmark ? ', ' + landmark : ''}<br>
                            ${pincode}, ${city}, ${state}
                        </div>
                        <div class="pt-2 text-xs text-gray-500">GST/ID: ${gst}</div>
                    </div>
                `;

                // --- Right Side: Invoice Dates ---
                const invNum = invoice.INV_NUMBER || 'N/A';
                const invDate = invoice.INVOICE_DATE ? formatDateForDisplay(invoice.INVOICE_DATE) : 'N/A';
                
                // Start/End dates are only relevant for UnBilled groups (Key Type is not 'INV')
                const startDate = invoice.KEY_TYPE !== 'INV' ? (invoice.START_DATE ? formatDateForDisplay(invoice.START_DATE) : 'N/A') : 'N/A';
                const endDate = invoice.KEY_TYPE !== 'INV' ? (invoice.END_DATE ? formatDateForDisplay(invoice.END_DATE) : 'N/A') : 'N/A';

                const rightContent = `
                    <div class="space-y-2 text-sm p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex justify-between"><span class="text-gray-500">Invoice No:</span><span class="font-semibold text-gray-800">${invNum}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Invoice Date:</span><span class="font-semibold text-gray-800">${invDate}</span></div>
                        <hr class="border-gray-100">
                        <div class="flex justify-between"><span class="text-gray-500">Start Date:</span><span class="font-medium text-gray-700">${startDate}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">End Date:</span><span class="font-medium text-gray-700">${endDate}</span></div>
                    </div>
                `;

                const header = `<div class="detail-card-header"><h3 class="font-semibold text-gray-700">Invoice Details</h3></div>`;
                
                // Card Body with responsive 3:1 layout (md:grid-cols-4)
                const body = `
                    <div class="detail-card-body">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div class="md:col-span-3">${leftContent}</div>
                            <div class="md:col-span-1">${rightContent}</div>
                        </div>
                    </div>
                `;

                ui.invoiceDetailsCardContainer.innerHTML = header + body;
            }
            
            // --- New Rendering Function for Shipments Table (Table 1) ---
            function renderShipmentDetailsTable(shipments, consolidationKey) {
                const totalShipments = shipments.length;
                let h_body = '';

                if (totalShipments === 0) {
                    h_body = `<p class="text-sm text-gray-500 p-4">No individual shipments found for this invoice group.</p>`;
                } else {
                    // Desktop Table View (visible > md)
                    h_body += `<div class="overflow-x-auto border rounded-md hidden md:block">
                                    <table id="shipmentListTable" class="min-w-full text-xs divide-y divide-gray-200">
                                        <thead class="bg-gray-50 sticky top-0">
                                            <tr>
                                                <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase">Order Date</th>
                                                <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase">AWB / Carrier</th>
                                                <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase">Origin City</th>
                                                <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase">Mode / Pcs</th>
                                                <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase">Dest. City (Pin)</th>
                                                <th class="px-3 py-2 text-right font-medium text-gray-500 uppercase">Chg Wt (kg)</th>
                                                <th class="px-3 py-2 text-right font-medium text-gray-500 uppercase">Fright (₹)</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">`;
                    
                    shipments.forEach(s => { 
                        const orderDate = formatDateForDisplay(s.ORDER_DATE); 
                        const awbCarrier = `${s.AWB_NUMBER || 'N/A'} / ${s.CARRIER || 'N/A'}`;
                        const modePieces = `${s.MODE || 'N/A'} / ${s.PIECS || 0}`;
                        const dest = `${s.DEST_CITY || 'N/A'} (${s.DEST_PINCODE || 'N/A'})`;
                        const chgWt = (s.CHG_WT !== undefined && s.CHG_WT !== null) ? parseFloat(s.CHG_WT).toFixed(2) : 'N/A';
                        const fright = (s.FRIGHT !== undefined && s.FRIGHT !== null) ? parseFloat(s.FRIGHT).toFixed(2) : 'N/A';

                        h_body += `<tr>
                            <td class="px-3 py-2 whitespace-nowrap">${orderDate}</td>
                            <td class="px-3 py-2">${awbCarrier}</td>
                            <td class="px-3 py-2">${s.ORIGIN_CITY || 'N/A'}</td>
                            <td class="px-3 py-2">${modePieces}</td>
                            <td class="px-3 py-2">${dest}</td>
                            <td class="px-3 py-2 text-right">${chgWt}</td>
                            <td class="px-3 py-2 text-right">${fright}</td>
                        </tr>`; 
                    }); 

                    h_body += `</tbody></table></div>`; 
                    
                    // Mobile Card View (visible < md)
                    h_body += `<div class="md:hidden space-y-3">`;
                    shipments.forEach(s => {
                         const orderDate = formatDateForDisplay(s.ORDER_DATE); 
                         const chgWt = (s.CHG_WT !== undefined && s.CHG_WT !== null) ? parseFloat(s.CHG_WT).toFixed(2) : 'N/A';
                         const fright = (s.FRIGHT !== undefined && s.FRIGHT !== null) ? parseFloat(s.FRIGHT).toFixed(2) : 'N/A';
                        
                         h_body += `<div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm text-sm space-y-1">
                                <div class="font-semibold text-gray-800 flex justify-between items-center">
                                    <span>AWB: ${s.AWB_NUMBER || 'N/A'}</span>
                                    <span class="text-xs font-normal text-indigo-600">${s.CARRIER || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between border-t border-gray-100 pt-1">
                                    <span class="text-gray-500">Order Date:</span>
                                    <span>${orderDate}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Origin / Dest.:</span>
                                    <span class="text-right">${s.ORIGIN_CITY || 'N/A'} -> ${s.DEST_CITY || 'N/A'} (${s.DEST_PINCODE || 'N/A'})</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Mode / Pieces:</span>
                                    <span>${s.MODE || 'N/A'} / ${s.PIECS || 0}</span>
                                </div>
                                <div class="flex justify-between pt-1 font-medium border-t border-dashed border-gray-200">
                                    <span class="text-gray-600">Charged Wt / Freight:</span>
                                    <span>${chgWt} kg / ₹${fright}</span>
                                </div>
                            </div>`;
                    });
                    h_body += `</div>`;
                }

                // --- ADDED PRINT BUTTON HTML ---
                const header = `<div class="detail-card-header flex justify-between items-center">
                                    <h3 class="font-semibold text-gray-700">Selected Invoice List and Freight (Shipments: ${totalShipments})</h3>
                                    <button id="printInvoiceBtn" 
                                            data-key="${consolidationKey}"
                                            class="px-3 py-1 text-sm font-medium bg-indigo-600 text-white rounded-md hover:bg-indigo-700 flex items-center gap-1 transition-all">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2v5H5v-5h2m0-3V9a3 3 0 013-3h2a3 3 0 013 3v5m-3 0h3m-6 0H6"></path></svg>
                                        Print Invoice
                                    </button>
                                </div>`;
                
                ui.shipmentDetailsTableContainer.innerHTML = `${header}<div class="detail-card-body">${h_body}</div>`;
            }

            // --- NEW Rendering Function for Summary Table (Table 2) ---
            function renderSummaryTable(shipments) {
                let totalFreight = 0;
                let totalOtherCharges = 0;
                let totalGST = 0;
                let grandTotal = 0;

                shipments.forEach(s => {
                    totalFreight += parseFloat(s.FRIGHT || 0);
                    
                    // Sum of Other Charges
                    totalOtherCharges += parseFloat(s.FUEL_CHG || 0);
                    totalOtherCharges += parseFloat(s.COD_CHG || 0);
                    totalOtherCharges += parseFloat(s.TOPAY_CHG || 0);
                    totalOtherCharges += parseFloat(s.FOV_CHG || 0);
                    totalOtherCharges += parseFloat(s.EWAY_CHG || 0);
                    totalOtherCharges += parseFloat(s.AWB_CHG || 0);
                    totalOtherCharges += parseFloat(s.PACK_CHG || 0);
                    totalOtherCharges += parseFloat(s.DEV_CHG || 0);

                    // Sum of GST
                    totalGST += parseFloat(s.SGST || 0);
                    totalGST += parseFloat(s.CGST || 0);
                    totalGST += parseFloat(s.IGST || 0);

                    // Sum of Grand Total
                    grandTotal += parseFloat(s.TOTAL || 0);
                });

                // Prepare data rows
                const data = [
                    { label: 'Freight', value: totalFreight, color: 'text-gray-700' },
                    { label: 'Other Charges', value: totalOtherCharges, color: 'text-gray-700' },
                    { label: 'GST', value: totalGST, color: 'text-gray-700' },
                    { label: 'GRAND TOTAL', value: grandTotal, isTotal: true, color: 'text-indigo-700' }
                ];

                let h_body = '';

                // Desktop Table View (visible > md)
                h_body += `<div class="overflow-x-auto hidden md:block">
                                <table class="min-w-full text-sm divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left font-medium text-gray-500 uppercase">Charge Type</th>
                                            <th class="px-4 py-2 text-right font-medium text-gray-500 uppercase">Amount (₹)</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">`;

                data.forEach(item => {
                    const rowClasses = item.isTotal ? 'bg-indigo-50 font-bold' : 'text-gray-700';
                    const amount = item.value.toFixed(2);
                    
                    h_body += `<tr class="${rowClasses}">
                        <td class="px-4 py-2 whitespace-nowrap ${item.color}">${item.label}</td>
                        <td class="px-4 py-2 text-right ${item.color}">${amount}</td>
                    </tr>`;
                });

                h_body += `</tbody></table></div>`;
                
                // Mobile Card View (visible < md)
                h_body += `<div class="md:hidden space-y-1">`;
                data.forEach(item => {
                    const cardClasses = item.isTotal ? 'bg-indigo-50 font-bold border-indigo-200' : 'bg-white border-gray-200';
                    const labelClasses = item.isTotal ? 'text-indigo-700' : 'text-gray-500';
                    const valueClasses = item.isTotal ? 'text-xl text-indigo-700' : 'text-lg text-gray-800';
                    const amount = item.value.toFixed(2);

                    h_body += `<div class="flex justify-between items-center p-3 border rounded-lg ${cardClasses}">
                        <span class="${labelClasses} text-sm">${item.label}</span>
                        <span class="${valueClasses}">₹${amount}</span>
                    </div>`;
                });
                h_body += `</div>`;


                ui.summaryTableContainer.innerHTML = `
                    <div class="detail-card-header">
                        <h3 class="font-semibold text-gray-700">Other Charges and Taxes (Consolidated)</h3>
                    </div>
                    <div class="detail-card-body">${h_body}</div>`;
            }
            
            // --- Selection Handler ---
            function handleInvoiceSelection(consolidationKey, selectedLi) {
                currentSelectedRef = consolidationKey; 
                
                // Update selected styles in the list
                ui.shipmentList.querySelectorAll('li.selected').forEach(li => li.classList.remove('selected'));
                if (selectedLi) selectedLi.classList.add('selected');
                
                // 1. Get the consolidated invoice object for customer/date info
                const invoice = consolidatedInvoices.find(i => i.CONSOLIDATION_KEY === consolidationKey);
                
                // 2. Get the list of shipments associated with this key
                const associatedShipments = getShipmentsForInvoice(consolidationKey);

                // 3. RENDER NEW CARD
                renderInvoiceDetailsCard(invoice);

                // 4. Render the Shipment Details table (This creates the Print button HTML)
                renderShipmentDetailsTable(associatedShipments, consolidationKey);
                
                // 5. Render the Charges Summary table
                renderSummaryTable(associatedShipments);
                
                // 6. Attach Print button handler (must be done after DOM is updated by step 4)
                const printBtn = document.getElementById('printInvoiceBtn');
                if (printBtn) {
                    const key = printBtn.dataset.key;
                    printBtn.onclick = () => {
                        // Call the stubbed generateDocument function with 'INVOICE' type and the consolidation key
                        generateDocument('INVOICE', key);
                    };
                }

                // 7. Make sure the detail view is visible
                showDetailView(true);
            }

            // --- Utility function for date formatting (kept for filter logic) ---
            function formatDateForDisplay(dateInput) {
                 if (!dateInput) return 'N/A';
                 let date;
                 try {
                     // 1. Try DD/MM/YYYY HH:MM:SS format first
                     if (typeof dateInput === 'string' && dateInput.includes('/') && dateInput.includes(':')) {
                         const parts = dateInput.split(' ');
                         const dateParts = parts[0].split('/');
                         const timeParts = parts[1] ? parts[1].split(':') : ['0', '0', '0'];
                         date = new Date(Date.UTC(
                             parseInt(dateParts[2], 10), // year
                             parseInt(dateParts[1], 10) - 1, // monthIndex
                             parseInt(dateParts[0], 10), // day
                             parseInt(timeParts[0], 10) || 0, 
                             parseInt(timeParts[1], 10) || 0, 
                             parseInt(timeParts[2], 10) || 0 
                         ));
                     }
                     // 2. Try ISO format (e.g., "2023-10-27T10:00:00.000Z")
                     else if (typeof dateInput === 'string' && dateInput.includes('T') && dateInput.includes('Z')) {
                         date = new Date(dateInput);
                     }
                      // 3. Try number format (Excel Serial Date)
                     else if (typeof dateInput === 'number' || (typeof dateInput === 'string' && !isNaN(parseFloat(dateInput)) && isFinite(parseFloat(dateInput)))) {
                         const serial = parseFloat(dateInput);
                          const utc_days = Math.floor(serial - 25569);
                          const utc_value = utc_days * 86400; // seconds
                          date = new Date(utc_value * 1000); // milliseconds
                     }
                     // 4. Try generic parsing as a fallback
                     else {
                         date = new Date(dateInput);
                     }

                     if (isNaN(date.getTime())) {
                         console.warn("formatDateForDisplay: Invalid date value:", dateInput);
                         return 'Invalid Date';
                     }
                     
                     const year = date.getUTCFullYear();
                     const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                     const day = String(date.getUTCDate()).padStart(2, '0');
                     return `${year}-${month}-${day}`;
                 } catch (e) {
                     console.error("formatDateForDisplay: Error parsing date:", dateInput, e);
                     return 'Error Date';
                 }
             }

        });
    </script>
</body>
</html>
