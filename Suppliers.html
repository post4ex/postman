<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Page Title updated to Supplier -->
    <title>Supplier Management - Postman</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Styles are identical to Customer.html, no changes needed here */
        body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top: 4px solid #4338ca; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .readonly-input { background-color: #f3f4f6; cursor: not-allowed; }
        .form-input {
            border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; transition: border-color 0.2s; width: 100%; font-size: 0.875rem; /* text-sm */
        }
        .form-input:focus { outline: none; border-color: #3b82f6; }
        .rate-input { text-align: right; padding: 0.3rem 0.5rem; width: 60px; /* Fixed width */ appearance: textfield; /* Remove number spinners */ margin: 0;}
        .rate-input::-webkit-outer-spin-button,
        .rate-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .rate-header { font-size: 0.75rem; /* text-xs */ font-weight: 600; text-align: center; padding: 0.4rem 0.2rem; background-color: #f9fafb; border: 1px solid #e5e7eb; white-space: nowrap; }
        .rate-label-col { font-size: 0.75rem; font-weight: 500; text-align: left; padding: 0.4rem 0.5rem; border: 1px solid #e5e7eb; background-color:#f9fafb; white-space: nowrap;}
        .rate-data-cell { border: 1px solid #e5e7eb; padding: 1px; /* Minimal padding */ text-align: center; }

        .tab-button { padding: 0.5rem 1rem; border: 1px solid transparent; border-bottom: none; cursor: pointer; font-weight: 500; transition: all 0.2s; background-color: #f3f4f6; color: #6b7280; border-top-left-radius: 0.375rem; border-top-right-radius: 0.375rem;}
        .tab-button.active { border-color: #d1d5db; background-color: white; border-bottom: 1px solid white; margin-bottom: -1px; z-index: 10; color: #1e3a8a; }
        .tab-button:disabled { cursor: not-allowed; color: #9ca3af; background-color: #e5e7eb;}

        .tab-content { border: 1px solid #d1d5db; border-top: none; padding: 1.5rem; background-color: white; border-bottom-left-radius: 0.375rem; border-bottom-right-radius: 0.375rem;}

        /* Sticky header for rate table */
        #rateTableContainer thead th { position: sticky; top: 0; z-index: 5; }
        /* Sticky first columns for rate table */
         #rateTableContainer tbody td:nth-child(1),
         #rateTableContainer tbody td:nth-child(2) { position: sticky; left: 0; z-index: 1; background-color: #f9fafb; }
         #rateTableContainer tbody td:nth-child(2) { left: 80px; } /* Adjust based on actual width */
         
         #rateTableContainer thead th:nth-child(1),
         #rateTableContainer thead th:nth-child(2) { position: sticky; left: 0; z-index: 6; }
         #rateTableContainer thead th:nth-child(2) { left: 80px; } /* Match tbody */

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="header-placeholder"></div>

    <div class="flex flex-col md:flex-row flex-grow w-full md:h-[calc(100vh-88px)]">
        <!-- Left Sidebar for Supplier List -->
        <aside id="supplierListContainer" class="w-full md:w-1/3 lg:w-1/4 bg-white border-r flex flex-col">
            <div class="p-4 border-b sticky top-0 bg-white z-20">
                <div class="flex justify-between items-center">
                    <!-- Text updated to Supplier -->
                    <h2 class="text-xl font-bold text-gray-800">Suppliers</h2>
                    <button id="newSupplierBtn" class="text-sm bg-indigo-100 text-indigo-700 font-semibold py-1 px-3 rounded-lg hover:bg-indigo-200 transition-colors">New</button>
                </div>
                <input type="text" id="searchSupplier" placeholder="Search by Name or Code..." class="mt-2 w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="overflow-y-auto flex-grow">
                <ul id="supplierList" class="p-4 space-y-2">
                    <!-- Text updated to Supplier -->
                    <li id="supplierLoader" class="text-center text-gray-500">Loading suppliers...</li>
                </ul>
            </div>
        </aside>

        <!-- Main Content Area for the Form -->
        <main id="supplierFormContainer" class="w-full md:w-2/3 lg:w-3/4 p-6 md:p-8 overflow-y-auto hidden md:block bg-gray-50">
             <!-- Mobile: Back to List Button -->
             <div class="p-4 border-b md:hidden bg-white -mt-6 -mx-6 mb-6 sticky top-0 z-10">
                 <button type="button" id="backToListBtn" class="text-sm bg-gray-200 text-gray-800 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300 flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Back to List
                </button>
            </div>

            <div class="w-full mx-auto bg-white rounded-lg shadow-lg p-6">
                <!-- Text updated to Supplier -->
                <h1 id="formTitle" class="text-2xl font-bold text-gray-900 mb-4 text-center">Manage Supplier</h1>
                <div id="responseMessage" class="mb-4 text-center p-3 rounded-lg text-sm hidden"></div>

                <!-- Tabs -->
                <div class="flex border-b border-gray-300 mb-0">
                    <!-- Text updated to Supplier -->
                    <button id="tabSupplierDetails" class="tab-button active">Supplier Details</button>
                    <button id="tabRateList" class="tab-button" disabled>Rate List</button>
                    <div class="flex-grow"></div> <!-- Fills the remaining space -->
                </div>

                <!-- Supplier Details Tab Content -->
                <div id="contentSupplierDetails" class="tab-content">
                    <form id="supplierForm" class="space-y-5">
                         <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="md:col-span-1">
                                <label for="code" class="block text-sm font-medium text-gray-700 mb-1">Code*</label>
                                <input type="text" name="CODE" id="code" required class="form-input uppercase" placeholder="e.g., SUPP01">
                            </div>
                             <div class="md:col-span-3">
                                <!-- Field name/id updated to SUPP_NAME -->
                                <label for="supp_name" class="block text-sm font-medium text-gray-700 mb-1">Supplier Name*</label>
                                <input type="text" name="SUPP_NAME" id="supp_name" required class="form-input" placeholder="Full legal name">
                            </div>
                            <div class="md:col-span-1">
                                <label for="mobile_number" class="block text-sm font-medium text-gray-700 mb-1">Mobile</label>
                                <input type="tel" name="MOBILE_NUMBER" id="mobile_number" class="form-input">
                            </div>
                            <div class="md:col-span-3">
                                <!-- Field name/id updated to SUPP_EMAIL -->
                                <label for="supp_email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" name="SUPP_EMAIL" id="supp_email" class="form-input" placeholder="primary@example.com">
                            </div>
                            <div class="md:col-span-4">
                                <!-- Field name/id updated to SUPP_ADDRESS -->
                                <label for="supp_address" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                <input type="text" name="SUPP_ADDRESS" id="supp_address" class="form-input">
                            </div>
                            <div class="md:col-span-1">
                                <!-- Field name/id updated to SUPP_LANDMARK -->
                                <label for="supp_landmark" class="block text-sm font-medium text-gray-700 mb-1">Landmark</label>
                                <input type="text" name="SUPP_LANDMARK" id="supp_landmark" class="form-input">
                            </div>
                             <div class="md:col-span-1">
                                <!-- Field name/id updated to SUPP_PINCODE -->
                                <label for="supp_pincode" class="block text-sm font-medium text-gray-700 mb-1">Pincode</label>
                                <input type="text" name="SUPP_PINCODE" id="supp_pincode" class="form-input" maxlength="6">
                            </div>
                             <div class="md:col-span-1">
                                <!-- Field name/id updated to SUPP_CITY -->
                                <label for="supp_city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                <input type="text" name="SUPP_CITY" id="supp_city" class="form-input">
                            </div>
                             <div class="md:col-span-1">
                                <!-- Field name/id updated to SUPP_STATE -->
                                <label for="supp_state" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                                <input type="text" name="SUPP_STATE" id="supp_state" class="form-input">
                            </div>
                             <div class="md:col-span-2">
                                <!-- Field name/id updated to SUPP_ID_GST_PAN_ADHAR -->
                                <label for="supp_id_gst_pan_adhar" class="block text-sm font-medium text-gray-700 mb-1">GST / PAN / Adhar</label>
                                <input type="text" name="SUPP_ID_GST_PAN_ADHAR" id="supp_id_gst_pan_adhar" class="form-input">
                            </div>
                            <div class="md:col-span-1">
                                <label for="branch" class="block text-sm font-medium text-gray-700 mb-1">Branch*</label>
                                <input type="text" name="BRANCH" id="branch" required class="form-input uppercase" placeholder="e.g., DDN">
                            </div>
                            <div class="md:col-span-1">
                                <label for="bill_cycle" class="block text-sm font-medium text-gray-700 mb-1">Bill Cycle</label>
                                <select name="BILL_CYCLE" id="bill_cycle" class="form-input">
                                    <option value="W">Weekly (W)</option>
                                    <option value="F">Fortnightly (F)</option>
                                    <option value="M">Monthly (M)</option>
                                    <option value="E">End (E)</option>
                                </select>
                            </div>
                        </div>
                        <h3 class="text-md font-semibold text-indigo-600 mt-5 mb-3 border-t pt-4">Charges & Settings</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 items-end">
                            <div>
                                <label for="weight_change" class="block text-sm font-medium text-gray-700 mb-1">Weight Change</label>
                                <input type="number" step="any" name="WEIGHT_CHANGE" id="weight_change" class="form-input" placeholder="e.g., 2">
                            </div>
                             <div>
                                <label for="pct_topay_if" class="block text-sm font-medium text-gray-700 mb-1">% TO-PAY</label>
                                <input type="number" step="0.001" min="0" name="%_TOPAY_IF" id="pct_topay_if" class="form-input" placeholder="e.g., 0.03">
                            </div>
                             <div>
                                <label for="pct_cod_if" class="block text-sm font-medium text-gray-700 mb-1">% COD</label>
                                <input type="number" step="0.001" min="0" name="%_COD_IF" id="pct_cod_if" class="form-input" placeholder="e.g., 0.005">
                            </div>
                            <div>
                                <label for="pct_fov_if" class="block text-sm font-medium text-gray-700 mb-1">% FOV</label>
                                <input type="number" step="0.001" min="0" name="%_FOV_IF" id="pct_fov_if" class="form-input" placeholder="e.g., 0.02">
                            </div>
                             <div>
                                <label for="eway_if" class="block text-sm font-medium text-gray-700 mb-1">E-Way Charge</label>
                                <input type="number" step="any" min="0" name="EWAY_IF" id="eway_if" class="form-input" placeholder="e.g., 10">
                            </div>
                             <div>
                                <label for="awb_charges" class="block text-sm font-medium text-gray-700 mb-1">AWB Charge</label>
                                <input type="number" step="any" min="0" name="AWB_CHARGES" id="awb_charges" class="form-input" placeholder="e.g., 0">
                            </div>
                            <div>
                                <label for="fuel_charges" class="block text-sm font-medium text-gray-700 mb-1">Fuel Charge %</label>
                                <input type="number" step="any" min="0" name="FUEL_CHARGES" id="fuel_charges" class="form-input" placeholder="e.g., 0.125">
                            </div>
                            <div>
                                <label for="dev_charges" class="block text-sm font-medium text-gray-700 mb-1">Dev. Charge %</label>
                                <input type="number" step="any" min="0" name="DEV_CHARGES" id="dev_charges" class="form-input" placeholder="e.g., 0.05">
                            </div>
                        </div>

                        <!-- Meta Data (Readonly & Hidden) -->
                        <div class="mt-5 border-t pt-4 hidden">
                            <h3 class="text-md font-semibold text-gray-500 mb-3">Meta Data</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" name="TIMESTAMP" id="timestamp" placeholder="Last Modified" class="form-input readonly-input" readonly>
                                <input type="text" name="USER_NAME" id="user_name" placeholder="Modified By" class="form-input readonly-input" readonly>
                            </div>
                        </div>

                        <!-- Supplier Form Action Buttons -->
                        <div class="mt-6 flex justify-center items-center gap-4 flex-wrap border-t pt-6">
                            <button type="submit" id="submitSupplierButton" class="text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-8 py-3 text-center flex items-center justify-center disabled:bg-indigo-400">
                                <!-- Text updated to Supplier -->
                                <span id="supplierButtonText">Save Supplier</span>
                                <div id="supplierSpinner" class="spinner hidden ml-3"></div>
                            </button>
                            <button type="button" id="deleteSupplierButton" class="hidden text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-8 py-3 text-center flex items-center justify-center disabled:bg-red-400">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                <!-- Text updated to Supplier -->
                                <span>Delete Supplier</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Rate List Tab Content -->
                <div id="contentRateList" class="tab-content hidden">
                    <!-- Text updated to Supplier -->
                    <h2 class="text-lg font-semibold text-indigo-600 mb-4">Rate List for <span id="rateListSupplierCode" class="font-bold"></span></h2>
                    <form id="rateForm">
                        <!-- Rate Table Container -->
                        <div id="rateTableContainer" class="overflow-x-auto relative border rounded-md max-h-[60vh]"><!-- Added max-height -->
                            <p id="rateLoader" class="text-center p-4 text-gray-500">Loading rates...</p>
                            <!-- Table will be generated here by JS -->
                        </div>
                         <!-- Rate Form Action Buttons -->
                        <div class="mt-6 flex justify-center items-center gap-4 flex-wrap border-t pt-6">
                            <button type="submit" id="submitRatesButton" class="text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-8 py-3 text-center flex items-center justify-center disabled:bg-green-400">
                                <span id="ratesButtonText">Save All Rates</span>
                                <div id="ratesSpinner" class="spinner hidden ml-3"></div>
                            </button>
                        </div>
                    </form>
                </div>

            </div> <!-- End Card -->
        </main>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal-overlay hidden">
        <div class="modal-content relative card text-center max-w-md">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Confirm Deletion</h2>
            <!-- Text updated to Supplier -->
            <p class="text-gray-600 mb-6">Are you sure you want to delete supplier <strong id="supplierToDelete" class="font-bold"></strong> and all associated rates? This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDeleteBtn" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300">Cancel</button>
                <button id="confirmDeleteBtn" class="px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 flex items-center disabled:bg-red-400">
                    <span>Confirm Delete</span>
                    <div id="deleteSpinner" class="spinner hidden ml-3" style="width: 20px; height: 20px;"></div>
                </button>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="layout.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwcZAkvu9JAxVpVeWT5pTOi6j2yEbJuFb48B-pweCG5BWZNLhbVYXP9Rzm_v6iXmdUGrw/exec';

        // --- STATE (variables renamed to supplier) ---
        let allSuppliers = []; // SUPPLIER list
        let allModes = [];     // MODE list
        let allRates = [];     // RATELISTS data
        let currentSupplierCode = null;
        let isUpdateMode = false;

        const staticWeights = ['0.5', '0.5A'];
        const dynamicWeights = ['3', '10', '25', '50', '100', '500', '1000', '2000', '5000', '10000'];

        // --- UI ELEMENTS (variables renamed to supplier) ---
        const ui = {
            // Containers & Views
            supplierListContainer: document.getElementById('supplierListContainer'),
            supplierFormContainer: document.getElementById('supplierFormContainer'),
            contentSupplierDetails: document.getElementById('contentSupplierDetails'),
            contentRateList: document.getElementById('contentRateList'),
            rateTableContainer: document.getElementById('rateTableContainer'),
            // Forms & Loaders
            supplierForm: document.getElementById('supplierForm'),
            rateForm: document.getElementById('rateForm'),
            supplierLoader: document.getElementById('supplierLoader'),
            rateLoader: document.getElementById('rateLoader'),
            // Supplier List
            supplierList: document.getElementById('supplierList'),
            searchSupplierInput: document.getElementById('searchSupplier'),
            newSupplierBtn: document.getElementById('newSupplierBtn'),
            backToListBtn: document.getElementById('backToListBtn'),
             // Supplier Form Fields (subset)
            formTitle: document.getElementById('formTitle'),
            codeInput: document.getElementById('code'),
            supplierNameInput: document.getElementById('supp_name'),
            supplierPincodeInput: document.getElementById('supp_pincode'),
            supplierCityInput: document.getElementById('supp_city'),
            supplierStateInput: document.getElementById('supp_state'),
             // Tabs
            tabSupplierDetails: document.getElementById('tabSupplierDetails'),
            tabRateList: document.getElementById('tabRateList'),
            rateListSupplierCodeSpan: document.getElementById('rateListSupplierCode'),
             // Buttons & Spinners
            submitSupplierButton: document.getElementById('submitSupplierButton'),
            supplierButtonText: document.getElementById('supplierButtonText'),
            supplierSpinner: document.getElementById('supplierSpinner'),
            deleteSupplierButton: document.getElementById('deleteSupplierButton'),
            submitRatesButton: document.getElementById('submitRatesButton'),
            ratesButtonText: document.getElementById('ratesButtonText'),
            ratesSpinner: document.getElementById('ratesSpinner'),
            // Delete Modal
            deleteModal: document.getElementById('deleteModal'),
            supplierToDeleteSpan: document.getElementById('supplierToDelete'),
            cancelDeleteBtn: document.getElementById('cancelDeleteBtn'),
            confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
            deleteSpinner: document.getElementById('deleteSpinner'),
            // Global Response Message
            responseMessage: document.getElementById('responseMessage'),
        };

        // --- PINCODE FETCH FUNCTION ---
        async function fetchPincodeDetails(pincode) {
            if (!pincode || pincode.length !== 6) return;
            
            ui.supplierCityInput.value = 'Fetching...';
            ui.supplierStateInput.value = '';
            ui.supplierCityInput.disabled = true;
            ui.supplierStateInput.disabled = true;

            try {
                const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
                if (!response.ok) throw new Error('Network response was not ok.');
                
                const data = await response.json();

                if (data && data[0] && data[0].Status === 'Success') {
                    const postOffice = data[0].PostOffice[0];
                    ui.supplierCityInput.value = postOffice.District || '';
                    ui.supplierStateInput.value = postOffice.State || '';
                    
                    if (!ui.responseMessage.classList.contains('hidden')) {
                         ui.responseMessage.classList.add('hidden');
                    }
                } else {
                    ui.supplierCityInput.value = '';
                    ui.supplierStateInput.value = '';
                    console.warn('Pincode not found:', data[0].Message);
                    showResponseMessage(`Pincode ${pincode} not found. Please check the number.`, 'error');
                }
            } catch (error) {
                console.error('Failed to fetch pincode:', error);
                ui.supplierCityInput.value = '';
                ui.supplierStateInput.value = '';
                showResponseMessage(`Error fetching pincode data: ${error.message}`, 'error');
            } finally {
                ui.supplierCityInput.disabled = false;
                ui.supplierStateInput.disabled = false;
            }
        }

        // --- VIEW LOGIC ---
        function isMobileView() { return window.innerWidth < 768; }

        function showFormView() {
            if (isMobileView()) {
                ui.supplierListContainer.classList.add('hidden');
                ui.supplierFormContainer.classList.remove('hidden', 'md:block');
                ui.supplierFormContainer.classList.add('block');
            }
             ui.supplierFormContainer.classList.remove('hidden');
        }

        function showListView() {
            resetFormsAndTabs();
            if (isMobileView()) {
                ui.supplierListContainer.classList.remove('hidden');
                ui.supplierFormContainer.classList.add('hidden');
                ui.supplierFormContainer.classList.remove('block');
            } else {
                 ui.supplierListContainer.classList.remove('hidden');
                 ui.supplierFormContainer.classList.remove('hidden');
            }
        }

        function handleResize() {
             if (!isMobileView()) {
                ui.supplierListContainer.classList.remove('hidden');
                ui.supplierFormContainer.classList.remove('hidden');
                ui.supplierFormContainer.classList.add('md:block');
            } else {
                 if (!ui.supplierFormContainer.classList.contains('hidden')) {
                    ui.supplierListContainer.classList.add('hidden');
                    ui.supplierFormContainer.classList.add('block');
                     ui.supplierFormContainer.classList.remove('md:block');
                } else {
                     ui.supplierListContainer.classList.remove('hidden');
                    ui.supplierFormContainer.classList.add('hidden');
                     ui.supplierFormContainer.classList.remove('block');
                }
            }
        }
        window.addEventListener('resize', handleResize);

        // --- TAB SWITCHING ---
        function switchTab(activeTab) {
            const isDetailsActive = activeTab === 'details';
            ui.tabSupplierDetails.classList.toggle('active', isDetailsActive);
            ui.tabRateList.classList.toggle('active', !isDetailsActive);
            ui.contentSupplierDetails.classList.toggle('hidden', !isDetailsActive);
            ui.contentRateList.classList.toggle('hidden', isDetailsActive);

            if (!isDetailsActive && currentSupplierCode && !ui.tabRateList.disabled) {
                generateRateForm(currentSupplierCode);
            }
        }

        ui.tabSupplierDetails.addEventListener('click', () => switchTab('details'));
        ui.tabRateList.addEventListener('click', () => {
            if (!ui.tabRateList.disabled) switchTab('rates');
        });

        // --- DATA LOADING & RENDERING ---
        function renderSupplierList(suppliers) {
            ui.supplierList.innerHTML = '';
            ui.supplierLoader.classList.remove('hidden');
            console.log('Rendering supplier list with:', suppliers);

            if (!suppliers || suppliers.length === 0) {
                 ui.supplierLoader.textContent = 'No matching suppliers.';
                return;
            }
            suppliers.sort((a, b) => (a.CODE || '').localeCompare(b.CODE || ''));

            suppliers.forEach(supplier => {
                if(!supplier.CODE) {
                     console.warn('Skipping supplier render due to missing CODE:', supplier);
                     return;
                 }

                const li = document.createElement('li');
                li.className = 'p-3 rounded-lg cursor-pointer hover:bg-indigo-50 transition-colors border border-gray-200';
                // JS updated to use SUPP_NAME
                li.innerHTML = `<strong class="text-indigo-700 block text-sm">${supplier.SUPP_NAME || 'Unnamed'}</strong><span class="text-xs text-gray-600">${supplier.CODE}</span>`;
                li.dataset.code = supplier.CODE;
                li.addEventListener('click', () => populateFormForEdit(supplier.CODE));
                ui.supplierList.appendChild(li);
            });
             ui.supplierLoader.classList.add('hidden');
        }

        function handleDataLoaded(event) {
            const appData = event.detail.data;
            console.log('handleDataLoaded received appData:', appData);
            let suppliersLoaded = false, modesLoaded = false, ratesLoaded = false;

            // JS updated to read from appData.SUPPLIER
            if (appData && appData.SUPPLIER && Array.isArray(appData.SUPPLIER)) {
                console.log('Found SUPPLIER data:', appData.SUPPLIER.length, 'suppliers');
                allSuppliers = appData.SUPPLIER;
                renderSupplierList(allSuppliers);
                suppliersLoaded = true;
            } else {
                ui.supplierLoader.textContent = 'No SUPPLIER data found in appData.';
                console.warn("Expected 'SUPPLIER' array not found or not an array in appData.", appData);
            }

            if (appData && appData.MODE) {
                allModes = appData.MODE;
                modesLoaded = true;
            } else {
                console.warn("MODE data not found in appData.");
            }

            if (appData && appData.RATES && Array.isArray(appData.RATES)) {
                allRates = appData.RATES;
                ratesLoaded = true;
                 console.log('Found RATES data:', appData.RATES.length, 'rates');
            } else {
                 console.warn("Expected 'RATES' array not found in appData. Using empty array.", appData);
                 allRates = [];
            }

            if (currentSupplierCode && !ui.contentRateList.classList.contains('hidden') && (modesLoaded || ratesLoaded)) {
                 generateRateForm(currentSupplierCode);
            }
        }
        
        window.addEventListener('appDataLoaded', handleDataLoaded);
        window.addEventListener('appDataRefreshed', handleDataLoaded);

        // --- FORM LOGIC ---
        function populateFormForEdit(code) {
            const supplier = allSuppliers.find(c => c.CODE === code);
            if (!supplier) {
                 showResponseMessage(`Supplier with code ${code} not found.`, 'error');
                 return;
            };
            resetFormsAndTabs();

            currentSupplierCode = code;
            isUpdateMode = true;

            for (const key in supplier) {
                const input = ui.supplierForm.querySelector(`[name="${key}"]`);
                 if (input) {
                    if ((key === 'TIMESTAMP' || key === 'TIME_STAMP') && supplier[key]) {
                         try { input.value = new Date(supplier[key]).toLocaleString(); } catch(e){ input.value = supplier[key]; }
                    }
                    else {
                        input.value = supplier[key] || '';
                    }
                }
            }

            ui.codeInput.value = code;
            ui.codeInput.readOnly = true;
            ui.codeInput.classList.add('readonly-input');
            ui.formTitle.textContent = `Edit Supplier: ${code}`;
            ui.supplierButtonText.textContent = `Update Supplier`;
            ui.deleteSupplierButton.classList.remove('hidden');
            ui.tabRateList.disabled = false;
            ui.rateListSupplierCodeSpan.textContent = code;

            showFormView();
            switchTab('details');
        }

        function resetFormsAndTabs() {
            ui.supplierForm.reset();
            ui.rateForm.reset();
            ui.rateTableContainer.innerHTML = `<p id="rateLoader" class="text-center p-4 text-gray-500">Select or save a supplier to view/edit rates.</p>`;

            currentSupplierCode = null;
            isUpdateMode = false;

            ui.codeInput.readOnly = false;
            ui.codeInput.classList.remove('readonly-input');
            ui.formTitle.textContent = 'Create New Supplier';
            ui.supplierButtonText.textContent = 'Submit New Supplier';
            ui.deleteSupplierButton.classList.add('hidden');
            ui.tabRateList.disabled = true;
            ui.responseMessage.classList.add('hidden');
            ui.rateListSupplierCodeSpan.textContent = '';


            switchTab('details');
        }

        // --- RATE LIST FORM GENERATION ---
        function generateRateForm(supplierCode) {
             if (!supplierCode) return;
            ui.rateListSupplierCodeSpan.textContent = supplierCode;
            ui.rateLoader.textContent = "Generating rate table...";
            ui.rateLoader.classList.remove('hidden');
            ui.rateTableContainer.innerHTML = '';

            if (!allModes || allModes.length === 0) {
                 ui.rateTableContainer.innerHTML = '<p class="text-center p-4 text-red-500">Error: Mode list not available.</p>';
                 ui.rateLoader.classList.add('hidden');
                 return;
            }
            
            const supplierRates = allRates.filter(rate => rate.CODE === supplierCode);
            
            const rateMap = supplierRates.reduce((acc, rate) => {
                if(rate.UID) acc[rate.UID.trim()] = rate;
                return acc;
            }, {});

            const table = document.createElement('table');
            table.className = 'w-full text-xs border-collapse table-fixed';

            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            const headersInfo = [
                { text: 'Mode', width: 'w-24' },
                { text: 'Wt', width: 'w-16' },
            ];

             headersInfo.forEach((info, index) => {
                const th = document.createElement('th');
                th.textContent = info.text;
                th.className = `rate-header sticky top-0 ${info.width}`;
                let leftOffset = 0;
                if (index === 1) leftOffset = 96; 
                th.style.left = `${leftOffset}px`;
                th.style.zIndex = '6';
                headerRow.appendChild(th);
            });

            for (let i = 1; i <= 14; i++) {
                const th = document.createElement('th');
                th.textContent = `Z${i}`;
                th.className = 'rate-header w-16';
                headerRow.appendChild(th);
            }

            const tbody = table.createTBody();

            const addRateRow = (modeName, modeShortCode, weight, branchCode) => {
                const row = tbody.insertRow();
                const uid = `${supplierCode}${modeShortCode}${weight}`;
                const existingRate = rateMap[uid];

                const labelsInfo = [
                    { value: modeName, width: headersInfo[0].width },
                    { value: weight, width: headersInfo[1].width, isWeight: true },
                ];

                labelsInfo.forEach((info, index) => {
                     const cell = row.insertCell();
                     cell.className = `rate-label-col sticky ${info.width}`;
                     cell.textContent = info.value;
                     let leftOffset = 0;
                     if (index === 1) leftOffset = 96;
                     cell.style.left = `${leftOffset}px`;
                     cell.style.zIndex = '1';
                     
                     if (info.isWeight) { 
                         cell.classList.add('text-gray-600');
                         
                         const hiddenUid = document.createElement('input'); 
                         hiddenUid.type='hidden'; 
                         hiddenUid.name=`rate_${uid}_UID`; 
                         hiddenUid.value=uid; 
                         cell.appendChild(hiddenUid);
                         
                         const hiddenService = document.createElement('input'); 
                         hiddenService.type='hidden'; 
                         hiddenService.name=`rate_${uid}_Service`; 
                         hiddenService.value=modeName; 
                         cell.appendChild(hiddenService);
                         
                         const hiddenWeight = document.createElement('input'); 
                         hiddenWeight.type='hidden'; 
                         hiddenWeight.name=`rate_${uid}_Weight`; 
                         hiddenWeight.value=weight; 
                         cell.appendChild(hiddenWeight);
                         
                         const hiddenBranch = document.createElement('input'); 
                         hiddenBranch.type='hidden'; 
                         hiddenBranch.name=`rate_${uid}_Branch`; 
                         hiddenBranch.value = branchCode || ''; 
                         cell.appendChild(hiddenBranch);
                         
                         const hiddenShortCode = document.createElement('input'); 
                         hiddenShortCode.type='hidden'; 
                         hiddenShortCode.name=`rate_${uid}_ServiceShortCode`; 
                         hiddenShortCode.value = modeShortCode || ''; 
                         cell.appendChild(hiddenShortCode);
                         
                         const hiddenType = document.createElement('input'); 
                         hiddenType.type='hidden'; 
                         hiddenType.name=`rate_${uid}_TYPE`; 
                         // **CRITICAL CHANGE**: Set rate type to SUPPLIER
                         hiddenType.value = 'SUPPLIER'; 
                         cell.appendChild(hiddenType);
                     }
                });

                for (let i = 1; i <= 14; i++) {
                    const cell = row.insertCell();
                    cell.className = 'rate-data-cell';
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = 'any';
                    input.name = `rate_${uid}_Z${i}`;
                    input.className = 'form-input rate-input w-full';
                    input.value = existingRate && existingRate[`Z${i}`] !== undefined ? existingRate[`Z${i}`] : '';
                    input.placeholder = `Z${i}`;
                    cell.appendChild(input);
                }
            };

            const currentSupplier = allSuppliers.find(c => c.CODE === supplierCode);
            const supplierBranch = currentSupplier ? currentSupplier.BRANCH : '';

             allModes.forEach(mode => {
                const modeName = mode.MODE;
                const shortCode = mode.SHORT;
                if (!shortCode) return;

                const weightsToUse = (modeName.toLowerCase() === 'express' || modeName.toLowerCase() === 'premium')
                                    ? staticWeights
                                    : dynamicWeights;

                 const uidShortCode = (modeName.toLowerCase() === 'express') ? 'E' : (modeName.toLowerCase() === 'premium') ? 'P' : shortCode;

                weightsToUse.forEach(weight => {
                    addRateRow(modeName, uidShortCode, weight, supplierBranch);
                });
            });

            ui.rateTableContainer.appendChild(table);
            ui.rateLoader.classList.add('hidden');
        }


        // --- EVENT LISTENERS (updated for supplier) ---
        ui.searchSupplierInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allSuppliers.filter(c =>
                (c.SUPP_NAME || '').toLowerCase().includes(searchTerm) ||
                (c.CODE || '').toLowerCase().includes(searchTerm)
            );
            renderSupplierList(filtered);
        });

        ui.supplierPincodeInput.addEventListener('input', (e) => {
            const pincode = e.target.value.trim();
            if (pincode.length === 6) {
                fetchPincodeDetails(pincode);
            }
        });

        ui.newSupplierBtn.addEventListener('click', () => {
            resetFormsAndTabs();
            showFormView();
        });

        ui.backToListBtn.addEventListener('click', showListView);

        ui.deleteSupplierButton.addEventListener('click', () => {
            if (!currentSupplierCode) return;
            const name = ui.supplierNameInput.value || currentSupplierCode;
            ui.supplierToDeleteSpan.textContent = `${name} (${currentSupplierCode})`;
            ui.deleteModal.classList.remove('hidden');
        });

        ui.cancelDeleteBtn.addEventListener('click', () => ui.deleteModal.classList.add('hidden'));

        ui.confirmDeleteBtn.addEventListener('click', () => {
             if (!currentSupplierCode) return;
             handleRequest(
                'supplier', // **CRITICAL CHANGE**: type set to 'supplier'
                'delete',
                { CODE: currentSupplierCode },
                ui.deleteSpinner,
                ui.confirmDeleteBtn,
                null,
                () => {
                     ui.deleteModal.classList.add('hidden');
                     showListView();
                },
                 () => {
                     ui.deleteModal.classList.add('hidden');
                 }
             );
        });

        ui.supplierForm.addEventListener('submit', (e) => {
            e.preventDefault();
             handleRequest(
                 'supplier', // **CRITICAL CHANGE**: type set to 'supplier'
                 'submit',
                 ui.supplierForm,
                 ui.supplierSpinner,
                 ui.submitSupplierButton,
                 ui.supplierButtonText,
                 (responseData) => {
                    if (!isUpdateMode && responseData && responseData.CODE) {
                        currentSupplierCode = responseData.CODE;
                        ui.codeInput.value = currentSupplierCode;
                        ui.codeInput.readOnly = true;
                        ui.codeInput.classList.add('readonly-input');
                        ui.formTitle.textContent = `Edit Supplier: ${currentSupplierCode}`;
                        ui.supplierButtonText.textContent = `Update Supplier`;
                        ui.deleteSupplierButton.classList.remove('hidden');
                        ui.tabRateList.disabled = false;
                        ui.rateListSupplierCodeSpan.textContent = currentSupplierCode;
                        isUpdateMode = true;
                    } else if (isUpdateMode && responseData && responseData.CODE) {
                         currentSupplierCode = responseData.CODE;
                         ui.tabRateList.disabled = false;
                         ui.rateListSupplierCodeSpan.textContent = currentSupplierCode;
                    }
                 }
            );
        });

        ui.rateForm.addEventListener('submit', (e) => {
             e.preventDefault();
             if (!currentSupplierCode) {
                 showResponseMessage("No supplier selected.", "error");
                 return;
             }

             const ratesPayload = [];
             const rateInputs = ui.rateForm.querySelectorAll('input[type="number"], input[type="hidden"]');
             const ratesGroupedByUID = {};

             rateInputs.forEach(input => {
                 const nameParts = input.name.split('_');
                 if (nameParts.length < 3 || nameParts[0] !== 'rate') return;
                 const uid = nameParts[1];
                 const field = nameParts.slice(2).join('_');
                 if (!ratesGroupedByUID[uid]) ratesGroupedByUID[uid] = { UID: uid };

                if (field.startsWith('Z') && !isNaN(parseInt(field.substring(1)))) {
                    const numValue = parseFloat(input.value);
                    ratesGroupedByUID[uid][field] = (isNaN(numValue) || input.value === null || input.value === '' || input.value === undefined) ? null : numValue;
                } else {
                    ratesGroupedByUID[uid][field] = (input.value === null || input.value === undefined) ? '' : input.value;
                }
             });

             for (const uid in ratesGroupedByUID) {
                 const rateData = ratesGroupedByUID[uid];
                 let hasValue = false;
                 for (let i = 1; i <= 14; i++) {
                    if (rateData[`Z${i}`] !== null) {
                         hasValue = true;
                         break;
                     }
                 }
                 
                 if (hasValue) {
                     ratesPayload.push(rateData);
                 }
             }

             if (ratesPayload.length === 0) {
                 showResponseMessage("No rate data entered. Nothing to save.", "warning");
                 return;
             }

             const submitData = {
                 code: currentSupplierCode,
                 branch: ui.supplierForm.querySelector('[name="BRANCH"]').value || '',
                 rates: ratesPayload
             };

             handleRequest(
                 'ratelist', // This remains 'ratelist'
                 'submit',
                 submitData,
                 ui.ratesSpinner,
                 ui.submitRatesButton,
                 ui.ratesButtonText
             );
        });


        // --- CORE NETWORK REQUEST FUNCTION ---
        async function handleRequest(type, action, dataOrForm, spinner, button, buttonTextSpan, successCallback, errorCallback) {

            let submitData;
             if (dataOrForm instanceof HTMLFormElement) {
                 submitData = {};
                 new FormData(dataOrForm).forEach((value, key) => { submitData[key] = value; });
             } else {
                 submitData = dataOrForm;
             }

             const loginDataJSON = localStorage.getItem('loginData');
             const loginData = loginDataJSON ? JSON.parse(loginDataJSON) : null;
             const auth = {
                 code: loginData?.CODE || loginData?.code,
                 token: loginData?.TOKEN || loginData?.token
             };

             if (!auth.code || !auth.token) {
                 showResponseMessage('Authentication error. Please log in again.', 'error');
                 return;
             }

            if(spinner) spinner.classList.remove('hidden');
            if(button) button.disabled = true;
            const originalButtonText = buttonTextSpan ? buttonTextSpan.textContent : '';
            if(buttonTextSpan) buttonTextSpan.textContent = 'Processing...';


            const payload = {
                auth: auth,
                data: submitData,
                action: action,
                type: type // This will be 'supplier' or 'ratelist'
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    mode: 'cors',
                });

                if (!response.ok) throw new Error(`Network error: ${response.status} ${response.statusText}`);
                const result = await response.json();
                if (result.error) throw new Error(result.message || 'Unknown script error.');

                showResponseMessage(result.message || 'Operation successful.', 'success', result.data);

                const isWrite = (action === 'submit' || action === 'delete');
                 if (isWrite && window.verifyAndFetchAppData) {
                    await window.verifyAndFetchAppData(true); // Force refresh data cache
                }

                if (successCallback) successCallback(result.data);


            } catch (error) {
                showResponseMessage(error.message, 'error');
                 if(errorCallback) errorCallback(error);

            } finally {
                 if(spinner) spinner.classList.add('hidden');
                 if(button) button.disabled = false;
                 if(buttonTextSpan) buttonTextSpan.textContent = originalButtonText;
            }
        }

        // --- UI HELPER ---
         function showResponseMessage(message, type, data = null) {
            let content = `<p class="font-semibold">${message}</p>`;

            ui.responseMessage.innerHTML = content;
            ui.responseMessage.className = `my-4 text-center p-3 rounded-lg text-sm ${type === 'success' ? 'bg-green-100 text-green-800' : type === 'error' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`;
            ui.responseMessage.classList.remove('hidden');
        }

        // --- INITIALIZE ---
        resetFormsAndTabs();
        handleResize();
        
        // --- INITIAL LOAD FROM CACHE (updated for supplier) ---
        const appDataJSON = localStorage.getItem('appData');
         if (appDataJSON) {
             try {
                 const cachedData = JSON.parse(appDataJSON).data;
                 console.log('Initial load from cache:', cachedData);
                 handleDataLoaded({ detail: { data: cachedData } });
             } catch (e) { console.error("Error parsing cached appData", e); }
         }

    });
    </script>
</body>
</html>
