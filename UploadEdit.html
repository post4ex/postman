<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit/Delete Uploads - Postman</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Reusing styles similar to Suppliers/Customer page */
        body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top: 4px solid #4338ca; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .readonly-input { background-color: #f3f4f6; cursor: not-allowed; opacity: 0.7; }
        .form-input {
            border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem;
            font-size: 0.875rem; width: 100%; transition: border-color 0.2s;
        }
        .form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 1px #4f46e5; }
        .form-label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: #374151; }

        /* --- NEW: Styles for Order List (like Clients.html) --- */
        #miniOrderList li {
            padding: 0.75rem; /* p-3 */
            border-radius: 0.5rem; /* rounded-lg */
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid #e5e7eb; /* border-gray-200 */
            line-height: 1.4;
        }
        #miniOrderList li.selected { 
            background-color: #e0e7ff; /* bg-indigo-100 */
            font-weight: 500;
            border-color: #c7d2fe; /* border-indigo-200 */
        }
        #miniOrderList li:hover { 
            background-color: #eef2ff; /* bg-indigo-50 */
        }
        #miniOrderList li strong { 
            color: #4338ca; /* text-indigo-700 */
            display: block; 
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* semibold */
        }
        #miniOrderList .client-info { 
            font-size: 0.75rem; /* text-xs */
            color: #6b7280; /* text-gray-500 */
        }
        #miniOrderList .details-info { 
            font-size: 0.75rem; /* text-xs */
            color: #4b5563; /* text-gray-600 */
            margin-top: 4px; /* mt-1 */
            display: block;
        }

        #loadMoreBtn {
            display: block; width: 100%; text-align: center; padding: 6px; font-size: 0.8rem;
            color: #4f46e5; background-color: #eef2ff; border: 1px solid #c7d2fe;
            border-radius: 0.375rem; margin-top: 0.5rem; margin-bottom: 1rem; cursor: pointer;
        }
         #loadMoreBtn:hover { background-color: #e0e7ff; }
         #loadMoreBtn:disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; }

        /* Styles for uploads table */
        #uploadsTableContainer { max-height: 300px; overflow-y: auto; }
        #uploadsTable th, #uploadsTable td { padding: 0.5rem; font-size: 0.8rem; }
        #uploadsTable tbody tr { cursor: pointer; transition: background-color 0.1s; }
        #uploadsTable tbody tr:hover { background-color: #f3f4f6; }
        #uploadsTable tbody tr.selected { background-color: #bfdbfe; font-weight: 500; }
        #uploadsTable img { max-height: 40px; max-width: 60px; object-fit: contain; }

         /* Make form grid responsive */
        #editForm { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1rem; }
        @media (min-width: 768px) {
            #editForm { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
         @media (min-width: 1024px) {
            #editForm { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <div id="header-placeholder"></div>

    <div class="flex flex-col md:flex-row flex-grow w-full md:h-[calc(100vh-88px)]">
        
        <!-- Left Sidebar for Order List -->
        <aside id="orderListContainer" class="w-full md:w-1/3 lg:w-1/4 bg-white border-r flex flex-col">
            <div class="p-4 border-b sticky top-0 bg-white z-10">
                <h2 class="text-xl font-bold text-gray-800 mb-3">Select Order</h2>
                <input type="text" id="searchMiniOrder" placeholder="Filter by AWB, Ref, Client, Dest..." class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="overflow-y-auto flex-grow">
                <ul id="miniOrderList" class="p-4 space-y-2">
                    <li id="orderLoader" class="text-center text-gray-500 border-none hover:bg-transparent cursor-default">Loading orders...</li>
                </ul>
                <button id="loadMoreBtn" style="display: none;" class="mx-4">Load More (Older)</button>
            </div>
        </aside>

        <!-- Main Content Area for Uploads & Form -->
        <main id="editFormMainContainer" class="w-full md:w-2/3 lg:w-3/4 p-6 md:p-8 overflow-y-auto bg-gray-50">
            
            <!-- Response Message Area -->
            <div id="response-message" class="hidden mb-4"></div>

            <div class="space-y-6">
                <!-- Uploads Table -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700">Associated Uploads</h2>
                    <div id="uploadsTableContainer" class="border rounded-md overflow-hidden">
                        <table id="uploadsTable" class="w-full text-left">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">Identifier</th>
                                    <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                    <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                    <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">File</th>
                                </tr>
                            </thead>
                            <tbody id="uploadsTableBody" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="6" class="text-center text-gray-500 p-4">Select an order from the list on the left.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Edit Form -->
                <div id="editFormContainer" class="bg-white p-4 rounded-lg shadow hidden">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700">Edit Upload Details</h2>
                    <form id="editForm"> <!-- Removed space-y-4, using grid gap -->
                        <!-- Hidden input to store the primary identifier for update/delete -->
                        <input type="hidden" id="edit-identifier">
                        <input type="hidden" id="edit-upload-type">
                            <input type="hidden" id="edit-file-url-hidden"> <!-- Store original URL -->

                        <!-- Read-only fields -->
                        <div>
                            <label for="edit-reference" class="form-label">Reference</label>
                            <input type="text" id="edit-reference" class="form-input readonly-input" readonly>
                        </div>
                        <div>
                            <label for="edit-file-url" class="form-label">File URL</label>
                            <input type="text" id="edit-file-url" class="form-input readonly-input" readonly>
                            <a id="view-file-link" href="#" target="_blank" class="text-sm text-blue-600 hover:underline mt-1 inline-block">View File</a>
                        </div>

                        <!-- Standard Fields (visibility controlled by JS) -->
                        <div id="field-awb-number">
                            <label for="edit-awb-number" class="form-label">AWB Number</label>
                            <input type="text" id="edit-awb-number" class="form-input">
                        </div>
                            <div id="field-child-awb">
                            <label for="edit-child-awb" class="form-label">Child AWB</label>
                            <input type="text" id="edit-child-awb" class="form-input">
                        </div>
                        <div id="field-customer-uid">
                            <label for="edit-customer-uid" class="form-label">Customer UID</label>
                            <input type="text" id="edit-customer-uid" class="form-input">
                        </div>
                        <div id="field-status-remark">
                            <label for="edit-status-remark" class="form-label">Status Remark</label>
                            <input type="text" id="edit-status-remark" class="form-input">
                        </div>

                        <!-- KYC Fields -->
                        <div id="field-kyc-number">
                            <label for="edit-kyc-number" class="form-label">KYC Number</label>
                            <input type="text" id="edit-kyc-number" class="form-input">
                        </div>
                        <div id="field-kyc-type">
                            <label for="edit-kyc-type" class="form-label">KYC Type</label>
                            <select id="edit-kyc-type" class="form-input">
                                <optgroup label="Individual">
                                    <option value="Aadhaar Card">Aadhaar Card</option>
                                    <option value="PAN Card">PAN Card</option>
                                    <option value="Indian Passport">Indian Passport</option>
                                    <option value="Voter ID Card">Voter ID Card</option>
                                    <option value="Driving License">Driving License</option>
                                    <option value="NREGA Job Card">NREGA Job Card</option>
                                </optgroup>
                                <optgroup label="Business">
                                    <option value="Partnership Deed">Partnership Deed</option>
                                    <option value="Certificate of Incorporation">Certificate of Incorporation</option>
                                    <option value="GST Registration">GST Registration</option>
                                    <option value="MoA & AoA">MoA & AoA</option>
                                    <option value="Board Resolution">Board Resolution</option>
                                </optgroup>
                            </select>
                        </div>

                        <!-- Product Fields -->
                            <div id="field-doc-number">
                            <label for="edit-doc-number" class="form-label">Doc Number</label>
                            <input type="text" id="edit-doc-number" class="form-input">
                        </div>
                        <div id="field-doc-type">
                            <label for="edit-doc-type" class="form-label">Doc Type</label>
                            <select id="edit-doc-type" class="form-input">
                                <option value="INV">INV</option>
                                <option value="EWB">EWB</option>
                                <option value="CLN">CLN</option>
                                <option value="ADH">ADH</option>
                                <option value="DBT">DBT</option>
                                <option value="CDT">CDT</option>
                                <option value="HRD">HRD</option>
                                <option value="AGT">AGT</option>
                                <option value="INT">INT</option>
                            </select>
                        </div>
                    </form>
                    <!-- Action Buttons -->
                    <div class="mt-6 flex items-center justify-end gap-4">
                        <button id="delete-button" type="button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-150 ease-in-out text-sm font-medium flex items-center">
                            Delete
                            <span id="delete-spinner" class="spinner ml-2 hidden" style="width: 16px; height: 16px;"></span>
                        </button>
                        <button id="update-button" type="button" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-150 ease-in-out text-sm font-medium flex items-center">
                            Update
                            <span id="update-spinner" class="spinner ml-2 hidden" style="width: 16px; height: 16px;"></span>
                        </button>
                        <button id="cancel-edit-button" type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out text-sm font-medium">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="footer-placeholder"></div>

    <script src="layout.js"></script>
    <script>
        // --- Global Variables & State ---
        let allOrders = [];
        let allUploads = [];
        let allClientsB2B2C = []; // Still needed to get Consignor/Consignee names
        let currentOrderRef = null;
        let selectedUploadData = null; // Holds data of the row selected in uploadsTable
        let displayDays = 90; // For order list filtering
        const GSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwkC3OXNACPPH-LLPJyhkZKaDh6VtNgGbp8lMQbzz1XF327IN_OhFEEapOzNm3REbn5/exec';

        // --- UI Elements ---
        let ui = {}; // Object to hold UI element references

        // --- Data Handling ---
        const initializeData = (event) => {
            if (!event || !event.detail || !event.detail.data) {
                showResponseMessage('Error: Could not load initial application data.', 'error');
                console.error("Invalid data event received:", event);
                return;
            };

            const data = event.detail.data;
            console.log("App data received:", data);

            // Store data globally
            allOrders = Array.isArray(data.ORDERS) ? data.ORDERS : [];
            allUploads = Array.isArray(data.UPLOADS) ? data.UPLOADS : [];
            allClientsB2B2C = Array.isArray(data.B2B2C) ? data.B2B2C : []; // Keep this

            // Sort orders
            allOrders = allOrders
                .filter(order => order && order.ORDER_DATE)
                .sort((a, b) => new Date(b.ORDER_DATE) - new Date(a.ORDER_DATE));
            
            // Initial render
            filterAndRenderOrders(); // Render the orders list
            
            // Re-select item if one was active before refresh
            if (currentOrderRef) {
                let li = ui.orderList.querySelector(`li[data-order-ref="${currentOrderRef}"]`);
                handleOrderSelection(currentOrderRef, li);
            } else {
                 resetEditForm(); // Ensure form is hidden initially if no order selected
            }
            showResponseMessage('Data loaded. Select an order from the list on the left.', 'info');
        };

        // --- List Rendering Functions ---

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                     if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                         return dateString; // Return as-is if it's already YYYY-MM-DD
                     }
                    console.warn("formatDate: Invalid date string received:", dateString);
                    return 'Invalid Date';
                }
                // --- MODIFICATION: Use UTC methods to avoid timezone shift ---
                const year = date.getUTCFullYear();
                const month = String(date.getUTCMonth() + 1).padStart(2, '0'); // getUTCMonth() is 0-indexed
                const day = String(date.getUTCDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                console.error("formatDate: Error parsing date:", dateString, e);
                return 'Error Date';
            }
        }

        const renderMiniOrderList = (ordersToRender) => {
            ui.orderList.innerHTML = ''; // Clear list
            if (!ordersToRender || ordersToRender.length === 0) {
                ui.orderList.innerHTML = '<li class="text-center text-gray-500 border-none hover:bg-transparent cursor-default">No matching orders found.</li>';
                ui.loadMoreBtn.style.display = 'none';
                return;
            }

            ordersToRender.forEach((order) => {
                const ref = order.REFERANCE; if (!ref) return;
                const displayAwb = order.AWB_NUMBER || 'No AWB';
                const consignor = allClientsB2B2C.find(c => c.UID === order.CONSIGNOR)?.NAME || 'Unknown';
                const consignee = allClientsB2B2C.find(c => c.UID === order.CONSIGNEE)?.NAME || 'Unknown';
                const date = formatDate(order.ORDER_DATE);

                const li = document.createElement('li');
                // NEW LI Structure (matches style)
                li.innerHTML = `<strong>${displayAwb}</strong>
                                <span class="client-info">${consignor} -> ${consignee}</span>
                                <span class="details-info">Ref: ${ref} | Date: ${date}</span>`;
                li.dataset.orderRef = ref;
                li.addEventListener('click', () => handleOrderSelection(ref, li));
                
                if(String(ref) === String(currentOrderRef)) {
                    li.classList.add('selected');
                }
                ui.orderList.appendChild(li);
            });

            // Load More button logic
            const searchTerm = ui.searchMiniOrderInput.value.toLowerCase();
            const totalFilteredCount = filterOrdersBySearchTerm(searchTerm, allOrders).length;
            ui.loadMoreBtn.style.display = (ordersToRender.length < totalFilteredCount) ? 'block' : 'none';
            if(ui.loadMoreBtn.style.display === 'block'){
                ui.loadMoreBtn.disabled = false;
                ui.loadMoreBtn.textContent = `Load More (${ordersToRender.length}/${totalFilteredCount})`;
            }
        };

        // --- Filtering Functions ---

        function filterOrdersBySearchTerm(searchTerm, orders) {
             if (!searchTerm) return orders;
             return orders.filter(order => {
                const consignorName = allClientsB2B2C.find(c => c.UID === order.CONSIGNOR)?.NAME || '';
                const consigneeName = allClientsB2B2C.find(c => c.UID === order.CONSIGNEE)?.NAME || '';
                const dest = order.DEST_CITY || '';
                const date = formatDate(order.ORDER_DATE).toLowerCase();
                 return (order.REFERANCE ? String(order.REFERANCE).toLowerCase().includes(searchTerm) : false) ||
                        (order.AWB_NUMBER ? String(order.AWB_NUMBER).toLowerCase().includes(searchTerm) : false) ||
                        (consignorName ? consignorName.toLowerCase().includes(searchTerm) : false) ||
                        (consigneeName ? consigneeName.toLowerCase().includes(searchTerm) : false) ||
                        (dest ? dest.toLowerCase().includes(searchTerm) : false) ||
                        (date ? date.includes(searchTerm) : false);
             });
        }
        
        function filterOrdersByDate(orders) {
            const cutoffDate = new Date();
             cutoffDate.setDate(cutoffDate.getDate() - displayDays);
             cutoffDate.setHours(0, 0, 0, 0);
             if (!Array.isArray(orders)) return [];
             return orders.filter(order => {
                 const orderDate = order.ORDER_DATE ? new Date(order.ORDER_DATE) : null;
                 return orderDate && orderDate >= cutoffDate;
             });
        }
        
        function filterAndRenderOrders() {
            const searchTerm = ui.searchMiniOrderInput.value.toLowerCase();
            let searchFiltered = filterOrdersBySearchTerm(searchTerm, allOrders);
            let dateFiltered = filterOrdersByDate(searchFiltered);
            renderMiniOrderList(dateFiltered);
        }
        
        // --- Selection Handlers ---

        const handleOrderSelection = (orderRef, selectedLi) => {
            console.log("Order selected:", orderRef);
            currentOrderRef = orderRef;
            selectedUploadData = null; // Clear selected upload when order changes

            ui.orderList.querySelectorAll('li.selected').forEach(li => li.classList.remove('selected'));
            if(selectedLi) selectedLi.classList.add('selected');

            // Filter and render uploads table
            const associatedUploads = allUploads.filter(upload => String(upload.REFERANCE) === String(orderRef));
            renderUploadsTable(associatedUploads);
            resetEditForm(); // Hide/clear the edit form
             showResponseMessage(`Showing ${associatedUploads.length} uploads for Order Ref: ${orderRef}. Select an upload to edit.`, 'info');
        };

        // --- Uploads Table Functions ---
        const renderUploadsTable = (uploads) => {
             console.log("Rendering uploads table with:", uploads);
            ui.uploadsTableBody.innerHTML = '';
            if (!uploads || uploads.length === 0) {
                ui.uploadsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">No uploads found for this selection.</td></tr>';
                return;
            }

            uploads.forEach(upload => {
                const tr = document.createElement('tr');
                 tr.dataset.identifier = (upload.UPLOAD_TYPE === 'KYC' ? upload.CUSTOMER_UID : upload.REFERANCE) || '';
                 tr.dataset.fileUrl = upload.FILE_URL || '';
                 tr.dataset.uploadType = upload.UPLOAD_TYPE || '';

                let identifierText = upload.AWB_NUMBER || upload.KYC_NUMBER || upload.REFERANCE;
                let details = '';
                if(upload.UPLOAD_TYPE === 'MultiBox') details = `Child: ${upload.CHILD_AWB || 'N/A'}`;
                else if(upload.UPLOAD_TYPE === 'KYC') details = `${upload.CUSTOMER_UID || 'N/A'} (${upload.KYC_TYPE || 'N/A'})`;
                 else if(upload.UPLOAD_TYPE === 'Product') details = `${upload.DOC_NUMBER || 'N/A'} (${upload.DOC_TYPE || 'N/A'})`;
                else details = upload.STATUS_REMARK || 'N/A';

                tr.innerHTML = `
                    <td class="whitespace-nowrap">${upload.UPLOAD_TYPE || 'N/A'}</td>
                    <td class="whitespace-nowrap">${identifierText || 'N/A'}</td>
                    <td>${details}</td>
                    <td class="whitespace-nowrap">${formatDate(upload.DATE_TIME)}</td>
                    <td class="whitespace-nowrap">${upload.USER_NAME || 'N/A'}</td>
                    <td><a href="${upload.FILE_URL}" target="_blank" class="text-blue-600 hover:underline text-xs">View File</a></td>
                `;

                tr.addEventListener('click', () => handleUploadSelection(upload, tr));
                ui.uploadsTableBody.appendChild(tr);
            });
        };

        const handleUploadSelection = (uploadData, selectedTr) => {
            console.log("Upload selected:", uploadData);
            selectedUploadData = uploadData; 

            ui.uploadsTableBody.querySelectorAll('tr.selected').forEach(row => row.classList.remove('selected'));
             if(selectedTr) selectedTr.classList.add('selected');

            populateEditForm(uploadData);
            ui.editFormContainer.classList.remove('hidden');
             showResponseMessage(`Editing upload for ${uploadData.REFERANCE || uploadData.CUSTOMER_UID}. File: ${uploadData.FILE_URL}`, 'info');
        };


        // --- Edit Form Functions ---
        const populateEditForm = (uploadData) => {
            // resetEditForm(); // <-- BUGGY LINE REMOVED
            
            // 1. Manually reset form and hide fields (what resetEditForm did)
            ui.editForm.reset(); 
            Object.keys(ui).forEach(key => {
                if (key.startsWith('field')) {
                    ui[key].style.display = 'none';
                }
            });
             ui.editCustomerUidInput.classList.remove('readonly-input');
             ui.editCustomerUidInput.readOnly = false;
            
            // 2. Continue with original logic
            const type = uploadData.UPLOAD_TYPE;
            ui.editIdentifierInput.value = (type === 'KYC' ? uploadData.CUSTOMER_UID : uploadData.REFERANCE) || '';
            ui.editUploadTypeInput.value = type || '';
             ui.editFileUrlHiddenInput.value = uploadData.FILE_URL || '';


            ui.editReferenceInput.value = uploadData.REFERANCE || '';
            ui.editFileUrlInput.value = uploadData.FILE_URL || '';
            ui.viewFileLink.href = uploadData.FILE_URL || '#';

            if (type === 'POD' || type === 'Reciept') {
                ui.fieldAwbNumber.style.display = 'block';
                ui.editAwbNumberInput.value = uploadData.AWB_NUMBER || '';
                ui.fieldStatusRemark.style.display = 'block';
                ui.editStatusRemarkInput.value = uploadData.STATUS_REMARK || '';
            } else if (type === 'MultiBox') {
                ui.fieldAwbNumber.style.display = 'block';
                ui.editAwbNumberInput.value = uploadData.AWB_NUMBER || '';
                ui.fieldChildAwb.style.display = 'block';
                ui.editChildAwbInput.value = uploadData.CHILD_AWB || '';
            } else if (type === 'KYC') {
                ui.fieldKycNumber.style.display = 'block';
                ui.editKycNumberInput.value = uploadData.KYC_NUMBER || '';
                ui.fieldCustomerUid.style.display = 'block';
                 ui.editCustomerUidInput.value = uploadData.CUSTOMER_UID || '';
                 ui.editCustomerUidInput.classList.add('readonly-input'); 
                 ui.editCustomerUidInput.readOnly = true;
                ui.fieldKycType.style.display = 'block';
                ui.editKycTypeSelect.value = uploadData.KYC_TYPE || 'Aadhaar Card';
            } else if (type === 'Product') {
                ui.fieldAwbNumber.style.display = 'block';
                ui.editAwbNumberInput.value = uploadData.AWB_NUMBER || '';
                ui.fieldDocNumber.style.display = 'block';
                ui.editDocNumberInput.value = uploadData.DOC_NUMBER || '';
                ui.fieldDocType.style.display = 'block';
                ui.editDocTypeSelect.value = uploadData.DOC_TYPE || 'INV';
            }

            ui.editFormContainer.classList.remove('hidden');
            ui.updateButton.disabled = false;
            ui.deleteButton.disabled = false;
        };

        const resetEditForm = () => {
             ui.editForm.reset(); 
             selectedUploadData = null; 
            Object.keys(ui).forEach(key => {
                if (key.startsWith('field')) {
                    ui[key].style.display = 'none';
                }
            });
             ui.editCustomerUidInput.classList.remove('readonly-input');
             ui.editCustomerUidInput.readOnly = false;
            ui.editFormContainer.classList.add('hidden');
            ui.updateButton.disabled = true;
            ui.deleteButton.disabled = true;
             ui.uploadsTableBody.querySelectorAll('tr.selected').forEach(row => row.classList.remove('selected'));
        };

        // --- Action Handlers (Update/Delete) ---
        const handleUpdate = async () => {
             if (!selectedUploadData) {
                 console.error("Update clicked but selectedUploadData is null.");
                 showResponseMessage('No upload selected to update. Please click a row in the table.', 'error');
                 return;
             }
            const identifier = (selectedUploadData.UPLOAD_TYPE === 'KYC' ? selectedUploadData.CUSTOMER_UID : selectedUploadData.REFERANCE) || '';
            const uploadType = selectedUploadData.UPLOAD_TYPE || '';
            const originalFileUrl = selectedUploadData.FILE_URL || ''; 

            if(!identifier || !uploadType || !originalFileUrl){
                 console.error("Update Error: Missing identifier, uploadType, or original file URL from selected data.", selectedUploadData);
                 showResponseMessage('Error: Critical data missing from selected upload. Cannot update.', 'error');
                 return;
            }

            const newData = {
                 UPLOAD_TYPE: uploadType,
                 REFERANCE: ui.editReferenceInput.value,
                 FILE_URL: originalFileUrl,
                 ...( (uploadType === 'POD' || uploadType === 'Reciept') && {
                     AWB_NUMBER: ui.editAwbNumberInput.value.trim(),
                     STATUS_REMARK: ui.editStatusRemarkInput.value.trim()
                 }),
                 ...( uploadType === 'MultiBox' && {
                     AWB_NUMBER: ui.editAwbNumberInput.value.trim(),
                     CHILD_AWB: ui.editChildAwbInput.value.trim()
                 }),
                 ...( uploadType === 'KYC' && {
                     CUSTOMER_UID: selectedUploadData.CUSTOMER_UID,
                     KYC_NUMBER: ui.editKycNumberInput.value.trim(),
                     KYC_TYPE: ui.editKycTypeSelect.value
                 }),
                  ...( uploadType === 'Product' && {
                     AWB_NUMBER: ui.editAwbNumberInput.value.trim(),
                     DOC_NUMBER: ui.editDocNumberInput.value.trim(),
                     DOC_TYPE: ui.editDocTypeSelect.value
                 }),
                 BRANCH: selectedUploadData.BRANCH || '',
                 CODE: selectedUploadData.CODE || '',
                 USER_NAME: selectedUploadData.USER_NAME || ''
            };

            const payload = {
                action: 'edit',
                identifier: identifier, 
                 fileUrl: originalFileUrl, 
                newData: newData
            };

            await sendRequestToGAS(payload, ui.updateButton, ui.updateSpinner, 'Update');
        };

        const handleDelete = async () => {
             if (!selectedUploadData) {
                 console.error("Delete clicked but selectedUploadData is null.");
                 showResponseMessage('No upload selected to delete. Please click a row in the table.', 'error');
                 return;
             }
             const identifier = (selectedUploadData.UPLOAD_TYPE === 'KYC' ? selectedUploadData.CUSTOMER_UID : selectedUploadData.REFERANCE) || '';
             const uploadType = selectedUploadData.UPLOAD_TYPE || '';
             const originalFileUrl = selectedUploadData.FILE_URL || ''; 

             if(!identifier || !uploadType || !originalFileUrl){
                  console.error("Delete Error: Missing identifier, uploadType, or original file URL from selected data.", selectedUploadData);
                 showResponseMessage('Error: Critical data missing from selected upload. Cannot delete.', 'error');
                 return;
             }
             if (!confirm(`Are you sure you want to delete the upload associated with identifier ${identifier} (URL: ${originalFileUrl})? This action cannot be undone.`)) {
                 return;
             }
            const payload = {
                action: 'delete',
                identifier: identifier,
                fileUrl: originalFileUrl,
                uploadType: uploadType
            };
             await sendRequestToGAS(payload, ui.deleteButton, ui.deleteSpinner, 'Delete');
        };

        // --- GAS Communication ---
        async function sendRequestToGAS(payload, button, spinner, buttonText) {
             const originalButtonText = button.textContent.trim();
             let authCode = '';
             let authToken = '';

             const loginDataJSON = localStorage.getItem('loginData');
             if (!loginDataJSON) {
                 showResponseMessage("Authentication error: loginData not found. Please re-login.", 'error');
                 return;
             }
             try {
                 const loginData = JSON.parse(loginDataJSON);
                 const codeKey = Object.keys(loginData).find(k => k.toLowerCase() === 'code');
                 const tokenKey = Object.keys(loginData).find(k => k.toLowerCase() === 'token');
                 if (!codeKey || !tokenKey) throw new Error("Code or Token missing.");
                 authCode = loginData[codeKey];
                 authToken = loginData[tokenKey];
             } catch (e) {
                 showResponseMessage(`Authentication error: ${e.message}. Please re-login.`, 'error');
                 return;
             }

             payload.code = authCode;
             payload.token = authToken;

             if (button) button.disabled = true;
             if (spinner) spinner.classList.remove('hidden');
             if (button) button.childNodes[0].nodeValue = `${buttonText}ing... `; 


            showResponseMessage(`Sending ${payload.action} request...`, 'info');
             console.log("Sending payload to GAS:", payload);

            try {
                const response = await fetch(GSCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    mode: 'cors'
                });

                const result = await response.json();
                 console.log("Received response from GAS:", result);

                if (result.status === 'success') {
                    showResponseMessage(result.message || `${payload.action} successful! Refreshing data...`, 'success');
                    resetEditForm();
                     if (window.verifyAndFetchAppData) {
                        await window.verifyAndFetchAppData(true); // Force a refresh
                     } else {
                         window.dispatchEvent(new CustomEvent('forceAppDataRefresh'));
                         alert("Data changed. Please refresh the page to see updates.");
                     }
                    showResponseMessage('Data refreshed.', 'info');

                } else {
                    throw new Error(result.message || `Server returned status: ${result.status}`);
                }
            } catch (error) {
                 console.error(`Error during ${payload.action}:`, error);
                 showResponseMessage(`Error during ${payload.action}: ${error.message}`, 'error');
            } finally {
                 if (button) button.disabled = false;
                 if (spinner) spinner.classList.add('hidden');
                 if (button) button.childNodes[0].nodeValue = buttonText;
            }
        }


        // --- UI Helper ---
        function showResponseMessage(message, type) {
            ui.responseMessage.innerHTML = `<p>${message}</p>`;
            ui.responseMessage.className = `my-4 text-center p-3 rounded-lg text-sm ${
                type === 'success' ? 'bg-green-100 text-green-800' :
                type === 'error' ? 'bg-red-100 text-red-800' :
                'bg-blue-100 text-blue-800'
            }`;
            ui.responseMessage.classList.remove('hidden');
        }
        
        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', () => {
            // Assign all UI elements
            ui = {
                responseMessage: document.getElementById('response-message'),
                searchMiniOrderInput: document.getElementById('searchMiniOrder'),
                orderList: document.getElementById('miniOrderList'),
                loadMoreBtn: document.getElementById('loadMoreBtn'),
                uploadsTableBody: document.getElementById('uploadsTableBody'),
                editFormContainer: document.getElementById('editFormContainer'),
                editForm: document.getElementById('editForm'),
                editIdentifierInput: document.getElementById('edit-identifier'),
                editUploadTypeInput: document.getElementById('edit-upload-type'),
                editFileUrlHiddenInput: document.getElementById('edit-file-url-hidden'),
                editReferenceInput: document.getElementById('edit-reference'),
                editFileUrlInput: document.getElementById('edit-file-url'),
                viewFileLink: document.getElementById('view-file-link'),
                fieldAwbNumber: document.getElementById('field-awb-number'),
                fieldChildAwb: document.getElementById('field-child-awb'),
                fieldCustomerUid: document.getElementById('field-customer-uid'),
                fieldStatusRemark: document.getElementById('field-status-remark'),
                fieldKycNumber: document.getElementById('field-kyc-number'),
                fieldKycType: document.getElementById('field-kyc-type'),
                fieldDocNumber: document.getElementById('field-doc-number'),
                fieldDocType: document.getElementById('field-doc-type'),
                editAwbNumberInput: document.getElementById('edit-awb-number'),
                editChildAwbInput: document.getElementById('edit-child-awb'),
                editCustomerUidInput: document.getElementById('edit-customer-uid'),
                editStatusRemarkInput: document.getElementById('edit-status-remark'),
                editKycNumberInput: document.getElementById('edit-kyc-number'),
                editKycTypeSelect: document.getElementById('edit-kyc-type'),
                editDocNumberInput: document.getElementById('edit-doc-number'),
                editDocTypeSelect: document.getElementById('edit-doc-type'),
                updateButton: document.getElementById('update-button'),
                deleteButton: document.getElementById('delete-button'),
                cancelEditButton: document.getElementById('cancel-edit-button'),
                updateSpinner: document.getElementById('update-spinner'),
                deleteSpinner: document.getElementById('delete-spinner'),
            };

            // Add event listeners
            window.addEventListener('appDataLoaded', initializeData);
            window.addEventListener('appDataRefreshed', initializeData); // Re-render on refresh
             ui.searchMiniOrderInput.addEventListener('input', filterAndRenderOrders); // MODIFIED
             ui.loadMoreBtn.addEventListener('click', () => { displayDays += 30; filterAndRenderOrders(); });
             ui.updateButton.addEventListener('click', handleUpdate);
             ui.deleteButton.addEventListener('click', handleDelete);
             ui.cancelEditButton.addEventListener('click', resetEditForm);

            // Initial setup
            resetEditForm();
            showResponseMessage('Loading data from cache...', 'info');

            // --- Load initial data from cache if available ---
            const appDataJSON = localStorage.getItem('appData');
             if (appDataJSON) {
                 try {
                     const cachedData = JSON.parse(appDataJSON);
                     if (cachedData && cachedData.data && Array.isArray(cachedData.data.ORDERS)) {
                         console.log('Initializing with cached data:', cachedData.data);
                         initializeData({ detail: { data: cachedData.data } });
                     } else {
                          console.warn("Cached data structure invalid.");
                          showResponseMessage('Cached data invalid. Waiting for network load...', 'error');
                     }
                 } catch (e) {
                      console.error("Error parsing cached appData", e);
                       showResponseMessage('Error reading cache. Waiting for network load...', 'error');
                 }
             } else {
                   console.log("No cached data found. Waiting for appDataLoaded event.");
                    showResponseMessage('No cached data. Waiting for network load...', 'info');
             }
        });
    </script>

</body>
</html>

