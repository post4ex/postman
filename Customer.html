
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Management - Postman</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top: 4px solid #4338ca; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .readonly-input { background-color: #f3f4f6; cursor: not-allowed; }
        .form-input {
            border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; transition: border-color 0.2s; width: 100%; font-size: 0.875rem; /* text-sm */
        }
        .form-input:focus { outline: none; border-color: #3b82f6; }
        .rate-input { text-align: right; padding: 0.3rem 0.5rem; width: 60px; /* Fixed width */ appearance: textfield; /* Remove number spinners */ margin: 0;}
        .rate-input::-webkit-outer-spin-button,
        .rate-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .rate-header { font-size: 0.75rem; /* text-xs */ font-weight: 600; text-align: center; padding: 0.4rem 0.2rem; background-color: #f9fafb; border: 1px solid #e5e7eb; white-space: nowrap; }
        .rate-label-col { font-size: 0.75rem; font-weight: 500; text-align: left; padding: 0.4rem 0.5rem; border: 1px solid #e5e7eb; background-color:#f9fafb; white-space: nowrap;}
        .rate-data-cell { border: 1px solid #e5e7eb; padding: 1px; /* Minimal padding */ text-align: center; }

        .tab-button { padding: 0.5rem 1rem; border: 1px solid transparent; border-bottom: none; cursor: pointer; font-weight: 500; transition: all 0.2s; background-color: #f3f4f6; color: #6b7280; border-top-left-radius: 0.375rem; border-top-right-radius: 0.375rem;}
        .tab-button.active { border-color: #d1d5db; background-color: white; border-bottom: 1px solid white; margin-bottom: -1px; z-index: 10; color: #1e3a8a; }
        .tab-button:disabled { cursor: not-allowed; color: #9ca3af; background-color: #e5e7eb;}

        .tab-content { border: 1px solid #d1d5db; border-top: none; padding: 1.5rem; background-color: white; border-bottom-left-radius: 0.375rem; border-bottom-right-radius: 0.375rem;}

        /* Sticky header for rate table */
        #rateTableContainer thead th { position: sticky; top: 0; z-index: 5; }
        /* Sticky first columns for rate table */
         #rateTableContainer tbody td:nth-child(1),
         #rateTableContainer tbody td:nth-child(2) { position: sticky; left: 0; z-index: 1; background-color: #f9fafb; }
         #rateTableContainer tbody td:nth-child(2) { left: 80px; } /* Adjust based on actual width */
         
         #rateTableContainer thead th:nth-child(1),
         #rateTableContainer thead th:nth-child(2) { position: sticky; left: 0; z-index: 6; }
         #rateTableContainer thead th:nth-child(2) { left: 80px; } /* Match tbody */

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="header-placeholder"></div>

    <div class="flex flex-col md:flex-row flex-grow w-full md:h-[calc(100vh-88px)]">
        <!-- Left Sidebar for Customer List -->
        <aside id="customerListContainer" class="w-full md:w-1/3 lg:w-1/4 bg-white border-r flex flex-col">
            <div class="p-4 border-b sticky top-0 bg-white z-20">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Customers (B2B)</h2>
                    <button id="newCustomerBtn" class="text-sm bg-indigo-100 text-indigo-700 font-semibold py-1 px-3 rounded-lg hover:bg-indigo-200 transition-colors">New</button>
                </div>
                <input type="text" id="searchCustomer" placeholder="Search by Name or Code..." class="mt-2 w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="overflow-y-auto flex-grow">
                <ul id="customerList" class="p-4 space-y-2">
                    <li id="customerLoader" class="text-center text-gray-500">Loading customers...</li>
                </ul>
            </div>
        </aside>

        <!-- Main Content Area for the Form -->
        <main id="customerFormContainer" class="w-full md:w-2/3 lg:w-3/4 p-6 md:p-8 overflow-y-auto hidden md:block bg-gray-50">
             <!-- Mobile: Back to List Button -->
             <div class="p-4 border-b md:hidden bg-white -mt-6 -mx-6 mb-6 sticky top-0 z-10">
                 <button type="button" id="backToListBtn" class="text-sm bg-gray-200 text-gray-800 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300 flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Back to List
                </button>
            </div>

            <div class="w-full mx-auto bg-white rounded-lg shadow-lg p-6">
                <h1 id="formTitle" class="text-2xl font-bold text-gray-900 mb-4 text-center">Manage Customer</h1>
                <div id="responseMessage" class="mb-4 text-center p-3 rounded-lg text-sm hidden"></div>

                <!-- Tabs -->
                <div class="flex border-b border-gray-300 mb-0">
                    <button id="tabCustomerDetails" class="tab-button active">Customer Details</button>
                    <button id="tabRateList" class="tab-button" disabled>Rate List</button>
                    <div class="flex-grow"></div> <!-- Fills the remaining space -->
                </div>

                <!-- Customer Details Tab Content -->
                <div id="contentCustomerDetails" class="tab-content">
                    <form id="customerForm" class="space-y-5">
                         <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="md:col-span-1">
                                <label for="code" class="block text-sm font-medium text-gray-700 mb-1">Code*</label>
                                <input type="text" name="CODE" id="code" required class="form-input uppercase" placeholder="e.g., AGWL">
                            </div>
                             <div class="md:col-span-3">
                                <label for="client_name" class="block text-sm font-medium text-gray-700 mb-1">Client Name*</label>
                                <input type="text" name="CLIENT_NAME" id="client_name" required class="form-input" placeholder="Full legal name">
                            </div>
                            <div class="md:col-span-1">
                                <label for="mobile_number" class="block text-sm font-medium text-gray-700 mb-1">Mobile</label>
                                <input type="tel" name="MOBILE_NUMBER" id="mobile_number" class="form-input">
                            </div>
                            <div class="md:col-span-3">
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" name="EMAIL" id="email" class="form-input" placeholder="primary@example.com">
                            </div>
                            <div class="md:col-span-4">
                                <label for="billing_address" class="block text-sm font-medium text-gray-700 mb-1">Billing Address</label>
                                <input type="text" name="BILLING_ADDRESS" id="billing_address" class="form-input">
                            </div>
                            <div class="md:col-span-1">
                                <label for="billing_landmark" class="block text-sm font-medium text-gray-700 mb-1">Landmark</label>
                                <input type="text" name="BILLING_LANDMARK" id="billing_landmark" class="form-input">
                            </div>
                             <div class="md:col-span-1">
                                <label for="billing_pincode" class="block text-sm font-medium text-gray-700 mb-1">Pincode</label>
                                <input type="text" name="BILLING_PINCODE" id="billing_pincode" class="form-input" maxlength="6">
                            </div>
                             <div class="md:col-span-1">
                                <label for="billing_city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                <input type="text" name="BILLING_CITY" id="billing_city" class="form-input">
                            </div>
                             <div class="md:col-span-1">
                                <label for="billing_state" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                                <input type="text" name="BILLING_STATE" id="billing_state" class="form-input">
                            </div>
                             <div class="md:col-span-2">
                                <label for="id_gst_pan_adhar" class="block text-sm font-medium text-gray-700 mb-1">GST / PAN / Adhar</label>
                                <input type="text" name="ID_GST_PAN_ADHAR" id="id_gst_pan_adhar" class="form-input">
                            </div>
                            <div class="md:col-span-1">
                                <label for="branch" class="block text-sm font-medium text-gray-700 mb-1">Branch*</label>
                                <input type="text" name="BRANCH" id="branch" required class="form-input uppercase" placeholder="e.g., DDN">
                            </div>
                            <div class="md:col-span-1">
                                <label for="bill_cycle" class="block text-sm font-medium text-gray-700 mb-1">Bill Cycle</label>
                                <select name="BILL_CYCLE" id="bill_cycle" class="form-input">
                                    <option value="W">Weekly (W)</option>
                                    <option value="F">Fortnightly (F)</option>
                                    <option value="M">Monthly (M)</option>
                                    <option value="E">End (E)</option>
                                </select>
                            </div>
                        </div>
                        <h3 class="text-md font-semibold text-indigo-600 mt-5 mb-3 border-t pt-4">Charges & Settings</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 items-end">
                            <div>
                                <label for="weight_change" class="block text-sm font-medium text-gray-700 mb-1">Weight Change</label>
                                <input type="number" step="any" name="WEIGHT_CHANGE" id="weight_change" class="form-input" placeholder="e.g., 2">
                            </div>
                             <div>
                                <label for="pct_topay_if" class="block text-sm font-medium text-gray-700 mb-1">% TO-PAY</label>
                                <input type="number" step="0.001" min="0" name="%_TOPAY_IF" id="pct_topay_if" class="form-input" placeholder="e.g., 0.03">
                            </div>
                             <div>
                                <label for="pct_cod_if" class="block text-sm font-medium text-gray-700 mb-1">% COD</label>
                                <input type="number" step="0.001" min="0" name="%_COD_IF" id="pct_cod_if" class="form-input" placeholder="e.g., 0.005">
                            </div>
                            <div>
                                <label for="pct_fov_if" class="block text-sm font-medium text-gray-700 mb-1">% FOV</label>
                                <input type="number" step="0.001" min="0" name="%_FOV_IF" id="pct_fov_if" class="form-input" placeholder="e.g., 0.02">
                            </div>
                             <div>
                                <label for="eway_if" class="block text-sm font-medium text-gray-700 mb-1">E-Way Charge</label>
                                <input type="number" step="any" min="0" name="EWAY_IF" id="eway_if" class="form-input" placeholder="e.g., 10">
                            </div>
                             <div>
                                <label for="awb_charges" class="block text-sm font-medium text-gray-700 mb-1">AWB Charge</label>
                                <input type="number" step="any" min="0" name="AWB_CHARGES" id="awb_charges" class="form-input" placeholder="e.g., 0">
                            </div>
                            <div>
                                <label for="packing_charges" class="block text-sm font-medium text-gray-700 mb-1">Packing Charge</label>
                                <input type="number" step="any" min="0" name="PACKING_CHARGES" id="packing_charges" class="form-input" placeholder="e.g., 0">
                            </div>
                            <div>
                                <label for="fuel_charges" class="block text-sm font-medium text-gray-700 mb-1">Fuel Charge %</label>
                                <input type="number" step="any" min="0" name="FUEL_CHARGES" id="fuel_charges" class="form-input" placeholder="e.g., 0.125">
                            </div>
                            <div>
                                <label for="dev_charges" class="block text-sm font-medium text-gray-700 mb-1">Dev. Charge %</label>
                                <input type="number" step="any" min="0" name="DEV_CHARGES" id="dev_charges" class="form-input" placeholder="e.g., 0.05">
                            </div>
                            <div class="flex items-center space-x-2 pt-5">
                                <input type="checkbox" name="GST_INC_CHECK" id="gst_inc_check" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="gst_inc_check" class="text-sm font-medium text-gray-700">GST Included?</label>
                                <input type="hidden" name="GST_INC" id="gst_inc" value="N"> <!-- Hidden input holds Y/N -->
                            </div>
                        </div>

                        <!-- Meta Data (Readonly & Hidden) -->
                        <div class="mt-5 border-t pt-4 hidden">
                            <h3 class="text-md font-semibold text-gray-500 mb-3">Meta Data</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" name="TIMESTAMP" id="timestamp" placeholder="Last Modified" class="form-input readonly-input" readonly>
                                <input type="text" name="USER_NAME" id="user_name" placeholder="Modified By" class="form-input readonly-input" readonly>
                            </div>
                        </div>


                        <!-- Customer Form Action Buttons -->
                        <div class="mt-6 flex justify-center items-center gap-4 flex-wrap border-t pt-6">
                            <button type="submit" id="submitCustomerButton" class="text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-8 py-3 text-center flex items-center justify-center disabled:bg-indigo-400">
                                <span id="customerButtonText">Save Customer</span>
                                <div id="customerSpinner" class="spinner hidden ml-3"></div>
                            </button>
                            <button type="button" id="deleteCustomerButton" class="hidden text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-8 py-3 text-center flex items-center justify-center disabled:bg-red-400">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                <span>Delete Customer</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Rate List Tab Content -->
                <div id="contentRateList" class="tab-content hidden">
                    <h2 class="text-lg font-semibold text-indigo-600 mb-4">Rate List for <span id="rateListCustomerCode" class="font-bold"></span></h2>
                    <form id="rateForm">
                        <!-- Rate Table Container -->
                        <div id="rateTableContainer" class="overflow-x-auto relative border rounded-md max-h-[60vh]"><!-- Added max-height -->
                            <p id="rateLoader" class="text-center p-4 text-gray-500">Loading rates...</p>
                            <!-- Table will be generated here by JS -->
                        </div>
                         <!-- Rate Form Action Buttons -->
                        <div class="mt-6 flex justify-center items-center gap-4 flex-wrap border-t pt-6">
                            <button type="submit" id="submitRatesButton" class="text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-8 py-3 text-center flex items-center justify-center disabled:bg-green-400">
                                <span id="ratesButtonText">Save All Rates</span>
                                <div id="ratesSpinner" class="spinner hidden ml-3"></div>
                            </button>
                        </div>
                    </form>
                </div>

            </div> <!-- End Card -->
        </main>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal-overlay hidden">
        <div class="modal-content relative card text-center max-w-md">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Confirm Deletion</h2>
            <p class="text-gray-600 mb-6">Are you sure you want to delete customer <strong id="customerToDelete" class="font-bold"></strong> and all associated rates? This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDeleteBtn" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300">Cancel</button>
                <button id="confirmDeleteBtn" class="px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 flex items-center disabled:bg-red-400">
                    <span>Confirm Delete</span>
                    <div id="deleteSpinner" class="spinner hidden ml-3" style="width: 20px; height: 20px;"></div>
                </button>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="layout.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwcZAkvu9JAxVpVeWT5pTOi6j2yEbJuFb48B-pweCG5BWZNLhbVYXP9Rzm_v6iXmdUGrw/exec';

        // --- STATE ---
        let allCustomers = []; // B2B list
        let allModes = [];     // MODE list
        let allRates = [];     // RATELISTS data
        let currentCustomerCode = null;
        let isUpdateMode = false;

        const staticWeights = ['0.5', '0.5A'];
        const dynamicWeights = ['3', '10', '25', '50', '100', '500', '1000', '2000', '5000', '10000'];

        // --- UI ELEMENTS ---
        const ui = {
            // Containers & Views
            customerListContainer: document.getElementById('customerListContainer'),
            customerFormContainer: document.getElementById('customerFormContainer'),
            contentCustomerDetails: document.getElementById('contentCustomerDetails'),
            contentRateList: document.getElementById('contentRateList'),
            rateTableContainer: document.getElementById('rateTableContainer'),
            // Forms & Loaders
            customerForm: document.getElementById('customerForm'),
            rateForm: document.getElementById('rateForm'),
            customerLoader: document.getElementById('customerLoader'),
            rateLoader: document.getElementById('rateLoader'),
            // Customer List
            customerList: document.getElementById('customerList'),
            searchCustomerInput: document.getElementById('searchCustomer'),
            newCustomerBtn: document.getElementById('newCustomerBtn'),
            backToListBtn: document.getElementById('backToListBtn'),
             // Customer Form Fields (subset)
            formTitle: document.getElementById('formTitle'),
            codeInput: document.getElementById('code'),
            clientNameInput: document.getElementById('client_name'),
            gstIncCheck: document.getElementById('gst_inc_check'),
            gstIncHidden: document.getElementById('gst_inc'),
             // Tabs
            tabCustomerDetails: document.getElementById('tabCustomerDetails'),
            tabRateList: document.getElementById('tabRateList'),
            rateListCustomerCodeSpan: document.getElementById('rateListCustomerCode'),
             // Buttons & Spinners
            submitCustomerButton: document.getElementById('submitCustomerButton'),
            customerButtonText: document.getElementById('customerButtonText'),
            customerSpinner: document.getElementById('customerSpinner'),
            deleteCustomerButton: document.getElementById('deleteCustomerButton'),
            submitRatesButton: document.getElementById('submitRatesButton'),
            ratesButtonText: document.getElementById('ratesButtonText'),
            ratesSpinner: document.getElementById('ratesSpinner'),
            // Delete Modal
            deleteModal: document.getElementById('deleteModal'),
            customerToDeleteSpan: document.getElementById('customerToDelete'),
            cancelDeleteBtn: document.getElementById('cancelDeleteBtn'),
            confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
            deleteSpinner: document.getElementById('deleteSpinner'),
            // Global Response Message
            responseMessage: document.getElementById('responseMessage'),
        };

        // --- VIEW LOGIC ---
        // FIX: Changed all helper functions from const to function declarations
        // This 'hoists' them, making them available immediately, solving the initialization error.
        
        function isMobileView() { return window.innerWidth < 768; }

        function showFormView() {
            if (isMobileView()) {
                ui.customerListContainer.classList.add('hidden');
                ui.customerFormContainer.classList.remove('hidden', 'md:block');
                ui.customerFormContainer.classList.add('block');
            }
             ui.customerFormContainer.classList.remove('hidden'); // Ensure visible on desktop
        }

        function showListView() {
            resetFormsAndTabs(); // Reset form state when going back
            if (isMobileView()) {
                ui.customerListContainer.classList.remove('hidden');
                ui.customerFormContainer.classList.add('hidden');
                ui.customerFormContainer.classList.remove('block');
            } else {
                 ui.customerListContainer.classList.remove('hidden');
                 ui.customerFormContainer.classList.remove('hidden');
            }
        }

        function handleResize() {
             if (!isMobileView()) {
                ui.customerListContainer.classList.remove('hidden');
                ui.customerFormContainer.classList.remove('hidden');
                ui.customerFormContainer.classList.add('md:block');
            } else {
                 if (!ui.customerFormContainer.classList.contains('hidden')) {
                    ui.customerListContainer.classList.add('hidden');
                    ui.customerFormContainer.classList.add('block');
                     ui.customerFormContainer.classList.remove('md:block');
                } else {
                     ui.customerListContainer.classList.remove('hidden');
                    ui.customerFormContainer.classList.add('hidden');
                     ui.customerFormContainer.classList.remove('block');
                }
            }
        }
        window.addEventListener('resize', handleResize);

        // --- TAB SWITCHING ---
        function switchTab(activeTab) {
            const isDetailsActive = activeTab === 'details';
            ui.tabCustomerDetails.classList.toggle('active', isDetailsActive);
            ui.tabRateList.classList.toggle('active', !isDetailsActive);
            ui.contentCustomerDetails.classList.toggle('hidden', !isDetailsActive);
            ui.contentRateList.classList.toggle('hidden', isDetailsActive);

            if (!isDetailsActive && currentCustomerCode && !ui.tabRateList.disabled) {
                generateRateForm(currentCustomerCode); // Load rates when switching TO rates tab
            }
        }

        ui.tabCustomerDetails.addEventListener('click', () => switchTab('details'));
        ui.tabRateList.addEventListener('click', () => {
            if (!ui.tabRateList.disabled) switchTab('rates');
        });

        // --- DATA LOADING & RENDERING ---
        function renderCustomerList(customers) {
            ui.customerList.innerHTML = '';
            ui.customerLoader.classList.remove('hidden');
            console.log('Rendering customer list with:', customers); // DEBUG: Log data being rendered

            if (!customers || customers.length === 0) {
                 ui.customerLoader.textContent = 'No matching customers.';
                return;
            }
            customers.sort((a, b) => (a.CODE || '').localeCompare(b.CODE || ''));

            customers.forEach(cust => {
                if(!cust.CODE) {
                     console.warn('Skipping customer render due to missing CODE:', cust); // DEBUG
                     return;
                 }

                const li = document.createElement('li');
                li.className = 'p-3 rounded-lg cursor-pointer hover:bg-indigo-50 transition-colors border border-gray-200';
                li.innerHTML = `<strong class="text-indigo-700 block text-sm">${cust.CLIENT_NAME || 'Unnamed'}</strong><span class="text-xs text-gray-600">${cust.CODE}</span>`;
                li.dataset.code = cust.CODE;
                li.addEventListener('click', () => populateFormForEdit(cust.CODE));
                ui.customerList.appendChild(li);
            });
             ui.customerLoader.classList.add('hidden');
        }

        function handleDataLoaded(event) {
            const appData = event.detail.data;
            console.log('handleDataLoaded received appData:', appData); // DEBUG: Log received data
            let customersLoaded = false, modesLoaded = false, ratesLoaded = false;

            if (appData && appData.B2B && Array.isArray(appData.B2B)) {
                console.log('Found B2B data:', appData.B2B.length, 'customers'); // DEBUG
                allCustomers = appData.B2B;
                renderCustomerList(allCustomers); // THIS IS NOW SAFE TO CALL
                customersLoaded = true;
            } else {
                ui.customerLoader.textContent = 'No B2B customers found in appData.';
                console.warn("Expected 'B2B' array not found or not an array in appData.", appData);
            }

            if (appData && appData.MODE) {
                allModes = appData.MODE;
                modesLoaded = true;
            } else {
                console.warn("MODE data not found in appData.");
            }

            // FIX: Check for "RATES" key as per user's cache data
            if (appData && appData.RATES && Array.isArray(appData.RATES)) {
                allRates = appData.RATES;
                ratesLoaded = true;
                 console.log('Found RATES data:', appData.RATES.length, 'rates'); // DEBUG
            } else {
                 console.warn("Expected 'RATES' array not found in appData. Using empty array.", appData);
                 allRates = [];
            }

            if (currentCustomerCode && !ui.contentRateList.classList.contains('hidden') && (modesLoaded || ratesLoaded)) {
                 generateRateForm(currentCustomerCode);
            }
        }
        
        window.addEventListener('appDataLoaded', handleDataLoaded);
        window.addEventListener('appDataRefreshed', handleDataLoaded);

        // --- FORM LOGIC ---
        function populateFormForEdit(code) {
            const customer = allCustomers.find(c => c.CODE === code);
            if (!customer) {
                 showResponseMessage(`Customer with code ${code} not found.`, 'error');
                 return;
            };
            resetFormsAndTabs();

            currentCustomerCode = code;
            isUpdateMode = true;

            for (const key in customer) {
                const input = ui.customerForm.querySelector(`[name="${key}"]`);
                 if (input) {
                    if (key === 'GST_INC') {
                        ui.gstIncCheck.checked = (customer[key] === 'Y');
                        ui.gstIncHidden.value = customer[key] || 'N';
                    }
                    else if ((key === 'TIMESTAMP' || key === 'TIME_STAMP') && customer[key]) {
                         try { input.value = new Date(customer[key]).toLocaleString(); } catch(e){ input.value = customer[key]; }
                    }
                    else {
                        input.value = customer[key] || '';
                    }
                }
            }

            ui.codeInput.value = code;
            ui.codeInput.readOnly = true;
            ui.codeInput.classList.add('readonly-input');
            ui.formTitle.textContent = `Edit Customer: ${code}`;
            ui.customerButtonText.textContent = `Update Customer`;
            ui.deleteCustomerButton.classList.remove('hidden');
            ui.tabRateList.disabled = false;
            ui.rateListCustomerCodeSpan.textContent = code;

            showFormView();
            switchTab('details');
        }

        function resetFormsAndTabs() {
            ui.customerForm.reset();
            ui.rateForm.reset();
            ui.rateTableContainer.innerHTML = `<p id="rateLoader" class="text-center p-4 text-gray-500">Select or save a customer to view/edit rates.</p>`;

            currentCustomerCode = null;
            isUpdateMode = false;

            ui.codeInput.readOnly = false;
            ui.codeInput.classList.remove('readonly-input');
            ui.formTitle.textContent = 'Create New Customer';
            ui.customerButtonText.textContent = 'Submit New Customer';
            ui.deleteCustomerButton.classList.add('hidden');
            ui.tabRateList.disabled = true;
            ui.responseMessage.classList.add('hidden');
            ui.gstIncCheck.checked = false;
            ui.gstIncHidden.value = 'N';
            ui.rateListCustomerCodeSpan.textContent = '';


            switchTab('details');
        }

        ui.gstIncCheck.addEventListener('change', () => {
            ui.gstIncHidden.value = ui.gstIncCheck.checked ? 'Y' : 'N';
        });

        // --- RATE LIST FORM GENERATION ---
        function generateRateForm(customerCode) {
             if (!customerCode) return;
            ui.rateListCustomerCodeSpan.textContent = customerCode;
            ui.rateLoader.textContent = "Generating rate table...";
            ui.rateLoader.classList.remove('hidden');
            ui.rateTableContainer.innerHTML = '';

            if (!allModes || allModes.length === 0) {
                 ui.rateTableContainer.innerHTML = '<p class="text-center p-4 text-red-500">Error: Mode list not available.</p>';
                 ui.rateLoader.classList.add('hidden');
                 return;
            }

            // *** FIX HERE ***
            // Changed rate.Code to rate.CODE to match the likely data structure from the Google Sheet.
            const customerRates = allRates.filter(rate => rate.CODE === customerCode);
            
            const rateMap = customerRates.reduce((acc, rate) => {
                if(rate.UID) acc[rate.UID.trim()] = rate;
                return acc;
            }, {});

            const table = document.createElement('table');
            table.className = 'w-full text-xs border-collapse table-fixed';

            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            // FIX: Removed UID from header
            const headersInfo = [
                { text: 'Mode', width: 'w-24' }, // Increased width
                { text: 'Wt', width: 'w-16' }, // Increased width
            ];

            // FIX: Adjust left-offsets for 2 columns
             headersInfo.forEach((info, index) => {
                const th = document.createElement('th');
                th.textContent = info.text;
                th.className = `rate-header sticky top-0 ${info.width}`;
                let leftOffset = 0;
                if (index === 1) leftOffset = 96; // Approx width of w-24
                
                th.style.left = `${leftOffset}px`;
                th.style.zIndex = '6';
                headerRow.appendChild(th);
            });

            for (let i = 1; i <= 14; i++) {
                const th = document.createElement('th');
                th.textContent = `Z${i}`;
                th.className = 'rate-header w-16';
                headerRow.appendChild(th);
            }

            const tbody = table.createTBody();

            const addRateRow = (modeName, modeShortCode, weight, branchCode) => {
                const row = tbody.insertRow();
                const uid = `${customerCode}${modeShortCode}${weight}`;
                const existingRate = rateMap[uid];

                // FIX: Only create 2 sticky columns
                const labelsInfo = [
                    { value: modeName, width: headersInfo[0].width },
                    { value: weight, width: headersInfo[1].width, isWeight: true },
                ];

                labelsInfo.forEach((info, index) => {
                     const cell = row.insertCell();
                     cell.className = `rate-label-col sticky ${info.width}`;
                     cell.textContent = info.value;
                     let leftOffset = 0;
                     if (index === 1) leftOffset = 96; // Approx width of w-24
                     
                     cell.style.left = `${leftOffset}px`;
                     cell.style.zIndex = '1';
                     
                     // FIX: Add all hidden inputs to the *second* cell
                     if (info.isWeight) { 
                         cell.classList.add('text-gray-600');
                         
                         // REFORMATTED: Broke multi-statement lines into single statements to fix syntax error.
                         const hiddenUid = document.createElement('input'); 
                         hiddenUid.type='hidden'; 
                         hiddenUid.name=`rate_${uid}_UID`; 
                         hiddenUid.value=uid; 
                         cell.appendChild(hiddenUid);
                         
                         const hiddenService = document.createElement('input'); 
                         hiddenService.type='hidden'; 
                         hiddenService.name=`rate_${uid}_Service`; 
                         hiddenService.value=modeName; 
                         cell.appendChild(hiddenService);
                         
                         const hiddenWeight = document.createElement('input'); 
                         hiddenWeight.type='hidden'; 
                         hiddenWeight.name=`rate_${uid}_Weight`; 
                         hiddenWeight.value=weight; 
                         cell.appendChild(hiddenWeight);
                         
                         const hiddenBranch = document.createElement('input'); 
                         hiddenBranch.type='hidden'; 
                         hiddenBranch.name=`rate_${uid}_Branch`; 
                         hiddenBranch.value = branchCode || ''; 
                         cell.appendChild(hiddenBranch);
                         
                         const hiddenShortCode = document.createElement('input'); 
                         hiddenShortCode.type='hidden'; 
                         hiddenShortCode.name=`rate_${uid}_ServiceShortCode`; 
                         hiddenShortCode.value = modeShortCode || ''; 
                         cell.appendChild(hiddenShortCode);
                         
                         const hiddenType = document.createElement('input'); 
                         hiddenType.type='hidden'; 
                         hiddenType.name=`rate_${uid}_TYPE`; 
                         hiddenType.value = 'CLIENT'; 
                         cell.appendChild(hiddenType);
                     }
                });

                for (let i = 1; i <= 14; i++) {
                    const cell = row.insertCell();
                    cell.className = 'rate-data-cell';
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = 'any';
                    input.name = `rate_${uid}_Z${i}`;
                    input.className = 'form-input rate-input w-full';
                    input.value = existingRate && existingRate[`Z${i}`] !== undefined ? existingRate[`Z${i}`] : '';
                    input.placeholder = `Z${i}`;
                    cell.appendChild(input);
                }
            };

            const currentCustomer = allCustomers.find(c => c.CODE === customerCode);
            const customerBranch = currentCustomer ? currentCustomer.BRANCH : '';

             allModes.forEach(mode => {
                const modeName = mode.MODE;
                const shortCode = mode.SHORT;
                if (!shortCode) return;

                const weightsToUse = (modeName.toLowerCase() === 'express' || modeName.toLowerCase() === 'premium')
                                    ? staticWeights
                                    : dynamicWeights;

                 const uidShortCode = (modeName.toLowerCase() === 'express') ? 'E' : (modeName.toLowerCase() === 'premium') ? 'P' : shortCode;

                weightsToUse.forEach(weight => {
                    addRateRow(modeName, uidShortCode, weight, customerBranch);
                });
            });

            ui.rateTableContainer.appendChild(table);
            ui.rateLoader.classList.add('hidden');
        }


        // --- EVENT LISTENERS ---
        ui.searchCustomerInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allCustomers.filter(c =>
                (c.CLIENT_NAME || '').toLowerCase().includes(searchTerm) ||
                (c.CODE || '').toLowerCase().includes(searchTerm)
            );
            renderCustomerList(filtered);
        });

        ui.newCustomerBtn.addEventListener('click', () => {
            resetFormsAndTabs();
            showFormView();
        });

        ui.backToListBtn.addEventListener('click', showListView);

        ui.deleteCustomerButton.addEventListener('click', () => {
            if (!currentCustomerCode) return;
            const name = ui.clientNameInput.value || currentCustomerCode;
            ui.customerToDeleteSpan.textContent = `${name} (${currentCustomerCode})`;
            ui.deleteModal.classList.remove('hidden');
        });

        ui.cancelDeleteBtn.addEventListener('click', () => ui.deleteModal.classList.add('hidden'));

        ui.confirmDeleteBtn.addEventListener('click', () => {
             if (!currentCustomerCode) return;
             handleRequest(
                'customer',
                'delete',
                { CODE: currentCustomerCode },
                ui.deleteSpinner,
                ui.confirmDeleteBtn,
                null,
                () => {
                     ui.deleteModal.classList.add('hidden');
                     showListView();
                },
                 () => {
                     ui.deleteModal.classList.add('hidden');
                 }
             );
        });

        ui.customerForm.addEventListener('submit', (e) => {
            e.preventDefault();
             handleRequest(
                 'customer',
                 'submit',
                 ui.customerForm,
                 ui.customerSpinner,
                 ui.submitCustomerButton,
                 ui.customerButtonText,
                 (responseData) => {
                    if (!isUpdateMode && responseData && responseData.CODE) {
                        currentCustomerCode = responseData.CODE;
                        ui.codeInput.value = currentCustomerCode;
                        ui.codeInput.readOnly = true;
                        ui.codeInput.classList.add('readonly-input');
                        ui.formTitle.textContent = `Edit Customer: ${currentCustomerCode}`;
                        ui.customerButtonText.textContent = `Update Customer`;
                        ui.deleteCustomerButton.classList.remove('hidden');
                        ui.tabRateList.disabled = false;
                        ui.rateListCustomerCodeSpan.textContent = currentCustomerCode;
                        isUpdateMode = true;
                    } else if (isUpdateMode && responseData && responseData.CODE) {
                         currentCustomerCode = responseData.CODE;
                         ui.tabRateList.disabled = false;
                         ui.rateListCustomerCodeSpan.textContent = currentCustomerCode;
                    }
                 }
            );
        });

        ui.rateForm.addEventListener('submit', (e) => {
             e.preventDefault();
             if (!currentCustomerCode) {
                 showResponseMessage("No customer selected.", "error");
                 return;
             }

             const ratesPayload = [];
             const rateInputs = ui.rateForm.querySelectorAll('input[type="number"], input[type="hidden"]');
             const ratesGroupedByUID = {};

             rateInputs.forEach(input => {
                 const nameParts = input.name.split('_');
                 if (nameParts.length < 3 || nameParts[0] !== 'rate') return;
                 const uid = nameParts[1];
                 const field = nameParts.slice(2).join('_');
                 if (!ratesGroupedByUID[uid]) ratesGroupedByUID[uid] = { UID: uid };

                // FIX: Check if this is a Zone field and parse it as a number
                if (field.startsWith('Z') && !isNaN(parseInt(field.substring(1)))) {
                    const numValue = parseFloat(input.value);
                    // Set to null if it's empty, NaN, or undefined
                    ratesGroupedByUID[uid][field] = (isNaN(numValue) || input.value === null || input.value === '' || input.value === undefined) ? null : numValue;
                } else {
                    // This is a hidden field (UID, Service, etc.)
                    ratesGroupedByUID[uid][field] = (input.value === null || input.value === undefined) ? '' : input.value;
                }
             });

            // FIX: Filter out empty rows (This logic is now robust)
             for (const uid in ratesGroupedByUID) {
                 const rateData = ratesGroupedByUID[uid];
                 let hasValue = false;
                 // Check if any Z1-Z14 field has a value
                 for (let i = 1; i <= 14; i++) {
                    // FIX: Check for not null, which correctly includes "0" and other values
                    if (rateData[`Z${i}`] !== null) {
                         hasValue = true;
                         break; // Found a value, no need to check further
                     }
                 }
                 
                 // Only add to payload if at least one zone has a rate
                 if (hasValue) {
                     ratesPayload.push(rateData);
                 }
             }

             if (ratesPayload.length === 0) {
                 showResponseMessage("No rate data entered. Nothing to save.", "warning");
                 return;
             }

             const submitData = {
                 code: currentCustomerCode,
                 branch: ui.customerForm.querySelector('[name="BRANCH"]').value || '',
                 rates: ratesPayload
             };

             handleRequest(
                 'ratelist',
                 'submit',
                 submitData,
                 ui.ratesSpinner,
                 ui.submitRatesButton,
                 ui.ratesButtonText
             );
        });


        // --- CORE NETWORK REQUEST FUNCTION ---
        async function handleRequest(type, action, dataOrForm, spinner, button, buttonTextSpan, successCallback, errorCallback) {

            let submitData;
             if (dataOrForm instanceof HTMLFormElement) {
                 submitData = {};
                 new FormData(dataOrForm).forEach((value, key) => { submitData[key] = value; });
             } else {
                 submitData = dataOrForm;
             }

             const loginDataJSON = localStorage.getItem('loginData');
             const loginData = loginDataJSON ? JSON.parse(loginDataJSON) : null;
             const auth = {
                 code: loginData?.CODE || loginData?.code,
                 token: loginData?.TOKEN || loginData?.token
             };

             if (!auth.code || !auth.token) {
                 showResponseMessage('Authentication error. Please log in again.', 'error');
                 return;
             }

            if(spinner) spinner.classList.remove('hidden');
            if(button) button.disabled = true;
            const originalButtonText = buttonTextSpan ? buttonTextSpan.textContent : '';
            if(buttonTextSpan) buttonTextSpan.textContent = 'Processing...';


            const payload = {
                auth: auth,
                data: submitData,
                action: action,
                type: type
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    mode: 'cors',
                });

                if (!response.ok) throw new Error(`Network error: ${response.status} ${response.statusText}`);
                const result = await response.json();
                if (result.error) throw new Error(result.message || 'Unknown script error.');

                showResponseMessage(result.message || 'Operation successful.', 'success', result.data);

                const isWrite = (action === 'submit' || action === 'delete');
                 if (isWrite && window.verifyAndFetchAppData) {
                    await window.verifyAndFetchAppData(true);
                }

                if (successCallback) successCallback(result.data);


            } catch (error) {
                showResponseMessage(error.message, 'error');
                 if(errorCallback) errorCallback(error);

            } finally {
                 if(spinner) spinner.classList.add('hidden');
                 if(button) button.disabled = false;
                 if(buttonTextSpan) buttonTextSpan.textContent = originalButtonText;
            }
        }

        // --- UI HELPER ---
         function showResponseMessage(message, type, data = null) {
            let content = `<p class="font-semibold">${message}</p>`;

            ui.responseMessage.innerHTML = content;
            ui.responseMessage.className = `my-4 text-center p-3 rounded-lg text-sm ${type === 'success' ? 'bg-green-100 text-green-800' : type === 'error' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`;
            ui.responseMessage.classList.remove('hidden');

            // setTimeout(() => { ui.responseMessage.classList.add('hidden'); }, 5000); // Optional: Auto-hide
        }

        // --- INITIALIZE ---
        resetFormsAndTabs();
        handleResize();
        
        // --- INITIAL LOAD FROM CACHE ---
        const appDataJSON = localStorage.getItem('appData');
         if (appDataJSON) {
             try {
                 const cachedData = JSON.parse(appDataJSON).data;
                 console.log('Initial load from cache:', cachedData); // Line 433
                 handleDataLoaded({ detail: { data: cachedData } }); // Line 434
             } catch (e) { console.error("Error parsing cached appData", e); } // Line 435
         }

    });
    </script>
</body>
</html>
