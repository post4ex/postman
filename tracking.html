import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from 'firebase/firestore';

// Main application component
const App = () => {
  // State for Firebase, authentication, and application readiness
  const [firebaseReady, setFirebaseReady] = useState(false);
  const [authError, setAuthError] = useState(null);
  const [user, setUser] = useState(null);
  const [db, setDb] = useState(null);
  const [userId, setUserId] = useState(null);

  // State for UI navigation
  const [activeSection, setActiveSection] = useState('main'); // 'main', 'shipments', 'about'
  const [termsExpanded, setTermsExpanded] = useState(false);

  // State for tracking functionality
  const [searchInput, setSearchInput] = useState('');
  const [trackingData, setTrackingData] = useState(null);
  const [trackingLogs, setTrackingLogs] = useState([]);
  const [loading, setLoading] = useState(false);
  const [searchMessage, setSearchMessage] = useState('');
  const [currentTrack, setCurrentTrack] = useState(null);
  
  // State for My Shipments
  const [savedShipments, setSavedShipments] = useState([]);
  
  // The Google Apps Script URL to fetch data from
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLN1G3ZmbqcX5nN9nx46p4pZz6AU3xSk4AzeRMxknRVxbqQMzvsj-mWWhfFjxv7tvlTw/exec";

  // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
  useEffect(() => {
    // This function sets up Firebase and signs in the user
    const setupFirebase = async () => {
      try {
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        if (!firebaseConfig) {
          throw new Error('Firebase configuration not found. Please ensure your project is set up correctly.');
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const firestore = getFirestore(app);
        setDb(firestore);

        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
        
        // Listen for auth state changes and set the userId
        onAuthStateChanged(auth, (user) => {
          if (user) {
            setUserId(user.uid);
            setUser(user);
            setFirebaseReady(true);
            console.log("User authenticated with UID:", user.uid);
          } else {
            setUserId(null);
            setUser(null);
            setFirebaseReady(true);
            console.log("No user signed in.");
          }
        });

      } catch (e) {
        console.error("Firebase setup failed:", e);
        setAuthError(e.message);
        setFirebaseReady(true);
      }
    };

    setupFirebase();
  }, []);

  // --- FIREBASE DATA LISTENER ---
  useEffect(() => {
    let unsubscribe;
    if (db && userId) {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const savedShipmentsRef = collection(db, `artifacts/${appId}/users/${userId}/saved-shipments`);

      unsubscribe = onSnapshot(savedShipmentsRef, (snapshot) => {
        const shipments = [];
        snapshot.forEach(doc => {
          shipments.push({ id: doc.id, ...doc.data() });
        });
        setSavedShipments(shipments);
      }, (error) => {
        console.error("Error loading saved shipments:", error);
        setSearchMessage('Failed to load saved shipments.');
      });
    }

    // Clean up the listener on component unmount or when dependencies change
    return () => {
      if (unsubscribe) {
        unsubscribe();
      }
    };
  }, [db, userId]);

  // --- HELPER FUNCTIONS ---
  const formatDateIST = (dateString) => {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    const pad = (num) => num.toString().padStart(2, '0');
    const day = pad(date.getUTCDate());
    const month = pad(date.getUTCMonth() + 1);
    const year = pad(date.getUTCFullYear() % 100);
    let hours = date.getUTCHours();
    let minutes = date.getUTCMinutes();
    const seconds = date.getUTCSeconds();
    minutes += 30;
    hours += 5;
    if (minutes >= 60) {
      hours += Math.floor(minutes / 60);
      minutes = minutes % 60;
    }
    if (hours >= 24) {
      hours = hours % 24;
    }
    return `${day}-${month}-${year} ${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
  };
  
  const formatDateDDMMYY = (dateString) => {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    const pad = (num) => num.toString().padStart(2, '0');
    const day = pad(date.getUTCDate());
    const month = pad(date.getUTCMonth() + 1);
    const year = pad(date.getUTCFullYear() % 100);
    return `${day}-${month}-${year}`;
  };

  // --- FIREBASE WRITE OPERATIONS ---
  const saveShipment = async () => {
    if (!currentTrack || !userId || !db) {
      setSearchMessage("No shipment to save or user not authenticated.");
      return;
    }

    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const shipmentDocRef = doc(db, `artifacts/${appId}/users/${userId}/saved-shipments`, currentTrack.ref.toString());
      await setDoc(shipmentDocRef, { ...currentTrack, savedAt: serverTimestamp() });
      setSearchMessage('Shipment saved successfully!');
    } catch (error) {
      console.error("Error saving shipment:", error);
      setSearchMessage('Error saving shipment. Please try again.');
    }
  };

  const deleteShipment = async (refNumber) => {
    if (!userId || !db) {
      setSearchMessage("User not authenticated. Cannot delete shipment.");
      return;
    }

    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const shipmentDocRef = doc(db, `artifacts/${appId}/users/${userId}/saved-shipments`, refNumber);
      await deleteDoc(shipmentDocRef);
      setSearchMessage(`Shipment ${refNumber} deleted.`);
    } catch (error) {
      console.error("Error deleting shipment:", error);
      setSearchMessage('Error deleting shipment. Please try again.');
    }
  };
  
  // --- SEARCH LOGIC ---
  const handleSearch = async (e) => {
    e.preventDefault();
    setLoading(true);
    setTrackingData(null);
    setTrackingLogs([]);
    setSearchMessage('');
    setCurrentTrack(null);
    
    // Close the terms and conditions when searching
    setTermsExpanded(false);

    const query = searchInput.trim().toUpperCase();

    if (query === '') {
      setSearchMessage('Please enter a Ref or AWB number.');
      setLoading(false);
      return;
    }

    try {
      const response = await fetch(APPS_SCRIPT_URL);
      const data = await response.json();
      
      const tracksData = data.tracks;
      const logsData = data.logs;
      const ordersData = data.orders;

      const track = tracksData.find(item => item.ref.toString().toUpperCase() === query || item.awb.toString().toUpperCase() === query);
      const refToSearch = track ? track.ref.toString().toUpperCase() : query;
      const order = ordersData.find(item => item.ref.toString().toUpperCase() === refToSearch || (item.awbBooked && item.awbBooked.toString().toUpperCase() === refToSearch));

      if (!track) {
        setSearchMessage(`No results found for "${query}".`);
        setLoading(false);
        return;
      }
      
      const fullTrack = {
        ref: track.ref,
        awb: track.awb,
        courier: track.courier,
        currentStatus: track.currentStatus,
        currentDate: track.currentDate,
        orderDate: order ? order.orderDate : 'N/A',
        edd: order ? order.edd : 'N/A',
        customer: order ? order.customer : 'N/A',
        billingMode: order ? order.billingMode : 'N/A',
        pieces: order ? order.pieces : 'N/A',
        weight: order ? order.weight : 'N/A',
        consigneeName: order ? order.consigneeName : 'N/A',
        consigneeCity: order ? order.consigneeCity : 'N/A',
        destCountry: order ? order.destCountry : 'N/A',
      };
      
      setTrackingData(fullTrack);
      setCurrentTrack(fullTrack);
      
      const filteredLogs = logsData.filter(log => log.ref.toString().toUpperCase() === track.ref.toString().toUpperCase());

      if (filteredLogs.length === 0) {
        setSearchMessage(`No logs found for ${track.ref}.`);
      } else {
        filteredLogs.sort((a, b) => new Date(b.date) - new Date(a.date));
        setTrackingLogs(filteredLogs);
      }
    } catch (error) {
      console.error("Failed to fetch data:", error);
      setSearchMessage('Failed to load tracking data. Please check your Apps Script deployment.');
    } finally {
      setLoading(false);
    }
  };

  // Display a loading message while Firebase is initializing
  if (!firebaseReady) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100 font-sans">
        <div className="p-8 text-center bg-white rounded-lg shadow-lg">
          <p className="text-xl font-semibold text-gray-700 animate-pulse">
            Loading...
          </p>
        </div>
      </div>
    );
  }

  // Display an error message if initialization failed
  if (authError) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100 font-sans">
        <div className="p-8 text-center bg-white rounded-lg shadow-lg border-2 border-red-500">
          <h1 className="text-2xl font-bold text-red-600 mb-2">Error!</h1>
          <p className="text-gray-700">{authError}</p>
        </div>
      </div>
    );
  }
  
  // --- RENDER FUNCTIONS FOR EACH SECTION ---
  const renderMainSection = () => (
    <div id="mainSection" className="p-4 md:p-8">
        <h1 className="text-3xl md:text-4xl font-extrabold text-gray-500 mb-6 text-center">Adventures of a Postman</h1>
        <form onSubmit={handleSearch}>
          <div className="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4 mb-8">
            <input
              type="text"
              id="searchInput"
              placeholder="Enter Ref or AWB number..."
              value={searchInput}
              onChange={(e) => setSearchInput(e.target.value)}
              className="flex-1 p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-gray-700"
            />
            <button
              type="submit"
              className="w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors shadow-md"
              disabled={loading}
            >
              {loading ? 'Searching...' : 'Search'}
            </button>
          </div>
        </form>

        <div id="resultsSection" className="space-y-6">
          {trackingData && (
            <div id="summaryResults" className="">
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-center">
                <div className="bg-gray-100 p-4 rounded-xl shadow-sm">
                  <span className="text-gray-500 font-medium">Ref Number</span>
                  <p id="refNumber" className="text-base md:text-lg font-bold text-blue-600 mt-1">{trackingData.ref}</p>
                </div>
                <div className="bg-gray-100 p-4 rounded-xl shadow-sm">
                  <span className="text-gray-500 font-medium">AWB Number</span>
                  <p id="awbNumber" className="text-base md:text-lg font-bold text-blue-600 mt-1">{trackingData.awb}</p>
                </div>
                <div className="bg-gray-100 p-4 rounded-xl shadow-sm">
                  <span className="text-gray-500 font-medium">Courier Name</span>
                  <p id="courierName" className="text-base md:text-lg font-bold text-blue-600 mt-1">{trackingData.courier}</p>
                </div>
                <div className="bg-gray-100 p-4 rounded-xl shadow-sm">
                  <span className="text-gray-500 font-medium">Current Status</span>
                  <p id="currentStatus" className="text-base md:text-lg font-bold text-blue-600 mt-1">{trackingData.currentStatus}</p>
                </div>
                <div className="bg-gray-100 p-4 rounded-xl shadow-sm">
                  <span className="text-gray-500 font-medium">Status Date</span>
                  <p id="currentDate" className="text-base md:text-lg font-bold text-blue-600 mt-1">{formatDateIST(trackingData.currentDate)}</p>
                </div>
                <div className="bg-gray-100 p-4 rounded-xl shadow-sm">
                    <span className="text-gray-500 font-medium">Order and EDD Date</span>
                    <p id="orderAndEddDate" className="text-base md:text-lg font-bold text-blue-600 mt-1">{trackingData.orderDate !== 'N/A' ? `${formatDateDDMMYY(trackingData.orderDate)} - ${formatDateDDMMYY(trackingData.edd)}` : 'N/A'}</p>
                </div>
                <div className="bg-gray-100 p-4 rounded-xl shadow-sm">
                    <span className="text-gray-500 font-medium">Customer</span>
                    <p id="customer" className="text-base md:text-lg font-bold text-blue-600 mt-1">{trackingData.customer}</p>
                </div>
                <div className="bg-gray-100 p-4 rounded-xl shadow-sm">
                    <span className="text-gray-500 font-medium">Mode, Pieces & Weight</span>
                    <p id="modePiecesWeight" className="text-base md:text-lg font-bold text-blue-600 mt-1">{trackingData.billingMode !== 'N/A' ? `${trackingData.billingMode} / ${trackingData.pieces} Pcs / ${trackingData.weight} Kg` : 'N/A'}</p>
                </div>
                <div className="bg-gray-100 p-4 rounded-xl shadow-sm">
                    <span className="text-gray-500 font-medium">Consignee Name</span>
                    <p id="consigneeName" className="text-base md:text-lg font-bold text-blue-600 mt-1">{trackingData.consigneeName}</p>
                </div>
                <div className="bg-gray-100 p-4 rounded-xl shadow-sm">
                    <span className="text-gray-500 font-medium">Destination</span>
                    <p id="destination" className="text-base md:text-lg font-bold text-blue-600 mt-1">{trackingData.consigneeCity !== 'N/A' ? `${trackingData.consigneeCity} - ${trackingData.destCountry}` : 'N/A'}</p>
                </div>
              </div>
              
              <div className="flex justify-center mt-6">
                <button 
                  onClick={saveShipment} 
                  className="px-6 py-2 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition-all duration-300 shadow-md">
                  Add to My Shipments
                </button>
              </div>
            </div>
          )}

          {trackingLogs.length > 0 && (
            <div id="logTableSection" className="mt-8">
              <h2 className="text-xl font-bold text-gray-800 mb-4">Tracking History</h2>
              <div className="overflow-x-auto rounded-xl shadow-sm border border-gray-200">
                <table className="min-w-full divide-y divide-gray-200 table-auto">
                  <thead className="bg-gray-50">
                    <tr>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider whitespace-normal">Scan Date & Time</th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider whitespace-normal">Event</th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider whitespace-normal">Scan Location</th>
                    </tr>
                  </thead>
                  <tbody id="logTableBody" className="bg-white divide-y divide-gray-200">
                    {trackingLogs.map((log, index) => (
                      <tr key={index} className="hover:bg-gray-100 transition-colors">
                        <td className="px-6 py-4 text-sm font-medium text-gray-900 whitespace-normal">{formatDateIST(log.date)}</td>
                        <td className="px-6 py-4 text-sm text-gray-500 whitespace-normal">{log.remark ? `${log.status} - ${log.remark}` : log.status}</td>
                        <td className="px-6 py-4 text-sm text-gray-500 whitespace-normal">{log.location}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
          
          <div className="text-center mt-6">
            <a href="#" onClick={(e) => { e.preventDefault(); setTermsExpanded(!termsExpanded); }} className="text-sm text-gray-500 hover:text-blue-600 transition-colors">Terms and Conditions Apply</a>
          </div>
          <div className={`collapsible-content ${termsExpanded ? 'expanded' : ''}`}>
            <ol className="list-decimal list-inside space-y-2 terms-text text-gray-600 leading-relaxed">
              <li>Consignor is fully responsible if IATAICAO/IMDG,ADR restricted/Prohabitted items is being ship or mismatch with declared contain.</li>
              <li>This Tracking means said shipment has been handovered for shipping.</li>
              <li>Shipment TAT may differ as declared, depends transport, air traffic and natural clamity.</li>
              <li>Custom, Clearance and Penalty are not paid be paid by carrier. will be taken if charged by GOV.</li>
              <li>Higher Value shipments are mandatory to be insured by the shipper/sender as “Owner’s Risk” with a valid insurance Documents. In-case of “Carrier’s Risk”, the sender pay the risk surcharge as per defined.</li>
              <li>Fright refund will not be entertained in any claims if service failure is resulted from any condition Eg. Strikes, Bandh, Elections, Rains, Floods, Fire, Accident or other natural calamities.</li>
              <li>NO FRAGILE and Perishable Item can be booked under Carrier's Risk.</li>
              <li>This Tracking has 90 days life from booking date.</li>
              <li>We are a service provider and in case of any unforeseen delay, damage, loss of consignment, our liabilities are specifically limited.</li>
              <li>Carrrier has the right at its option or at the request of competent authorities to open consignment at any time to inspect the contents of the shipment.</li>
            </ol>
          </div>
          
          {searchMessage && <p className="text-center text-gray-500">{searchMessage}</p>}
        </div>
    </div>
  );

  const renderMyShipmentsSection = () => (
    <div className="p-4 md:p-8">
      <h2 className="text-3xl font-bold text-gray-800 mb-6">My Saved Shipments</h2>
      <p className="text-gray-600 mb-4">Your User ID (UID): {userId || 'N/A'}</p>
      <div className="space-y-4">
        {savedShipments.length === 0 ? (
          <p className="text-gray-500 text-center">You have no saved shipments yet. Search for one and click "Add to My Shipments".</p>
        ) : (
          savedShipments.map(shipment => (
            <div key={shipment.id} className="bg-gray-100 p-4 rounded-xl shadow-sm flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0">
              <div className="text-left w-full md:w-auto space-y-1">
                <p className="text-lg font-bold text-gray-800">Ref: {shipment.ref}</p>
                <p className="text-sm text-gray-600">AWB: {shipment.awb}</p>
                <p className="text-sm text-gray-600">Status: {shipment.currentStatus}</p>
                <p className="text-sm text-gray-600">Consignee: {shipment.consigneeName}</p>
                <p className="text-sm text-gray-600">Destination: {shipment.consigneeCity} - {shipment.destCountry}</p>
                <p className="text-sm text-gray-600">Pieces: {shipment.pieces} / Weight: {shipment.weight} Kg</p>
              </div>
              <div className="flex space-x-2">
                <button onClick={() => { setSearchInput(shipment.ref); setActiveSection('main'); }} className="px-4 py-2 bg-blue-500 text-white font-semibold rounded-xl hover:bg-blue-600 transition-colors shadow-md">Track</button>
                <button onClick={() => deleteShipment(shipment.ref)} className="px-4 py-2 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition-colors shadow-md">Delete</button>
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  );

  const renderAboutSection = () => (
    <div className="p-4 md:p-8">
      <h2 className="text-3xl font-bold text-gray-800 mb-4">About This Tool</h2>
      <p className="text-gray-600 leading-relaxed mb-4">This web application provides a simple and efficient way to track shipments using a reference number or an AWB number. It fetches data from a connected Google Apps Script to display real-time tracking information and a detailed history of the shipment's journey.</p>
      <p className="text-600 leading-relaxed">The main goal of this project is to create a lightweight, responsive, and easy-to-use interface that can be easily customized and deployed. It's an excellent example of how simple web tools can be built to solve practical problems.</p>
    </div>
  );

  return (
    <div className="flex flex-col min-h-screen bg-gray-100 font-sans p-4">
      {/* Header Section */}
      <header className="bg-white shadow-sm py-4 px-6 md:px-10 sticky top-0 z-50">
          <div className="container mx-auto flex items-center justify-between">
              <a href="#" onClick={(e) => { e.preventDefault(); setActiveSection('main'); }} className="flex items-center space-x-3">
                  <img src="https://i.postimg.cc/wv02f1fb/postman-Logo-28.png" alt="Postman Logo" className="w-12 h-18 rounded-lg" onError={(e) => e.target.src = 'https://placehold.co/48x72/2563EB/ffffff?text=Postman'} />
                  <span className="text-xl font-bold text-gray-800">Postman</span>
              </a>
              <nav>
                  <ul className="flex space-x-6">
                      <li><a href="#" onClick={(e) => { e.preventDefault(); setActiveSection('main'); }} className="text-gray-600 hover:text-blue-600 font-medium transition-colors">Home</a></li>
                      <li><a href="#" onClick={(e) => { e.preventDefault(); setActiveSection('shipments'); }} className="text-gray-600 hover:text-blue-600 font-medium transition-colors">My Shipments</a></li>
                      <li><a href="#" onClick={(e) => { e.preventDefault(); setActiveSection('about'); }} className="text-gray-600 hover:text-blue-600 font-medium transition-colors">About</a></li>
                  </ul>
              </nav>
          </div>
      </header>
      
      {/* Main Content Wrapper */}
      <div className="p-4 md:p-8 flex items-center justify-center flex-grow">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl">
              {activeSection === 'main' && renderMainSection()}
              {activeSection === 'shipments' && renderMyShipmentsSection()}
              {activeSection === 'about' && renderAboutSection()}
          </div>
      </div>
    </div>
  );
};

export default App;
