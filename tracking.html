<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postman - Track Shipment</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://post4ex.github.io/postman/style.css">
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 flex flex-col items-center relative">

    <div id="header-placeholder"></div>

    <main class="container space-y-8 mt-4">
        <div class="card">
            <div class="flex flex-col sm:flex-row items-center gap-4 mb-8">
                <div class="flex rounded-lg overflow-hidden w-full sm:w-1/4">
                    <button id="refButton" class="p-3 text-white font-semibold rounded-l-lg transition-colors w-1/2 bg-blue-800 hover:bg-blue-900">AWB/Ref</button>
                    <button id="mobileButton" class="p-3 text-gray-700 font-semibold rounded-r-lg transition-colors w-1/2 bg-gray-200 hover:bg-gray-300">Mobile</button>
                </div>
                <input type="text" id="searchInput" placeholder="Enter AWB/Ref Number(s), comma-separated" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-700 w-full">
                <button id="searchButton" class="px-6 py-3 bg-blue-800 text-white font-semibold rounded-lg hover:bg-blue-900 transition-colors w-full sm:w-auto">Search</button>
            </div>
            <div id="loadingIndicator" class="hidden text-center text-gray-500 mb-4"><p>Loading data...</p></div>
            <div id="resultsContainer" class="hidden space-y-6"></div>
            <div id="messageBox" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert"><p id="messageText"></p></div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <!-- Modal for Scan History -->
    <div id="scanHistoryModal" class="modal-overlay hidden">
        <div class="modal-content relative card">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Scan History</h2>
            <button id="closeModalButton" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div id="modalContent"></div>
        </div>
    </div>
    
    <script src="https://post4ex.github.io/postman/layout.js"></script>
    <script>
        // --- Tracking Specific Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'https://script.google.com/macros/s/AKfycbwdEPTko2RsIDO4T3-11nwsCUcVR3jtzC8Xpya5FTqZo13aNWfn1uNhZQ9Zfw_r7hk4aQ/exec';
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const refButton = document.getElementById('refButton');
            const mobileButton = document.getElementById('mobileButton');
            const resultsContainer = document.getElementById('resultsContainer');
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const scanHistoryModal = document.getElementById('scanHistoryModal');
            const closeModalButton = document.getElementById('closeModalButton');
            const modalContent = document.getElementById('modalContent');
            
            let currentSearchType = 'ref';
            let allConsignments = [];

            function formatDateTime(isoString) {
                if (!isoString) return 'N/A';
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return 'Date not available';
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
            }

            function updateButtonStyles() {
                if (currentSearchType === 'ref') {
                    refButton.classList.add('bg-blue-800', 'text-white');
                    refButton.classList.remove('bg-gray-200', 'text-gray-700');
                    mobileButton.classList.add('bg-gray-200', 'text-gray-700');
                    mobileButton.classList.remove('bg-blue-800', 'text-white');
                    searchInput.placeholder = 'Enter AWB/Ref Number(s), comma-separated';
                    searchInput.type = 'text';
                } else {
                    mobileButton.classList.add('bg-blue-800', 'text-white');
                    mobileButton.classList.remove('bg-gray-200', 'text-gray-700');
                    refButton.classList.add('bg-gray-200', 'text-gray-700');
                    refButton.classList.remove('bg-blue-800', 'text-white');
                    searchInput.placeholder = 'Enter Mobile Number';
                    searchInput.type = 'tel';
                }
            }

            refButton.addEventListener('click', () => { currentSearchType = 'ref'; updateButtonStyles(); });
            mobileButton.addEventListener('click', () => { currentSearchType = 'mobile'; updateButtonStyles(); });
            searchButton.addEventListener('click', trackConsignment);
            searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') trackConsignment(); });
            resultsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('track-btn')) {
                    const index = e.target.dataset.index;
                    if (allConsignments[index]) showScanHistoryModal(allConsignments[index]);
                }
            });
            closeModalButton.addEventListener('click', () => scanHistoryModal.classList.add('hidden'));
            scanHistoryModal.addEventListener('click', (e) => { if (e.target === scanHistoryModal) scanHistoryModal.classList.add('hidden'); });

            async function trackConsignment() {
                let query = searchInput.value.trim();
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');
                messageBox.classList.add('hidden');
                allConsignments = [];
                loadingIndicator.classList.remove('hidden');

                if (!query) {
                    showMessage(`Please enter a valid ${currentSearchType === 'ref' ? 'Reference/AWB Number(s)' : 'Mobile Number'}.`, 'error');
                    loadingIndicator.classList.add('hidden');
                    return;
                }

                const queries = currentSearchType === 'ref' ? query.split(',').map(item => item.trim()).filter(Boolean) : [query];
                
                try {
                    const fetchPromises = queries.map(q => fetch(`${API_URL}?searchType=${currentSearchType}&query=${encodeURIComponent(q)}`));
                    const responses = await Promise.all(fetchPromises);
                    const results = await Promise.all(responses.map(res => res.ok ? res.json() : Promise.reject(new Error(`Status: ${res.status}`))));

                    let allOrdersFound = false;
                    results.forEach(responseData => {
                        if (responseData.orders && responseData.orders.length > 0) {
                            allConsignments.push(...responseData.orders);
                            allOrdersFound = true;
                        }
                    });

                    if (allOrdersFound) {
                        resultsContainer.classList.remove('hidden');
                        if (currentSearchType === 'mobile') {
                            allConsignments.sort((a, b) => new Date(b.order['Order Date']) - new Date(a.order['Order Date']));
                            renderOrderList(allConsignments);
                        } else {
                            resultsContainer.innerHTML = '';
                            allConsignments.forEach(showConsignmentDetails);
                        }
                        showMessage('Tracking results successfully loaded.', 'success');
                    } else {
                        showMessage(`No orders found for the ${currentSearchType} number(s) provided.`, 'error');
                    }
                } catch (error) {
                    console.error('An unexpected error occurred:', error);
                    showMessage('A network error occurred. Please check your internet connection and try again.', 'error');
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            }

            function renderOrderList(consignments) {
                const modeMap = {'E': 'Express', 'P': 'Premium', 'A': 'Airline', 'S': 'Surface'};
                resultsContainer.innerHTML = `<div class="card space-y-4"><h2 class="text-xl font-semibold text-gray-700">Orders Found</h2><ul class="space-y-4">${consignments.map((c, i) => `
                    <li class="order-list-item">
                        <div class="grid grid-cols-2 gap-x-6 gap-y-2 flex-grow">
                            <div class="col-span-2 sm:col-span-1">
                                <p class="font-medium text-gray-800">Status: ${c.track?.['Current Status'] || 'N/A'}</p>
                                <p class="text-sm text-gray-600">AWB: ${c.order['AWB Booked']}</p>
                                <p class="text-sm text-gray-600">Date: ${formatDateTime(c.order['Order Date'])}</p>
                            </div>
                            <div class="col-span-2 sm:col-span-1">
                                <p class="text-sm text-gray-600">Carrier: ${c.order['Carrier Name']}</p>
                                <p class="text-sm text-gray-500">Mode: ${modeMap[c.order['Billing Mode']] || c.order['Billing Mode']}</p>
                            </div>
                            <div class="col-span-2"><p class="text-sm text-gray-600">To: ${c.order['Consignee Name']} - ${c.order['Consignee City']}</p></div>
                        </div>
                        <button class="track-btn px-4 py-2 bg-blue-800 text-white font-semibold rounded-lg hover:bg-blue-900" data-index="${i}">Track</button>
                    </li>`).join('')}</ul></div>`;
            }

            function showConsignmentDetails(consignment) {
                const { order, track, logs } = consignment;
                if (logs) logs.sort((a, b) => new Date(b['Scan Date']) - new Date(a['Scan Date']));
                const modeMap = {'E': 'Express', 'P': 'Premium', 'A': 'Airline', 'S': 'Surface'};
                const latestLogDate = logs && logs.length > 0 ? logs[0]['Scan Date'] : null;
                const currentUpdateDate = track?.['Current Date'] || latestLogDate;
                const currentStatus = track?.['Current Status'] || 'Status N/A';
                const edd = order.EDD ? formatDateTime(order.EDD) : 'N/A';
                
                let html = `<div class="card space-y-4 mb-8">
                    <h2 class="text-xl font-semibold text-gray-700">Order Details for AWB: ${order['AWB Booked']}</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-600">
                        <div class="bg-blue-50 p-4 rounded-lg border"><h3 class="font-medium text-gray-800">Reference & AWB</h3><p>Ref: <span class="font-semibold">${order.Ref}</span></p><p>AWB: <span class="font-semibold">${order['AWB Booked']}</span></p></div>
                        <div class="bg-blue-50 p-4 rounded-lg border"><h3 class="font-medium text-gray-800">Dates</h3><p>Order: <span class="font-semibold">${formatDateTime(order['Order Date'])}</span></p><p>EDD: <span class="font-semibold">${edd}</span></p></div>
                        <div class="bg-blue-50 p-4 rounded-lg border"><h3 class="font-medium text-gray-800">Shipment</h3><p>Carrier: <span class="font-semibold">${order['Carrier Name']}</span></p><p>Mode: <span class="font-semibold">${modeMap[order['Billing Mode']] || order['Billing Mode']}</span></p></div>
                        <div class="bg-blue-50 p-4 rounded-lg border"><h3 class="font-medium text-gray-800">From / To</h3><p>From: <span class="font-semibold">${order.Customer} - ${order['Sender City']}</span></p><p>To: <span class="font-semibold">${order['Consignee Name']} - ${order['Consignee City']}</span></p></div>
                    </div>
                    <div class="mt-6"><h2 class="text-xl font-semibold text-gray-700">Current Status</h2><p class="text-3xl font-bold text-gray-800">${currentStatus}</p><p class="text-gray-500">Last updated: ${formatDateTime(currentUpdateDate)}</p></div>
                    <div class="mt-6"><h2 class="text-xl font-semibold text-gray-700 mb-4">Scan History</h2>${(logs && logs.length > 0) ? `
                        <div class="overflow-x-auto rounded-lg border"><table class="scan-history-table w-full text-sm"><thead><tr><th class="py-3 px-4 font-semibold">Date</th><th class="py-3 px-4 font-semibold">Status & Remarks</th><th class="py-3 px-4 font-semibold">Location</th></tr></thead><tbody>
                        ${logs.map(log => `<tr class="hover:bg-gray-50"><td>${formatDateTime(log['Scan Date'])}</td><td>${log['Scan Status']} - ${log.Remark}</td><td>${log['Scan Location']}</td></tr>`).join('')}
                        </tbody></table></div>` : `<p class="text-gray-500">No scan history found.</p>`}
                    </div></div>`;
                resultsContainer.insertAdjacentHTML('beforeend', html);
            }
            
            function showScanHistoryModal(consignment) {
                const logs = consignment.logs;
                if (logs) logs.sort((a, b) => new Date(b['Scan Date']) - new Date(a['Scan Date']));
                let modalHtml = (logs && logs.length > 0) ? `
                    <div class="overflow-x-auto rounded-lg border"><table class="scan-history-table w-full text-sm">
                        <thead><tr><th class="py-3 px-4 font-semibold">Date</th><th class="py-3 px-4 font-semibold">Status & Remarks</th><th class="py-3 px-4 font-semibold">Location</th></tr></thead>
                        <tbody>${logs.map(log => `<tr class="hover:bg-gray-50"><td>${formatDateTime(log['Scan Date'])}</td><td>${log['Scan Status']} - ${log.Remark}</td><td>${log['Scan Location']}</td></tr>`).join('')}</tbody>
                    </table></div>` : `<p class="text-gray-500">No scan history found.</p>`;
                modalContent.innerHTML = modalHtml;
                scanHistoryModal.classList.remove('hidden');
            }

            function showMessage(text, type) {
                messageText.textContent = text;
                messageBox.classList.remove('hidden');
                messageBox.className = 'p-4 rounded-lg';
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                } else {
                    messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                }
            }
            updateButtonStyles();
        });
    </script>
</body>
</html>

