<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookOrder - Postman</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #1f2937;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-results {
            position: absolute;
            z-index: 10;
            width: 100%;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .autocomplete-results li {
            padding: 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
        }
        .autocomplete-results li:last-child {
            border-bottom: none;
        }
        .autocomplete-results li:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <div id="header-placeholder"></div>

    <main class="flex-grow p-1">
        <div class="container mx-auto bg-white flex flex-col border border-gray-400">

            <!-- Top Row -->
            <div class="flex flex-col md:flex-row border-b border-gray-400">
                <!-- Top Left: Booking Form -->
                <div class="w-full md:w-1/2 border-r border-gray-400">
                    <form id="bookingForm" class="">
                        <!-- Hidden timestamp input to preserve JS logic -->
                        <input type="text" id="timestamp" name="timestamp" readonly class="hidden">

                        <!-- Order Date & Customer Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-0 border border-gray-400 p-2">
                            <div class="p-2 border-r border-gray-400">
                                <input type="date" id="order_date" name="order_date" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="p-2">
                                <select id="customer_name" name="customer_name" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                   <option value="">Loading Customers...</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Sender & Receiver Flexbox -->
                        <div class="flex flex-col md:flex-row gap-0 border border-gray-400">
                            <!-- Sender Details -->
                            <div class="w-full md:w-1/2 p-2 autocomplete-container">
                                <input type="text" id="sender_name" name="sender_name" placeholder="Consignor Name or Mobile" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500 rounded-md" autocomplete="off">
                                <ul id="sender_autocomplete_results" class="autocomplete-results hidden"></ul>
                                <div id="senderDetailsDisplay" class="p-2 bg-white mt-2 min-h-[60px]">
                                    <span class="italic text-gray-500">Select a customer to autofill sender.</span>
                                </div>
                            </div>
                            <!-- Receiver Details -->
                            <div class="w-full md:w-1/2 border-t md:border-t-0 md:border-l border-gray-400 p-2 autocomplete-container">
                                <input type="text" id="receiver_name" name="receiver_name" placeholder="Consignee Name or Mobile" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500 rounded-md" autocomplete="off">
                                 <ul id="receiver_autocomplete_results" class="autocomplete-results hidden"></ul>
                                <div id="receiverDetailsDisplay" class="p-2 bg-white mt-2 min-h-[60px]">
                                    <span class="italic text-gray-500">Enter receiver details manually.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Mode & Carrier Grid -->
                        <div class="border border-gray-400">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-0 p-2">
                                <div class="p-2 border-r border-gray-400">
                                    <select id="transport_type" name="transport_type" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Loading Modes...</option>
                                    </select>
                                </div>
                                <div class="p-2">
                                     <select id="carrier_select" name="carrier_select" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Loading Carriers...</option>
                                    </select>
                                </div>
                            </div>
                            <div id="modeChangeMessage" class="text-xs text-blue-600 px-4 pb-2"></div>
                        </div>


                        <!-- Payment Type Grid -->
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-0 border border-gray-400 p-2">
                            <div class="flex items-center">
                                <input id="payment_global" type="checkbox" name="payment_type" value="global" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="payment_global" class="ml-2 text-sm text-gray-700">Global</label>
                            </div>
                            <div class="flex items-center">
                                <input id="payment_topay" type="checkbox" name="payment_type" value="topay" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="payment_topay" class="ml-2 text-sm text-gray-700">Topay</label>
                            </div>
                            <div class="flex items-center">
                                <input id="payment_cod" type="checkbox" name="payment_type" value="cod" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="payment_cod" class="ml-2 text-sm text-gray-700">COD</label>
                            </div>
                            <div class="flex items-center">
                                <input id="payment_fov" type="checkbox" name="payment_type" value="fov" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="payment_fov" class="ml-2 text-sm text-gray-700">FOV</label>
                            </div>
                        </div>

                        <!-- Origin & Destination Pincode (Hidden) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-0 border border-gray-400 hidden">
                            <div class="p-2 border-r border-gray-400">
                                <input type="tel" id="origin_pincode" name="origin_pincode" pattern="[0-9]{6}" maxlength="6" placeholder="Origin Pincode" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500 rounded-md">
                            </div>
                            <div class="p-2">
                                <input type="tel" id="dest_pincode" name="dest_pincode" pattern="[0-9]{6}" maxlength="6" placeholder="Destination Pincode" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500 rounded-md">
                            </div>
                        </div>

                        <!-- Consignment Details Grid -->
                        <div id="multiboxErrorMessage" class="text-xs text-red-500 px-2 pt-2"></div>
                        <div class="flex items-center gap-0 border border-gray-400 p-2">
                            <input type="number" id="actual_weight" name="actual_weight" placeholder="Wgt (kg)" class="w-1/4 p-1 border-r border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            <input type="number" id="length" name="length" placeholder="L (cm)" class="w-1/4 p-1 border-r border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            <input type="number" id="breadth" name="breadth" placeholder="B (cm)" class="w-1/4 p-1 border-r border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            <input type="number" id="height" name="height" placeholder="H (cm)" class="w-1/4 p-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- Product Details Grid -->
                        <div class="flex items-end gap-0 border border-gray-400 p-2">
                            <input type="text" id="product_name" name="product_name" placeholder="Product" class="w-1/5 p-1 border-r border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" id="doc_no" name="doc_no" placeholder="DocNo" class="w-1/5 p-1 border-r border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" id="eway_bill" name="eway_bill" placeholder="EWay" class="w-1/5 p-1 border-r border-gray-300 focus:ring-blue-500 focus:border-blue-500" pattern="\d{12}" maxlength="12" title="EWay bill must be a 12-digit numeric number.">
                            <select id="product_type" name="product_type" class="w-1/5 p-1 border-r border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                <option value="INV">INV</option>
                                <option value="CLN">CLN</option>
                                <option value="DEC">DEC</option>
                                <option value="ADH">ADH</option>
                            </select>
                            <input type="number" id="amount" name="amount" placeholder="Amount (₹)" class="w-1/5 p-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div id="ewayStatusMessage" class="text-xs text-red-500 mt-1 px-2"></div>
                        
                        <!-- AWB and Action Buttons -->
                        <div class="flex items-center gap-2 border border-gray-400 p-2">
                            <div class="relative flex-grow">
                                <input type="text" id="awb" name="awb" placeholder="AWB" class="w-full p-2 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 pr-10">
                                <button type="button" id="getAwbButton" class="absolute inset-y-0 right-0 flex items-center px-2 text-gray-500 hover:text-gray-700" title="Get AWB">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 9a9 9 0 0115.12-4.38M20 20v-5h-5"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 15a9 9 0 01-15.12 4.38"></path>
                                    </svg>
                                </button>
                            </div>
                            <button id="cancel_button" type="button" class="flex-grow bg-red-600 text-white py-2 px-4 text-sm font-medium hover:bg-red-700 rounded-md shadow-sm">
                                Cancel
                            </button>
                            <button id="book_button" type="button" class="flex-grow bg-gray-800 text-white py-2 px-4 text-sm font-medium hover:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                Book
                            </button>
                        </div>
                        <!-- Inline Message Display Area -->
                        <div id="bookingMessage" class="p-2 text-sm text-center rounded-md mt-2"></div>
                    </form>

                    <!-- Order Details Table (HIDDEN) -->
                    <div id="orderTableSection" class="p-4 bg-white border-t border-gray-400 hidden">
                        <h3 class="text-lg font-semibold mb-2 text-gray-800">Order Details</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <tbody class="divide-y divide-gray-300">
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50 w-1/4">REFERENCE</td>
                                        <td id="display_reference" class="px-2 py-1 w-1/4">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50 w-1/4">BRANCH</td>
                                        <td id="display_branch" class="px-2 py-1 w-1/4">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">CODE</td>
                                        <td id="display_code" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">USER_NAME</td>
                                        <td id="display_user_name" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">TIME_STAMP</td>
                                        <td id="display_timestamp" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">ORDER_DATE</td>
                                        <td id="display_order_date" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">CARRIER</td>
                                        <td id="display_carrier" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">AWB_NUMBER</td>
                                        <td id="display_awb_number" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">TRANSIT_DATE</td>
                                        <td id="display_transit_date" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">CONSIGNOR</td>
                                        <td id="display_consignor" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">ORIGIN_CITY</td>
                                        <td id="display_origin_city" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">ORIGIN_PINCODE</td>
                                        <td id="display_origin_pincode" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">CONSIGNEE</td>
                                        <td id="display_consignee" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">DEST_CITY</td>
                                        <td id="display_dest_city" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">DEST_PINCODE</td>
                                        <td id="display_dest_pincode" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">TAT</td>
                                        <td id="display_tat" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">ZONE</td>
                                        <td id="display_zone" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">MODE</td>
                                        <td id="display_mode" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">GLOBAL</td>
                                        <td id="display_global" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">COD</td>
                                        <td id="display_cod" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">TOPAY</td>
                                        <td id="display_topay" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">FOV</td>
                                        <td id="display_fov" class="px-2 py-1">---</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Top Right: Multibox & Product -->
                <div class="w-full md:w-1/2">
                    <!-- Multibox Section -->
                    <div id="multiboxSection" class="p-4 bg-white">
                        <div class="overflow-x-auto">
                            <table class="min-w-full border-collapse border border-gray-400">
                                <thead>
                                    <tr class="bg-gray-200 text-gray-700 text-sm">
                                        <th class="p-2 border border-gray-400 text-left">BoxNum</th>
                                        <th class="p-2 border border-gray-400 text-left">Wgt</th>
                                        <th class="p-2 border border-gray-400 text-left">L</th>
                                        <th class="p-2 border border-gray-400 text-left">B</th>
                                        <th class="p-2 border border-gray-400 text-left">H</th>
                                        <th class="p-2 border border-gray-400 text-left">Vol.Wt</th>
                                        <th class="p-2 border border-gray-400 text-left">Chg.Wt</th>
                                    </tr>
                                </thead>
                                <tbody id="multiboxTableBody">
                                    <!-- Multibox rows will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div id="multiboxTotals" class="flex justify-between items-center mt-4">
                            <div id="multiboxTotalsText" class="text-sm font-semibold text-gray-700 space-y-1 hidden">
                                <!-- Totals will be displayed here dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Product Section -->
                    <div id="productSection" class="p-4 bg-white border-t border-gray-400">
                        <div class="overflow-x-auto">
                            <table class="min-w-full border-collapse border border-gray-400">
                                <thead>
                                    <tr class="bg-gray-200 text-gray-700 text-sm">
                                        <th class="p-2 border border-gray-400 text-left">SrNo</th>
                                        <th class="p-2 border border-gray-400 text-left">Product</th>
                                        <th class="p-2 border border-gray-400 text-left">DocNo</th>
                                        <th class="p-2 border border-gray-400 text-left">EWay</th>
                                        <th class="p-2 border border-gray-400 text-left">Type</th>
                                        <th class="p-2 border border-gray-400 text-left">Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="productTableBody">
                                    <!-- Product rows will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div id="productTotals" class="flex justify-end items-center mt-4 space-x-2">
                            <div id="productTotalsText" class="text-sm font-semibold text-gray-700 space-y-1 hidden">
                                <!-- Totals will be displayed here dynamically -->
                            </div>
                            <button id="clearMultiboxButton" class="bg-yellow-500 text-white py-1 px-3 rounded-md text-xs font-medium hover:bg-yellow-600">
                                Clear Multibox
                            </button>
                            <button id="clearProductsButton" class="bg-red-500 text-white py-1 px-3 rounded-md text-xs font-medium hover:bg-red-600">
                                Clear Product
                            </button>
                            <button id="clearAllButton" class="bg-gray-500 text-white py-1 px-3 rounded-md text-xs font-medium hover:bg-gray-600">
                                Clear All
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Combined Summary and Charges Row -->
            <div class="flex flex-col md:flex-row border-b border-gray-400">
                <!-- Left: Summary -->
                <div class="w-full md:w-1/2 border-r border-gray-400">
                    <div id="summarySection" class="p-4 bg-white">
                        <div class="grid grid-cols-4 gap-4 text-center">
                            <div>
                                <p class="text-sm text-gray-500">WEIGHT</p>
                                <p id="display_weight" class="text-lg font-bold text-gray-800">---</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">CHG_WT</p>
                                <p id="display_chg_wt" class="text-lg font-bold text-gray-800">---</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">PIECES</p>
                                <p id="display_pieces" class="text-lg font-bold text-gray-800">---</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">VALUE</p>
                                <p id="display_value" class="text-lg font-bold text-gray-800">---</p>
                            </div>
                        </div>
                    </div>
                    <!-- Helper Table Section -->
                    <div id="helperTableSection" class="p-4 bg-white border-t border-gray-400 hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full border-collapse border border-gray-400 text-sm">
                                <thead>
                                    <tr class="bg-gray-100 text-gray-600">
                                        <th class="p-2 border border-gray-400 text-left">WEIGHT_CEILING</th>
                                        <th class="p-2 border border-gray-400 text-left">WEIGHT_ZONE</th>
                                        <th class="p-2 border border-gray-400 text-left">RATE_UID</th>
                                        <th class="p-2 border border-gray-400 text-left">RATE</th>
                                        <th class="p-2 border border-gray-400 text-left">ADD_RATE</th>
                                    </tr>
                                </thead>
                                <tbody id="helperTableBody">
                                    <tr>
                                        <td class="p-2 border border-gray-400" id="display_weight_ceiling">---</td>
                                        <td class="p-2 border border-gray-400" id="display_weight_zone">---</td>
                                        <td class="p-2 border border-gray-400" id="display_rate_uid">---</td>
                                        <td class="p-2 border border-gray-400" id="display_rate">---</td>
                                        <td class="p-2 border border-gray-400" id="display_add_rate">---</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Right: Charges -->
                <div class="w-full md:w-1/2">
                     <div id="chargesSection" class="p-4 bg-white">
                        <h3 class="text-lg font-semibold mb-2 text-gray-800 hidden">Charges & Taxes</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <tbody class="divide-y divide-gray-300">
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50 w-1/4">FRIGHT</td>
                                        <td id="display_fright" class="px-2 py-1 w-1/4 text-right">0.00</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50 w-1/4">OTHER CHARGES</td>
                                        <td id="display_other_chg" class="px-2 py-1 w-1/4 text-right">0.00</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50 w-1/4">GST</td>
                                        <td id="display_gst_total" class="px-2 py-1 w-1/4 text-right">0.00</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-blue-100 text-blue-800 text-base w-1/4">TOTAL</td>
                                        <td id="display_total" class="px-2 py-1 text-right font-bold text-blue-800 text-base w-1/4">0.00</td>
                                    </tr>
                                </tbody>
                            </table>
                             <!-- Hidden elements for preserving post data -->
                            <div class="hidden">
                                <span id="display_fuel_chg"></span>
                                <span id="display_cod_chg"></span>
                                <span id="display_topay_chg"></span>
                                <span id="display_fov_chg"></span>
                                <span id="display_eway_chg"></span>
                                <span id="display_awb_chg"></span>
                                <span id="display_pack_chg"></span>
                                <span id="display_dev_chg"></span>
                                <span id="display_taxable"></span>
                                <span id="display_sgst"></span>
                                <span id="display_cgst"></span>
                                <span id="display_igst"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>
    
    <!-- NEW: Last 10 Shipments Section -->
    <div id="shipmentListContainer" class="container mx-auto bg-white border border-gray-400 mt-4">
        <h2 class="text-xl font-bold text-gray-800 p-4 border-b hidden">
            Last 10 Shipments
        </h2>
        
        <!-- Header Row (Desktop only) -->
        <div class="hidden md:grid md:grid-cols-6 gap-4 font-semibold text-gray-600 p-4 border-b bg-gray-50">
            <div class="col-span-1">Date</div>
            <div class="col-span-1">Ref / AWB</div>
            <div class="col-span-1">Carrier / Mode</div>
            <div class="col-span-1">Pieces / Value</div>
            <div class="col-span-1">Parties</div>
            <div class="col-span-1">Destination</div>
        </div>

        <!-- Data List (Responsive Cards) -->
-       <div id="shipmentList" class="divide-y divide-gray-200 md:divide-y-0">
+       <div id="shipmentList">
            <p class="p-4 text-center text-gray-500">Loading shipments...</p>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="layout.js"></script>
    <script src="calculations.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const timestampInput = document.getElementById('timestamp');
            const orderDateInput = document.getElementById('order_date');
            const senderNameInput = document.getElementById('sender_name');
            const senderDetailsDisplay = document.getElementById('senderDetailsDisplay');
            const senderAutocompleteResults = document.getElementById('sender_autocomplete_results');
            const receiverNameInput = document.getElementById('receiver_name');
            const receiverDetailsDisplay = document.getElementById('receiverDetailsDisplay');
            const receiverAutocompleteResults = document.getElementById('receiver_autocomplete_results');
            const originPincodeInput = document.getElementById('origin_pincode');
            const destPincodeInput = document.getElementById('dest_pincode');
            const actualWeightInput = document.getElementById('actual_weight');
            const lengthInput = document.getElementById('length');
            const breadthInput = document.getElementById('breadth');
            const heightInput = document.getElementById('height');
            const multiboxTableBody = document.getElementById('multiboxTableBody');
            const clearMultiboxButton = document.getElementById('clearMultiboxButton');
            const multiboxErrorMessage = document.getElementById('multiboxErrorMessage');
            const modeChangeMessage = document.getElementById('modeChangeMessage');
            const productTableBody = document.getElementById('productTableBody');
            const productNameInput = document.getElementById('product_name');
            const docNoInput = document.getElementById('doc_no');
            const ewayBillInput = document.getElementById('eway_bill');
            const productTypeSelect = document.getElementById('product_type');
            const amountInput = document.getElementById('amount');
            const ewayStatusMessage = document.getElementById('ewayStatusMessage');
            const clearProductsButton = document.getElementById('clearProductsButton');
            const clearAllButton = document.getElementById('clearAllButton');
            const bookButton = document.getElementById('book_button');
            const cancelButton = document.getElementById('cancel_button');
            const getAwbButton = document.getElementById('getAwbButton');
            const customerNameSelect = document.getElementById('customer_name');
            const transportTypeSelect = document.getElementById('transport_type');
            const carrierSelect = document.getElementById('carrier_select');
            const bookingMessage = document.getElementById('bookingMessage');
            const shipmentList = document.getElementById('shipmentList'); // ADDED

            let loginData = {};
            let isBookingLocked = false;
            let wasModeUnlocked = false; 
            let userMadeInitialModeChoice = false;
            let fetchedGSheetData = {};
            let consignmentBoxes = [];
            let consignmentProducts = [];
            let selectedCustomerDetails = {};
            let selectedContacts = { sender: null, receiver: null };
            let summaryTotals = {
                totalWgt: 0,
                totalChgWt: 0,
                boxCount: 0,
                totalAmount: 0
            };

            // NEW: Function to render the last 10 shipments
            function renderShipmentList(orders) {
                if (!shipmentList) return;
                if (!orders || orders.length === 0) {
                    shipmentList.innerHTML = '<p class="p-4 text-center text-gray-500">No shipments found.</p>';
                    return;
                }

                // --- UPDATE START: Fix sorting and add mappings ---
                
                // Sort by REFERANCE number descending, then take the top 10
                const sortedOrders = [...orders].sort((a, b) => {
                    const refA = Number(a.REFERANCE) || 0;
                    const refB = Number(b.REFERANCE) || 0;
                    return refB - refA; // Sorts descending
                });
                const lastTenOrders = sortedOrders.slice(0, 10);

                // Helper maps for displaying full names
                const modeMap = new Map();
                if (fetchedGSheetData.MODE) {
                    fetchedGSheetData.MODE.forEach(m => modeMap.set(m.SHORT, m.MODE));
                }
                const getModeName = (shortCode) => modeMap.get(shortCode) || shortCode;

                const contactMap = new Map();
                if (fetchedGSheetData.B2B2C) {
                    fetchedGSheetData.B2B2C.forEach(c => contactMap.set(c.UID, c.NAME));
                }
                const getContactName = (uid) => contactMap.get(uid) || uid;

                // --- UPDATE END ---

                shipmentList.innerHTML = ''; // Clear loader

                lastTenOrders.forEach(order => {
                    const orderCard = document.createElement('div');
                    // This class list makes it a card on mobile and a grid row on desktop
-                   orderCard.className = "bg-white p-4 rounded-lg shadow md:shadow-none md:rounded-none md:grid md:grid-cols-6 md:gap-4 md:p-4 md:border-b items-start mb-4 md:mb-0";
+                   orderCard.className = "bg-white p-4 rounded-lg shadow md:shadow-none md:rounded-none md:grid md:grid-cols-6 md:gap-4 md:border-b items-start mb-4 md:mb-0";
                    
                    // Helper functions for clean data display
                    const val = (v) => v || '---';
                    const valNum = (v) => v || 0;
                    // Format value as currency, or '---' if not present
                    const valVal = (v) => v ? `₹${Number(v).toFixed(2)}` : '---';
                    const valDate = (d) => {
                        if (!d) return '---';
                        try {
                            const date = new Date(d);
                            const day = String(date.getDate()).padStart(2, '0');
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const year = date.getFullYear();
                            return `${day}/${month}/${year}`;
                        } catch (e) {
                            return '---';
                        }
                    };

-                   orderCard.innerHTML = `
-                       <!-- Col 1: Date -->
-                       <div class="mb-2 md:mb-0">
-                           <!-- Mobile label -->
-                           <span class="font-bold text-sm text-gray-500 md:hidden">Date</span>
-                           <!-- Data -->
-                           <span class="block font-medium">${valDate(order.ORDER_DATE)}</span>
-                           <span class="block text-sm text-gray-600">${valDate(order.TRANSIT_DATE)}</span>
-                       </div>
-
-                       <!-- Col 2: Ref/AWB -->
-                       <div class="mb-2 md:mb-0">
-                           <!-- Mobile label -->
-                           <span class="font-bold text-sm text-gray-500 md:hidden">Ref / AWB</span>
-                           <!-- Data -->
-                           <span class="block font-medium text-blue-600">${val(order.REFERANCE)}</span>
-                           <span class="block text-sm text-gray-600">${val(order.AWB_NUMBER)}</span>
-                       </div>
-                       
-                       <!-- Col 3: Carrier/Mode -->
-                       <div class="mb-2 md:mb-0">
-                           <span class="font-bold text-sm text-gray-500 md:hidden">Carrier / Mode</span>
-                           <span class="block font-medium">${val(order.CARRIER)}</span>
-                           <!-- UPDATE: Use getModeName helper -->
-                           <span class="block text-sm text-gray-600">${getModeName(val(order.MODE))}</span>
-                       </div>
-                       
-                       <!-- Col 4: Pieces/Value -->
-                       <div class="mb-2 md:mb-0">
-                           <span class="font-bold text-sm text-gray-500 md:hidden">Pieces / Value</span>
-                           <span class="block font-medium">${valNum(order.PIECS)}</span>
-                           <span class="block text-sm text-gray-600">${valVal(order.VALUE)}</span>
-                       </div>
-                       
-                       <!-- Col 5: Parties -->
-                       <div class="mb-2 md:mb-0">
-                           <span class="font-bold text-sm text-gray-500 md:hidden">Parties</span>
-                           <!-- UPDATE: Use getContactName helper -->
-                           <span class="block font-medium">${getContactName(val(order.CONSIGNOR))}</span>
-                           <span class="block text-sm text-gray-600">${getContactName(val(order.CONSIGNEE))}</span>
-                       </div>
-                       
-                       <!-- Col 6: Destination -->
-                       <div class="mb-2 md:mb-0">
-                           <span class="font-bold text-sm text-gray-500 md:hidden">Destination</span>
-                           <span class="block font-medium">${val(order.DEST_CITY)}</span>
-                           <span class="block text-sm text-gray-600">${val(order.DEST_PINCODE)}</span>
-                       </div>
-                   `;
+                   orderCard.innerHTML = `
+                       <!-- Mobile Layout -->
+                       <div class="flex flex-col md:hidden">
+                           <!-- Row 1: Date, Ref/AWB, Pieces/Value -->
+                           <div class="flex justify-between mb-2">
+                               <div class="w-1/3">
+                                   <span class="font-bold text-sm text-gray-500">Date</span>
+                                   <span class="block font-medium">${valDate(order.ORDER_DATE)}</span>
+                               </div>
+                               <div class="w-1/3">
+                                   <span class="font-bold text-sm text-gray-500">Ref / AWB</span>
+                                   <span class="block font-medium text-blue-600">${val(order.REFERANCE)}</span>
+                               </div>
+                               <div class="w-1/3 text-right">
+                                   <span class="font-bold text-sm text-gray-500">Pieces / Value</span>
+                                   <span class="block font-medium">${valNum(order.PIECS)}</span>
+                                   <span class="block text-sm text-gray-600">${valVal(order.VALUE)}</span>
+                               </div>
+                           </div>
+                           <!-- Row 2: Carrier/Mode, Destination -->
+                           <div class="flex justify-between mb-2">
+                               <div class="w-1/2">
+                                   <span class="font-bold text-sm text-gray-500">Carrier / Mode</span>
+                                   <span class="block font-medium">${val(order.CARRIER)}</span>
+                                   <span class="block text-sm text-gray-600">${getModeName(val(order.MODE))}</span>
+                               </div>
+                               <div class="w-1/2 text-right">
+                                   <span class="font-bold text-sm text-gray-500">Destination</span>
+                                   <span class="block font-medium">${val(order.DEST_CITY)}</span>
+                                   <span class="block text-sm text-gray-600">${val(order.DEST_PINCODE)}</span>
+                               </div>
+                           </div>
+                           <!-- Row 3: Parties -->
+                           <div class="mb-0"> <!-- No margin-bottom on last element -->
+                               <span class="font-bold text-sm text-gray-500">Parties</span>
+                               <span class="block font-medium">${getContactName(val(order.CONSIGNOR))}</span>
+                               <span class="block text-sm text-gray-600">${getContactName(val(order.CONSIGNEE))}</span>
+                           </div>
+                       </div>
+
+                       <!-- Desktop Layout (Original Grid Columns) -->
+                       <!-- Col 1: Date -->
+                       <div class="hidden md:block">
+                           <span class="block font-medium">${valDate(order.ORDER_DATE)}</span>
+                           <span class="block text-sm text-gray-600">${valDate(order.TRANSIT_DATE)}</span>
+                       </div>
+                       <!-- Col 2: Ref/AWB -->
+                       <div class="hidden md:block">
+                           <span class="block font-medium text-blue-600">${val(order.REFERANCE)}</span>
+                           <span class="block text-sm text-gray-600">${val(order.AWB_NUMBER)}</span>
+                       </div>
+                       <!-- Col 3: Carrier/Mode -->
+                       <div class="hidden md:block">
+                           <span class="block font-medium">${val(order.CARRIER)}</span>
+                           <span class="block text-sm text-gray-600">${getModeName(val(order.MODE))}</span>
+                       </div>
+                       <!-- Col 4: Pieces/Value -->
+                       <div class="hidden md:block">
+                           <span class="block font-medium">${valNum(order.PIECS)}</span>
+                           <span class="block text-sm text-gray-600">${valVal(order.VALUE)}</span>
+                       </div>
+                       <!-- Col 5: Parties -->
+                       <div class="hidden md:block">
+                           <span class="block font-medium">${getContactName(val(order.CONSIGNOR))}</span>
+                           <span class="block text-sm text-gray-600">${getContactName(val(order.CONSIGNEE))}</span>
+                       </div>
+                       <!-- Col 6: Destination -->
+                       <div class="hidden md:block">
+                           <span class="block font-medium">${val(order.DEST_CITY)}</span>
+                           <span class="block text-sm text-gray-600">${val(order.DEST_PINCODE)}</span>
+                       </div>
+                   `;
                    shipmentList.appendChild(orderCard);
                });
            }
