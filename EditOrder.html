<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CreateOrder - Postman</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #1f2937;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-results {
            position: absolute;
            z-index: 10;
            width: 100%;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .autocomplete-results li {
            padding: 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
        }
        .autocomplete-results li:last-child {
            border-bottom: none;
        }
        .autocomplete-results li:hover {
            background-color: #f3f4f6;
        }
        .form-input {
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            padding: 0.5rem 0.75rem;
            transition: border-color 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .readonly-input {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <div id="header-placeholder"></div>

    <main class="flex-grow p-1">
        <div class="container mx-auto bg-white flex flex-col border border-gray-400">

            <!-- Top Row -->
            <div class="flex flex-col md:flex-row border-b border-gray-400">
                <!-- Top Left: Booking Form -->
                <div class="w-full md:w-1/2 border-r border-gray-400">
                    <form id="bookingForm" class="">
                        <!-- Hidden timestamp input to preserve JS logic -->
                        <input type="text" id="timestamp" name="timestamp" readonly class="hidden">

                        <!-- Order Date & Customer Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-0 border border-gray-400 p-2">
                            <div class="p-2 border-r border-gray-400">
                                <input type="date" id="order_date" name="order_date" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="p-2">
                                <select id="customer_name" name="customer_name" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                   <option value="">Loading Customers...</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Sender & Receiver Flexbox -->
                        <div class="flex flex-col md:flex-row gap-0 border border-gray-400">
                            <!-- Sender Details -->
                            <div class="w-full md:w-1/2 p-2 autocomplete-container">
                                <input type="text" id="sender_name" name="sender_name" placeholder="Consignor Name or Mobile" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500 rounded-md" autocomplete="off">
                                <ul id="sender_autocomplete_results" class="autocomplete-results hidden"></ul>
                                <div id="senderDetailsDisplay" class="p-2 bg-white mt-2 min-h-[60px]">
                                    <span class="italic text-gray-500">Select a customer to autofill sender.</span>
                                </div>
                            </div>
                            <!-- Receiver Details -->
                            <div class="w-full md:w-1/2 border-t md:border-t-0 md:border-l border-gray-400 p-2 autocomplete-container">
                                <input type="text" id="receiver_name" name="receiver_name" placeholder="Consignee Name or Mobile" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500 rounded-md" autocomplete="off">
                                 <ul id="receiver_autocomplete_results" class="autocomplete-results hidden"></ul>
                                <div id="receiverDetailsDisplay" class="p-2 bg-white mt-2 min-h-[60px]">
                                    <span class="italic text-gray-500">Enter receiver details manually.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Mode & Carrier Grid -->
                        <div class="border border-gray-400">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-0 p-2">
                                <div class="p-2 border-r border-gray-400">
                                    <select id="transport_type" name="transport_type" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Loading Modes...</option>
                                    </select>
                                </div>
                                <div class="p-2">
                                     <select id="carrier_select" name="carrier_select" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Loading Carriers...</option>
                                    </select>
                                </div>
                            </div>
                            <div id="modeChangeMessage" class="text-xs text-blue-600 px-4 pb-2"></div>
                        </div>


                        <!-- Payment Type Grid -->
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-0 border border-gray-400 p-2">
                            <div class="flex items-center">
                                <input id="payment_global" type="checkbox" name="payment_type" value="global" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="payment_global" class="ml-2 text-sm text-gray-700">Global</label>
                            </div>
                            <div class="flex items-center">
                                <input id="payment_topay" type="checkbox" name="payment_type" value="topay" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="payment_topay" class="ml-2 text-sm text-gray-700">Topay</label>
                            </div>
                            <div class="flex items-center">
                                <input id="payment_cod" type="checkbox" name="payment_type" value="cod" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="payment_cod" class="ml-2 text-sm text-gray-700">COD</label>
                            </div>
                            <div class="flex items-center">
                                <input id="payment_fov" type="checkbox" name="payment_type" value="fov" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="payment_fov" class="ml-2 text-sm text-gray-700">FOV</label>
                            </div>
                        </div>

                        <!-- Origin & Destination Pincode (Hidden) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-0 border border-gray-400 hidden">
                            <div class="p-2 border-r border-gray-400">
                                <input type="tel" id="origin_pincode" name="origin_pincode" pattern="[0-9]{6}" maxlength="6" placeholder="Origin Pincode" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500 rounded-md">
                            </div>
                            <div class="p-2">
                                <input type="tel" id="dest_pincode" name="dest_pincode" pattern="[0-9]{6}" maxlength="6" placeholder="Destination Pincode" class="w-full p-1 border border-gray-300 focus:ring-blue-500 focus:border-blue-500 rounded-md">
                            </div>
                        </div>

                        <!-- Consignment Details Grid -->
                        <div id="multiboxErrorMessage" class="text-xs text-red-500 px-2 pt-2"></div>
                        <div class="flex items-center gap-0 border border-gray-400 p-2">
                            <input type="number" id="actual_weight" name="actual_weight" placeholder="Wgt (kg)" class="w-1/4 p-1 border-r border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            <input type="number" id="length" name="length" placeholder="L (cm)" class="w-1/4 p-1 border-r border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            <input type="number" id="breadth" name="breadth" placeholder="B (cm)" class="w-1/4 p-1 border-r border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            <input type="number" id="height" name="height" placeholder="H (cm)" class="w-1/4 p-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- Product Details Grid -->
                        <div class="flex items-end gap-0 border border-gray-400 p-2">
                            <input type="text" id="product_name" name="product_name" placeholder="Product" class="w-1/5 p-1 border-r border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" id="doc_no" name="doc_no" placeholder="DocNo" class="w-1/5 p-1 border-r border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" id="eway_bill" name="eway_bill" placeholder="EWay" class="w-1/5 p-1 border-r border-gray-300 focus:ring-blue-500 focus:border-blue-500" pattern="\d{12}" maxlength="12" title="EWay bill must be a 12-digit numeric number.">
                            <select id="product_type" name="product_type" class="w-1/5 p-1 border-r border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                <option value="INV">INV</option>
                                <option value="CLN">CLN</option>
                                <option value="DEC">DEC</option>
                                <option value="ADH">ADH</option>
                            </select>
                            <input type="number" id="amount" name="amount" placeholder="Amount (₹)" class="w-1/5 p-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div id="ewayStatusMessage" class="text-xs text-red-500 mt-1 px-2"></div>
                        
                        <!-- AWB and Action Buttons -->
                        <div class="flex items-center gap-2 border border-gray-400 p-2">
                            <div class="relative flex-grow">
                                <input type="text" id="awb" name="awb" placeholder="AWB" class="w-full p-2 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 pr-10">
                                <button type="button" id="getAwbButton" class="absolute inset-y-0 right-0 flex items-center px-2 text-gray-500 hover:text-gray-700" title="Get AWB">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 9a9 9 0 0115.12-4.38M20 20v-5h-5"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 15a9 9 0 01-15.12 4.38"></path>
                                    </svg>
                                </button>
                            </div>
                            <button id="cancel_button" type="button" class="flex-grow bg-red-600 text-white py-2 px-4 text-sm font-medium hover:bg-red-700 rounded-md shadow-sm">
                                Cancel
                            </button>
                            <button id="book_button" type="button" class="flex-grow bg-gray-800 text-white py-2 px-4 text-sm font-medium hover:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                Book
                            </button>
                        </div>
                        <!-- Inline Message Display Area -->
                        <div id="bookingMessage" class="p-2 text-sm text-center rounded-md mt-2"></div>
                    </form>

                    <!-- Order Details Table -->
                    <div id="orderTableSection" class="p-4 bg-white border-t border-gray-400 hidden">
                        <h3 class="text-lg font-semibold mb-2 text-gray-800">Order Details</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <tbody class="divide-y divide-gray-300">
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50 w-1/4">REFERENCE</td>
                                        <td id="display_reference" class="px-2 py-1 w-1/4">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50 w-1/4">BRANCH</td>
                                        <td id="display_branch" class="px-2 py-1 w-1/4">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">CODE</td>
                                        <td id="display_code" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">USER_NAME</td>
                                        <td id="display_user_name" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">TIME_STAMP</td>
                                        <td id="display_timestamp" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">ORDER_DATE</td>
                                        <td id="display_order_date" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">CARRIER</td>
                                        <td id="display_carrier" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">AWB_NUMBER</td>
                                        <td id="display_awb_number" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">TRANSIT_DATE</td>
                                        <td id="display_transit_date" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">CONSIGNOR</td>
                                        <td id="display_consignor" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">ORIGIN_CITY</td>
                                        <td id="display_origin_city" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">ORIGIN_PINCODE</td>
                                        <td id="display_origin_pincode" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">CONSIGNEE</td>
                                        <td id="display_consignee" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">DEST_CITY</td>
                                        <td id="display_dest_city" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">DEST_PINCODE</td>
                                        <td id="display_dest_pincode" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">TAT</td>
                                        <td id="display_tat" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">ZONE</td>
                                        <td id="display_zone" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">MODE</td>
                                        <td id="display_mode" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">GLOBAL</td>
                                        <td id="display_global" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">COD</td>
                                        <td id="display_cod" class="px-2 py-1">---</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">TOPAY</td>
                                        <td id="display_topay" class="px-2 py-1">---</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50">FOV</td>
                                        <td id="display_fov" class="px-2 py-1">---</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Top Right: Multibox & Product -->
                <div class="w-full md:w-1/2">
                    <!-- Multibox Section -->
                    <div id="multiboxSection" class="p-4 bg-white">
                        <div class="overflow-x-auto">
                            <table class="min-w-full border-collapse border border-gray-400">
                                <thead>
                                    <tr class="bg-gray-200 text-gray-700 text-sm">
                                        <th class="p-2 border border-gray-400 text-left">BoxNum</th>
                                        <th class="p-2 border border-gray-400 text-left">Wgt</th>
                                        <th class="p-2 border border-gray-400 text-left">L</th>
                                        <th class="p-2 border border-gray-400 text-left">B</th>
                                        <th class="p-2 border border-gray-400 text-left">H</th>
                                        <th class="p-2 border border-gray-400 text-left">Vol.Wt</th>
                                        <th class="p-2 border border-gray-400 text-left">Chg.Wt</th>
                                    </tr>
                                </thead>
                                <tbody id="multiboxTableBody">
                                    <!-- Multibox rows will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div id="multiboxTotals" class="flex justify-between items-center mt-4">
                            <div id="multiboxTotalsText" class="text-sm font-semibold text-gray-700 space-y-1 hidden">
                                <!-- Totals will be displayed here dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Product Section -->
                    <div id="productSection" class="p-4 bg-white border-t border-gray-400">
                        <div class="overflow-x-auto">
                            <table class="min-w-full border-collapse border border-gray-400">
                                <thead>
                                    <tr class="bg-gray-200 text-gray-700 text-sm">
                                        <th class="p-2 border border-gray-400 text-left">SrNo</th>
                                        <th class="p-2 border border-gray-400 text-left">Product</th>
                                        <th class="p-2 border border-gray-400 text-left">DocNo</th>
                                        <th class="p-2 border border-gray-400 text-left">EWay</th>
                                        <th class="p-2 border border-gray-400 text-left">Type</th>
                                        <th class="p-2 border border-gray-400 text-left">Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="productTableBody">
                                    <!-- Product rows will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div id="productTotals" class="flex justify-end items-center mt-4 space-x-2">
                            <div id="productTotalsText" class="text-sm font-semibold text-gray-700 space-y-1 hidden">
                                <!-- Totals will be displayed here dynamically -->
                            </div>
                            <button id="clearMultiboxButton" class="bg-yellow-500 text-white py-1 px-3 rounded-md text-xs font-medium hover:bg-yellow-600">
                                Clear Multibox
                            </button>
                            <button id="clearProductsButton" class="bg-red-500 text-white py-1 px-3 rounded-md text-xs font-medium hover:bg-red-600">
                                Clear Product
                            </button>
                            <button id="clearAllButton" class="bg-gray-500 text-white py-1 px-3 rounded-md text-xs font-medium hover:bg-gray-600">
                                Clear All
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Combined Summary and Charges Row -->
            <div class="flex flex-col md:flex-row border-b border-gray-400">
                <!-- Left: Summary -->
                <div class="w-full md:w-1/2 border-r border-gray-400">
                    <div id="summarySection" class="p-4 bg-white">
                        <div class="grid grid-cols-4 gap-4 text-center">
                            <div>
                                <p class="text-sm text-gray-500">WEIGHT</p>
                                <p id="display_weight" class="text-lg font-bold text-gray-800">---</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">CHG_WT</p>
                                <p id="display_chg_wt" class="text-lg font-bold text-gray-800">---</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">PIECES</p>
                                <p id="display_pieces" class="text-lg font-bold text-gray-800">---</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">VALUE</p>
                                <p id="display_value" class="text-lg font-bold text-gray-800">---</p>
                            </div>
                        </div>
                    </div>
                    <!-- Helper Table Section -->
                    <div id="helperTableSection" class="p-4 bg-white border-t border-gray-400 hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full border-collapse border border-gray-400 text-sm">
                                <thead>
                                    <tr class="bg-gray-100 text-gray-600">
                                        <th class="p-2 border border-gray-400 text-left">WEIGHT_CEILING</th>
                                        <th class="p-2 border border-gray-400 text-left">WEIGHT_ZONE</th>
                                        <th class="p-2 border border-gray-400 text-left">RATE_UID</th>
                                        <th class="p-2 border border-gray-400 text-left">RATE</th>
                                        <th class="p-2 border border-gray-400 text-left">ADD_RATE</th>
                                    </tr>
                                </thead>
                                <tbody id="helperTableBody">
                                    <tr>
                                        <td class="p-2 border border-gray-400" id="display_weight_ceiling">---</td>
                                        <td class="p-2 border border-gray-400" id="display_weight_zone">---</td>
                                        <td class="p-2 border border-gray-400" id="display_rate_uid">---</td>
                                        <td class="p-2 border border-gray-400" id="display_rate">---</td>
                                        <td class="p-2 border border-gray-400" id="display_add_rate">---</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Right: Charges -->
                <div class="w-full md:w-1/2">
                     <div id="chargesSection" class="p-4 bg-white">
                        <h3 class="text-lg font-semibold mb-2 text-gray-800 hidden">Charges & Taxes</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <tbody class="divide-y divide-gray-300">
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50 w-1/4">FRIGHT</td>
                                        <td id="display_fright" class="px-2 py-1 w-1/4 text-right">0.00</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50 w-1/4">OTHER CHARGES</td>
                                        <td id="display_other_chg" class="px-2 py-1 w-1/4 text-right">0.00</td>
                                    </tr>
                                    <tr class="divide-x divide-gray-300">
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-gray-50 w-1/4">GST</td>
                                        <td id="display_gst_total" class="px-2 py-1 w-1/4 text-right">0.00</td>
                                        <td class="px-2 py-1 font-medium text-gray-600 bg-blue-100 text-blue-800 text-base w-1/4">TOTAL</td>
                                        <td id="display_total" class="px-2 py-1 text-right font-bold text-blue-800 text-base w-1/4">0.00</td>
                                    </tr>
                                </tbody>
                            </table>
                             <!-- Hidden elements for preserving post data -->
                            <div class="hidden">
                                <span id="display_fuel_chg"></span>
                                <span id="display_cod_chg"></span>
                                <span id="display_topay_chg"></span>
                                <span id="display_fov_chg"></span>
                                <span id="display_eway_chg"></span>
                                <span id="display_awb_chg"></span>
                                <span id="display_pack_chg"></span>
                                <span id="display_dev_chg"></span>
                                <span id="display_taxable"></span>
                                <span id="display_sgst"></span>
                                <span id="display_cgst"></span>
                                <span id="display_igst"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Add Contact Form Section (Initially Hidden) -->
    <div id="addContactSection" class="hidden flex-grow container mx-auto p-4">
        <div class="card bg-white p-6 rounded-lg shadow-md border border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-800 p-4 border-b mb-6">B2B2C Client Submission Form</h2>
            
            <form id="addContactForm" class="space-y-4">
                <!-- Hidden Authorization Fields -->
                <input type="hidden" id="add_contact_user" name="user">
                <input type="hidden" id="add_contact_token" name="token">
                <input type="hidden" id="add_contact_code" name="code">
                
                <!-- Data Fields Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <input type="tel" id="add_contact_mobile" name="mobile" placeholder="MOBILE" required class="form-input w-full">
                    <input type="text" id="add_contact_gst_id" name="gst_id" placeholder="GST/PAN/ADHAR" class="form-input w-full">
                    <input type="text" id="add_contact_branch" name="branch" placeholder="BRANCH" class="form-input w-full">
                    
                    <div class="relative">
                        <input type="text" id="add_contact_client_search" placeholder="Search Client (Name or Code)" class="form-input w-full" autocomplete="off">
                        <div id="add_contact_client_results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-60 overflow-y-auto hidden"></div>
                    </div>
                    <input type="text" id="add_contact_name" name="name" placeholder="NAME" required class="form-input w-full md:col-span-2">

                    <input type="text" id="add_contact_address" name="address" placeholder="ADDRESS" required class="form-input w-full md:col-span-2 lg:col-span-3">

                    <input type="email" id="add_contact_email" name="email" placeholder="EMAIL" class="form-input w-full md:col-span-2">
                    <input type="text" id="add_contact_pincode" name="pincode" placeholder="PINCODE" required class="form-input w-full">
                    
                    <input type="text" id="add_contact_city" name="city" placeholder="CITY" class="form-input w-full readonly-input" readonly>
                    <input type="text" id="add_contact_state" name="state" placeholder="STATE" class="form-input w-full readonly-input" readonly>
                    <input type="text" id="add_contact_zone" name="zone" placeholder="ZONE" class="form-input w-full readonly-input" readonly>
                    
                    <input type="text" id="add_contact_express_tat" name="express_tat" placeholder="EXPRESS TAT" class="form-input w-full readonly-input" readonly>
                    <input type="text" id="add_contact_airline_tat" name="airline_tat" placeholder="AIRLINE TAT" class="form-input w-full readonly-input md:col-span-2" readonly>
                    
                    <input type="text" id="add_contact_surface_tat" name="surface_tat" placeholder="SURFACE TAT" class="form-input w-full readonly-input" readonly>
                    <input type="text" id="add_contact_premium_tat" name="premium_tat" placeholder="PREMIUM TAT" class="form-input w-full readonly-input" readonly>
                    <input type="text" id="add_contact_oda" name="oda" placeholder="ODA" class="form-input w-full readonly-input" readonly>
                    <input type="text" id="add_contact_carrier" name="carrier" placeholder="CARRIER" class="form-input w-full readonly-input" readonly>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-end space-x-4 pt-4 border-t mt-6">
                    <button type="button" id="addContactCancelBtn" class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="addContactSubmitBtn" class="px-6 py-2 bg-blue-800 text-white font-semibold rounded-lg hover:bg-blue-900 transition-colors disabled:bg-gray-400 flex items-center">
                        <span id="addContactButtonText">Submit</span>
                        <svg id="addContactSpinner" class="animate-spin h-5 w-5 text-white ml-3 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
            <!-- Status message area -->
            <div id="addContactStatus" class="text-center font-medium mt-4 text-sm"></div>
        </div>
    </div>
    
    <div id="footer-placeholder"></div>

    <script src="layout.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENT REFERENCES (Main Booking Form) ---
            const mainFormContainer = document.querySelector('main');
            const addContactContainer = document.getElementById('addContactSection');
            const timestampInput = document.getElementById('timestamp');
            const orderDateInput = document.getElementById('order_date');
            const senderNameInput = document.getElementById('sender_name');
            const senderDetailsDisplay = document.getElementById('senderDetailsDisplay');
            const senderAutocompleteResults = document.getElementById('sender_autocomplete_results');
            const receiverNameInput = document.getElementById('receiver_name');
            const receiverDetailsDisplay = document.getElementById('receiverDetailsDisplay');
            const receiverAutocompleteResults = document.getElementById('receiver_autocomplete_results');
            const originPincodeInput = document.getElementById('origin_pincode');
            const destPincodeInput = document.getElementById('dest_pincode');
            const actualWeightInput = document.getElementById('actual_weight');
            const lengthInput = document.getElementById('length');
            const breadthInput = document.getElementById('breadth');
            const heightInput = document.getElementById('height');
            const multiboxTableBody = document.getElementById('multiboxTableBody');
            const clearMultiboxButton = document.getElementById('clearMultiboxButton');
            const multiboxErrorMessage = document.getElementById('multiboxErrorMessage');
            const modeChangeMessage = document.getElementById('modeChangeMessage');
            const productTableBody = document.getElementById('productTableBody');
            const productNameInput = document.getElementById('product_name');
            const docNoInput = document.getElementById('doc_no');
            const ewayBillInput = document.getElementById('eway_bill');
            const productTypeSelect = document.getElementById('product_type');
            const amountInput = document.getElementById('amount');
            const ewayStatusMessage = document.getElementById('ewayStatusMessage');
            const clearProductsButton = document.getElementById('clearProductsButton');
            const clearAllButton = document.getElementById('clearAllButton');
            const bookButton = document.getElementById('book_button');
            const cancelButton = document.getElementById('cancel_button');
            const getAwbButton = document.getElementById('getAwbButton');
            const customerNameSelect = document.getElementById('customer_name');
            const transportTypeSelect = document.getElementById('transport_type');
            const carrierSelect = document.getElementById('carrier_select');
            const bookingMessage = document.getElementById('bookingMessage');

            // --- STATE (Main Booking Form) ---
            let loginData = {};
            let isBookingLocked = false;
            let wasModeUnlocked = false; 
            let userMadeInitialModeChoice = false;
            let fetchedGSheetData = {};
            let consignmentBoxes = [];
            let consignmentProducts = [];
            let selectedCustomerDetails = {};
            let selectedContacts = { sender: null, receiver: null };
            let summaryTotals = {
                totalWgt: 0,
                totalChgWt: 0,
                boxCount: 0,
                totalAmount: 0
            };

            // --- BOOKING FORM FUNCTIONS ---
            function setBookingFieldsLocked(locked) {
                const fieldsToLock = [
                    'order_date', 'sender_name', 'receiver_name',
                    'transport_type', 'carrier_select', 'payment_global',
                    'payment_topay', 'payment_cod', 'payment_fov'
                ];
                fieldsToLock.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (locked && id === 'carrier_select' && element.value === '') {
                           return;
                        }
                        element.disabled = locked;
                        element.classList.toggle('bg-gray-200', locked);
                        element.classList.toggle('cursor-not-allowed', locked);
                    }
                });
                isBookingLocked = locked;
            }
            
             function toggleWeightProductEntry(locked) {
                const fields = [
                    actualWeightInput, lengthInput, breadthInput, heightInput,
                    productNameInput, docNoInput, ewayBillInput, productTypeSelect, amountInput
                ];
                fields.forEach(field => {
                    field.disabled = locked;
                    field.classList.toggle('bg-gray-200', locked);
                    field.classList.toggle('cursor-not-allowed', locked);
                });
            }

            function areMainDetailsComplete() {
                return customerNameSelect.value !== '' &&
                       !!selectedContacts.sender &&
                       !!selectedContacts.receiver &&
                       transportTypeSelect.value !== '' &&
                       carrierSelect.value !== '';
            }

             function checkMainDetailsAndToggleInputs() {
                toggleWeightProductEntry(!areMainDetailsComplete());
            }

            function resetForNextBooking() {
                consignmentBoxes = [];
                consignmentProducts = [];
                
                ['receiver_name', 'awb', 'actual_weight', 'length', 'breadth', 'height', 'product_name', 'doc_no', 'eway_bill', 'amount'].forEach(id => document.getElementById(id).value = '');
                ['payment_global', 'payment_topay', 'payment_cod', 'payment_fov'].forEach(id => document.getElementById(id).checked = false);
                
                selectedContacts.receiver = null;
                receiverDetailsDisplay.innerHTML = `<span class="italic text-gray-500">Enter receiver details manually.</span>`;

                transportTypeSelect.value = '';
                carrierSelect.value = '';

                renderMultiboxTable();
                renderProductTable();
                
                setBookingFieldsLocked(false); 
                toggleWeightProductEntry(true); 
                updateDisplayTables();
            }

            function resetFullForm() {
                consignmentBoxes = [];
                consignmentProducts = [];
                renderMultiboxTable();
                renderProductTable();
                setBookingFieldsLocked(false);
                userMadeInitialModeChoice = false;
                document.getElementById('bookingForm').reset();
                orderDateInput.value = formatDate(new Date());
                senderDetailsDisplay.innerHTML = `<span class="italic text-gray-500">Select a customer to autofill sender.</span>`;
                receiverDetailsDisplay.innerHTML = `<span class="italic text-gray-500">Enter receiver details manually.</span>`;
                bookingMessage.textContent = '';
                bookingMessage.className = 'p-2 text-sm text-center rounded-md mt-2';
                selectedContacts.sender = null;
                selectedContacts.receiver = null;
                selectedCustomerDetails = {};
                updateDisplayTables();
                updateCharges();
                toggleWeightProductEntry(true);
            }

            function formatDate(date) {
                return date.toISOString().split('T')[0];
            }

            function formatTime(date) {
                const hh = String(date.getHours()).padStart(2, '0');
                const min = String(date.getMinutes()).padStart(2, '0');
                return `${hh}:${min}`;
            }

            function updateTimestamp() {
                const now = new Date();
                timestampInput.value = `${formatDate(now)} ${formatTime(now)}`;
                updateDisplayTables();
            }
            
            function calculateFreight() {
                const rate = parseFloat(document.getElementById('display_rate').textContent);
                const addRate = parseFloat(document.getElementById('display_add_rate').textContent);
                const weightCeiling = parseFloat(document.getElementById('display_weight_ceiling').textContent);
                const weightZone = parseFloat(document.getElementById('display_weight_zone').textContent);
                const selectedMode = transportTypeSelect.value;

                if (isNaN(rate) || isNaN(weightCeiling)) return 0;

                let fright = 0;
                if (selectedMode === 'E' || selectedMode === 'P') {
                     fright = isNaN(addRate) ? rate : rate + ((weightCeiling * 2) - 1) * addRate;
                } else {
                     if (!isNaN(addRate) && !isNaN(weightZone)) {
                        fright = rate + ((weightCeiling - weightZone) * addRate);
                    } else {
                       fright = weightCeiling * rate; 
                    }
                }
                return fright > 0 ? fright : 0;
            }

            function updateHelperTable() {
                const chgWt = parseFloat(document.getElementById('display_chg_wt').textContent) || 0;
                const weightChange = parseFloat(selectedCustomerDetails.WEIGHT_CHANGE);
                const weightCeiling = (!isNaN(weightChange) && chgWt >= weightChange) ? Math.ceil(chgWt * 2) / 2 : Math.ceil(chgWt);
                document.getElementById('display_weight_ceiling').textContent = weightCeiling.toFixed(2);
                
                let weightZone = '---';
                const selectedMode = transportTypeSelect.value;
                if (selectedMode) {
                    if (selectedMode === 'E' || selectedMode === 'P') {
                        weightZone = 0.5;
                    } else {
                        const zoneThresholds = [3, 10, 25, 50, 100, 500, 1000];
                        weightZone = zoneThresholds.reduce((acc, threshold) => (weightCeiling >= threshold ? threshold : acc), 0);
                    }
                }
                document.getElementById('display_weight_zone').textContent = weightZone;
                
                const customerCode = selectedCustomerDetails.CODE;
                const rateUid = (customerCode && selectedMode && weightZone !== '---') ? `${customerCode}${selectedMode}${weightZone}` : '---';
                document.getElementById('display_rate_uid').textContent = rateUid;

                let rate = '---', addRate = '---';
                const receiverZone = selectedContacts.receiver?.ZONE;
                const ratesData = fetchedGSheetData.RATES;
                if (rateUid !== '---' && receiverZone && ratesData) {
                    const rateRow = ratesData.find(r => r.UID === rateUid);
                    if (rateRow) rate = rateRow[receiverZone] || '---';
                    const addRateRow = ratesData.find(r => r.UID === `${rateUid}A`);
                    if (addRateRow) addRate = addRateRow[receiverZone] || '---';
                }
                document.getElementById('display_rate').textContent = rate;
                document.getElementById('display_add_rate').textContent = addRate;
                
                updateCharges();
            }

            function updateSummaryDisplay() {
                const selectedModeOption = transportTypeSelect.options[transportTypeSelect.selectedIndex];
                const minWt = parseFloat(selectedModeOption?.dataset.minWt) || 0;
                const finalTotalChgWt = Math.max(summaryTotals.totalChgWt, minWt);

                document.getElementById('display_weight').textContent = summaryTotals.totalWgt ? summaryTotals.totalWgt.toFixed(2) : '---';
                document.getElementById('display_chg_wt').textContent = finalTotalChgWt ? finalTotalChgWt.toFixed(2) : '---';
                document.getElementById('display_pieces').textContent = summaryTotals.boxCount || '---';
                document.getElementById('display_value').textContent = summaryTotals.totalAmount ? `₹${summaryTotals.totalAmount.toFixed(2)}` : '---';
                
                updateHelperTable();
            }

            function updateDisplayTables() {
                document.getElementById('display_timestamp').textContent = timestampInput.value || '---';
                document.getElementById('display_order_date').textContent = orderDateInput.value || '---';
                document.getElementById('display_transit_date').textContent = orderDateInput.value || '---';
                document.getElementById('display_carrier').textContent = carrierSelect.value || '---';
                document.getElementById('display_awb_number').textContent = document.getElementById('awb').value || '---';
                document.getElementById('display_consignor').textContent = selectedContacts.sender?.UID || '---';
                document.getElementById('display_origin_pincode').textContent = originPincodeInput.value || '---';
                document.getElementById('display_origin_city').textContent = selectedContacts.sender?.CITY || '---';
                document.getElementById('display_consignee').textContent = selectedContacts.receiver?.UID || '---';
                document.getElementById('display_dest_pincode').textContent = destPincodeInput.value || '---';
                document.getElementById('display_dest_city').textContent = selectedContacts.receiver?.CITY || '---';
                
                const selectedModeOption = transportTypeSelect.options[transportTypeSelect.selectedIndex];
                const selectedModeText = selectedModeOption?.text.toUpperCase().replace(/ /g, '_') || '';
                const tatColumnName = `${selectedModeText}_TAT`;
                document.getElementById('display_tat').textContent = selectedContacts.receiver?.[tatColumnName] || '---';
                
                document.getElementById('display_mode').textContent = transportTypeSelect.value || '---';
                document.getElementById('display_zone').textContent = selectedContacts.receiver?.ZONE || '---';
                document.getElementById('display_global').textContent = document.getElementById('payment_global').checked ? 'Yes' : 'No';
                document.getElementById('display_cod').textContent = document.getElementById('payment_cod').checked ? 'Yes' : 'No';
                document.getElementById('display_topay').textContent = document.getElementById('payment_topay').checked ? 'Yes' : 'No';
                document.getElementById('display_fov').textContent = document.getElementById('payment_fov').checked ? 'Yes' : 'No';

                document.getElementById('display_code').textContent = selectedCustomerDetails.CODE || '---';
                document.getElementById('display_user_name').textContent = loginData.NAME || loginData.name || '---';
                document.getElementById('display_branch').textContent = loginData.BRANCH || loginData.branch || '---';
            }

            function revalidateMode() {
                if (userMadeInitialModeChoice && isBookingLocked) return;

                let initialMode = transportTypeSelect.value;
                let newMode = initialMode;
                let message = '';
                let temporaryUnlock = false;

                const weightChangeLimit = parseFloat(selectedCustomerDetails.WEIGHT_CHANGE);
                const expressOption = Array.from(transportTypeSelect.options).find(opt => opt.text.toUpperCase() === 'EXPRESS');
                
                if (!isNaN(weightChangeLimit) && expressOption && !userMadeInitialModeChoice) {
                    const isOverWeight = summaryTotals.totalChgWt > weightChangeLimit;
                    if (isOverWeight && initialMode === expressOption.value) {
                        newMode = selectedContacts.receiver?.MODE || newMode;
                        message = newMode !== initialMode ? `Mode auto-switched to ${newMode} based on weight.` : `Weight exceeds Express limit (${weightChangeLimit}kg). Please select a new mode.`;
                        if (newMode === initialMode) temporaryUnlock = true;
                    } else if (!isOverWeight && initialMode !== expressOption.value) {
                        newMode = expressOption.value;
                        message = `Weight is within limit. Mode reverted to Express.`;
                    }
                }
                
                if (newMode !== initialMode) transportTypeSelect.value = newMode;

                const receiverZone = selectedContacts.receiver?.ZONE;
                if (receiverZone && fetchedGSheetData.MODE) {
                    const currentModeData = fetchedGSheetData.MODE.find(m => m.SHORT === transportTypeSelect.value);
                    if (currentModeData && currentModeData[receiverZone] === 'N') {
                        const surfaceOption = fetchedGSheetData.MODE.find(m => m.MODE.toUpperCase() === 'SURFACE');
                        if (surfaceOption) {
                            transportTypeSelect.value = surfaceOption.SHORT;
                            message = `Mode ${currentModeData.MODE} not available for ${receiverZone}. Switched to Surface. Select another mode if needed.`;
                            temporaryUnlock = true;
                        }
                    }
                }
                
                if (transportTypeSelect.value !== initialMode) recalculateAllBoxWeights();
                modeChangeMessage.textContent = message;

                if (isBookingLocked) {
                    transportTypeSelect.disabled = !temporaryUnlock && wasModeUnlocked;
                    transportTypeSelect.classList.toggle('bg-gray-200', !temporaryUnlock);
                    transportTypeSelect.classList.toggle('cursor-not-allowed', !temporaryUnlock);
                    wasModeUnlocked = temporaryUnlock;
                }
                updateDisplayTables();
            }

            function renderMultiboxTable() {
                multiboxTableBody.innerHTML = '';
                let totalWgt = 0, totalVolWt = 0, calculatedTotalChgWt = 0;

                consignmentBoxes.forEach(box => {
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-50');
                    row.innerHTML = `
                        <td class="p-2 border border-gray-400">${box.boxNum}</td>
                        <td class="p-2 border border-gray-400">${box.actualWeight}</td>
                        <td class="p-2 border border-gray-400">${box.length}</td>
                        <td class="p-2 border border-gray-400">${box.breadth}</td>
                        <td class="p-2 border border-gray-400">${box.height}</td>
                        <td class="p-2 border border-gray-400">${box.volWeight.toFixed(2)}</td>
                        <td class="p-2 border border-gray-400">${box.chargeWeight.toFixed(2)}</td>
                    `;
                    multiboxTableBody.appendChild(row);
                    totalWgt += box.actualWeight;
                    totalVolWt += box.volWeight;
                    calculatedTotalChgWt += box.chargeWeight;
                });
                
                summaryTotals.totalWgt = totalWgt;
                summaryTotals.totalChgWt = calculatedTotalChgWt;
                summaryTotals.boxCount = consignmentBoxes.length;
                updateSummaryDisplay();
                revalidateMode(); 
            }

            function addMultiboxEntry() {
                const actualWeight = parseFloat(actualWeightInput.value);
                const length = parseFloat(lengthInput.value);
                const breadth = parseFloat(breadthInput.value);
                const height = parseFloat(heightInput.value);
                const selectedModeOption = transportTypeSelect.options[transportTypeSelect.selectedIndex];
                const volIngr = parseFloat(selectedModeOption?.dataset.volIngr) || 4700; 

                multiboxErrorMessage.textContent = ''; 
                if (!actualWeight || !length || !breadth || !height) {
                    multiboxErrorMessage.textContent = 'Please fill all Wgt, L, B, and H fields to add a box.';
                    return;
                }
                
                const volWeight = (length * breadth * height) / volIngr;
                const chargeWeight = Math.max(actualWeight, volWeight);
                const boxNum = consignmentBoxes.length + 1;

                consignmentBoxes.push({ boxNum, actualWeight, length, breadth, height, volWeight, chargeWeight });

                if (!isBookingLocked) setBookingFieldsLocked(true);
                else if (wasModeUnlocked) {
                    transportTypeSelect.disabled = true;
                    transportTypeSelect.classList.add('bg-gray-200', 'cursor-not-allowed');
                    wasModeUnlocked = false; 
                    modeChangeMessage.textContent = '';
                }

                renderMultiboxTable();
                [actualWeightInput, lengthInput, breadthInput, heightInput].forEach(input => input.value = '');
            }
            
            function updateCharges() {
                const frightValue = calculateFreight();
                document.getElementById('display_fright').textContent = frightValue.toFixed(2);

                const totalValue = summaryTotals.totalAmount;
                const chgWt = parseFloat(document.getElementById('display_chg_wt').textContent) || 0;

                let charges = { cod: 0, topay: 0, fov: 0, awb: 0, fuel: 0, eway: 0, pack: 0, dev: 0 };

                if (Object.keys(selectedCustomerDetails).length > 0) {
                    if (document.getElementById('payment_cod').checked) charges.cod = Math.max(150, totalValue * (parseFloat(selectedCustomerDetails['%_COD_IF']) || 0));
                    if (document.getElementById('payment_topay').checked) charges.topay = Math.max(150, frightValue * (parseFloat(selectedCustomerDetails['%_TOPAY_IF']) || 0));
                    if (document.getElementById('payment_fov').checked) charges.fov = Math.max(100, totalValue * (parseFloat(selectedCustomerDetails['%_FOV_IF']) || 0));
                    charges.awb = parseFloat(selectedCustomerDetails['AWB_CHARGES']) || 0;
                    charges.fuel = frightValue * (parseFloat(selectedCustomerDetails['FUEL_CHARGES']) || 0);
                    charges.eway = consignmentProducts.filter(p => p.ewayBill).length * (parseFloat(selectedCustomerDetails['EWAY_IF']) || 0);
                    charges.pack = chgWt * (parseFloat(selectedCustomerDetails['PACKING_CHARGES']) || 0);
                    charges.dev = frightValue * (parseFloat(selectedCustomerDetails['DEV_CHARGES']) || 0);
                }

                document.getElementById('display_cod_chg').textContent = charges.cod.toFixed(2);
                document.getElementById('display_topay_chg').textContent = charges.topay.toFixed(2);
                document.getElementById('display_fov_chg').textContent = charges.fov.toFixed(2);
                document.getElementById('display_awb_chg').textContent = charges.awb.toFixed(2);
                document.getElementById('display_fuel_chg').textContent = charges.fuel.toFixed(2);
                document.getElementById('display_eway_chg').textContent = charges.eway.toFixed(2);
                document.getElementById('display_pack_chg').textContent = charges.pack.toFixed(2);
                document.getElementById('display_dev_chg').textContent = charges.dev.toFixed(2);

                const otherCharges = charges.fuel + charges.cod + charges.topay + charges.fov + charges.eway + charges.awb + charges.pack + charges.dev;
                document.getElementById('display_other_chg').textContent = otherCharges.toFixed(2);

                const subtotal = frightValue + otherCharges;
                let taxableAmount = 0, sgst = 0, cgst = 0, igst = 0, total = 0;

                if (selectedCustomerDetails.GST_INC === 'Y') {
                    taxableAmount = subtotal;
                    if (selectedCustomerDetails.BILLING_STATE === 'Uttarakhand-05') {
                        const totalTax = taxableAmount - (taxableAmount / 1.18);
                        sgst = totalTax / 2;
                        cgst = totalTax / 2;
                    } else {
                        igst = taxableAmount - (taxableAmount / 1.18);
                    }
                    total = taxableAmount;
                } else {
                    taxableAmount = subtotal;
                    if (selectedCustomerDetails.BILLING_STATE === 'Uttarakhand-05') {
                        sgst = taxableAmount * 0.09;
                        cgst = taxableAmount * 0.09;
                    } else {
                        igst = taxableAmount * 0.18;
                    }
                    total = taxableAmount + sgst + cgst + igst;
                }

                document.getElementById('display_taxable').textContent = taxableAmount.toFixed(2);
                document.getElementById('display_sgst').textContent = sgst.toFixed(2);
                document.getElementById('display_cgst').textContent = cgst.toFixed(2);
                document.getElementById('display_igst').textContent = igst.toFixed(2);
                document.getElementById('display_gst_total').textContent = (sgst + cgst + igst).toFixed(2);
                document.getElementById('display_total').textContent = total.toFixed(2);
            }

            function renderProductTable() {
                productTableBody.innerHTML = '';
                summaryTotals.totalAmount = 0;
                consignmentProducts.forEach((product, index) => {
                    const row = productTableBody.insertRow();
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="p-2 border border-gray-400">${index + 1}</td>
                        <td class="p-2 border border-gray-400">${product.name}</td>
                        <td class="p-2 border border-gray-400">${product.docNo}</td>
                        <td class="p-2 border border-gray-400">${product.ewayBill}</td>
                        <td class="p-2 border border-gray-400">${product.type}</td>
                        <td class="p-2 border border-gray-400">₹${product.amount.toFixed(2)}</td>
                    `;
                    summaryTotals.totalAmount += product.amount;
                });
                updateSummaryDisplay();
                updateCharges(); 
            }

            function addProductEntry() {
                const productName = productNameInput.value.trim();
                const docNo = docNoInput.value.trim();
                const ewayBill = ewayBillInput.value.trim();
                const amount = parseFloat(amountInput.value);

                ewayStatusMessage.textContent = '';
                if (!productName || !docNo || !amountInput.value) {
                    ewayStatusMessage.textContent = 'Product, DocNo and Amount are required.';
                    return;
                }
                if (amount >= 50000 && !ewayBill) {
                    ewayStatusMessage.textContent = 'EWay Bill is mandatory for invoice value ≥ ₹50,000.';
                    return;
                }
                if (ewayBill && !/^\d{12}$/.test(ewayBill)) {
                    ewayStatusMessage.textContent = 'EWay bill must be a 12-digit number.';
                    return;
                }

                consignmentProducts.push({ name: productName, docNo, ewayBill, type: productTypeSelect.value, amount: amount || 0 });
                if (!isBookingLocked) setBookingFieldsLocked(true);
                renderProductTable();
                productNameInput.value = '';
                docNoInput.value = '';
                ewayBillInput.value = '';
                amountInput.value = '';
                productTypeSelect.value = 'INV';
            }
            
            function handleCustomerSelectionChange() {
                const selectedCustomerName = customerNameSelect.value;
                selectedCustomerDetails = fetchedGSheetData.B2B?.find(c => c.CLIENT_NAME === selectedCustomerName) || {};
                
                const contactDetails = fetchedGSheetData.B2B2C?.find(c => c.NAME === selectedCustomerName && c.CODE === selectedCustomerDetails.CODE);
                if (contactDetails) {
                    senderNameInput.value = contactDetails.NAME;
                    originPincodeInput.value = contactDetails.PINCODE || '';
                    selectedContacts.sender = contactDetails;
                    displayContactDetails(contactDetails, senderDetailsDisplay);
                } else {
                    senderNameInput.value = '';
                    originPincodeInput.value = '';
                    selectedContacts.sender = null;
                    senderDetailsDisplay.innerHTML = `<span class="italic text-gray-500">Select a customer to autofill sender.</span>`;
                }
                
                populateModeDropdown(null); 
                const expressOption = Array.from(transportTypeSelect.options).find(opt => opt.text.toUpperCase() === 'EXPRESS');
                if (expressOption) transportTypeSelect.value = expressOption.value;
                updateDisplayTables();
                checkMainDetailsAndToggleInputs();
            }

            function populateCustomerDropdown() {
                const clients = fetchedGSheetData.B2B;
                if (clients && clients.length > 0) {
                    customerNameSelect.innerHTML = '<option value="">Select Customer</option>';
                    clients.forEach(client => {
                        customerNameSelect.add(new Option(client.CLIENT_NAME, client.CLIENT_NAME));
                    });
                    if (clients.length === 1) {
                        customerNameSelect.value = clients[0].CLIENT_NAME;
                        handleCustomerSelectionChange();
                    }
                }
            }

            function populateModeDropdown(zone) {
                const modes = fetchedGSheetData.MODE;
                if (modes && modes.length > 0) {
                    const currentMode = transportTypeSelect.value;
                    transportTypeSelect.innerHTML = '<option value="">Select Mode</option>';
                    modes.forEach(mode => {
                        const option = new Option(mode.MODE, mode.SHORT);
                        option.dataset.volIngr = mode.VOL_INGR;
                        option.dataset.minWt = mode.MIN_WT;
                        option.disabled = zone && mode[zone] === 'N';
                        transportTypeSelect.add(option);
                    });
                    if (Array.from(transportTypeSelect.options).some(opt => opt.value === currentMode && !opt.disabled)) {
                        transportTypeSelect.value = currentMode;
                    }
                }
            }

            function populateCarrierDropdown() {
                const carriers = fetchedGSheetData.CARRIER;
                if (carriers && carriers.length > 0) {
                    carrierSelect.innerHTML = '<option value="">Select Carrier</option>';
                    carriers.forEach(carrier => {
                        carrierSelect.add(new Option(carrier.COMPANY_CODE, carrier.COMPANY_CODE));
                    });
                }
            }
            
            function recalculateAllBoxWeights() {
                const selectedModeOption = transportTypeSelect.options[transportTypeSelect.selectedIndex];
                const volIngr = parseFloat(selectedModeOption?.dataset.volIngr) || 4700;
                consignmentBoxes.forEach(box => {
                    box.volWeight = (box.length * box.breadth * box.height) / volIngr;
                    box.chargeWeight = Math.max(box.actualWeight, box.volWeight);
                });
                renderMultiboxTable();
            }

            function displayContactDetails(contact, displayElement) {
                if (contact) {
                    displayElement.innerHTML = `
                        <p class="text-xs text-gray-600">${contact.ADDRESS || ''}</p>
                        <p class="text-xs text-gray-600">${contact.CITY || ''}, ${contact.STATE || ''} - ${contact.PINCODE || ''}</p>
                        <p class="text-xs text-gray-600">Ph: ${contact.MOBILE || ''}</p>
                    `;
                } else {
                    displayElement.innerHTML = `<span class="italic text-gray-500">No details found.</span>`;
                }
            }

            function setupAutocomplete(inputElement, resultsElement, displayElement, type) {
                inputElement.addEventListener('input', () => {
                    const query = inputElement.value.toLowerCase();
                    resultsElement.innerHTML = '';
                    resultsElement.classList.add('hidden');

                    if (type === 'sender') selectedContacts.sender = null;
                    if (type === 'receiver') {
                        selectedContacts.receiver = null;
                        populateModeDropdown(null);
                    }
                    updateDisplayTables();
                    checkMainDetailsAndToggleInputs();

                    if (query.length < 2 || !fetchedGSheetData.B2B2C) return;
                    const customerCode = selectedCustomerDetails.CODE;
                    if (!customerCode) return;

                    const customerSpecificContacts = fetchedGSheetData.B2B2C.filter(contact => contact.CODE === customerCode);
                    const filteredResults = customerSpecificContacts.filter(contact => 
                        contact.NAME?.toLowerCase().includes(query) || 
                        contact.PINCODE?.toString().includes(query) || 
                        contact.CITY?.toLowerCase().includes(query)
                    );

                    if (filteredResults.length > 0 || query) {
                        filteredResults.forEach(contact => {
                            const li = document.createElement('li');
                            li.textContent = `${contact.NAME} - ${contact.CITY}, ${contact.PINCODE}`;
                            li.addEventListener('click', () => {
                                inputElement.value = contact.NAME;
                                displayContactDetails(contact, displayElement);
                                if (type === 'sender') {
                                    selectedContacts.sender = contact;
                                    originPincodeInput.value = contact.PINCODE || '';
                                } else {
                                    selectedContacts.receiver = contact;
                                    destPincodeInput.value = contact.PINCODE || '';
                                    carrierSelect.value = contact.CARRIER || '';
                                    populateModeDropdown(contact.ZONE);
                                }
                                resultsElement.classList.add('hidden');
                                revalidateMode(); 
                                updateDisplayTables();
                                checkMainDetailsAndToggleInputs();
                            });
                            resultsElement.appendChild(li);
                        });
                        
                        const addNewLi = document.createElement('li');
                        addNewLi.className = 'bg-gray-100 font-semibold';
                        addNewLi.textContent = '+ Add New Contact';
                        addNewLi.addEventListener('click', () => {
                            const customerCode = selectedCustomerDetails.CODE;
                            if (customerCode) {
                                mainFormContainer.classList.add('hidden');
                                addContactContainer.classList.remove('hidden');
                                
                                const addContactForm = document.getElementById('addContactForm');
                                addContactForm.querySelector('#add_contact_code').value = customerCode;
                                addContactForm.querySelector('#add_contact_branch').value = selectedCustomerDetails.BRANCH || '';
                                const clientSearchInput = addContactForm.querySelector('#add_contact_client_search');
                                clientSearchInput.value = `${selectedCustomerDetails.CLIENT_NAME} (${customerCode})`;
                                clientSearchInput.readOnly = true;
                                clientSearchInput.classList.add('readonly-input');
                            } else {
                                bookingMessage.textContent = 'Please select a customer before adding a new contact.';
                                bookingMessage.className = 'p-2 text-sm text-center rounded-md mt-2 text-red-700 bg-red-100';
                            }
                            resultsElement.classList.add('hidden');
                        });
                        resultsElement.appendChild(addNewLi);
                        resultsElement.classList.remove('hidden');
                    }
                });
            }

            function initializePageWithData(data) {
                if (!data) {
                    bookingMessage.textContent = 'Application data could not be loaded. Please refresh.';
                    bookingMessage.className = 'p-2 text-sm text-center rounded-md mt-2 text-red-700 bg-red-100';
                    return;
                }
                fetchedGSheetData = data;
                populateCustomerDropdown();
                populateCarrierDropdown();
                populateModeDropdown(null); 
                setupAutocomplete(senderNameInput, senderAutocompleteResults, senderDetailsDisplay, 'sender');
                setupAutocomplete(receiverNameInput, receiverAutocompleteResults, receiverDetailsDisplay, 'receiver');
                
                // Initialize the add contact form logic as well
                initializeAddContactForm(data.B2B);
            }
            
            // --- MAIN INITIALIZATION ---
            const loginDataJSON = localStorage.getItem('loginData');
            if (loginDataJSON) {
                loginData = JSON.parse(loginDataJSON);
            } else {
                // Let layout.js handle redirect if it exists
                return; 
            }

            window.addEventListener('appDataLoaded', (e) => initializePageWithData(e.detail));
            window.addEventListener('appDataRefreshed', (e) => initializePageWithData(e.detail));
            
            const appDataJSON = localStorage.getItem('appData');
            if (appDataJSON) {
                const appData = JSON.parse(appDataJSON);
                if (appData.data) initializePageWithData(appData.data);
            }
            
            customerNameSelect.addEventListener('change', handleCustomerSelectionChange);
            transportTypeSelect.addEventListener('change', () => {
                if (!isBookingLocked) userMadeInitialModeChoice = true;
                recalculateAllBoxWeights();
                if (isBookingLocked && wasModeUnlocked) {
                    transportTypeSelect.disabled = true;
                    transportTypeSelect.classList.add('bg-gray-200', 'cursor-not-allowed');
                    wasModeUnlocked = false; 
                    modeChangeMessage.textContent = '';
                }
                checkMainDetailsAndToggleInputs();
            });
            carrierSelect.addEventListener('change', () => {
                if (isBookingLocked && carrierSelect.value) {
                    carrierSelect.disabled = true;
                    carrierSelect.classList.add('bg-gray-200', 'cursor-not-allowed');
                }
                checkMainDetailsAndToggleInputs();
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.autocomplete-container')) {
                    senderAutocompleteResults.classList.add('hidden');
                    receiverAutocompleteResults.classList.add('hidden');
                }
            });

            ['order_date', 'carrier_select', 'awb', 'sender_name', 'origin_pincode', 'receiver_name', 'dest_pincode', 'transport_type'].forEach(id => {
                const element = document.getElementById(id);
                if(element) element.addEventListener('input', updateDisplayTables);
            });
            ['payment_global', 'payment_topay', 'payment_cod', 'payment_fov'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    updateDisplayTables();
                    updateCharges();
                });
            });

            // Input chaining with Enter key
            const chainInputs = (currentId, nextId) => {
                document.getElementById(currentId).addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById(nextId).focus(); } });
            };
            chainInputs('actual_weight', 'length');
            chainInputs('length', 'breadth');
            chainInputs('breadth', 'height');
            heightInput.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === 'Tab') { e.preventDefault(); addMultiboxEntry(); actualWeightInput.focus(); } });
            chainInputs('product_name', 'doc_no');
            chainInputs('doc_no', 'eway_bill');
            chainInputs('eway_bill', 'amount');
            amountInput.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === 'Tab') { e.preventDefault(); addProductEntry(); productNameInput.focus(); } });

            clearMultiboxButton.addEventListener('click', () => {
                consignmentBoxes.pop();
                renderMultiboxTable();
                if (!consignmentBoxes.length && !consignmentProducts.length) setBookingFieldsLocked(false);
            });
            clearMultiboxButton.addEventListener('dblclick', () => {
                consignmentBoxes = [];
                renderMultiboxTable();
                setBookingFieldsLocked(false);
            });
            clearProductsButton.addEventListener('click', () => {
                consignmentProducts.pop();
                renderProductTable();
                if (!consignmentBoxes.length && !consignmentProducts.length) setBookingFieldsLocked(false);
            });
            clearProductsButton.addEventListener('dblclick', () => {
                consignmentProducts = [];
                renderProductTable();
                setBookingFieldsLocked(false);
            });
            clearAllButton.addEventListener('click', () => {
                consignmentBoxes = [];
                consignmentProducts = [];
                renderMultiboxTable();
                renderProductTable();
                setBookingFieldsLocked(false);
            });
            
            cancelButton.addEventListener('click', resetFullForm);

            bookButton.addEventListener('click', async () => {
                 bookingMessage.textContent = '';
                 bookingMessage.className = 'p-2 text-sm text-center rounded-md mt-2';

                 if (!areMainDetailsComplete() || (consignmentBoxes.length === 0 && consignmentProducts.length === 0)) {
                    bookingMessage.textContent = 'Please fill all required fields (Customer, Sender, Receiver, Mode, Carrier) and add at least one box or product.';
                    bookingMessage.className = 'p-2 text-sm text-center rounded-md mt-2 text-red-700 bg-red-100';
                    return;
                }
                bookButton.disabled = true;
                bookButton.textContent = 'Booking...';
                
                const orderData = {
                    'CODE': document.getElementById('display_code').textContent || '', 'TIME_STAMP': document.getElementById('display_timestamp').textContent,
                    'ORDER_DATE': document.getElementById('display_order_date').textContent, 'CARRIER': document.getElementById('display_carrier').textContent,
                    'AWB_NUMBER': document.getElementById('awb').value.trim(), 'TRANSIT_DATE': document.getElementById('display_transit_date').textContent,
                    'CONSIGNOR': document.getElementById('display_consignor').textContent, 'ORIGIN_CITY': document.getElementById('display_origin_city').textContent,
                    'ORIGIN_PINCODE': document.getElementById('display_origin_pincode').textContent, 'CONSIGNEE': document.getElementById('display_consignee').textContent,
                    'DEST_CITY': document.getElementById('display_dest_city').textContent, 'DEST_PINCODE': document.getElementById('display_dest_pincode').textContent,
                    'TAT': document.getElementById('display_tat').textContent, 'ZONE': document.getElementById('display_zone').textContent,
                    'MODE': document.getElementById('display_mode').textContent, 'GLOBAL': document.getElementById('display_global').textContent,
                    'COD': document.getElementById('display_cod').textContent, 'TOPAY': document.getElementById('display_topay').textContent,
                    'FOV': document.getElementById('display_fov').textContent, 'WEIGHT': document.getElementById('display_weight').textContent,
                    'CHG_WT': document.getElementById('display_chg_wt').textContent, 'PIECS': document.getElementById('display_pieces').textContent,
                    'VALUE': summaryTotals.totalAmount, 'FRIGHT': document.getElementById('display_fright').textContent,
                    'FUEL_CHG': document.getElementById('display_fuel_chg').textContent, 'COD_CHG': document.getElementById('display_cod_chg').textContent,
                    'TOPAY_CHG': document.getElementById('display_topay_chg').textContent, 'FOV_CHG': document.getElementById('display_fov_chg').textContent,
                    'EWAY_CHG': document.getElementById('display_eway_chg').textContent, 'AWB_CHG': document.getElementById('display_awb_chg').textContent,
                    'PACK_CHG': document.getElementById('display_pack_chg').textContent, 'DEV_CHG': document.getElementById('display_dev_chg').textContent,
                    'TAXABLE': document.getElementById('display_taxable').textContent, 'SGST': document.getElementById('display_sgst').textContent,
                    'CGST': document.getElementById('display_cgst').textContent, 'IGST': document.getElementById('display_igst').textContent,
                    'TOTAL': document.getElementById('display_total').textContent,
                };
                const payload = {
                    code: loginData.code,
                    token: loginData.token,
                    orderDetails: orderData,
                    multiboxDetails: consignmentBoxes,
                    productDetails: consignmentProducts
                };

                try {
                    const response = await fetch('https://script.google.com/macros/s/AKfycbx5PZJRnnDmyDtYbWctF6d0428h1haJnDfVA4HKQR4hcsdAolcmkhLG9MgntAhPSQyi/exec', { 
                        method: 'POST', mode: 'cors', cache: 'no-cache', headers: {'Content-Type': 'text/plain;charset=utf-8'},
                        redirect: 'follow', body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (result.success) {
                        bookingMessage.textContent = result.message;
                        bookingMessage.className = 'p-2 text-sm text-center rounded-md mt-2 text-green-700 bg-green-100';
                        resetForNextBooking();
                    } else { throw new Error(result.message); }
                } catch (error) {
                    bookingMessage.textContent = `Booking failed: ${error.message}`;
                    bookingMessage.className = 'p-2 text-sm text-center rounded-md mt-2 text-red-700 bg-red-100';
                } finally {
                    bookButton.disabled = false;
                    bookButton.textContent = 'Book';
                }
            });
            
            if (getAwbButton) {
                getAwbButton.addEventListener('click', () => {
                    bookingMessage.textContent = 'AWB fetch logic not implemented yet.';
                    bookingMessage.className = 'p-2 text-sm text-center rounded-md mt-2 text-blue-700 bg-blue-100';
                });
            }

            updateTimestamp();
            orderDateInput.value = formatDate(new Date());
            setInterval(updateTimestamp, 60000);
            updateDisplayTables();
            updateSummaryDisplay();
            toggleWeightProductEntry(true);

            // --- ADD CONTACT FORM LOGIC ---
            function initializeAddContactForm(clients) {
                const addContactForm = document.getElementById('addContactForm');
                const statusDiv = document.getElementById('addContactStatus');
                const submitBtn = document.getElementById('addContactSubmitBtn');
                const cancelBtn = document.getElementById('addContactCancelBtn');
                const buttonText = document.getElementById('addContactButtonText');
                const spinner = document.getElementById('addContactSpinner');

                const userInput = document.getElementById('add_contact_user');
                const tokenInput = document.getElementById('add_contact_token');
                const pincodeInput = document.getElementById('add_contact_pincode');
                
                const SUBMIT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwb5gqe6hep6orsrnviSzD-LDNt4axEnLKNPCfWJl8GINS55FzWEOKSMVVTy8M8KlO4w/exec';
                const PINCODE_API_URL = 'https://script.google.com/macros/s/AKfycbzZOoT6tp9XVgXiOdiiUL9wWchgGqdBPoTI9BiuT2HyKBIuFzPKPZI4z3kF1IAYBgpn/exec';

                function populateAuthFields() {
                    userInput.value = loginData.code || '';
                    tokenInput.value = loginData.token || '';
                }
                populateAuthFields();

                function setLoading(isLoading) {
                    submitBtn.disabled = isLoading;
                    spinner.classList.toggle('hidden', !isLoading);
                    buttonText.textContent = isLoading ? 'Submitting...' : 'Submit';
                }

                function displayMessage(message, type) {
                    statusDiv.textContent = message;
                    statusDiv.className = 'text-center font-medium mt-4 text-sm p-2 rounded-md ';
                    if (type === 'error') statusDiv.classList.add('text-red-700', 'bg-red-100');
                    else if (type === 'success') statusDiv.classList.add('text-green-700', 'bg-green-100');
                }

                cancelBtn.addEventListener('click', () => {
                    addContactForm.reset();
                    document.getElementById('add_contact_client_search').readOnly = false;
                    document.getElementById('add_contact_client_search').classList.remove('readonly-input');
                    clearPincodeDataFields();
                    populateAuthFields();
                    addContactContainer.classList.add('hidden');
                    mainFormContainer.classList.remove('hidden');
                });

                let debounceTimer;
                pincodeInput.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        const pincode = pincodeInput.value.trim();
                        if (pincode.length !== 6 || !/^\d{6}$/.test(pincode)) {
                            clearPincodeDataFields();
                            return;
                        }
                        fetchPincodeData(pincode);
                    }, 500);
                });

                addContactForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    setLoading(true);
                    try {
                        const response = await fetch(SUBMIT_SCRIPT_URL, { method: 'POST', body: new FormData(addContactForm) });
                        const result = await response.json();
                        if (result.status === 'success') {
                            displayMessage(result.message, 'success');
                            setTimeout(() => {
                                cancelBtn.click(); // Use cancel logic to hide form and reset
                                // Manually trigger a data refresh using the function from layout.js if available
                                if (typeof window.refreshData === 'function') {
                                    window.refreshData();
                                }
                            }, 2000);
                        } else {
                            displayMessage(result.message, 'error');
                        }
                    } catch (error) {
                        displayMessage('An unexpected error occurred.', 'error');
                    } finally {
                        setLoading(false);
                    }
                });

                const clearPincodeDataFields = () => {
                    ['add_contact_city', 'add_contact_state', 'add_contact_carrier', 'add_contact_express_tat', 'add_contact_airline_tat', 'add_contact_surface_tat', 'add_contact_premium_tat', 'add_contact_oda', 'add_contact_zone'].forEach(id => {
                        const field = document.getElementById(id);
                        if (field) field.value = '';
                    });
                };

                async function fetchPincodeData(pincode) {
                    pincodeInput.classList.add('opacity-50', 'cursor-wait');
                    try {
                        const response = await fetch(`${PINCODE_API_URL}?pincode=${pincode}`);
                        if (!response.ok) throw new Error('Network response was not OK');
                        const result = await response.json();
                        if (result.found && result.data) {
                            const data = result.data;
                            document.getElementById('add_contact_state').value = data.StateName || '';
                            document.getElementById('add_contact_city').value = data.DestinationName || '';
                            document.getElementById('add_contact_carrier').value = data.Carrier || '';
                            document.getElementById('add_contact_express_tat').value = data['Dox (E)'] || '';
                            document.getElementById('add_contact_airline_tat').value = data['NonDox (A)'] || '';
                            document.getElementById('add_contact_surface_tat').value = data['NonDox (S)'] || '';
                            document.getElementById('add_contact_oda').value = data.ODA || '';
                            document.getElementById('add_contact_premium_tat').value = data['PRO (P)'] || '';
                            document.getElementById('add_contact_zone').value = data.ZONE || '';
                        } else {
                            clearPincodeDataFields();
                        }
                    } catch (error) {
                        console.error('Error fetching pincode data:', error);
                        clearPincodeDataFields();
                    } finally {
                        pincodeInput.classList.remove('opacity-50', 'cursor-wait');
                    }
                }
            }
        });
    </script>
</body>
</html>

