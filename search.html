<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search - Postman</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>

    <main class="w-full flex-grow p-4 sm:p-8">
        <div class="container mx-auto">
            <div class="card">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Search Application Data</h1>
                
                <!-- Search Controls -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 items-end">
                    <!-- Sheet Selector -->
                    <div class="md:col-span-1">
                        <label for="sheet-selector" class="block text-sm font-medium text-gray-700">Select Data Source</label>
                        <select id="sheet-selector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border">
                            <option>Loading...</option>
                        </select>
                    </div>
                    <!-- Search Input -->
                    <div class="md:col-span-2">
                        <label for="search-input" class="block text-sm font-medium text-gray-700">Search Term</label>
                        <input type="text" id="search-input" placeholder="Enter search term..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results-container" class="space-y-4">
                    <p class="text-center text-gray-500">Please log in to access data. If you are logged in, data is loading.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Layout script -->
    <script src="layout.js"></script>

    <!-- Page-specific script for searching -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sheetSelector = document.getElementById('sheet-selector');
            const searchInput = document.getElementById('search-input');
            const resultsContainer = document.getElementById('results-container');
            let appData = null;

            function initializeSearchPage() {
                const appDataJSON = localStorage.getItem('appData');
                if (!appDataJSON) {
                    resultsContainer.innerHTML = '<p class="text-center text-red-500">No application data found. Please log in and ensure data is loaded correctly.</p>';
                    sheetSelector.innerHTML = '<option>No data sources</option>';
                    return;
                }

                try {
                    appData = JSON.parse(appDataJSON).data;
                    populateSheetSelector();
                    displayResults(); // Initial display
                } catch (e) {
                    resultsContainer.innerHTML = '<p class="text-center text-red-500">Error parsing application data.</p>';
                    console.error("Error parsing appData:", e);
                }
            }

            function populateSheetSelector() {
                sheetSelector.innerHTML = '';
                if (appData) {
                    for (const sheetName in appData) {
                        const option = document.createElement('option');
                        option.value = sheetName;
                        option.textContent = sheetName;
                        sheetSelector.appendChild(option);
                    }
                }
            }

            function displayResults() {
                if (!appData) return;

                const selectedSheet = sheetSelector.value;
                const searchTerm = searchInput.value.toLowerCase().trim();
                const sheetData = appData[selectedSheet];

                resultsContainer.innerHTML = '';

                if (!sheetData || sheetData.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-center text-gray-500">No data available for this source.</p>';
                    return;
                }

                const filteredData = searchTerm
                    ? sheetData.filter(row => 
                        Object.values(row).some(value => 
                            String(value).toLowerCase().includes(searchTerm)
                        )
                      )
                    : sheetData;

                if (filteredData.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-center text-gray-500">No results found for your search term.</p>';
                    return;
                }
                
                // Render table
                const tableContainer = document.createElement('div');
                tableContainer.className = 'overflow-x-auto border rounded-lg';
                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200';
                
                const thead = document.createElement('thead');
                thead.className = 'bg-gray-50';
                const headerRow = document.createElement('tr');
                const headers = Object.keys(filteredData[0]);
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                tbody.className = 'bg-white divide-y divide-gray-200';
                filteredData.forEach(rowData => {
                    const tr = document.createElement('tr');
                    headers.forEach(header => {
                        const td = document.createElement('td');
                        td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-800';
                        td.textContent = rowData[header];
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                tableContainer.appendChild(table);
                resultsContainer.appendChild(tableContainer);
            }
            
            // Wait for data to be loaded by layout.js
            window.addEventListener('appDataLoaded', initializeSearchPage);
            window.addEventListener('appDataRefreshed', initializeSearchPage);

            // Event listeners for controls
            searchInput.addEventListener('input', displayResults);
            sheetSelector.addEventListener('change', displayResults);

            // Initial check in case data is already loaded
            initializeSearchPage();
        });
    </script>
</body>
</html>
